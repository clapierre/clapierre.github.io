var expect=require("expect.js");var path=require("path");var fs=require("graceful-fs");var nock=require("nock");var Q=require("q");var rimraf=require("rimraf");var mkdirp=require("mkdirp");var Logger=require("bower-logger");var cmd=require("../../../lib/util/cmd");var UrlResolver=require("../../../lib/core/resolvers/UrlResolver");var defaultConfig=require("../../../lib/config");describe("UrlResolver",function(){var c=path.resolve(__dirname,"../../assets/package-a");var d=path.resolve(__dirname,"../../tmp/tmp");var a;before(function(e){a=new Logger();cmd("git",["checkout","0.2.1"],{cwd:c}).then(e.bind(e,null),e)});afterEach(function(){a.removeAllListeners();nock.cleanAll()});function b(e){if(typeof e==="string"){e={source:e}}return new UrlResolver(e,defaultConfig(),a)}describe(".constructor",function(){it("should guess the name from the URL",function(){var e=b("http://bower.io/foo.txt");expect(e.getName()).to.equal("foo")});it("should remove ?part from the URL when guessing the name",function(){var e=b("http://bower.io/foo.txt?bar");expect(e.getName()).to.equal("foo")});it("should not guess the name or remove ?part from the URL if not guessing",function(){var e=b({source:"http://bower.io/foo.txt?bar",name:"baz"});expect(e.getName()).to.equal("baz")});it("should error out if a target was specified",function(e){var g;try{g=b({source:c,target:"0.0.1"})}catch(f){expect(f).to.be.an(Error);expect(f.message).to.match(/can\'t resolve targets/i);expect(f.code).to.equal("ENORESTARGET");return e()}e(new Error("Should have thrown"))})});describe(".hasNew",function(){before(function(){mkdirp.sync(d)});afterEach(function(e){rimraf(path.join(d,".bower.json"),e)});after(function(e){rimraf(d,e)});it("should resolve to true if the response is not in the 2xx range",function(e){var f=b("http://bower.io/foo.js");nock("http://bower.io").head("/foo.js").reply(500);fs.writeFileSync(path.join(d,".bower.json"),JSON.stringify({name:"foo",version:"0.0.0"}));f.hasNew(d).then(function(g){expect(g).to.be(true);e()}).done()});it("should resolve to true if cache headers changed",function(e){var f=b("http://bower.io/foo.js");nock("http://bower.io").head("/foo.js").reply(200,"",{ETag:"686897696a7c876b7e","Last-Modified":"Tue, 15 Nov 2012 12:45:26 GMT"});fs.writeFileSync(path.join(d,".bower.json"),JSON.stringify({name:"foo",version:"0.0.0",_cacheHeaders:{ETag:"fk3454fdmmlw20i9nf","Last-Modified":"Tue, 16 Nov 2012 13:35:29 GMT"}}));f.hasNew(d).then(function(g){expect(g).to.be(true);e()}).done()});it("should resolve to false if cache headers haven't changed",function(e){var f=b("http://bower.io/foo.js");nock("http://bower.io").head("/foo.js").reply(200,"",{ETag:"686897696a7c876b7e","Last-Modified":"Tue, 15 Nov 2012 12:45:26 GMT"});fs.writeFileSync(path.join(d,".bower.json"),JSON.stringify({name:"foo",version:"0.0.0",_cacheHeaders:{ETag:"686897696a7c876b7e","Last-Modified":"Tue, 15 Nov 2012 12:45:26 GMT"}}));f.hasNew(d).then(function(g){expect(g).to.be(false);e()}).done()});it("should resolve to true if server responds with 304 (ETag mechanism)",function(e){var f=b("http://bower.io/foo.js");nock("http://bower.io").head("/foo.js").matchHeader("If-None-Match","686897696a7c876b7e").reply(304,"",{ETag:"686897696a7c876b7e","Last-Modified":"Tue, 15 Nov 2012 12:45:26 GMT"});fs.writeFileSync(path.join(d,".bower.json"),JSON.stringify({name:"foo",version:"0.0.0",_cacheHeaders:{ETag:"686897696a7c876b7e","Last-Modified":"Tue, 15 Nov 2012 12:45:26 GMT"}}));f.hasNew(d).then(function(g){expect(g).to.be(false);e()}).done()});it("should work with redirects",function(f){var e="http://redirecting-url.com";var h="http://bower.io";var g;nock(e).head("/foo.js").reply(302,"",{location:h+"/foo.js"});nock(h).head("/foo.js").reply(200,"foo contents",{ETag:"686897696a7c876b7e","Last-Modified":"Tue, 15 Nov 2012 12:45:26 GMT"});fs.writeFileSync(path.join(d,".bower.json"),JSON.stringify({name:"foo",version:"0.0.0",_cacheHeaders:{ETag:"686897696a7c876b7e","Last-Modified":"Tue, 15 Nov 2012 12:45:26 GMT"}}));g=b(e+"/foo.js");g.hasNew(d).then(function(i){expect(i).to.be(false);f()}).done()})});describe(".resolve",function(){function e(g,f){return Q.nfcall(fs.readFile,path.join(g,".bower.json")).then(function(h){var i=JSON.parse(h.toString());expect(i.main).to.equal(f);return i})}it("should download file, renaming it to index",function(f){var g;nock("http://bower.io").get("/foo.js").reply(200,"foo contents");g=b("http://bower.io/foo.js");g.resolve().then(function(h){var i;expect(fs.existsSync(path.join(h,"index.js"))).to.be(true);expect(fs.existsSync(path.join(h,"foo.js"))).to.be(false);i=fs.readFileSync(path.join(h,"index.js")).toString();expect(i).to.equal("foo contents");e(h,"index.js").then(f.bind(f,null))}).done()});it("should extract if source is an archive",function(f){var g;nock("http://bower.io").get("/package-zip.zip").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip.zip"));g=b("http://bower.io/package-zip.zip");g.resolve().then(function(h){expect(fs.existsSync(path.join(h,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(h,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-zip.zip"))).to.be(false);f()}).done()});it("should extract if source is an archive (case insensitive)",function(f){var g;nock("http://bower.io").get("/package-zip.ZIP").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip.zip"));g=b("http://bower.io/package-zip.ZIP");g.resolve().then(function(h){expect(fs.existsSync(path.join(h,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(h,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-zip.ZIP"))).to.be(false);f()}).done()});it("should copy extracted folder contents if archive contains only a folder inside",function(f){var g;nock("http://bower.io").get("/package-zip-folder.zip").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip-folder.zip"));nock("http://bower.io").get("/package-zip.zip").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip-folder.zip"));g=b("http://bower.io/package-zip-folder.zip");g.resolve().then(function(h){expect(fs.existsSync(path.join(h,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(h,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-zip"))).to.be(false);expect(fs.existsSync(path.join(h,"package-zip-folder"))).to.be(false);expect(fs.existsSync(path.join(h,"package-zip-folder.zip"))).to.be(false);g=b({source:"http://bower.io/package-zip.zip",name:"package-zip"});return g.resolve()}).then(function(h){expect(fs.existsSync(path.join(h,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(h,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-zip"))).to.be(false);expect(fs.existsSync(path.join(h,"package-zip.zip"))).to.be(false);f()}).done()});it("should extract if source is an archive and rename to index if it's only one file inside",function(f){var g;nock("http://bower.io").get("/package-zip-single-file.zip").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip-single-file.zip"));g=b("http://bower.io/package-zip-single-file.zip");g.resolve().then(function(h){expect(fs.existsSync(path.join(h,"index.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-zip"))).to.be(false);expect(fs.existsSync(path.join(h,"package-zip-single-file"))).to.be(false);expect(fs.existsSync(path.join(h,"package-zip-single-file.zip"))).to.be(false);return e(h,"index.js").then(f.bind(f,null))}).done()});it("should extract if source is an archive and not rename to index if inside it's just a just bower.json/component.json file in it",function(f){var g;nock("http://bower.io").get("/package-zip-single-bower-json.zip").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip-single-bower-json.zip")).get("/package-zip-single-component-json.zip").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip-single-component-json.zip"));g=b("http://bower.io/package-zip-single-bower-json.zip");g.resolve().then(function(h){expect(fs.existsSync(path.join(h,"bower.json"))).to.be(true);g=b("http://bower.io/package-zip-single-component-json.zip")}).then(function(){return g.resolve()}).then(function(h){expect(fs.existsSync(path.join(h,"component.json"))).to.be(true);f()}).done()});it("should rename single file from a single folder to index when source is an archive",function(f){var g;nock("http://bower.io").get("/package-zip-folder-single-file.zip").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip-folder-single-file.zip"));g=b("http://bower.io/package-zip-folder-single-file.zip");g.resolve().then(function(h){expect(fs.existsSync(path.join(h,"index.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-zip"))).to.be(false);expect(fs.existsSync(path.join(h,"package-zip-folder-single-file"))).to.be(false);expect(fs.existsSync(path.join(h,"package-zip-folder-single-file.zip"))).to.be(false);return e(h,"index.js").then(f.bind(f,null))}).done()});it("should extract if response content-type is an archive",function(f){var g;nock("http://bower.io").get("/package-zip").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip.zip"),{"Content-Type":"application/zip"}).get("/package-zip2").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip.zip"),{"Content-Type":"application/zip; charset=UTF-8"}).get("/package-zip3").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip.zip"),{"Content-Type":" application/zip ; charset=UTF-8"}).get("/package-zip4").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip.zip"),{"Content-Type":'"application/x-zip"'}).get("/package-tar").replyWithFile(200,path.resolve(__dirname,"../../assets/package-tar.tar.gz"),{"Content-Type":" application/x-tgz ; charset=UTF-8"}).get("/package-tar.tar.gz").replyWithFile(200,path.resolve(__dirname,"../../assets/package-tar.tar.gz"),{"Content-Type":" application/x-tgz ; charset=UTF-8"}).get("/package-tar2.tar.gz").replyWithFile(200,path.resolve(__dirname,"../../assets/package-tar.tar.gz"),{"Content-Type":" application/octet-stream ; charset=UTF-8"});g=b("http://bower.io/package-zip");g.resolve().then(function(h){expect(fs.existsSync(path.join(h,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(h,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-zip"))).to.be(false);expect(fs.existsSync(path.join(h,"package-zip.zip"))).to.be(false);g=b("http://bower.io/package-zip2");return g.resolve()}).then(function(h){expect(fs.existsSync(path.join(h,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(h,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-zip"))).to.be(false);expect(fs.existsSync(path.join(h,"package-zip3.zip"))).to.be(false);g=b("http://bower.io/package-zip3");return g.resolve()}).then(function(h){expect(fs.existsSync(path.join(h,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(h,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-zip"))).to.be(false);expect(fs.existsSync(path.join(h,"package-zip4.zip"))).to.be(false);g=b("http://bower.io/package-zip4");return g.resolve()}).then(function(h){expect(fs.existsSync(path.join(h,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(h,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-tar"))).to.be(false);g=b("http://bower.io/package-tar");return g.resolve()}).then(function(h){expect(fs.existsSync(path.join(h,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(h,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-tar"))).to.be(false);expect(fs.existsSync(path.join(h,"package-tar.tar.gz"))).to.be(false);g=b("http://bower.io/package-tar.tar.gz");return g.resolve()}).then(function(h){expect(fs.existsSync(path.join(h,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(h,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-tar"))).to.be(false);expect(fs.existsSync(path.join(h,"package-tar.tar.gz"))).to.be(false);g=b("http://bower.io/package-tar2.tar.gz");return g.resolve()}).then(function(h){expect(fs.existsSync(path.join(h,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(h,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-tar"))).to.be(false);expect(fs.existsSync(path.join(h,"package-tar.tar.gz"))).to.be(false);f()}).done()});it("should extract if response content-disposition filename is an archive",function(f){var g;nock("http://bower.io").get("/package-zip").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip.zip"),{"Content-Disposition":'attachment; filename="package-zip.zip"'});g=b("http://bower.io/package-zip");g.resolve().then(function(h){expect(fs.existsSync(path.join(h,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(h,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(h,"package-zip"))).to.be(false);expect(fs.existsSync(path.join(h,"package-zip.zip"))).to.be(false);f()}).done()});it("should save the release if there's a E-Tag",function(f){var g;nock("http://bower.io").get("/foo.js").reply(200,"foo contents",{ETag:"686897696a7c876b7e","Last-Modified":"Tue, 15 Nov 2012 12:45:26 GMT"});g=b("http://bower.io/foo.js");g.resolve().then(function(h){e(h,"index.js").then(function(i){expect(i._release).to.equal("e-tag:686897696a");f()})}).done()});it("should allow for query strings in URL",function(f){var g;nock("http://bower.io").get("/foo.js?bar=baz").reply(200,"foo contents");g=b("http://bower.io/foo.js?bar=baz");g.resolve().then(function(h){var i;expect(fs.existsSync(path.join(h,"index.js"))).to.be(true);expect(fs.existsSync(path.join(h,"foo.js"))).to.be(false);expect(fs.existsSync(path.join(h,"foo.js?bar=baz"))).to.be(false);i=fs.readFileSync(path.join(h,"index.js")).toString();expect(i).to.equal("foo contents");e(h,"index.js").then(f.bind(f,null))}).done()});it("should save cache headers",function(f){var g;nock("http://bower.io").get("/foo.js").reply(200,"foo contents",{ETag:"686897696a7c876b7e","Last-Modified":"Tue, 15 Nov 2012 12:45:26 GMT"});g=b("http://bower.io/foo.js");g.resolve().then(function(h){e(h,"index.js").then(function(i){expect(i._cacheHeaders).to.eql({ETag:"686897696a7c876b7e","Last-Modified":"Tue, 15 Nov 2012 12:45:26 GMT"});f()})}).done()});it("should work with redirects",function(g){var f="http://redirecting-url.com";var i="http://bower.io";var h;nock(f).get("/foo.js").reply(302,"",{location:i+"/foo.js"});nock(i).get("/foo.js").reply(200,"foo contents");h=b(f+"/foo.js");h.resolve().then(function(j){var k;expect(fs.existsSync(path.join(j,"index.js"))).to.be(true);expect(fs.existsSync(path.join(j,"foo.js"))).to.be(false);k=fs.readFileSync(path.join(j,"index.js")).toString();expect(k).to.equal("foo contents");e(j,"index.js").then(g.bind(g,null))}).done()});it.skip("it should error out if the status code is not within 200-299");it.skip("should report progress when it takes too long to download");describe("content-disposition validation",function(){function f(i,g){var h;nock("http://bower.io").get("/package-zip").replyWithFile(200,path.resolve(__dirname,"../../assets/package-zip.zip"),{"Content-Disposition":i});h=b("http://bower.io/package-zip");return h.resolve().then(function(j){if(g){expect(fs.existsSync(path.join(j,"foo.js"))).to.be(true);expect(fs.existsSync(path.join(j,"bar.js"))).to.be(true);expect(fs.existsSync(path.join(j,"package-zip"))).to.be(false)}else{expect(fs.existsSync(path.join(j,"foo.js"))).to.be(false);expect(fs.existsSync(path.join(j,"bar.js"))).to.be(false);expect(fs.existsSync(path.join(j,"package-zip"))).to.be(false);expect(fs.existsSync(path.join(j,"index"))).to.be(true)}})}it("should work with and without quotes",function(g){f('attachment; filename="package-zip.zip"',true).then(function(){return f("attachment; filename=package-zip.zip",true)}).then(g.bind(g,null)).done()});it("should not work with partial quotes",function(g){f('attachment; filename="package-zip.zip',false).then(function(){return f('attachment; filename=package-zip.zip"',true)}).then(g.bind(g,null)).done()});it("should not work if the filename contain chars other than alphanumerical, dashes, spaces and dots",function(g){f('attachment; filename="1package01 _-zip.zip"',true).then(function(){return f('attachment; filename="package$%"',false)}).then(function(){return f("attachment; filename=packagé",false)}).then(function(){return f('attachment; filename=1package01 _-zip.zip"',false)}).then(function(){return f('attachment; filename=1package01.zip _-zip.zip"',true)}).then(g.bind(g,null)).done()});it("should trim leading and trailing spaces",function(g){f('attachment; filename=" package.zip "',true).then(g.bind(g,null)).done()});it("should not work if the filename ends with a dot",function(g){f('attachment; filename="package.zip."',false).then(function(){return f('attachment; filename="package.zip. "',false)}).then(function(){return f("attachment; filename=package.zip.",false)}).then(function(){return f('attachment; filename="package.zip ."',false)}).then(function(){return f('attachment; filename="package.zip. "',false)}).then(g.bind(g,null)).done()});it("should be case insensitive",function(g){f('attachment; FILENAME="package.zip"',true).then(function(){return f('attachment; filename="package.ZIP"',true)}).then(function(){return f("attachment; FILENAME=package.zip",true)}).then(function(){return f("attachment; filename=package.ZIP",true)}).then(g.bind(g,null)).done()})})});describe("#isTargetable",function(){it("should return false",function(){expect(UrlResolver.isTargetable()).to.be(false)})})});