var expect=require("expect.js"),object=require("mout").object,helpers=require("../helpers"),commands=helpers.require("lib/index").commands;describe("bower install",function(){var e=new helpers.TempDir,t=new helpers.TempDir({"bower.json":{name:"package"}}).prepare(),n=new helpers.TempDir,r=function(t,n,r){return r=object.merge(r||{},{cwd:e.path}),commands.install(t,n,r)},o=function(e,t,n){var o=r(e,t,n);return helpers.expectEvent(o,"end")};it("writes to bower.json if --save flag is used",function(){return t.prepare(),e.prepare({"bower.json":{name:"test"}}),o([t.path],{save:!0}).then(function(){expect(e.read("bower.json")).to.contain("dependencies")})}),it("reads .bowerrc from cwd",function(){return t.prepare({foo:"bar"}),e.prepare({".bowerrc":{directory:"assets"},"bower.json":{name:"test",dependencies:{"package":t.path}}}),o().then(function(){expect(e.read("assets/package/foo")).to.be("bar")})}),it("runs preinstall hook",function(){return t.prepare(),e.prepare({"bower.json":{name:"test",dependencies:{"package":t.path}},".bowerrc":{scripts:{preinstall:'bash -c "echo -n % > preinstall.txt"'}}}),o().then(function(){expect(e.read("preinstall.txt")).to.be("package")})}),it("runs preinstall hook",function(){return t.prepare(),e.prepare({"bower.json":{name:"test",dependencies:{"package":t.path}},".bowerrc":{scripts:{postinstall:'bash -c "echo -n % > postinstall.txt"'}}}),o().then(function(){expect(e.read("postinstall.txt")).to.be("package")})}),it("does not run hooks if nothing is installed",function(){return e.prepare({"bower.json":{name:"test"},".bowerrc":{scripts:{postinstall:'bash -c "echo -n % > hooks.txt"',preinstall:'bash -c "echo -n % > hooks.txt"'}}}),o().then(function(){expect(e.exists("hooks.txt")).to.be(!1)})}),it("runs postinstall after bower.json is written",function(){return t.prepare(),e.prepare({"bower.json":{name:"test"},".bowerrc":{scripts:{postinstall:'bash -c "cat bower.json > hook.txt"'}}}),o([t.path],{save:!0}).then(function(){expect(e.read("hook.txt")).to.contain("dependencies")})}),it("display the output of hook scripts",function(n){t.prepare(),e.prepare({"bower.json":{name:"test",dependencies:{"package":t.path}},".bowerrc":{scripts:{postinstall:'bash -c "echo foobar"'}}});var o=null;r().intercept(function(e){"action"===e.level&&(o=e)}).on("end",function(){expect(o.message).to.be("foobar"),n()})}),it("works for git repositories",function(){return n.prepareGit({"1.0.0":{"bower.json":{name:"package"},"version.txt":"1.0.0"},"1.0.1":{"bower.json":{name:"package"},"version.txt":"1.0.1"}}).then(function(){return e.prepare({"bower.json":{name:"test",dependencies:{"package":n.path+"#1.0.0"}}}),o().then(function(){expect(e.read("bower_components/package/version.txt")).to.contain("1.0.0")})})})});
