var expect=require("expect.js"),object=require("mout").object,helpers=require("../helpers"),commands=helpers.require("lib/index").commands;describe("bower update",function(){var e=new helpers.TempDir,t=new helpers.TempDir;t.prepareGit({"1.0.0":{"bower.json":{name:"package"},"version.txt":"1.0.0"},"1.0.1":{"bower.json":{name:"package"},"version.txt":"1.0.1"}});var n=new helpers.TempDir({"bower.json":{name:"package"}}).prepare(),a=function(t,n,a){return a=object.merge(a||{},{cwd:e.path}),commands.update(t,n,a)},r=function(e,t,n){var r=a(e,t,n);return helpers.expectEvent(r,"end")},p=function(t,n,a){a=object.merge(a||{},{cwd:e.path});var r=commands.install(t,n,a);return helpers.expectEvent(r,"end")};it("install missing packages",function(){return n.prepare(),e.prepare({"bower.json":{name:"test",dependencies:{"package":n.path}}}),r().then(function(){expect(e.exists("bower_components/package/bower.json")).to.equal(!0),expect(e.read("bower_components/package/bower.json")).to.contain('"name": "package"')})}),it("runs preinstall hook when installing missing package",function(){return n.prepare(),e.prepare({"bower.json":{name:"test",dependencies:{"package":n.path}},".bowerrc":{scripts:{preinstall:'bash -c "echo -n % > preinstall.txt"'}}}),r().then(function(){expect(e.read("preinstall.txt")).to.be("package")})}),it("runs postinstall hook when installing missing package",function(){return n.prepare(),e.prepare({"bower.json":{name:"test",dependencies:{"package":n.path}},".bowerrc":{scripts:{postinstall:'bash -c "echo -n % > postinstall.txt"'}}}),r().then(function(){expect(e.read("postinstall.txt")).to.be("package")})}),it("doesn't runs postinstall when no package is update",function(){return n.prepare(),e.prepare({"bower.json":{name:"test",dependencies:{"package":n.path}},".bowerrc":{scripts:{postinstall:'bash -c "echo -n % > postinstall.txt"'}}}),p().then(function(){return e.prepare(),r().then(function(){expect(e.exists("postinstall.txt")).to.be(!1)})})}),it("updates a package",function(){return e.prepare({"bower.json":{name:"test",dependencies:{"package":t.path+"#1.0.0"}}}),p().then(function(){return expect(e.read("bower_components/package/version.txt")).to.contain("1.0.0"),e.prepare({"bower.json":{name:"test",dependencies:{"package":t.path+"#1.0.1"}}}),r().then(function(){expect(e.read("bower_components/package/version.txt")).to.contain("1.0.1")})})}),it("runs preinstall hook when updating a package",function(){return e.prepare({"bower.json":{name:"test",dependencies:{"package":t.path+"#1.0.0"}},".bowerrc":{scripts:{preinstall:'bash -c "echo -n % > preinstall.txt"'}}}),p().then(function(){return e.prepare({"bower.json":{name:"test",dependencies:{"package":t.path+"#1.0.1"}}}),expect(e.exists("preinstall.txt")).to.be(!1),r().then(function(){expect(e.read("preinstall.txt")).to.be("package")})})}),it("runs postinstall hook when updating a package",function(){return e.prepare({"bower.json":{name:"test",dependencies:{"package":t.path+"#1.0.0"}},".bowerrc":{scripts:{postinstall:'bash -c "echo -n % > postinstall.txt"'}}}),p().then(function(){return e.prepare({"bower.json":{name:"test",dependencies:{"package":t.path+"#1.0.1"}}}),expect(e.exists("postinstall.txt")).to.be(!1),r().then(function(){expect(e.read("postinstall.txt")).to.be("package")})})})});
