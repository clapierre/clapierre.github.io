var fs=require("graceful-fs");var path=require("path");var Q=require("q");var semver=require("semver");var mout=require("mout");var rimraf=require("rimraf");var mkdirp=require("mkdirp");var chalk=require("chalk");var cmd=require("../lib/util/cmd");var packages=require("./packages.json");var nopt=require("nopt");var options=nopt({force:Boolean},{f:"--force"});var env={GIT_AUTHOR_DATE:"Sun Apr 7 22:13:13 2013 +0000",GIT_AUTHOR_NAME:"André Cruz",GIT_AUTHOR_EMAIL:"amdfcruz@gmail.com",GIT_COMMITTER_DATE:"Sun Apr 7 22:13:13 2013 +0000",GIT_COMMITTER_NAME:"André Cruz",GIT_COMMITTER_EMAIL:"amdfcruz@gmail.com"};mout.object.mixIn(env,process.env);function ensurePackage(a){var b;if(options.force){b=Q.nfcall(rimraf,a).then(function(){throw new Error()})}else{b=Q.nfcall(fs.stat,path.join(a,".git"))}return b.fail(function(){return Q.nfcall(mkdirp,a).then(cmd.bind(null,"git",["init"],{cwd:a})).then(function(){return Q.nfcall(fs.writeFile,path.join(a,".master"),"based on master")}).then(cmd.bind(null,"git",["add","-A"],{cwd:a})).then(function(){return cmd("git",["commit",'-m"Initial commit."'],{cwd:a,env:env})}).then(function(){return a})})}function checkRelease(b,a){if(semver.valid(a)){return cmd("git",["tag","-l"],{cwd:b}).spread(function(c){return c.split(/\s*\r*\n\s*/).some(function(d){return semver.clean(d)===a})})}return cmd("git",["branch","--list"],{cwd:b}).spread(function(c){return c.split(/\s*\r*\n\s*/).some(function(d){d=d.trim().replace(/^\*?\s*/,"");return d===a})})}function createRelease(b,a,d){var c=semver.valid(a)?"branch-"+a:a;return cmd("git",["checkout","master","-f"],{cwd:b}).then(function(){return cmd("git",["branch","-D",c],{cwd:b}).fail(function(){})}).then(cmd.bind(null,"git",["checkout","-b",c,"master"],{cwd:b})).then(function(){var f;var e=[];mout.object.forOwn(d,function(h,g){g=path.join(b,g);if(typeof h!=="string"){h=JSON.stringify(h,null,"  ")}f=Q.nfcall(mkdirp,path.dirname(g)).then(function(){return Q.nfcall(fs.writeFile,g,h)});e.push(f)});f=Q.nfcall(fs.unlink,path.join(b,".master"));e.push(f);return Q.all(e)}).then(cmd.bind(null,"git",["add","-A"],{cwd:b})).then(function(){return cmd("git",["commit",'-m"Commit for '+c+'."'],{cwd:b,env:env})}).then(function(){if(!semver.valid(a)){return}return cmd("git",["tag","-f",a],{cwd:b}).then(cmd.bind(null,"git",["checkout","master","-f"],{cwd:b})).then(cmd.bind(null,"git",["branch","-D",c],{cwd:b}))})}var promises=[];mout.object.forOwn(packages,function(c,b){var d;var a=path.join(__dirname,"assets",b);d=ensurePackage(a);d=d.fail(function(e){console.log("Failed to create "+b);console.log(e.message)});mout.object.forOwn(c,function(f,e){d=d.then(checkRelease.bind(null,a,e)).then(function(g){if(g){return console.log(chalk.cyan("> ")+"Package "+b+"#"+e+" already created")}return createRelease(a,e,f).then(function(){console.log(chalk.green("> ")+"Package "+b+"#"+e+" successfully created")})}).fail(function(g){console.log(chalk.red("> ")+"Failed to create "+b+"#"+e);console.log(g.message.trim());if(g.details){console.log(g.details.trim())}console.log(g.stack)})});promises.push(d)});Q.allSettled(promises,function(a){a.forEach(function(b){if(b.state!=="fulfilled"){process.exit(1)}})});