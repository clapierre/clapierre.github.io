var expect=require("expect.js");var proxyquire=require("proxyquire");var object=require("mout").object;describe("analytics",function(){var a=function(b,c){return proxyquire("../../lib/util/analytics",{insight:function(){return object.merge(b||{},{askPermission:function(d,e){e(undefined,c)}})}})};describe("#setup",function(){it("leaves analytics enabled if provided",function(){return a().setup({analytics:true}).then(function(b){expect(b).to.be(true)})});it("leaves analytics disabled if provided",function(){return a().setup({analytics:false}).then(function(b){expect(b).to.be(false)})});it("disables analytics for non-interactive mode",function(){return a().setup({interactive:false}).then(function(b){expect(b).to.be(false)})});it("disables if insight.optOut is true and interactive",function(){return a({optOut:true}).setup({interactive:true}).then(function(b){expect(b).to.be(false)})});it("enables if insight.optOut is false and interactive",function(){return a({optOut:false}).setup({interactive:true}).then(function(b){expect(b).to.be(true)})});it("disables if insight.optOut is false and non-interactive",function(){return a({optOut:false}).setup({interactive:false}).then(function(b){expect(b).to.be(false)})});it("enables if interactive insights return true from prompt",function(){return a({optOut:undefined},true).setup({interactive:true}).then(function(b){expect(b).to.be(true)})});it("disables if interactive insights return false from prompt",function(){return a({optOut:undefined},false).setup({interactive:true}).then(function(b){expect(b).to.be(false)})})});describe("Tracker",function(b){it("tracks if analytics = true",function(d){var c=a({track:function(e){expect(e).to.be("foo");d()}});new c.Tracker({analytics:true}).track("foo")});it("does not track if analytics = false",function(){var c=a({track:function(d){throw new Error()}});expect(function(){new c.Tracker({analytics:false}).track("foo")}).to.not.throwError()});it("tracks if analytics = undefined and setup returns true",function(d){var c=a({track:function(e){expect(e).to.be("foo");d()}});c.setup({analytics:true}).then(function(){new c.Tracker({}).track("foo")})})})});