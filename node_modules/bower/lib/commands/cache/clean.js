var fs=require("graceful-fs");var path=require("path");var mout=require("mout");var Q=require("q");var rimraf=require("rimraf");var endpointParser=require("bower-endpoint-parser");var PackageRepository=require("../../core/PackageRepository");var semver=require("../../util/semver");var cli=require("../../util/cli");var defaultConfig=require("../../config");function clean(d,a,c,b){var e;var f;c=c||{};b=defaultConfig(b);if(a&&!a.length){a=null}if(a){e=a.map(function(g){return endpointParser.decompose(g)});f=e.map(function(g){return g.name||g.source})}return Q.all([clearPackages(e,b,d),clearLinks(f,b,d),!f?clearCompletion(b,d):null]).spread(function(g){return g})}function clearPackages(d,b,a){var c=new PackageRepository(b,a);return c.list().then(function(e){var f;if(d){e=e.filter(function(g){return !!mout.array.find(d,function(i){var h=g.pkgMeta;if(i.name!==h.name&&i.source!==h.name&&i.source!==h._source){return false}if(i.target==="*"){return true}if(semver.validRange(i.target)){return semver.satisfies(h.version,i.target)}return i.target===h._target||i.target===h._release})})}f=e.map(function(g){return c.eliminate(g.pkgMeta).then(function(){a.info("deleted","Cached package "+g.pkgMeta.name+": "+g.canonicalDir,{file:g.canonicalDir})})});return Q.all(f).then(function(){if(!d){return c.clear()}}).then(function(){return e})})}function clearLinks(d,c,b){var e;var a=c.storage.links;if(!d){e=Q.nfcall(fs.readdir,a).fail(function(f){if(f.code==="ENOENT"){return[]}throw f})}else{e=Q.resolve(d)}return e.then(function(h){var g;var f=[];g=h.map(function(i){var j=path.join(c.storage.links,i);return Q.nfcall(fs.readlink,j).then(function(k){return Q.nfcall(fs.stat,k).then(function(l){if(!l.isDirectory()){f.push(j)}}).fail(function(){f.push(j)})},function(k){if(k.code!=="ENOENT"){f.push(j)}})});return Q.all(g).then(function(){var i;i=f.map(function(j){return Q.nfcall(rimraf,j).then(function(){b.info("deleted","Invalid link: "+j,{file:j})})});return Q.all(i)})})}function clearCompletion(c,b){var a=c.storage.completion;return Q.nfcall(fs.stat,a).then(function(){return Q.nfcall(rimraf,a).then(function(){b.info("deleted","Completion cache",{file:a})})},function(d){if(d.code!=="ENOENT"){throw d}})}clean.line=function(d,a){var c=cli.readOptions(a);var b=c.argv.remain.slice(2);return clean(d,b,c)};clean.completion=function(){};module.exports=clean;