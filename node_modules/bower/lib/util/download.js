var progress=require("request-progress");var request=require("request");var Q=require("q");var mout=require("mout");var retry=require("retry");var fs=require("graceful-fs");var createError=require("./createError");var errorCodes=["EADDRINFO","ETIMEDOUT","ECONNRESET","ESOCKETTIMEDOUT"];function download(f,g,e){var d;var c;var b=Q.defer();var a=8000;e=mout.object.mixIn({retries:5,factor:2,minTimeout:1000,maxTimeout:35000,randomize:true},e||{});d=retry.operation(e);d.attempt(function(){var k;var j;var i;var h=0;k=progress(request(f,e),{delay:a}).on("response",function(m){var l=m.statusCode;if(l<200||l>=300){return b.reject(createError("Status code of "+l,"EHTTP"))}c=m;i=Number(m.headers["content-length"])}).on("data",function(l){h+=l.length}).on("progress",function(l){b.notify(l)}).on("end",function(){if(i&&h<i){k.emit("error",createError("Transfer closed with "+(i-h)+" bytes remaining to read","EINCOMPLETE"))}}).on("error",function(l){var m=d._timeouts[0];if(errorCodes.indexOf(l.code)===-1){return b.reject(l)}a=0;if(d.retry(l)){k.removeAllListeners();k.on("error",function(){});j.removeAllListeners();j.on("error",function(){});return b.notify({retry:true,delay:m,error:l})}b.reject(l)});j=k.pipe(fs.createWriteStream(g)).on("error",b.reject).on("close",function(){b.resolve(c)})});return b.promise}module.exports=download;