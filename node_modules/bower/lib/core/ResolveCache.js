function ResolveCache(e){this._config=e,this._dir=this._config.storage.packages,this._lockDir=this._config.storage.packages,mkdirp.sync(this._lockDir),this._cache=this.constructor._cache.get(this._dir),this._cache||(this._cache=new LRU({max:100,maxAge:3e5}),this.constructor._cache.set(this._dir,this._cache)),mkdirp.sync(this._dir)}var fs=require("graceful-fs"),path=require("path"),mout=require("mout"),Q=require("q"),mkdirp=require("mkdirp"),rimraf=require("rimraf"),LRU=require("lru-cache"),lockFile=require("lockfile"),semver=require("../util/semver"),readJson=require("../util/readJson"),copy=require("../util/copy"),md5=require("../util/md5");ResolveCache.prototype.retrieve=function(e,r){var t=md5(e),n=path.join(this._dir,t),i=this;return r=r||"*",this._getVersions(t).spread(function(e){var t;return semver.validRange(r)&&(t=semver.maxSatisfying(e,r,!0))?t:"*"===r?mout.array.find(e,function(e){return"_wildcard"===e}):mout.array.find(e,function(e){return e===r})}).then(function(o){var a;return o?(a=path.join(n,encodeURIComponent(o)),i._readPkgMeta(a).then(function(e){return[a,e]},function(){return i._cache.del(t),Q.nfcall(rimraf,a).then(function(){return i.retrieve(e,r)})})):[]})},ResolveCache.prototype.store=function(e,r){var t,n,i,o,a,c=this;return a=r?Q.resolve(r):this._readPkgMeta(e),a.then(function(r){return t=md5(r._source),n=c._getPkgRelease(r),i=path.join(c._dir,t,n),o=path.join(c._lockDir,t+"-"+n+".lock"),Q.nfcall(fs.stat,i).fail(function(){var r={wait:250,retries:25,stale:6e4};return Q.nfcall(lockFile.lock,o,r).then(function(){return Q.nfcall(fs.stat,i).fail(function(r){if("ENOENT"!==r.code)throw r;return Q.nfcall(mkdirp,path.dirname(i)).then(function(){return Q.nfcall(fs.rename,e,i).fail(function(r){if("EXDEV"!==r.code)throw r;return copy.copyDir(e,i)})})})})["finally"](function(){lockFile.unlockSync(o)})})["finally"](function(){return Q.nfcall(rimraf,e)})}).then(function(){var e=c._cache.get(t);return e&&-1===e.indexOf(n)&&(e.push(n),c._sortVersions(e)),i})},ResolveCache.prototype.eliminate=function(e){var r=md5(e._source),t=this._getPkgRelease(e),n=path.join(this._dir,r,t),i=this;return Q.nfcall(rimraf,n).then(function(){var e=i._cache.get(r)||[];return mout.array.remove(e,t),e.length?void 0:(i._cache.del(r),i._getVersions(r).spread(function(e){return e.length?void 0:(i._cache.del(r),Q.nfcall(rimraf,path.dirname(n)))}))})},ResolveCache.prototype.clear=function(){return Q.nfcall(rimraf,this._dir).then(function(){return Q.nfcall(fs.mkdir,this._dir)}.bind(this)).then(function(){this._cache.reset()}.bind(this))},ResolveCache.prototype.reset=function(){return this._cache.reset(),this},ResolveCache.prototype.versions=function(e){var r=md5(e);return this._getVersions(r).spread(function(e){return e.filter(function(e){return semver.valid(e)})})},ResolveCache.prototype.list=function(){var e,r=[],t=this;return Q.nfcall(fs.readdir,this._dir).then(function(n){return e=n.map(function(e){return Q.nfcall(fs.readdir,path.join(t._dir,e)).then(function(n){n.forEach(function(n){var i=path.join(t._dir,e,n);r.push(i)})},function(e){if("ENOTDIR"===e.code&&e.path)return Q.nfcall(rimraf,e.path);throw e})}),Q.all(e)}).then(function(){return e=r.map(function(e){return t._readPkgMeta(e).then(function(r){return{canonicalDir:e,pkgMeta:r}},function(){var r=path.basename(path.dirname(e));return t._cache.del(r),Q.nfcall(rimraf,e)})}),Q.all(e)}).then(function(e){return e=e.filter(function(e){return!!e}),e.sort(function(e,r){var t=e.pkgMeta,n=r.pkgMeta,i=t.name.localeCompare(n.name);return i?i:t.version&&n.version?semver.compare(t.version,n.version):t.version?-1:n.version?1:t._target.localeCompare(n._target)})})},ResolveCache.clearRuntimeCache=function(){this._cache.forEach(function(e){e.reset()}),this._cache.reset()},ResolveCache.prototype._getPkgRelease=function(e){var r=e.version||("*"===e._target?"_wildcard":e._target);return r=encodeURIComponent(r)},ResolveCache.prototype._readPkgMeta=function(e){var r=path.join(e,".bower.json");return readJson(r).spread(function(e){return e})},ResolveCache.prototype._getVersions=function(e){var r,t=this._cache.get(e),n=this;return t?Q.resolve([t,!0]):(r=path.join(this._dir,e),Q.nfcall(fs.readdir,r).then(function(r){return n._sortVersions(r),r=r.map(decodeURIComponent),n._cache.set(e,r),[r,!1]},function(r){if("ENOENT"===r.code)return t=[],n._cache.set(e,t),[t,!1];throw r}))},ResolveCache.prototype._sortVersions=function(e){e.sort(function(e,r){var t=semver.valid(e),n=semver.valid(r);return t&&n?semver.rcompare(e,r):t?-1:n?1:0})},ResolveCache._cache=new LRU({max:5,maxAge:18e5}),module.exports=ResolveCache;
