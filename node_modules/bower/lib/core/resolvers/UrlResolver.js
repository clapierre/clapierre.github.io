var util=require("util");var path=require("path");var fs=require("graceful-fs");var url=require("url");var request=require("request");var Q=require("q");var mout=require("mout");var junk=require("junk");var Resolver=require("./Resolver");var download=require("../../util/download");var extract=require("../../util/extract");var createError=require("../../util/createError");function UrlResolver(c,b,a){Resolver.call(this,c,b,a);if(this._target!=="*"){throw createError("URL sources can't resolve targets","ENORESTARGET")}if(this._guessedName){this._name=this._name.replace(/\?.*$/,"");this._name=this._name.substr(0,this._name.length-path.extname(this._name).length)}this._remote=url.parse(this._source)}util.inherits(UrlResolver,Resolver);mout.object.mixIn(UrlResolver,Resolver);UrlResolver.isTargetable=function(){return false};UrlResolver.prototype._hasNew=function(a,c){var b=c._cacheHeaders||{};var d={};if(b.ETag){d["If-None-Match"]=b.ETag}if(this._config.userAgent){d["User-Agent"]=this._config.userAgent}return Q.nfcall(request.head,this._source,{proxy:this._remote.protocol==="https:"?this._config.httpsProxy:this._config.proxy,strictSSL:this._config.strictSsl,timeout:this._config.timeout,headers:d}).spread(function(e){var f;if(e.statusCode===304){return false}if(e.statusCode<200||e.statusCode>=300){return true}f=this._collectCacheHeaders(e);return !mout.object.equals(b,f)}.bind(this),function(){return true})};UrlResolver.prototype._resolve=function(){return this._download().spread(this._parseHeaders.bind(this)).spread(this._extract.bind(this)).then(this._rename.bind(this))};UrlResolver.prototype._download=function(){var d=url.parse(path.basename(this._source)).pathname;var a=path.join(this._tempDir,d);var c={};var b=this;if(this._config.userAgent){c["User-Agent"]=this._config.userAgent}this._logger.action("download",b._source,{url:b._source,to:a});return download(this._source,a,{proxy:this._remote.protocol==="https:"?this._config.httpsProxy:this._config.proxy,strictSSL:this._config.strictSsl,timeout:this._config.timeout,headers:c}).progress(function(e){var f;if(e.retry){f="Download of "+b._source+" failed"+(e.error.code?" with "+e.error.code:"")+", ";f+="retrying in "+(e.delay/1000).toFixed(1)+"s";b._logger.debug("error",e.error.message,{error:e.error});return b._logger.warn("retry",f)}f="received "+(e.received/1024/1024).toFixed(1)+"MB";if(e.total){f+=" of "+(e.total/1024/1024).toFixed(1)+"MB downloaded, ";f+=e.percent+"%"}b._logger.info("progress",f)}).then(function(e){b._response=e;return[a,e]})};UrlResolver.prototype._parseHeaders=function(d,b){var e;var a;var c;e=b.headers["content-disposition"];if(!e){return Q.resolve([d,b])}c=e.match(/filename=(?:"([\w\-\. ]+)")/i);if(!c){c=e.match(/filename=([\w\-\.]+)/i);if(!c){return Q.resolve([d,b])}}a=c[1].trim();if(mout.string.endsWith(a,".")){return Q.resolve([d,b])}a=path.join(this._tempDir,a);return Q.nfcall(fs.rename,d,a).then(function(){return[a,b]})};UrlResolver.prototype._extract=function(b,a){var c=a.headers["content-type"];if(c){c=c.split(";")[0].trim();c=mout.string.trim(c,['"',"'"])}if(!extract.canExtract(b,c)){return Q.resolve()}this._logger.action("extract",path.basename(this._source),{archive:b,to:this._tempDir});return extract(b,this._tempDir,{mimeType:c})};UrlResolver.prototype._rename=function(){return Q.nfcall(fs.readdir,this._tempDir).then(function(c){var a;var d;var b;c=c.filter(junk.isnt);if(c.length===1&&!/^(component|bower)\.json$/.test(c[0])){a=c[0];this._singleFile="index"+path.extname(a);d=path.join(this._tempDir,a);b=path.join(this._tempDir,this._singleFile);return Q.nfcall(fs.rename,d,b)}}.bind(this))};UrlResolver.prototype._savePkgMeta=function(a){a._cacheHeaders=this._collectCacheHeaders(this._response);if(a._cacheHeaders.ETag){a._release="e-tag:"+mout.string.trim(a._cacheHeaders.ETag.substr(0,10),'"')}if(this._singleFile){a.main=this._singleFile}return Resolver.prototype._savePkgMeta.call(this,a)};UrlResolver.prototype._collectCacheHeaders=function(a){var b={};this.constructor._cacheHeaders.forEach(function(c){var d=a.headers[c.toLowerCase()];if(d!=null){b[c]=d}});return b};UrlResolver._cacheHeaders=["Content-MD5","ETag","Last-Modified","Content-Language","Content-Length","Content-Type","Content-Disposition"];module.exports=UrlResolver;