var fs=require("graceful-fs");var path=require("path");var Q=require("q");var tmp=require("tmp");var mkdirp=require("mkdirp");var rimraf=require("rimraf");var readJson=require("../../util/readJson");var createError=require("../../util/createError");var removeIgnores=require("../../util/removeIgnores");tmp.setGracefulCleanup();function Resolver(c,b,a){this._source=c.source;this._target=c.target||"*";this._name=c.name||path.basename(this._source);this._config=b;this._logger=a;this._guessedName=!c.name}Resolver.prototype.getSource=function(){return this._source};Resolver.prototype.getName=function(){return this._name};Resolver.prototype.getTarget=function(){return this._target};Resolver.prototype.getTempDir=function(){return this._tempDir};Resolver.prototype.getPkgMeta=function(){return this._pkgMeta};Resolver.prototype.hasNew=function(a,e){var d;var c;var b=this;if(this._working){return Q.reject(createError("Already working","EWORKING"))}this._working=true;if(e){d=this._hasNew(a,e)}else{c=path.join(a,".bower.json");d=readJson(c).spread(function(f){return b._hasNew(a,f)},function(f){b._logger.debug("read-json","Failed to read "+c,{filename:c,error:f});return true})}return d.fin(function(){b._working=false})};Resolver.prototype.resolve=function(){var a=this;if(this._working){return Q.reject(createError("Already working","EWORKING"))}this._working=true;return this._createTempDir().then(this._resolve.bind(this)).then(this._readJson.bind(this,null)).then(function(b){return a._applyPkgMeta(b).then(a._savePkgMeta.bind(a,b))}).then(function(){return a._tempDir},function(b){a._tempDir=null;throw b}).fin(function(){a._working=false})};Resolver.prototype.isCacheable=function(){if(this._source&&/^(?:file:[\/\\]{2}|[A-Z]:)?\.?\.?[\/\\]/.test(this._source)){return false}if(this._pkgMeta&&this._pkgMeta._resolution&&this._pkgMeta._resolution.type==="branch"){return false}return true};Resolver.prototype._resolve=function(){throw new Error("_resolve not implemented")};Resolver.prototype._hasNew=function(a,b){return Q.resolve(true)};Resolver.isTargetable=function(){return true};Resolver.versions=function(a){return Q.resolve([])};Resolver.clearRuntimeCache=function(){};Resolver.prototype._createTempDir=function(){return Q.nfcall(mkdirp,this._config.tmp).then(function(){return Q.nfcall(tmp.dir,{template:path.join(this._config.tmp,this._name+"-"+process.pid+"-XXXXXX"),mode:511&~process.umask(),unsafeCleanup:true})}.bind(this)).then(function(a){return this._tempDir=Array.isArray(a)?a[0]:a}.bind(this))};Resolver.prototype._cleanTempDir=function(){var a=this._tempDir;if(!a){return Q.resolve()}return Q.nfcall(rimraf,a).then(function(){return Q.nfcall(mkdirp,a,511&~process.umask())}).then(function(){return a})};Resolver.prototype._readJson=function(a){var b=this;a=a||this._tempDir;return readJson(a,{assume:{name:this._name}}).spread(function(d,c){if(c){b._logger.warn("deprecated","Package "+b._name+" is using the deprecated "+c)}return d})};Resolver.prototype._applyPkgMeta=function(a){if(a.name!==this._name&&this._guessedName){this._name=a.name}if(!a.ignore||!a.ignore.length){return Q.resolve(a)}return removeIgnores(this._tempDir,a).then(function(){return a})};Resolver.prototype._savePkgMeta=function(c){var b=this;var a;c._source=this._source;c._target=this._target;["main","ignore"].forEach(function(d){if(c[d]){return}b._logger.log("warn","invalid-meta",(c.name||"component")+' is missing "'+d+'" entry in bower.json')});a=JSON.stringify(c,null,2);return Q.nfcall(fs.writeFile,path.join(this._tempDir,".bower.json"),a).then(function(){return b._pkgMeta=c})};module.exports=Resolver;