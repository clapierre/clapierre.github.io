var util=require("util");var url=require("url");var Q=require("q");var mout=require("mout");var LRU=require("lru-cache");var GitResolver=require("./GitResolver");var cmd=require("../../util/cmd");function GitRemoteResolver(c,b,a){GitResolver.call(this,c,b,a);if(!mout.string.startsWith(this._source,"file://")){this._source=this._source.replace(/\/+$/,"")}if(this._guessedName&&mout.string.endsWith(this._name,".git")){this._name=this._name.slice(0,-4)}if(!/:\/\//.test(this._source)){this._host=url.parse("ssh://"+this._source).host}else{this._host=url.parse(this._source).host}this._shallowClone=false}util.inherits(GitRemoteResolver,GitResolver);mout.object.mixIn(GitRemoteResolver,GitResolver);GitRemoteResolver.prototype._checkout=function(){var d;var e;var a;var c=this;var b=this._resolution;this._logger.action("checkout",b.tag||b.branch||b.commit,{resolution:b,to:this._tempDir});if(b.type==="commit"){d=this._slowClone(b)}else{d=this._fastClone(b)}a=mout.fn.throttle(function(g){var f;f=g.split(/[\r\n]+/);f.forEach(function(h){if(/\d{1,3}\%/.test(h)){c._logger.info("progress",h.trim())}})},1000);e=setTimeout(function(){d.progress(a)},8000);return d.fail(function(f){c._suggestProxyWorkaround(f);throw f}).fin(function(){clearTimeout(e);a.cancel()})};GitRemoteResolver.prototype._findResolution=function(b){var a=this;return GitResolver.prototype._findResolution.call(this,b).fail(function(c){a._suggestProxyWorkaround(c);throw c})};GitRemoteResolver.prototype._slowClone=function(a){return cmd("git",["clone",this._source,this._tempDir,"--progress"]).then(cmd.bind(cmd,"git",["checkout",a.commit],{cwd:this._tempDir}))};GitRemoteResolver.prototype._fastClone=function(b){var c,a,d=this;c=b.tag||b.branch;a=["clone",this._source,"-b",c,"--progress","."];if(this._shallowClone&&!GitRemoteResolver._noShallow.get(this._host)){a.push("--depth",1)}return cmd("git",a,{cwd:this._tempDir}).spread(function(e,f){if(!/branch .+? not found/i.test(f)){return}d._logger.warn("old-git","It seems you are using an old version of git, it will be slower and propitious to errors!");return cmd("git",["checkout",b.commit],{cwd:d._tempDir})},function(e){if(!GitRemoteResolver._noShallow.has(d._source)&&e.details&&/(rpc failed|shallow|--depth)/i.test(e.details)){GitRemoteResolver._noShallow.set(d._host,true);return d._fastClone(b)}throw e})};GitRemoteResolver.prototype._suggestProxyWorkaround=function(a){if((this._config.proxy||this._config.httpsProxy)&&mout.string.startsWith(this._source,"git://")&&a.code==="ECMDERR"&&a.details){a.details=a.details.trim();a.details+="\n\nWhen under a proxy, you must configure git to use https:// instead of git://.";a.details+="\nYou can configure it for every endpoint or for this specific host as follows:";a.details+='\ngit config --global url."https://".insteadOf git://';a.details+='\ngit config --global url."https://'+this._host+'".insteadOf git://'+this._host;a.details+="Ignore this suggestion if you already have this configured."}};GitRemoteResolver.refs=function(b){var a;a=this._cache.refs.get(b);if(a){return Q.resolve(a)}a=cmd("git",["ls-remote","--tags","--heads",b]).spread(function(c){var d;d=c.toString().trim().replace(/[\t ]+/g," ").split(/[\r\n]+/);this._cache.refs.set(b,d);return d}.bind(this));this._cache.refs.set(b,a);return a};GitRemoteResolver._noShallow=new LRU({max:50,maxAge:5*60*1000});module.exports=GitRemoteResolver;