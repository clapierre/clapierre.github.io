var Q=require("q");var mout=require("mout");var path=require("path");var mkdirp=require("mkdirp");var rimraf=require("rimraf");var fs=require("graceful-fs");var endpointParser=require("bower-endpoint-parser");var PackageRepository=require("./PackageRepository");var semver=require("../util/semver");var copy=require("../util/copy");var createError=require("../util/createError");var scripts=require("./scripts");function Manager(b,a){this._config=b;this._logger=a;this._repository=new PackageRepository(this._config,this._logger);this.configure({})}Manager.prototype.configure=function(a){var b={};this._conflicted={};this._targets=a.targets||[];this._targets.forEach(function(c){c.initialName=c.name;c.dependants=mout.object.values(c.dependants);b[c.name]=true;c.unresolvable=!!c.newly});this._resolved={};this._installed={};mout.object.forOwn(a.resolved,function(d,c){d.dependants=mout.object.values(d.dependants);this._resolved[c]=[d];this._installed[c]=d.pkgMeta},this);mout.object.mixIn(this._installed,a.installed);this._incompatibles={};a.incompatibles=this._uniquify(a.incompatibles||[]);a.incompatibles.forEach(function(d){var c=d.name;this._incompatibles[c]=this._incompatibles[c]||[];this._incompatibles[c].push(d);d.dependants=mout.object.values(d.dependants);this._conflicted[c]=true;if(!b[c]&&!this._resolved[c]){this._targets.push(d)}},this);this._resolutions=a.resolutions||{};this._targets=this._uniquify(this._targets);this._forceLatest=!!a.forceLatest;return this};Manager.prototype.resolve=function(){if(this._working){return Q.reject(createError("Already working","EWORKING"))}this._fetching={};this._nrFetching=0;this._failed={};this._hasFailed=false;this._deferred=Q.defer();if(!this._targets.length){process.nextTick(this._dissect.bind(this))}else{this._targets.forEach(this._fetch.bind(this))}return this._deferred.promise.fin(function(){this._working=false}.bind(this))};Manager.prototype.preinstall=function(a){var b=this;var c=path.join(this._config.cwd,this._config.directory);if(mout.lang.isEmpty(b._dissected)){return Q.resolve({})}return Q.nfcall(mkdirp,c).then(function(){return scripts.preinstall(b._config,b._logger,b._dissected,b._installed,a)})};Manager.prototype.postinstall=function(a){var b=this;var c=path.join(this._config.cwd,this._config.directory);if(mout.lang.isEmpty(b._dissected)){return Q.resolve({})}return Q.nfcall(mkdirp,c).then(function(){return scripts.postinstall(b._config,b._logger,b._dissected,b._installed,a)})};Manager.prototype.install=function(a){var c;var b=this;if(this._working){return Q.reject(createError("Already working","EWORKING"))}if(mout.lang.isEmpty(b._dissected)){return Q.resolve({})}c=path.join(this._config.cwd,this._config.directory);return Q.nfcall(mkdirp,c).then(function(){var d=[];mout.object.forOwn(b._dissected,function(g,f){var h;var i;var e=g.pkgMeta._release;b._logger.action("install",f+(e?"#"+e:""),b.toData(g));i=path.join(c,f);h=Q.nfcall(rimraf,i).then(copy.copyDir.bind(copy,g.canonicalDir,i)).then(function(){var j=path.join(i,".bower.json");g.canonicalDir=i;return Q.nfcall(fs.readFile,j).then(function(l){var k=JSON.parse(l.toString());k._target=g.target;k._originalSource=g.source;if(g.newly){k._direct=true}k=JSON.stringify(k,null,"  ");return Q.nfcall(fs.writeFile,j,k)})});d.push(h)});return Q.all(d)}).then(function(){mout.object.forOwn(b._dissected,function(d){mout.object.forOwn(d.dependencies,function(f,e){var g=this._dissected[e]||(this._resolved[e]?this._resolved[e][0]:f);d.dependencies[e]=g},this);d.dependants=d.dependants.map(function(g){var e=g.name;var f=this._dissected[e]||(this._resolved[e]?this._resolved[e][0]:g);return f},this)},b);return mout.object.map(b._dissected,function(d){return this.toData(d)},b)}).fin(function(){this._working=false}.bind(this))};Manager.prototype.toData=function(d,b,c){var f;var a;var e={};c=c||[];e.endpoint=mout.object.pick(d,["name","source","target"]);if(d.canonicalDir){e.canonicalDir=d.canonicalDir;e.pkgMeta=d.pkgMeta}if(b){a=mout.object.pick(d,b);a=mout.object.filter(a,function(g){return !!g});mout.object.mixIn(e,a)}if(d.dependencies){e.dependencies={};f=Object.keys(d.dependencies).sort();f.forEach(function(g){if(!mout.array.contains(c,g)){e.dependencies[g]=this.toData(d.dependencies[g],b,c.concat(d.name))}},this)}e.nrDependants=mout.object.size(d.dependants);return e};Manager.prototype.getPackageRepository=function(){return this._repository};Manager.prototype._fetch=function(b){var a=b.name;if(this._hasFailed){return}this._fetching[a]=this._fetching[a]||[];this._fetching[a].push(b);this._nrFetching++;return b.promise=this._repository.fetch(b).spread(this._onFetchSuccess.bind(this,b)).fail(this._onFetchError.bind(this,b))};Manager.prototype._onFetchSuccess=function(j,g,h,f){var b;var i;var e;var d;var a=j.initialName!=null?j.initialName:j.name;var c=this._fetching[a];mout.array.remove(c,j);this._nrFetching--;j.name=b=j.name||h.name;j.canonicalDir=g;j.pkgMeta=h;delete j.promise;i=this._resolved[b]=this._resolved[b]||[];e=mout.array.findIndex(i,function(k){return k.target===j.target});if(e!==-1){j.dependants.push.apply(j.dependants,i[e.dependants]);j.dependants=this._uniquify(j.dependants);i.splice(e,1)}i.push(j);this._parseDependencies(j,h,"dependencies");d=this._incompatibles[b];if(d){d=d.filter(function(k){return !i.some(function(l){return k.target===l.target})},this);d=d.filter(function(k){return !c.some(function(l){return k.target===l.target})},this);d.forEach(this._fetch.bind(this));delete this._incompatibles[b]}if(!f){j.untargetable=true}if(this._nrFetching<=0){process.nextTick(this._dissect.bind(this))}};Manager.prototype._onFetchError=function(c,b){var a=c.name;b.data=b.data||{};b.data.endpoint=mout.object.pick(c,["name","source","target"]);mout.array.remove(this._fetching[a],c);this._nrFetching--;this._failed[a]=this._failed[a]||[];this._failed[a].push(b);delete c.promise;this._failFast();if(this._nrFetching<=0){process.nextTick(this._dissect.bind(this))}};Manager.prototype._failFast=function(){if(this._hasFailed){return}this._hasFailed=true;this._failFastTimeout=setTimeout(function(){this._nrFetching=Infinity;this._dissect()}.bind(this),20000)};Manager.prototype._parseDependencies=function(b,d,a){var c=[];b.dependencies=b.dependencies||{};mout.object.forOwn(d[a],function(j,h){var e;var g;var f;var i=endpointParser.json2decomposed(h,j);e=this._resolved[h];if(e){f=mout.array.find(e,function(k){return i.target===k.target},this);if(f){b.dependencies[h]=f;f.dependants.push(b);f.dependants=this._uniquify(f.dependants);return}f=mout.array.find(e,function(k){return this._areCompatible(i,k)},this);if(f){b.dependencies[h]=f;i.canonicalDir=f.canonicalDir;i.pkgMeta=f.pkgMeta;i.dependencies=f.dependencies;i.dependants=[b];this._resolved[h].push(i);return}}g=this._fetching[h];if(g){f=mout.array.find(g,function(k){return this._areCompatible(i,k)},this);if(f){c.push(f.promise);return}}i.unresolvable=!!b.unresolvable;b.dependencies[h]=i;i.dependants=[b];this._fetch(i)},this);if(c.length>0){Q.all(c).then(function(){this._parseDependencies(b,d,a)}.bind(this))}};Manager.prototype._dissect=function(){var c;var d;var e=Q.resolve();var a={};var b=this;if(this._hasFailed){clearTimeout(this._failFastTimeout);c=mout.object.values(this._failed)[0][0];this._deferred.reject(c);return}mout.object.forOwn(this._resolved,function(h,g){var f;var i;f=h.filter(function(j){return !!j.pkgMeta.version});f.sort(function(l,k){var j=semver.rcompare(l.pkgMeta.version,k.pkgMeta.version);if(!j){if(l.target==="*"){return 1}if(k.target==="*"){return -1}}return j});f.forEach(function(j){if(j.newly&&j.target==="*"&&!j.untargetable){j.target="~"+j.pkgMeta.version;j.originalTarget="*"}});i=h.filter(function(j){return !j.pkgMeta.version});e=e.then(function(){return b._electSuitable(g,f,i).then(function(j){a[g]=j})})},this);e.then(function(){mout.object.forOwn(this._resolutions,function(g,f){if(this._conflicted[f]){return}this._logger.warn("extra-resolution","Unnecessary resolution: "+f+"#"+g,{name:f,resolution:g,action:"delete"})},this);d=path.resolve(b._config.cwd,b._config.directory);this._dissected=mout.object.filter(a,function(g,f){var h=this._installed[f];var i;if(g.linked){return false}i=path.join(d,f);if(i===g.canonicalDir){return false}if(h&&h._target===g.target&&h._originalSource===g.source&&h._release===g.pkgMeta._release){return this._config.force}return true},this)}.bind(this)).then(this._deferred.resolve,this._deferred.reject)};Manager.prototype._electSuitable=function(b,e,g){var a;var d;var i;var f;var h;var j;var c=[];if(e.length&&g.length){c.push.apply(c,e);c.push.apply(c,g)}else{if(g.length){if(g.length===1){return Q.resolve(g[0])}c.push.apply(c,g)}else{a=mout.array.find(e,function(k){return e.every(function(l){return k===l||semver.satisfies(k.pkgMeta.version,l.target)})});if(a){return Q.resolve(a)}c.push.apply(c,e)}}this._conflicted[b]=true;c.sort(function(n,m){var k=n.pkgMeta.version;var o=m.pkgMeta.version;var l;if(k&&o){l=semver.compare(k,o);if(l){return l}}else{if(k){return 1}if(o){return -1}}if(n.dependants.length>m.dependants.length){return -1}if(n.dependants.length<m.dependants.length){return 1}return 0});f=c.map(function(l){var k=this.toData(l);k.dependants=l.dependants.map(this.toData,this);k.dependants.sort(function(m,n){return m.endpoint.name.localeCompare(n.endpoint.name)});return k},this);d=this._resolutions[b];i=mout.object.find(c,function(k){return k.unresolvable});if(d&&!i){a=-1;if(semver.validRange(d)){a=mout.array.findIndex(c,function(k){return k.pkgMeta.version&&semver.satisfies(k.pkgMeta.version,d)})}if(a===-1){a=mout.array.findIndex(c,function(k){return k.target===d||k.pkgMeta._release===d})}if(a===-1){this._logger.warn("resolution","Unsuitable resolution declared for "+b+": "+d,{name:b,picks:f,resolution:d})}else{this._logger.conflict("solved","Unable to find suitable version for "+b,{name:b,picks:f,resolution:d,suitable:f[a]});return Q.resolve(c[a])}}if(this._forceLatest){a=c.length-1;this._logger.conflict("solved","Unable to find suitable version for "+b,{name:b,picks:f,suitable:f[a],forced:true});this._storeResolution(c[a]);return Q.resolve(c[a])}if(!this._config.interactive){throw createError("Unable to find suitable version for "+b,"ECONFLICT",{name:b,picks:f})}this._logger.conflict("incompatible","Unable to find suitable version for "+b,{name:b,picks:f});j=c.map(function(l,k){return k+1});return Q.nfcall(this._logger.prompt.bind(this._logger),{type:"input",message:"Answer:",validate:function(k){k=Number(mout.string.trim(k.trim(),"!"));if(!k||k<1||k>c.length){return"Invalid choice"}return true}}).then(function(k){var l;k=k.trim();h=/^!/.test(k)||/!$/.test(k);k=Number(mout.string.trim(k,"!"));l=c[k-1];if(h){this._storeResolution(l)}return l}.bind(this))};Manager.prototype._storeResolution=function(c){var b;var a=c.name;if(c.target==="*"){b=c.pkgMeta._release||"*"}else{b=c.target}this._logger.info("resolution","Saved "+a+"#"+b+" as resolution",{name:a,resolution:b,action:this._resolutions[a]?"edit":"add"});this._resolutions[a]=b};Manager.prototype._areCompatible=function(i,g){var h;var f;var a;var e=semver.validRange(i.target);var d=semver.validRange(g.target);var b=semver.valid(i.target);var c=semver.valid(g.target);if(i.target===g.target){return true}h=g.pkgMeta&&g.pkgMeta.version;if(!h){if(b&&d){return semver.satisfies(i.target,g.target)}if(c&&e){return semver.satisfies(g.target,i.target)}if(c&&b){return semver.eq(g.target,i.target)}if(d&&e){f=this._getCap(semver.toComparators(i.target),"highest");a=this._getCap(semver.toComparators(g.target),"highest");if(!a.version||!f.version){return false}return semver.eq(f.version,a.version)&&f.comparator===a.comparator}return false}if(b){return semver.eq(i.target,h)}if(e){return semver.satisfies(h,i.target)}return false};Manager.prototype._getCap=function(c,b){var f;var d;var a={};var e=b==="lowest"?semver.lt:semver.gt;c.forEach(function(g){if(Array.isArray(g)){d=this._getCap(g,b);if(!a.version||e(d.version,a.version)){a=d}}else{f=g.match(/(.*?)(\d+\.\d+\.\d+.*)$/);if(!f){return}if(!a.version||e(f[2],a.version)){a.version=f[2];a.comparator=f[1]}}},this);return a};Manager.prototype._uniquify=function(a){var b=a.length;return a.filter(function(e,d){var c;var f;for(c=d+1;c<b;++c){f=a[c];if(f===e){return false}if(!f.name&&!e.name){if(f.source!==e.source){continue}}else{if(f.name!==e.name){continue}}if(f.target===e.target){return false}}return true})};module.exports=Manager;