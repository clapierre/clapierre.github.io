"use strict";function Insight(e){if(e=e||{},!e.trackingCode||!e.packageName)throw new Error("Must provide trackingCode and packageName");this.trackingCode=e.trackingCode,this.trackingProvider=e.trackingProvider||"google",this.packageName=e.packageName,this.packageVersion=e.packageVersion||"undefined",this.os=osName(),this.nodeVersion=process.version,this.appVersion=e.packageVersion,this.config=e.config||new Configstore("insight-"+this.packageName,{clientId:e.clientId||Math.floor(Date.now()*Math.random())}),this._queue={}}var path=require("path"),osName=require("os-name"),fork=require("child_process").fork,Configstore=require("configstore"),chalk=require("chalk"),assign=require("object-assign"),debounce=require("lodash.debounce"),inquirer=require("inquirer"),providers=require("./providers");Object.defineProperty(Insight.prototype,"optOut",{get:function(){return this.config.get("optOut")},set:function(e){this.config.set("optOut",e)}}),Object.defineProperty(Insight.prototype,"clientId",{get:function(){return this.config.get("clientId")},set:function(e){this.config.set("clientId",e)}}),Insight.prototype._save=debounce(function(){var e=fork(path.join(__dirname,"push.js"));e.send(this._getPayload()),e.unref(),e.disconnect(),this._queue={}},100),Insight.prototype._getPayload=function(){return{queue:assign({},this._queue),packageName:this.packageName,packageVersion:this.packageVersion,trackingCode:this.trackingCode,trackingProvider:this.trackingProvider}},Insight.prototype._getRequestObj=function(){return providers[this.trackingProvider].apply(this,arguments)},Insight.prototype.track=function(){if(!this.optOut){var e="/"+[].map.call(arguments,function(e){return String(e).trim().replace(/ /,"-")}).join("/");this._queue[Date.now()+" "+e]=e,this._save()}},Insight.prototype.askPermission=function(e,t){var i="May "+chalk.cyan(this.packageName)+" anonymously report usage statistics to improve the tool over time?";return t=t||function(){},process.stdout.isTTY?void inquirer.prompt({type:"confirm",name:"optIn",message:e||i,"default":!0},function(e){this.optOut=!e.optIn,t(null,e.optIn)}.bind(this)):void setImmediate(t,null,!1)},module.exports=Insight;
