var RegistryClient=require("../Client"),fs=require("fs"),expect=require("expect.js"),md5=require("../lib/util/md5"),nock=require("nock"),http=require("http");describe("RegistryClient",function(){beforeEach(function(){this.uri="https://bower.herokuapp.com",this.timeoutVal=5e3,this.registry=new RegistryClient({strictSsl:!1,timeout:this.timeoutVal}),this.conf={search:[this.uri],register:this.uri,publish:this.uri}}),describe("Constructor",function(){describe("instantiating a client",function(){it("should provide an instance of RegistryClient",function(){expect(this.registry instanceof RegistryClient).to.be.ok}),it("should set default registry config",function(){expect(this.registry._config.registry).to.eql(this.conf)}),it("should set default search config",function(){expect(this.registry._config.registry.search[0]).to.eql(this.uri)}),it("should set default register config",function(){expect(this.registry._config.registry.register).to.eql(this.uri)}),it("should set default publish config",function(){expect(this.registry._config.registry.publish).to.eql(this.uri)}),it("should set default cache path config",function(){expect("string"==typeof this.registry._config.cache).to.be.ok}),it("should set default timeout config",function(){expect(this.registry._config.timeout).to.eql(this.timeoutVal)}),it("should set default strictSsl config",function(){expect(this.registry._config.strictSsl).to.be(!1)})}),it("should have a lookup prototype method",function(){expect(RegistryClient.prototype).to.have.property("lookup")}),it("should have a search prototype method",function(){expect(RegistryClient.prototype).to.have.property("search")}),it("should have a list prototype method",function(){expect(RegistryClient.prototype).to.have.property("list")}),it("should have a register prototype method",function(){expect(RegistryClient.prototype).to.have.property("register")}),it("should have a clearCache prototype method",function(){expect(RegistryClient.prototype).to.have.property("clearCache")}),it("should have a resetCache prototype method",function(){expect(RegistryClient.prototype).to.have.property("resetCache")}),it("should have a clearRuntimeCache static method",function(){expect(RegistryClient).to.have.property("clearRuntimeCache")})}),describe("instantiating a client with custom options",function(){describe("offline",function(){it("should not return search results if cache is empty",function(t){this.registry.clearCache(function(){this.registry._config.offline=!0,this.registry.search("jquery",function(e,r){expect(e).to.be(null),expect(r.length).to.eql(0),t()})}.bind(this))})}),describe("cache",function(){beforeEach(function(){nock("https://bower.herokuapp.com:443").get("/packages/search/jquery").replyWithFile(200,__dirname+"/fixtures/search.json"),this.client=new RegistryClient({cache:__dirname+"/cache",strictSsl:!1}),this.cacheDir=this.client._config.cache,this.host="bower.herokuapp.com",this.method="search",this.pkg="jquery",this.path=this.cacheDir+"/"+this.host+"/"+this.method+"/"+this.pkg+"_"+md5(this.pkg).substr(0,5)}),afterEach(function(t){this.client.clearCache(t)}),it("should fill cache",function(t){var e=this;e.client.search(e.pkg,function(r,i){expect(r).to.be(null),expect(i.length).to.eql(334),fs.exists(e.path,function(e){expect(e).to.be(!0),t()})})}),it("should read results from cache",function(t){var e=this;e.client.search(e.pkg,function(r,i){expect(r).to.be(null),expect(i.length).to.eql(334),fs.exists(e.path,function(e){expect(e).to.be(!0),t()})})})})}),describe("calling the lookup instance method with argument",function(){beforeEach(function(){nock("https://bower.herokuapp.com:443").get("/packages/jquery").reply(200,{name:"jquery",url:"git://github.com/components/jquery.git"}),this.registry._config.force=!0}),it("should not return an error",function(t){this.registry.lookup("jquery",function(e){expect(e).to.be(null),t()})}),it("should return entry type",function(t){this.registry.lookup("jquery",function(e,r){expect(e).to.be(null),expect(r.type).to.eql("alias"),t()})}),it("should return entry url ",function(t){this.registry.lookup("jquery",function(t,e){expect(t).to.be(null),expect(e.url).to.eql("git://github.com/components/jquery.git")}),t()})}),describe("calling the lookup instance method without argument",function(){it("should return no result",function(t){this.timeout(1e4),this.registry.lookup("",function(e,r){expect(e).to.not.be.ok(),expect(r).to.not.be.ok(),t()})})}),describe("calling the lookup instance method with two registries, and the first missing.",function(){beforeEach(function(){nock("http://custom-registry.com").get("/packages/jquery").reply(200,{error:{message:"missing",stack:"Error: missing"}}),nock("http://custom-registry2.com").get("/packages/jquery").reply(200,{name:"jquery",url:"git://github.com/foo/baz"}),this.registry=new RegistryClient({strictSsl:!1,force:!0,registry:{search:["http://custom-registry.com","http://custom-registry2.com"]}})}),it("should return entry type",function(t){this.registry.lookup("jquery",function(e,r){expect(e).to.be(null),expect(r).to.be.an("object"),expect(r.type).to.eql("alias"),t()})}),it("should return entry url ",function(t){this.registry.lookup("jquery",function(e,r){expect(e).to.be(null),expect(r).to.be.an("object"),expect(r.url).to.eql("git://github.com/foo/baz"),t()})})}),describe("calling the lookup instance method with three registries",function(){beforeEach(function(){nock("https://bower.herokuapp.com:443").get("/packages/jquery").reply(404),nock("http://custom-registry.com").get("/packages/jquery").reply(200,{name:"jquery",url:"git://github.com/foo/bar"}),nock("http://custom-registry2.com").get("/packages/jquery").reply(200,{name:"jquery",url:"git://github.com/foo/baz"}),this.registry=new RegistryClient({strictSsl:!1,force:!0,registry:{search:["https://bower.herokuapp.com","http://custom-registry.com","http://custom-registry2.com"]}})}),it("should return entry type",function(t){this.registry.lookup("jquery",function(e,r){expect(e).to.be(null),expect(r).to.be.an("object"),expect(r.type).to.eql("alias"),t()})}),it("should return entry url ",function(t){this.registry.lookup("jquery",function(e,r){expect(e).to.be(null),expect(r).to.be.an("object"),expect(r.url).to.eql("git://github.com/foo/bar"),t()})}),it("should respect order",function(t){this.registry._config.registry.search=["https://bower.herokuapp.com","http://custom-registry2.com","http://custom-registry.com"],this.registry.lookup("jquery",function(e,r){expect(e).to.be(null),expect(r).to.be.an("object"),expect(r.url).to.eql("git://github.com/foo/baz"),t()})})}),describe("calling the register instance method with argument",function(){beforeEach(function(){nock("https://bower.herokuapp.com:443").post("/packages","name=test-ba&url=git%3A%2F%2Fgithub.com%2Ftest-ba%2Ftest-ba.git").reply(201),this.pkg="test-ba",this.pkgUrl="git://github.com/test-ba/test-ba.git"}),it("should not return an error",function(t){this.registry.register(this.pkg,this.pkgUrl,function(e){expect(e).to.be(null),t()})}),it("should return entry name",function(t){var e=this;this.registry.register(this.pkg,this.pkgUrl,function(r,i){expect(r).to.be(null),expect(i.name).to.eql(e.pkg),t()})}),it("should return entry url",function(t){var e=this;this.registry.register(this.pkg,this.pkgUrl,function(r,i){expect(r).to.be(null),expect(i.url).to.eql(e.pkgUrl),t()})})}),describe("calling the register instance method without arguments",function(){beforeEach(function(){nock("https://bower.herokuapp.com:443").post("/packages","name=&url=").reply(400)}),it("should return an error and no result",function(t){this.registry.register("","",function(e,r){expect(e).to.be.an(Error),expect(r).to.be(void 0),t()})})}),describe("calling the unregister instance method with argument",function(){beforeEach(function(){this.pkg="testfoo",this.accessToken="12345678",this.registry._config.accessToken=this.accessToken,nock("https://bower.herokuapp.com:443")["delete"]("/packages/"+this.pkg+"?access_token="+this.accessToken).reply(204)}),it("should not return an error when valid",function(t){this.registry.unregister(this.pkg,function(e){expect(e).to.be(null),t()})}),it("should return entry name",function(t){var e=this;this.registry.unregister(this.pkg,function(r,i){expect(r).to.be(null),expect(i.name).to.eql(e.pkg),t()})})}),describe("calling the unregister instance method with invalid token",function(){beforeEach(function(){this.pkg="testfoo",this.registry._config.accessToken="",nock("https://bower.herokuapp.com:443")["delete"]("/packages/"+this.pkg).reply(403)}),it("should return an error",function(t){this.registry.unregister(this.pkg,function(e,r){expect(e).to.be.an(Error),expect(r).to.be(void 0),t()})})}),describe("calling the unregister instance method with invalid package",function(){beforeEach(function(){this.notpkg="testbar",this.accessToken="12345678",this.registry._config.accessToken=this.accessToken,nock("https://bower.herokuapp.com:443")["delete"]("/packages/"+this.notpkg+"?access_token="+this.accessToken).reply(404)}),it("should return an error",function(t){this.registry.unregister(this.notpkg,function(e,r){expect(e).to.be.an(Error),expect(r).to.be(void 0),t()})})}),describe("calling the search instance method with argument",function(){beforeEach(function(){nock("https://bower.herokuapp.com:443").get("/packages/search/jquery").replyWithFile(200,__dirname+"/fixtures/search.json"),this.pkg="jquery",this.pkgUrl="git://github.com/components/jquery.git",this.registry._config.force=!0}),it("should not return an error",function(t){this.registry.search(this.pkg,function(e){expect(e).to.be(null),t()})}),it("should return entry name",function(t){var e=this;this.registry.search(this.pkg,function(r,i){var o=i.some(function(t){return t.name===e.pkg});expect(o).to.be(!0),t()})}),it("should return entry url",function(t){var e=this;this.registry.search(this.pkg,function(r,i){var o=i.some(function(t){return t.url===e.pkgUrl});expect(o).to.be(!0),t()})})}),describe("calling the search instance method with two registries",function(){beforeEach(function(){nock("https://bower.herokuapp.com:443").get("/packages/search/jquery").reply(200,[]),nock("http://custom-registry.com").get("/packages/search/jquery").reply(200,[{name:"jquery",url:"git://github.com/bar/foo.git"}]),this.pkg="jquery",this.pkgUrl="git://github.com/bar/foo.git",this.registry=new RegistryClient({strictSsl:!1,force:!0,registry:{search:["https://bower.herokuapp.com","http://custom-registry.com"]}})}),it("should return entry name",function(t){var e=this;this.registry.search(this.pkg,function(r,i){var o=i.some(function(t){return t.name===e.pkg});expect(o).to.be(!0),t()})}),it("should return entry url",function(t){var e=this;this.registry.search(this.pkg,function(r,i){if(!i.length)return t(new Error("Result expected"));var o=i.some(function(t){return t.url===e.pkgUrl});expect(o).to.be(!0),t()})})}),describe("calling the search instance method without argument",function(){beforeEach(function(){nock("https://bower.herokuapp.com:443").get("/packages/search/").reply(404)}),it("should return an error and no results",function(t){this.registry.search("",function(e,r){expect(e).to.be.an(Error),expect(r).to.be(void 0),t()})})}),describe("calling the list instance method",function(){beforeEach(function(){nock("https://bower.herokuapp.com:443").get("/packages").reply(200,[],{}),this.registry._config.force=!0}),it("should not return an error",function(t){this.registry.list(function(e){expect(e).to.be(null),t()})}),it("should return results array",function(t){this.registry.list(function(e,r){expect(r).to.be.an("array"),t()})})}),describe("calling the list instance method with two registries",function(){beforeEach(function(){nock("https://bower.herokuapp.com:443").get("/packages").reply(200,[]),nock("http://custom-registry.com").get("/packages").reply(200,[{name:"jquery",url:"git://github.com/bar/foo.git"}]),this.registry=new RegistryClient({strictSsl:!1,force:!0,registry:{search:["https://bower.herokuapp.com","http://custom-registry.com"]}})}),it("should return entry name",function(t){var e=this;this.registry.list(function(r,i){var o=i.some(function(t){return t.name===e.pkg});expect(o).to.be(!0),t()})}),it("should return entry url",function(t){var e=this;this.registry.list(function(r,i){if(!i.length)return t(new Error("Result expected"));var o=i.some(function(t){return t.url===e.pkgUrl});expect(o).to.be(!0),t()})})}),describe("calling the list instance method",function(){beforeEach(function(){nock("https://bower.herokuapp.com:443").get("/packages").reply(200,[],{})}),it("should return an error and no results",function(t){this.registry.list(function(e){expect(e).to.be(null),t()})})}),describe("called the clearCache instance method with argument",function(){beforeEach(function(){this.pkg="jquery"}),it("should not return an error",function(t){this.registry.clearCache(this.pkg,function(e){expect(e).to.be(null),t()})})}),describe("called the clearCache instance method without argument",function(){it("should not return any errors and remove all cache items",function(t){this.registry.clearCache(function(e){expect(e).to.be(null),t()})})}),describe("add a custom userAgent with argument",function(){this.timeout(5e3),it("should send custom userAgent to the server",function(t){var e=this;this.ua="",this.server=http.createServer(function(t,r){e.ua=t.headers["user-agent"],r.writeHeader(200,{"Content-Type":"application/json"}),r.end('{"name":"jquery","url":"git://github.com/components/jquery.git"}'),e.server.close()}),this.server.listen("7777","127.0.0.1"),this.registry=new RegistryClient({userAgent:"test agent",registry:"http://127.0.0.1:7777"}),this.registry.search("jquery",function(){expect(e.ua).to.be("test agent"),t()})})})});
