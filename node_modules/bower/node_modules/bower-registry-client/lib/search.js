var path=require("path");var url=require("url");var async=require("async");var request=require("request");var replay=require("request-replay");var Cache=require("./util/Cache");var createError=require("./util/createError");function search(c,g){var f=[];var e=this;var a=this._config.registry.search;var d=a.length;var b=0;if(!d){return g(null,[])}async.doUntil(function(i){var j=url.parse(a[b]);var h=e._searchCache[j.host];if(e._config.offline){return h.get(c,function(l,k){if(l||!k||!k.length){return i(l)}k.forEach(function(m){addResult.call(e,f,m)});i()})}doRequest.call(e,c,b,function(l,k){if(l||!k||!k.length){return i(l)}k.forEach(function(m){addResult.call(e,f,m)});h.set(c,k,getMaxAge(),i)})},function(){return ++b===d},function(h){resetCache();if(h){return g(h)}g(null,f)})}function addResult(c,a){var b=c.some(function(d){return d.name===a.name});if(!b){c.push(a)}}function doRequest(a,f,i){var h;var c;var g=this._config.registry.search[f]+"/packages/search/"+encodeURIComponent(a);var b=url.parse(g);var d={};var e=this;if(this._config.userAgent){d["User-Agent"]=this._config.userAgent}h=replay(request.get(g,{proxy:b.protocol==="https:"?this._config.httpsProxy:this._config.proxy,headers:d,ca:this._config.ca.search[f],strictSSL:this._config.strictSsl,timeout:this._config.timeout,json:true},function(l,k,j){if(l){return i(createError("Request to "+g+" failed: "+l.message,l.code))}if(k.statusCode<200||k.statusCode>299){return i(createError("Request to "+g+" failed with "+k.statusCode,"EINVRES"))}if(typeof j!=="object"){return i(createError("Response of request to "+g+" is not a valid json","EINVRES"))}i(null,j)}));if(this._logger){h.on("replay",function(j){c="Request to "+g+" failed with "+j.error.code+", ";c+="retrying in "+(j.delay/1000).toFixed(1)+"s";e._logger.warn("retry",c)})}}function getMaxAge(){return 5*60*60*1000}function initCache(){this._searchCache=this._cache.search||{};this._config.registry.search.forEach(function(a){var c;var b=url.parse(a).host;if(this._searchCache[b]){return}if(this._config.cache){c=path.join(this._config.cache,encodeURIComponent(b),"search")}this._searchCache[b]=new Cache(c,{max:250,useStale:this._config.offline})},this)}function clearCache(c,d){var b=this._searchCache;var a=Object.keys(b);if(typeof c==="function"){d=c;c=null}async.forEach(a,function(f,e){b[f].clear(e)},d)}function resetCache(){var a;for(a in this._searchCache){this._searchCache[a].reset()}}search.initCache=initCache;search.clearCache=clearCache;search.resetCache=resetCache;module.exports=search;