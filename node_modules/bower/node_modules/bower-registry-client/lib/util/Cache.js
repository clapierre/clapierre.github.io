var fs=require("graceful-fs");var path=require("path");var async=require("async");var mkdirp=require("mkdirp");var LRU=require("lru-cache");var md5=require("./md5");function Cache(b,a){a=a||{};this._dir=b;this._options=a;this._cache=this.constructor._cache.get(this._dir);if(!this._cache){this._cache=new LRU(a);this.constructor._cache.set(this._dir,this._cache)}if(b){mkdirp.sync(b)}}Cache.prototype.get=function(c,d){var b;var a=this._cache.get(c);if(a){if(this._hasExpired(a)){this.del(c,d)}else{d(null,a.value)}return}if(!this._dir){return d(null)}b=this._getFile(c);fs.readFile(b,function(h,g){var f;if(h){return d(h.code==="ENOENT"?null:h)}try{f=JSON.parse(g.toString())}catch(i){return this.del(c,d)}if(this._hasExpired(f)){return this.del(c,d)}this._cache.set(c,f);d(null,f.value)}.bind(this))};Cache.prototype.set=function(c,f,a,i){var b;var d;var h;a=a!=null?a:this._options.maxAge;d={expires:a?Date.now()+a:null,value:f};this._cache.set(c,d);if(!this._dir){return i(null)}try{h=JSON.stringify(d)}catch(g){return i(g)}b=this._getFile(c);fs.writeFile(b,h,i)};Cache.prototype.del=function(a,b){this._cache.del(a);if(!this._dir){return b(null)}fs.unlink(this._getFile(a),function(c){if(c&&c.code!=="ENOENT"){return b(c)}b()})};Cache.prototype.clear=function(b){var a=this._dir;this._cache.reset();if(!a){return b(null)}fs.readdir(a,function(d,c){if(d){return b(d)}async.forEach(c,function(e,f){fs.unlink(path.join(a,e),function(g){if(g&&g.code!=="ENOENT"){return f(g)}f()})},b)})};Cache.prototype.reset=function(){this._cache.reset()};Cache.clearRuntimeCache=function(){this._cache.forEach(function(a){a.reset()});this._cache.reset()};Cache.prototype._hasExpired=function(b){var a=b.expires;if(!a||this._options.useStale){return false}return Date.now()>a};Cache.prototype._getFile=function(a){return path.join(this._dir,encodeURIComponent(a)+"_"+md5(a).substr(0,5))};Cache._cache=new LRU({max:5,maxAge:60*30*1000});module.exports=Cache;