var path=require("path");var url=require("url");var async=require("async");var request=require("request");var replay=require("request-replay");var Cache=require("./util/Cache");var createError=require("./util/createError");function list(f){var e=[];var d=this;var a=this._config.registry.search;var c=a.length;var b=0;if(!c){return f(null,[])}async.doUntil(function(g){var i=url.parse(a[b]);var h=d._listCache[i.host];if(d._config.offline){return h.get("list",function(k,j){if(k||!j){return g(k)}j.forEach(function(l){addResult.call(d,e,l)});g()})}doRequest.call(d,b,function(k,j){if(k||!j){return g(k)}j.forEach(function(l){addResult(e,l)});h.set("list",j,getMaxAge(),g)})},function(){return ++b===c},function(g){resetCache();if(g){return f(g)}f(null,e)})}function addResult(c,a){var b=c.some(function(d){return d.name===a.name});if(!b){c.push(a)}}function doRequest(a,h){var d;var g;var b=this._config.registry.search[a]+"/packages";var e=url.parse(b);var f={};var c=this;if(this._config.userAgent){f["User-Agent"]=this._config.userAgent}d=replay(request.get(b,{proxy:e.protocol==="https:"?this._config.httpsProxy:this._config.proxy,ca:this._config.ca.search[a],headers:f,strictSSL:this._config.strictSsl,timeout:this._config.timeout,json:true},function(k,j,i){if(k){return h(createError("Request to "+b+" failed: "+k.message,k.code))}if(j.statusCode<200||j.statusCode>299){return h(createError("Request to "+b+" failed with "+j.statusCode,"EINVRES"))}if(typeof i!=="object"){return h(createError("Response of request to "+b+" is not a valid json","EINVRES"))}h(null,i)}));if(this._logger){d.on("replay",function(i){g="Request to "+b+" failed with "+i.error.code+", ";g+="retrying in "+(i.delay/1000).toFixed(1)+"s";c._logger.warn("retry",g)})}}function getMaxAge(){return 5*60*60*1000}function initCache(){this._listCache=this._cache.list||{};this._config.registry.search.forEach(function(a){var c;var b=url.parse(a).host;if(this._listCache[b]){return}if(this._config.cache){c=path.join(this._config.cache,encodeURIComponent(b),"list")}this._listCache[b]=new Cache(c,{max:250,useStale:this._config.offline})},this)}function clearCache(c){var b=this._listCache;var a=Object.keys(b);async.forEach(a,function(e,d){b[e].clear(d)},c)}function resetCache(){var a;for(a in this._listCache){this._listCache[a].reset()}}list.initCache=initCache;list.clearCache=clearCache;list.resetCache=resetCache;module.exports=list;