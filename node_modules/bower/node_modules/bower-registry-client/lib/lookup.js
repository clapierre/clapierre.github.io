var path=require("path");var url=require("url");var async=require("async");var request=require("request");var replay=require("request-replay");var createError=require("./util/createError");var Cache=require("./util/Cache");function lookup(c,g){var f;var e=this;var a=this._config.registry.search;var d=a.length;var b=0;if(!d){return g()}async.doUntil(function(i){var j=url.parse(a[b]);var h=e._lookupCache[j.host];if(!e._config.force){h.get(c,function(k,l){f=l;if(k||f||e._config.offline){return i(k)}doRequest.call(e,c,b,function(n,m){if(n||!m){return i(n)}f=m;h.set(c,m,getMaxAge(m),i)})})}else{doRequest.call(e,c,b,function(l,k){if(l||!k){return i(l)}f=k;h.set(c,k,getMaxAge(k),i)})}},function(){return !!f||++b===d},function(h){if(h){return g(h)}g(null,f)})}function doRequest(a,f,i){var h;var c;var g=this._config.registry.search[f]+"/packages/"+encodeURIComponent(a);var b=url.parse(g);var d={};var e=this;if(this._config.userAgent){d["User-Agent"]=this._config.userAgent}h=replay(request.get(g,{proxy:b.protocol==="https:"?this._config.httpsProxy:this._config.proxy,headers:d,ca:this._config.ca.search[f],strictSSL:this._config.strictSsl,timeout:this._config.timeout,json:true},function(l,k,j){if(l){return i(createError("Request to "+g+" failed: "+l.message,l.code))}if(k.statusCode===404){return i()}if(k.statusCode<200||k.statusCode>299){return i(createError("Request to "+g+" failed with "+k.statusCode,"EINVRES"))}if(typeof j!=="object"){return i(createError("Response of request to "+g+" is not a valid json","EINVRES"))}var m;if(j.url){m={type:"alias",url:j.url}}i(null,m)}));if(this._logger){h.on("replay",function(j){c="Request to "+g+" failed with "+j.error.code+", ";c+="retrying in "+(j.delay/1000).toFixed(1)+"s";e._logger.warn("retry",c)})}}function getMaxAge(a){if(a.type==="alias"){return 5*24*60*60*1000}return 5*60*60*1000}function initCache(){this._lookupCache=this._cache.lookup||{};this._config.registry.search.forEach(function(a){var c;var b=url.parse(a).host;if(this._lookupCache[b]){return}if(this._config.cache){c=path.join(this._config.cache,encodeURIComponent(b),"lookup")}this._lookupCache[b]=new Cache(c,{max:250,useStale:this._config.offline})},this)}function clearCache(c,d){var b=this._lookupCache;var a=Object.keys(b);if(typeof c==="function"){d=c;c=null}if(c){async.forEach(a,function(f,e){b[f].del(c,e)},d)}else{async.forEach(a,function(f,e){b[f].clear(e)},d)}}function resetCache(){var a;for(a in this._lookupCache){this._lookupCache[a].reset()}}lookup.initCache=initCache;lookup.clearCache=clearCache;lookup.resetCache=resetCache;module.exports=lookup;