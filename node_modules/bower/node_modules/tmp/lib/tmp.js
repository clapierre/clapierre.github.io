/*!
 * Tmp
 *
 * Copyright (c) 2011-2013 KARASZI Istvan <github@spam.raszi.hu>
 *
 * MIT Licensed
 */
var fs=require("fs"),path=require("path"),os=require("os"),exists=fs.exists||path.exists,tmpDir=os.tmpDir||_getTMPDir,_c=require("constants");var _TMP=tmpDir(),randomChars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",randomCharsLength=randomChars.length,_removeObjects=[],_gracefulCleanup=false,_uncaughtException=false;function _getTMPDir(){var a=["TMPDIR","TMP","TEMP"];for(var b=0,c=a.length;b<c;b++){if(_isUndefined(process.env[a[b]])){continue}return process.env[a[b]]}return"/tmp"}function _isUndefined(a){return typeof a==="undefined"}function _parseArguments(a,b){if(!b||typeof b!="function"){b=a;a={}}return[a,b]}function _getTmpName(j,i){var f=_parseArguments(j,i),a=f[0],c=f[1],h=a.template,d=!_isUndefined(h),g=a.tries||3;if(isNaN(g)||g<0){return c(new Error("Invalid tries"))}if(d&&!h.match(/XXXXXX/)){return c(new Error("Invalid template provided"))}function b(){if(!d){var k=[(_isUndefined(a.prefix))?"tmp-":a.prefix,process.pid,(Math.random()*68719476736).toString(36),a.postfix].join("");return path.join(a.dir||_TMP,k)}var m=[];for(var l=0;l<6;l++){m.push(randomChars.substr(Math.floor(Math.random()*randomCharsLength),1))}return h.replace(/XXXXXX/,m.join(""))}(function e(){var l=b();exists(l,function k(m){if(m){if(g-->0){return e()}return c(new Error("Could not get a unique tmp filename, max tries reached"))}c(null,l)})}())}function _createTmpFile(c,f){var b=_parseArguments(c,f),d=b[0],a=b[1];d.postfix=(_isUndefined(d.postfix))?".tmp":d.postfix;_getTmpName(d,function e(h,g){if(h){return a(h)}fs.open(g,_c.O_CREAT|_c.O_EXCL|_c.O_RDWR,d.mode||384,function i(k,j){if(k){return a(k)}if(!d.keep){_removeObjects.unshift([fs.unlinkSync,g])}a(null,g,j)})})}function _rmdirRecursiveSync(a){var f=fs.readdirSync(a);for(var c=0,e=f.length;c<e;c++){var b=path.join(a,f[c]);var d=fs.lstatSync(b);if(d.isDirectory()){_rmdirRecursiveSync(b)}else{fs.unlinkSync(b)}}fs.rmdirSync(a)}function _createTmpDir(c,f){var b=_parseArguments(c,f),d=b[0],a=b[1];_getTmpName(d,function e(i,g){if(i){return a(i)}fs.mkdir(g,d.mode||448,function h(j){if(j){return a(j)}if(!d.keep){if(d.unsafeCleanup){_removeObjects.unshift([_rmdirRecursiveSync,g])}else{_removeObjects.unshift([fs.rmdirSync,g])}}a(null,g)})})}function _garbageCollector(){if(_uncaughtException&&!_gracefulCleanup){return}for(var a=0,b=_removeObjects.length;a<b;a++){try{_removeObjects[a][0].call(null,_removeObjects[a][1])}catch(c){}}}function _setGracefulCleanup(){_gracefulCleanup=true}var version=process.versions.node.split(".").map(function(a){return parseInt(a,10)});if(version[0]===0&&(version[1]<9||version[1]===9&&version[2]<5)){process.addListener("uncaughtException",function _uncaughtExceptionThrown(a){_uncaughtException=true;_garbageCollector();throw a})}process.addListener("exit",function _exit(a){if(a){_uncaughtException=true}_garbageCollector()});module.exports.tmpdir=_TMP;module.exports.dir=_createTmpDir;module.exports.file=_createTmpFile;module.exports.tmpName=_getTmpName;module.exports.setGracefulCleanup=_setGracefulCleanup;