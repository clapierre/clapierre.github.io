var json=typeof JSON!==undefined?JSON:require("jsonify");var map=require("array-map");var filter=require("array-filter");var reduce=require("array-reduce");exports.quote=function(a){return map(a,function(b){if(b&&typeof b==="object"){return b.op.replace(/(.)/g,"\\$1")}else{if(/["\s]/.test(b)&&!/'/.test(b)){return"'"+b.replace(/(['\\])/g,"\\$1")+"'"}else{if(/["'\s]/.test(b)){return'"'+b.replace(/(["\\$`!])/g,"\\$1")+'"'}else{return String(b).replace(/([\\$`()!#&*|])/g,"\\$1")}}}}).join(" ")};var CONTROL="(?:"+["\\|\\|","\\&\\&",";;","\\|\\&","[&;()|<>]"].join("|")+")";var META="|&;()<> \\t";var BAREWORD="(\\\\['\""+META+"]|[^\\s'\""+META+"])+";var SINGLE_QUOTE='"((\\\\"|[^"])*?)"';var DOUBLE_QUOTE="'((\\\\'|[^'])*?)'";var TOKEN="";for(var i=0;i<4;i++){TOKEN+=(Math.pow(16,8)*Math.random()).toString(16)}exports.parse=function(c,b){var a=parse(c,b);if(typeof b!=="function"){return a}return reduce(a,function(f,e){if(typeof e==="object"){return f.concat(e)}var d=e.split(RegExp("("+TOKEN+".*?"+TOKEN+")","g"));if(d.length===1){return f.concat(d[0])}return f.concat(map(filter(d,Boolean),function(g){if(RegExp("^"+TOKEN).test(g)){return json.parse(g.split(TOKEN)[1])}else{return g}}))},[])};function parse(e,d){var a=new RegExp(["("+CONTROL+")","("+BAREWORD+"|"+SINGLE_QUOTE+"|"+DOUBLE_QUOTE+")*"].join("|"),"g");var c=filter(e.match(a),Boolean);if(!c){return[]}if(!d){d={}}return map(c,function(u){if(RegExp("^"+CONTROL+"$").test(u)){return{op:u}}var n="'";var t='"';var l="\\";var q="$";var f=false;var g=false;var o=false;var j="";var h=false;for(var k=0,m=u.length;k<m;k++){var p=u.charAt(k);h=h||(!f&&(p==="*"||p==="?"));if(o){j+=p;o=false}else{if(f){if(p===f){f=false}else{if(f==n){j+=p}else{if(p===l){k+=1;p=u.charAt(k);if(p===t||p===l||p===q){j+=p}else{j+=l+p}}else{if(p===q){j+=r()}else{j+=p}}}}}else{if(p===t||p===n){f=p}else{if(RegExp("^"+CONTROL+"$").test(p)){return{op:u}}else{if(p===l){o=true}else{if(p===q){j+=r()}else{j+=p}}}}}}}if(h){return{op:"glob",pattern:j}}return j;function r(){k+=1;var v,s;if(u.charAt(k)==="{"){k+=1;if(u.charAt(k)==="}"){throw new Error("Bad substitution: "+u.substr(k-2,3))}v=u.indexOf("}",k);if(v<0){throw new Error("Bad substitution: "+u.substr(k))}s=u.substr(k,v-k);k=v}else{if(/[*@#?$!_\-]/.test(u.charAt(k))){s=u.charAt(k);k+=1}else{v=u.substr(k).match(/[^\w\d_]/);if(!v){s=u.substr(k);k=u.length}else{s=u.substr(k,v.index);k+=v.index-1}}}return b(null,"",s)}});function b(f,j,g){var h=typeof d==="function"?d(g):d[g];if(h===undefined){h=""}if(typeof h==="object"){return j+TOKEN+json.stringify(h)+TOKEN}else{return j+h}}};