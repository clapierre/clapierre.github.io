"use strict";var binary=require("binary");var convertDateTime=function(h,g){var e=((h>>9)&127)+1980;var d=(h>>5)&15;var f=h&31;var c=(g>>11);var b=(g>>5)&63;var a=(g&31)*2;var i=new Date(e,d-1,f,c,b,a,0);return i};var convertGeneralPurposeFlags=function(c){var b=[];for(var a=0;a<16;a++){b[a]=(c>>a)&1}return{encrypted:!!b[0],compressionFlag1:!!b[1],compressionFlag2:!!b[2],useDataDescriptor:!!b[3],enhancedDeflating:!!b[4],compressedPatched:!!b[5],strongEncryption:!!b[6],utf8:!!b[11],encryptedCD:!!b[13]}};var parseExternalFileAttributes=function(c,a){var b={1:"NamedPipe",2:"Character",4:"Directory",6:"Block",8:"File",10:"SymbolicLink",12:"Socket"};switch(a){case 3:return{platform:"Unix",type:b[(c>>60)&15],mode:(c>>48)&4095};default:if(a!==0){console.warn("Possibly unsupported ZIP platform type, "+a)}var e={A:(c>>5)&1,D:(c>>4)&1,V:(c>>3)&1,S:(c>>2)&1,H:(c>>1)&1,R:c&1};var d=parseInt("0444",8);if(e.D){d|=parseInt("0111",8)}if(!e.R){d|=parseInt("0222",8)}d&=~process.umask();return{platform:"DOS",type:e.D?"Directory":"File",mode:d}}};var readEndRecord=function(a){var b=binary.parse(a).word32lu("signature").word16lu("diskNumber").word16lu("directoryStartDisk").word16lu("directoryEntryCountDisk").word16lu("directoryEntryCount").word32lu("directorySize").word32lu("directoryOffset").word16lu("commentLength").buffer("comment","commentLength").vars;b.comment=b.comment.toString();return b};var directorySort=function(d,c){return d.relativeOffsetOfLocalHeader-c.relativeOffsetOfLocalHeader};var readDirectory=function(b){var a=[];var d;var c=0;while(c<b.length){d=binary.parse(b.slice(c,c+46)).word32lu("signature").word8lu("creatorSpecVersion").word8lu("creatorPlatform").word8lu("requiredSpecVersion").word8lu("requiredPlatform").word16lu("generalPurposeBitFlag").word16lu("compressionMethod").word16lu("lastModFileTime").word16lu("lastModFileDate").word32lu("crc32").word32lu("compressedSize").word32lu("uncompressedSize").word16lu("fileNameLength").word16lu("extraFieldLength").word16lu("fileCommentLength").word16lu("diskNumberStart").word16lu("internalFileAttributes").word32lu("externalFileAttributes").word32lu("relativeOffsetOfLocalHeader").vars;c+=46;d.generalPurposeFlags=convertGeneralPurposeFlags(d.generalPurposeBitFlag);d.fileAttributes=parseExternalFileAttributes(d.externalFileAttributes,d.creatorPlatform);d.modifiedTime=convertDateTime(d.lastModFileDate,d.lastModFileTime);d.fileName=d.extraField=d.fileComment="";d.headerLength=46+d.fileNameLength+d.extraFieldLength+d.fileCommentLength;if(d.fileNameLength>0){d.fileName=b.slice(c,c+d.fileNameLength).toString();c+=d.fileNameLength}if(d.extraFieldLength>0){d.extraField=b.slice(c,c+d.extraFieldLength).toString();c+=d.extraFieldLength}if(d.fileCommentLength>0){d.fileComment=b.slice(c,c+d.fileCommentLength).toString();c+=d.fileCommentLength}if(d.fileAttributes.type!=="Directory"&&d.fileName.substr(-1)==="/"){d.fileAttributes.type="Directory"}a.push(d)}a.sort(directorySort);return a};var readFileEntry=function(a){var b=0;var c=binary.parse(a.slice(b,30)).word32lu("signature").word16lu("versionNeededToExtract").word16lu("generalPurposeBitFlag").word16lu("compressionMethod").word16lu("lastModFileTime").word16lu("lastModFileDate").word32lu("crc32").word32lu("compressedSize").word32lu("uncompressedSize").word16lu("fileNameLength").word16lu("extraFieldLength").vars;b+=30;c.fileName=c.extraField="";c.entryLength=30+c.fileNameLength+c.extraFieldLength;if(c.entryLength>structures.maxFileEntrySize){throw new Error("File entry unexpectedly large: "+c.entryLength+" (max: "+structures.maxFileEntrySize+")")}if(c.fileNameLength>0){c.fileName=a.slice(b,b+c.fileNameLength).toString();b+=c.fileNameLength}if(c.extraFieldLength>0){c.extraField=a.slice(b,b+c.extraFieldLength).toString();b+=c.extraFieldLength}return c};var structures=module.exports={readEndRecord:readEndRecord,readDirectory:readDirectory,readFileEntry:readFileEntry,maxFileEntrySize:4096};