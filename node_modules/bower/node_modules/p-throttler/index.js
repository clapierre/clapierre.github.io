"use strict";var Q=require("q");var arrayRemove=require("./lib/arrayRemove");function PThrottler(b,a){this._defaultConcurrency=typeof b==="number"?b:10;this._queue={};this._slots=a||{};this._executing=[]}PThrottler.prototype.enqueue=function(e,c){var a=Q.defer();var b;var d;c=c||"";b=Array.isArray(c)?c:[c];d={func:e,types:b,deferred:a};b.forEach(function(g){var f=this._queue[g]=this._queue[g]||[];f.push(d)},this);Q.fcall(this._processEntry.bind(this,d));return a.promise};PThrottler.prototype.abort=function(){var a;Object.keys(this._queue).forEach(function(b){this._queue[b]=[]},this);a=this._executing.map(function(b){return b.deferred.promise});return Q.allResolved(a).then(function(){})};PThrottler.prototype._processQueue=function(c){var b=this._queue[c];var d=b?b.length:0;var a;for(a=0;a<d;++a){if(this._processEntry(b[a])){break}}};PThrottler.prototype._processEntry=function(a){var b=a.types.every(this._hasSlot,this);var c;if(b){a.types.forEach(function(d){arrayRemove(this._queue[d],a);this._takeSlot(d)},this);this._executing.push(a);c=a.func();if(typeof c.then==="undefined"){c=Q.resolve(c)}c.progress(a.deferred.notify.bind(a.deferred));c.then(this._onFulfill.bind(this,a,true),this._onFulfill.bind(this,a,false))}return b};PThrottler.prototype._onFulfill=function(c,b,a){if(b){c.deferred.resolve(a)}else{c.deferred.reject(a)}arrayRemove(this._executing,c);c.types.forEach(this._freeSlot,this);c.types.forEach(this._processQueue,this)};PThrottler.prototype._hasSlot=function(a){var b=this._slots[a];if(b==null){b=this._defaultConcurrency}return b>0};PThrottler.prototype._takeSlot=function(a){if(this._slots[a]==null){this._slots[a]=this._defaultConcurrency}else{if(!this._slots[a]){throw new Error("No free slots")}}--this._slots[a]};PThrottler.prototype._freeSlot=function(a){if(this._slots[a]!=null){++this._slots[a]}};PThrottler.create=function(b,a){return new PThrottler(b,a)};module.exports=PThrottler;