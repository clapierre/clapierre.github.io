var fs=require("./fs.js");var constants=require("constants");var origCwd=process.cwd;var cwd=null;process.cwd=function(){if(!cwd){cwd=origCwd.call(process)}return cwd};var chdir=process.chdir;process.chdir=function(a){cwd=null;chdir.call(process,a)};if(constants.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)){fs.lchmod=function(a,b,c){c=c||noop;fs.open(a,constants.O_WRONLY|constants.O_SYMLINK,b,function(e,d){if(e){c(e);return}fs.fchmod(d,b,function(f){fs.close(d,function(g){c(f||g)})})})};fs.lchmodSync=function(e,f){var c=fs.openSync(e,constants.O_WRONLY|constants.O_SYMLINK,f);var d,a;try{var b=fs.fchmodSync(c,f)}catch(g){d=g}try{fs.closeSync(c)}catch(g){a=g}if(d||a){throw (d||a)}return b}}if(!fs.lutimes){if(constants.hasOwnProperty("O_SYMLINK")){fs.lutimes=function(d,b,c,a){fs.open(d,constants.O_SYMLINK,function(f,e){a=a||noop;if(f){return a(f)}fs.futimes(e,b,c,function(g){fs.close(e,function(h){return a(g||h)})})})};fs.lutimesSync=function(g,a,c){var e=fs.openSync(g,constants.O_SYMLINK),f,b,d;try{var d=fs.futimesSync(e,a,c)}catch(h){f=h}try{fs.closeSync(e)}catch(h){b=h}if(f||b){throw (f||b)}return d}}else{if(fs.utimensat&&constants.hasOwnProperty("AT_SYMLINK_NOFOLLOW")){fs.lutimes=function(d,b,c,a){fs.utimensat(d,b,c,constants.AT_SYMLINK_NOFOLLOW,a)};fs.lutimesSync=function(c,a,b){return fs.utimensatSync(c,a,b,constants.AT_SYMLINK_NOFOLLOW)}}else{fs.lutimes=function(d,c,b,a){process.nextTick(a)};fs.lutimesSync=function(){}}}}fs.chown=chownFix(fs.chown);fs.fchown=chownFix(fs.fchown);fs.lchown=chownFix(fs.lchown);fs.chmod=chownFix(fs.chmod);fs.fchmod=chownFix(fs.fchmod);fs.lchmod=chownFix(fs.lchmod);fs.chownSync=chownFixSync(fs.chownSync);fs.fchownSync=chownFixSync(fs.fchownSync);fs.lchownSync=chownFixSync(fs.lchownSync);fs.chmodSync=chownFix(fs.chmodSync);fs.fchmodSync=chownFix(fs.fchmodSync);fs.lchmodSync=chownFix(fs.lchmodSync);function chownFix(a){if(!a){return a}return function(e,c,d,b){return a.call(fs,e,c,d,function(g,f){if(chownErOk(g)){g=null}b(g,f)})}}function chownFixSync(a){if(!a){return a}return function(d,b,c){try{return a.call(fs,d,b,c)}catch(e){if(!chownErOk(e)){throw e}}}}function chownErOk(b){if(!b){return true}if(b.code==="ENOSYS"){return true}var a=!process.getuid||process.getuid()!==0;if(a){if(b.code==="EINVAL"||b.code==="EPERM"){return true}}return false}if(!fs.lchmod){fs.lchmod=function(b,c,a){process.nextTick(a)};fs.lchmodSync=function(){}}if(!fs.lchown){fs.lchown=function(d,b,c,a){process.nextTick(a)};fs.lchownSync=function(){}}if(process.platform==="win32"){var rename_=fs.rename;fs.rename=function rename(e,d,a){var c=Date.now();rename_(e,d,function b(f){if(f&&(f.code==="EACCES"||f.code==="EPERM")&&Date.now()-c<1000){return rename_(e,d,b)}if(a){a(f)}})}}var read=fs.read;fs.read=function(d,b,g,e,a,c){var h;if(c&&typeof c==="function"){var f=0;h=function(k,i,j){if(k&&k.code==="EAGAIN"&&f<10){f++;return read.call(fs,d,b,g,e,a,h)}c.apply(this,arguments)}}return read.call(fs,d,b,g,e,a,h)};var readSync=fs.readSync;fs.readSync=function(c,b,f,d,a){var e=0;while(true){try{return readSync.call(fs,c,b,f,d,a)}catch(g){if(g.code==="EAGAIN"&&e<10){e++;continue}throw g}}};