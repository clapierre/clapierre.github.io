var tar=require("tar-stream");var pump=require("pump");var mkdirp=require("mkdirp");var fs=require("fs");var path=require("path");var os=require("os");var win32=os.platform()==="win32";var noop=function(){};var echo=function(a){return a};var normalize=!win32?echo:function(a){return a.replace(/\\/g,"/")};var statAll=function(c,d){var a=["."];return function b(g){if(!a.length){return g()}var e=a.shift();var f=path.join(c,e);fs.lstat(f,function(i,h){if(i){return g(i)}if(!h.isDirectory()){return g(null,e,h)}fs.readdir(f,function(l,k){if(l){return g(l)}for(var j=0;j<k.length;j++){if(!d(path.join(c,e,k[j]))){a.push(path.join(e,k[j]))}}g(null,e,h)})})}};var strip=function(a,b){return function(c){c.name=c.name.split("/").slice(b).join("/");if(c.linkname){c.linkname=c.linkname.split("/").slice(b).join("/")}return a(c)}};exports.pack=function(h,a){if(!h){h="."}if(!a){a={}}var f=a.ignore||noop;var c=a.map||noop;var e=a.mapStream||echo;var g=statAll(h,f);var i=tar.pack();if(a.strip){c=strip(c,a.strip)}var d=function(k,l){fs.readlink(path.join(h,k),function(n,m){if(n){return i.destroy(n)}l.linkname=normalize(m);i.entry(l,b)})};var j=function(o,l,m){if(o){return i.destroy(o)}if(!l){return i.finalize()}if(m.isSocket()){return b()}var p={name:normalize(l),mode:m.mode,mtime:m.mtime,size:m.size,type:"file",uid:m.uid,gid:m.gid};if(m.isDirectory()){p.size=0;p.type="directory";return i.entry(p,b)}if(m.isSymbolicLink()){p.size=0;p.type="symlink";return d(l,p)}if(!m.isFile()){return i.destroy(new Error("unsupported type for "+l))}p=c(p)||p;var n=i.entry(p,b);if(!n){return}var k=fs.createReadStream(path.join(h,l));pump(e(k),n)};var b=function(k){if(k){return i.destroy(k)}g(j)};b();return i};var head=function(a){return a.length?a[a.length-1]:null};exports.extract=function(j,a){if(!j){j="."}if(!a){a={}}var g=a.ignore||noop;var b=a.map||noop;var e=a.mapStream||echo;var o=a.chown!==false&&!win32&&process.getuid()===0;var d=tar.extract();var i=[];var c=new Date();var m=typeof a.umask==="number"?~a.umask:~process.umask();var l=typeof a.dmode==="number"?a.dmode:0;var f=typeof a.fmode==="number"?a.fmode:0;if(a.strip){b=strip(b,a.strip)}if(a.readable){l|=365;f|=292}if(a.writable){l|=219;f|=146}var k=function(q,p){var r;while((r=head(i))&&q.slice(0,r[0].length)!==r[0]){i.pop()}if(!r){return p()}fs.utimes(r[0],c,r[1],p)};var n=function(q,r,p){if(a.utimes===false){return p()}if(r.type==="directory"){return fs.utimes(q,c,r.mtime,p)}if(r.type==="symlink"){return k(q,p)}fs.utimes(q,c,r.mtime,function(s){if(s){return p(s)}k(q,p)})};var h=function(r,u,q){var s=u.type==="symlink";var p=s?fs.lchmod:fs.chmod;var t=s?fs.lchown:fs.chown;if(!p){return q()}p(r,(u.mode|(u.type==="directory"?l:f))&m,function(v){if(v){return q(v)}if(!o){return q()}if(!t){return q()}t(r,u.uid,u.gid,q)})};d.on("entry",function(v,u,s){v=b(v)||v;var p=path.join(j,path.join("/",v.name));if(g(p)){u.resume();return s()}var r=function(w){if(w){return s(w)}if(win32){return s()}n(p,v,function(x){if(x){return s(x)}h(p,v,s)})};var t=function(){if(win32){return s()}fs.unlink(p,function(){fs.symlink(v.linkname,p,r)})};var q=function(){var w=fs.createWriteStream(p);pump(e(u),w,function(x){if(x){return s(x)}w.on("close",r)})};if(v.type==="directory"){i.push([p,v.mtime]);return mkdirp(p,r)}mkdirp(path.dirname(p),function(w){if(w){return s(w)}if(v.type==="symlink"){return t()}if(v.type!=="file"){return s(new Error("unsupported type for "+p+" ("+v.type+")"))}q()})});return d};