var fs=require("fs");var wx="wx";if(process.version.match(/^v0\.[0-6]/)){var c=require("constants");wx=c.O_TRUNC|c.O_CREAT|c.O_WRONLY|c.O_EXCL}var os=require("os");exports.filetime="ctime";if(os.platform()=="win32"){exports.filetime="mtime"}var debug;var util=require("util");if(util.debuglog){debug=util.debuglog("LOCKFILE")}else{if(/\blockfile\b/i.test(process.env.NODE_DEBUG)){debug=function(){var a=util.format.apply(util,arguments);console.error("LOCKFILE %d %s",process.pid,a)}}else{debug=function(){}}}var locks={};function hasOwnProperty(a,b){return Object.prototype.hasOwnProperty.call(a,b)}process.on("exit",function(){debug("exit listener");Object.keys(locks).forEach(exports.unlockSync)});if(/^v0\.[0-8]\./.test(process.version)){debug("uncaughtException, version = %s",process.version);process.on("uncaughtException",function H(d){debug("uncaughtException");var a=process.listeners("uncaughtException").filter(function(e){return e!==H});if(!a.length){try{Object.keys(locks).forEach(exports.unlockSync)}catch(b){}process.removeListener("uncaughtException",H);throw d}})}exports.unlock=function(b,a){debug("unlock",b);delete locks[b];fs.unlink(b,function(d){a()})};exports.unlockSync=function(a){debug("unlockSync",a);try{fs.unlinkSync(a)}catch(b){}delete locks[a]};exports.check=function(d,b,a){if(typeof b==="function"){a=b,b={}}debug("check",d,b);fs.open(d,"r",function(f,e){if(f){if(f.code!=="ENOENT"){return a(f)}return a(null,false)}if(!b.stale){return fs.close(e,function(g){return a(g,true)})}fs.fstat(e,function(h,g){if(h){return fs.close(e,function(i){return a(h)})}fs.close(e,function(j){var i=Date.now()-g[exports.filetime].getTime();return a(j,i<=b.stale)})})})};exports.checkSync=function(f,e){e=e||{};debug("checkSync",f,e);if(e.wait){throw new Error("opts.wait not supported sync for obvious reasons")}try{var d=fs.openSync(f,"r")}catch(g){if(g.code!=="ENOENT"){throw g}return false}if(!e.stale){try{fs.closeSync(d)}catch(g){}return true}if(e.stale){try{var b=fs.fstatSync(d)}finally{fs.closeSync(d)}var a=Date.now()-b[exports.filetime].getTime();return(a<=e.stale)}};var req=1;exports.lock=function(e,d,a){if(typeof d==="function"){a=d,d={}}d.req=d.req||req++;debug("lock",e,d);d.start=d.start||Date.now();if(typeof d.retries==="number"&&d.retries>0){debug("has retries",d.retries);var b=d.retries;d.retries=0;a=(function(g){return function f(j,i){debug("retry-mutated callback");b-=1;if(!j||b<0){return g(j,i)}debug("lock retry",e,d);if(d.retryWait){setTimeout(h,d.retryWait)}else{h()}function h(){d.start=Date.now();debug("retrying",d.start);exports.lock(e,d,f)}}})(a)}fs.open(e,wx,function(g,f){if(!g){debug("locked",e,f);locks[e]=f;return fs.close(f,function(){return a()})}if(g.code!=="EEXIST"){return a(g)}if(!d.stale){return notStale(g,e,d,a)}return maybeStale(g,e,d,false,a)})};function maybeStale(b,f,e,d,a){fs.stat(f,function(i,h){if(i){if(i.code==="ENOENT"){e.stale=false;debug("lock stale enoent retry",f,e);exports.lock(f,e,a);return}return a(i)}var g=Date.now()-h[exports.filetime].getTime();if(g<=e.stale){return notStale(b,f,e,a)}debug("lock stale",f,e);if(d){exports.unlock(f,function(j){if(j){return a(j)}debug("lock stale retry",f,e);fs.link(f+".STALE",f,function(k){fs.unlink(f+".STALE",function(){a(k)})})})}else{debug("acquire .STALE file lock",e);exports.lock(f+".STALE",e,function(j){if(j){return a(j)}maybeStale(b,f,e,true,a)})}})}function notStale(j,k,a,f){debug("notStale",k,a);if(typeof a.wait!=="number"||a.wait<=0){return f(j)}var e=Date.now();var d=a.start||e;var g=d+a.wait;if(g<=e){return f(j)}debug("now=%d, wait until %d (delta=%d)",d,g,g-d);var h=Math.min(g-d,a.pollPeriod||100);var b=setTimeout(i,h);function i(){debug("notStale, polling",k,a);exports.lock(k,a,f)}}exports.lockSync=function(g,f){f=f||{};f.req=f.req||req++;debug("lockSync",g,f);if(f.wait||f.retryWait){throw new Error("opts.wait not supported sync for obvious reasons")}try{var e=fs.openSync(g,wx);locks[g]=e;try{fs.closeSync(e)}catch(h){}debug("locked sync!",g,e);return}catch(h){if(h.code!=="EEXIST"){return retryThrow(g,f,h)}if(f.stale){var b=fs.statSync(g);var d=b[exports.filetime].getTime();if(!(d%1000)&&(f.stale%1000)){f.stale=1000*Math.ceil(f.stale/1000)}var a=Date.now()-d;if(a>f.stale){debug("lockSync stale",g,f,a);exports.unlockSync(g);return exports.lockSync(g,f)}}debug("failed to lock",g,f,h);return retryThrow(g,f,h)}};function retryThrow(d,b,e){if(typeof b.retries==="number"&&b.retries>0){var a=b.retries-1;debug("retryThrow",d,b,a);b.retries=a;return exports.lockSync(d,b)}throw e};