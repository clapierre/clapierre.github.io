var lockFile=require("../");var touch=require("touch");var test=require("tap").test;var fs=require("fs");var RETRYWAIT=100;var WAIT=100;var RETRIES=2;var EXPECTTIME=(RETRYWAIT*RETRIES)+(WAIT*(RETRIES+1));var TOOLONG=EXPECTTIME*1.1;test("setup",function(a){touch.sync("file.lock");a.end()});var pollPeriods=[10,100,10000];pollPeriods.forEach(function(a){test("retry+wait, poll="+a,function(b){var e=false;var d=setTimeout(function(){b.fail("taking too long!");e=true;b.end()},2000);d.unref();var c=Date.now();lockFile.lock("file.lock",{wait:WAIT,retries:RETRIES,retryWait:RETRYWAIT,pollPeriod:a},function(g){if(e){return}var f=Date.now()-c;console.error("t=%d",f);b.ok(f>=EXPECTTIME,"should take at least "+EXPECTTIME);b.ok(f<TOOLONG,"should take less than "+TOOLONG);clearTimeout(d);b.end()})})});test("cleanup",function(a){fs.unlinkSync("file.lock");a.end();setTimeout(function(){process.exit(1)},500).unref()});