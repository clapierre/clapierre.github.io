var common=exports,url=require("url"),extend=require("util")._extend,required=require("requires-port");var upgradeHeader=/(^|,)\s*upgrade\s*($|,)/i,isSSL=/^https|wss/;common.isSSL=isSSL;common.setupOutgoing=function(d,c,e,b){d.port=c[b||"target"].port||(isSSL.test(c[b||"target"].protocol)?443:80);["host","hostname","socketPath","pfx","key","passphrase","cert","ca","ciphers","secureProtocol"].forEach(function(h){d[h]=c[b||"target"][h]});d.method=e.method;d.headers=extend({},e.headers);if(c.headers){extend(d.headers,c.headers)}if(c.auth){d.auth=c.auth}if(isSSL.test(c[b||"target"].protocol)){d.rejectUnauthorized=(typeof c.secure==="undefined")?true:c.secure}d.agent=c.agent||false;d.localAddress=c.localAddress;if(!d.agent){d.headers=d.headers||{};if(typeof d.headers.connection!=="string"||!upgradeHeader.test(d.headers.connection)){d.headers.connection="close"}}var f=c[b||"target"];var g=f&&c.prependPath!==false?(f.path||""):"";var a=!c.toProxy?(url.parse(e.url).path||"/"):e.url;a=!c.ignorePath?a:"/";d.path=common.urlJoin(g,a);if(c.changeOrigin){d.headers.host=required(d.port,c[b||"target"].protocol)&&!hasPort(d.host)?d.host+":"+d.port:d.host}return d};common.setupSocket=function(a){a.setTimeout(0);a.setNoDelay(true);a.setKeepAlive(true,0);return a};common.getPort=function(b){var a=b.headers.host?b.headers.host.match(/:(\d+)/):"";return a?a[1]:common.hasEncryptedConnection(b)?"443":"80"};common.hasEncryptedConnection=function(a){return Boolean(a.connection.encrypted||a.connection.pair)};common.urlJoin=function(){var b=Array.prototype.slice.call(arguments),e=b.length-1,d=b[e],a=d.split("?"),c;b[e]=a.shift();c=[b.filter(Boolean).join("/").replace(/\/+/g,"/").replace(/:\//g,"://")];c.push.apply(c,a);return c.join("?")};function hasPort(a){return !!~a.indexOf(":")};