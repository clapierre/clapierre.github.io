var httpProxy=exports,extend=require("util")._extend,parse_url=require("url").parse,EE3=require("eventemitter3"),http=require("http"),https=require("https"),web=require("./passes/web-incoming"),ws=require("./passes/ws-incoming");httpProxy.Server=ProxyServer;function createRightProxy(a){return function(b){return function(h,f){var g=(a==="ws")?this.wsPasses:this.webPasses,c=[].slice.call(arguments),j=c.length-1,e,k;if(typeof c[j]==="function"){k=c[j];j--}if(!(c[j] instanceof Buffer)&&c[j]!==f){b=extend({},b);extend(b,c[j]);j--}if(c[j] instanceof Buffer){e=c[j]}["target","forward"].forEach(function(i){if(typeof b[i]==="string"){b[i]=parse_url(b[i])}});if(!b.target&&!b.forward){return this.emit("error",new Error("Must provide a proper URL as target"))}for(var d=0;d<g.length;d++){if(g[d](h,f,b,e,this,k)){break}}}}}httpProxy.createRightProxy=createRightProxy;function ProxyServer(a){EE3.call(this);a=a||{};a.prependPath=a.prependPath===false?false:true;this.web=this.proxyRequest=createRightProxy("web")(a);this.ws=this.proxyWebsocketRequest=createRightProxy("ws")(a);this.options=a;this.webPasses=Object.keys(web).map(function(b){return web[b]});this.wsPasses=Object.keys(ws).map(function(b){return ws[b]});this.on("error",this.onError,this)}require("util").inherits(ProxyServer,EE3);ProxyServer.prototype.onError=function(a){if(this.listeners("error").length===1){throw a}};ProxyServer.prototype.listen=function(c,b){var a=this,d=function(f,e){a.web(f,e)};this._server=this.options.ssl?https.createServer(this.options.ssl,d):http.createServer(d);if(this.options.ws){this._server.on("upgrade",function(g,e,f){a.ws(g,e,f)})}this._server.listen(c,b);return this};ProxyServer.prototype.close=function(c){var b=this;if(this._server){this._server.close(a)}function a(){b._server=null;if(c){c.apply(null,arguments)}}};ProxyServer.prototype.before=function(b,d,e){if(b!=="ws"&&b!=="web"){throw new Error("type must be `web` or `ws`")}var c=(b==="ws")?this.wsPasses:this.webPasses,a=false;c.forEach(function(g,f){if(g.name===d){a=f}});if(a===false){throw new Error("No such pass")}c.splice(a,0,e)};ProxyServer.prototype.after=function(b,d,e){if(b!=="ws"&&b!=="web"){throw new Error("type must be `web` or `ws`")}var c=(b==="ws")?this.wsPasses:this.webPasses,a=false;c.forEach(function(g,f){if(g.name===d){a=f}});if(a===false){throw new Error("No such pass")}c.splice(a++,0,e)};