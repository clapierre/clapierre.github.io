var http=require("http"),https=require("https"),common=require("../common"),passes=exports,passes=exports;[function(e,o){return"GET"===e.method&&e.headers.upgrade?"websocket"!==e.headers.upgrade.toLowerCase()?(o.destroy(),!0):void 0:(o.destroy(),!0)},function(e,o,r){if(r.xfwd){var t={"for":e.connection.remoteAddress||e.socket.remoteAddress,port:common.getPort(e),proto:common.hasEncryptedConnection(e)?"wss":"ws"};["for","port","proto"].forEach(function(o){e.headers["x-forwarded-"+o]=(e.headers["x-forwarded-"+o]||"")+(e.headers["x-forwarded-"+o]?",":"")+t[o]})}},function(e,o,r,t,n,s){function c(r){s?s(r,e,o):n.emit("error",r,e,o),o.end()}common.setupSocket(o),t&&t.length&&o.unshift(t);var i=(common.isSSL.test(r.target.protocol)?https:http).request(common.setupOutgoing(r.ssl||{},r,e));return i.on("error",c),i.on("response",function(e){e.upgrade||o.end()}),i.on("upgrade",function(e,r,t){r.on("error",c),r.on("end",function(){n.emit("close",e,r,t)}),o.on("error",function(){r.end()}),common.setupSocket(r),t&&t.length&&r.unshift(t),o.write("HTTP/1.1 101 Switching Protocols\r\n"),o.write(Object.keys(e.headers).map(function(o){return o+": "+e.headers[o]}).join("\r\n")+"\r\n\r\n"),r.pipe(o).pipe(r),n.emit("open",r),n.emit("proxySocket",r)}),i.end()}].forEach(function(e){passes[e.name]=e});