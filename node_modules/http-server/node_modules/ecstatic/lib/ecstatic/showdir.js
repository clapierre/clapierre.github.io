var ecstatic=require("../ecstatic"),fs=require("fs"),path=require("path"),he=require("he"),etag=require("./etag"),url=require("url"),status=require("./status-handlers");module.exports=function(a,d){var b=a.cache,g=path.resolve(a.root),h=a.baseDir,f=a.humanReadable,c=a.handleError,e=a.si;return function i(n,l,m){var j=url.parse(n.url),o=decodeURIComponent(j.pathname),k=path.normalize(path.join(g,path.relative(path.join("/",h),o)));fs.stat(k,function(q,p){if(q){return c?status[500](l,m,{error:q}):m()}fs.readdir(k,function(u,t){if(u){return c?status[500](l,m,{error:u}):m()}l.setHeader("content-type","text/html");l.setHeader("etag",etag(p));l.setHeader("last-modified",(new Date(p.mtime)).toUTCString());l.setHeader("cache-control",b);r(t,function(v,x,w){if(path.resolve(k,"..").slice(0,g.length)==g){return fs.stat(path.join(k,".."),function(z,y){if(z){return c?status[500](l,m,{error:z}):m()}x.unshift(["..",y]);s(x,w,v)})}s(x,w,v)});function r(A,v){var z=A.length,w=[],y=[],x=[];if(!z){return v(w,y,x)}A.forEach(function(B){fs.stat(path.join(k,B),function(D,C){if(D){w.push([B,D])}else{if(C.isDirectory()){y.push([B,C])}else{x.push([B,C])}}if(--z===0){v(w,y,x)}})})}function s(A,z,y){var x=["<!doctype html>","<html>","  <head>",'    <meta charset="utf-8">','    <meta name="viewport" content="width=device-width">',"    <title>Index of "+o+"</title>","  </head>","  <body>","<h1>Index of "+o+"</h1>"].join("\n")+"\n";x+="<table>";var w=false;var v=function(E,D){var F=E[1].isDirectory&&E[1].isDirectory();var C=j.pathname.replace(/\/$/,"")+"/"+encodeURI(E[0]);if(F){C+="/"+((j.search)?j.search:"")}var B=he.encode(E[0])+((F)?"/":"");x+="<tr><td><code>("+permsToString(E[1])+')</code></td><td style="text-align: right; padding-left: 1em"><code>'+sizeToString(E[1],f,e)+'</code></td><td style="padding-left: 1em"><a href="'+C+'">'+B+"</a></td></tr>\n"};A.sort(function(C,B){return C[0].toString().localeCompare(B[0].toString())}).forEach(v);z.sort(function(C,B){return C.toString().localeCompare(B.toString())}).forEach(v);y.sort(function(C,B){return C[0].toString().localeCompare(B[0].toString())}).forEach(v);x+="</table>\n";x+="<br><address>Node.js "+process.version+'/ <a href="https://github.com/jesusabdullah/node-ecstatic">ecstatic</a> server running @ '+he.encode(n.headers.host||"")+"</address>\n</body></html>";if(!w){l.writeHead(200,{"Content-Type":"text/html"});l.end(x)}}})})}};function permsToString(b){if(!b.isDirectory||!b.mode){return"???!!!???"}var a=b.isDirectory()?"d":"-",c=b.mode.toString(8);return a+c.slice(-3).split("").map(function(d){return["---","--x","-w-","-wx","r--","r-x","rw-","rwx"][parseInt(d,10)]}).join("")}function sizeToString(c,g,d){if(c.isDirectory&&c.isDirectory()){return""}var a="";var j=c.size;var e=d?1000:1024;if(!g||j<e){return j+"B"}var f=["k","M","G","T","P","E","Z","Y"];var i=-1;do{j/=e;++i}while(j>=e);var h=j.toFixed(1);if(isNaN(h)){h="??"}return h+f[i]};