var util=require("util"),HttpStream=require("./http-stream");var ResponseStream=module.exports=function(b){var a=this,c;b=b||{};HttpStream.call(this,b);this.writeable=true;this.response=b.response;if(b.headers){for(c in b.headers){this.response.setHeader(c,b.headers[c])}}Object.defineProperty(this,"statusCode",{get:function(){return a.response.statusCode},set:function(d){a.response.statusCode=d},enumerable:true,configurable:true});if(this.response){this._headers=this.response._headers=this.response._headers||{};this.response._headerNames=this.response._headerNames||{};this._renderHeaders=this.response._renderHeaders;this.response._renderHeaders=function(){if(!a._emittedHeader){a._emittedHeader=true;a.headerSent=true;a._header=true;a.emit("header")}return a._renderHeaders.call(a.response)}}};util.inherits(ResponseStream,HttpStream);ResponseStream.prototype.writeHead=function(b,c){if(c){for(var a in c){this.response.setHeader(a,c[a])}}this.response.statusCode=b};["setHeader","getHeader","removeHeader","_implicitHeader","addTrailers"].forEach(function(a){ResponseStream.prototype[a]=function(){return this.response[a].apply(this.response,arguments)}});ResponseStream.prototype.json=function(a){if(!this.response.writable){return}if(typeof a==="number"){this.response.statusCode=a;a=arguments[1]}this.modified=true;if(!this.response._header&&this.response.getHeader("content-type")!=="application/json"){this.response.setHeader("content-type","application/json")}this.end(a?JSON.stringify(a):"")};ResponseStream.prototype.html=function(a){if(!this.response.writable){return}if(typeof a==="number"){this.response.statusCode=a;a=arguments[1]}this.modified=true;if(!this.response._header&&this.response.getHeader("content-type")!=="text/html"){this.response.setHeader("content-type","text/html")}this.end(a?a:"")};ResponseStream.prototype.text=function(a){if(!this.response.writable){return}if(typeof a==="number"){this.response.statusCode=a;a=arguments[1]}this.modified=true;if(!this.response._header&&this.response.getHeader("content-type")!=="text/plain"){this.response.setHeader("content-type","text/plain")}this.end(a?a:"")};ResponseStream.prototype.end=function(a){if(a&&this.writable){this.emit("data",a)}this.modified=true;this.emit("end")};ResponseStream.prototype.write=function(a){this.modified=true;if(this.writable){this.emit("data",a)}};ResponseStream.prototype.redirect=function(c,a){var b="";if(~c.indexOf("://")){b=c}else{b+=this.req.connection.encrypted?"https://":"http://";b+=this.req.headers.host;b+=(c[0]==="/")?c:"/"+c}this.res.writeHead(a||302,{Location:b});this.end()};