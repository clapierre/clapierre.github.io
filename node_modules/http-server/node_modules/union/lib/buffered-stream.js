var events=require("events"),fs=require("fs"),stream=require("stream"),util=require("util");var BufferedStream=module.exports=function(a){events.EventEmitter.call(this);if(typeof a==="undefined"){a=Infinity}this.limit=a;this.size=0;this.chunks=[];this.writable=true;this.readable=true;this._buffer=true};util.inherits(BufferedStream,stream.Stream);Object.defineProperty(BufferedStream.prototype,"buffer",{get:function(){return this._buffer},set:function(b){if(!b&&this.chunks){var a=this;this.chunks.forEach(function(d){a.emit("data",d)});if(this.ended){this.emit("end")}this.size=0;delete this.chunks}this._buffer=b}});BufferedStream.prototype.pipe=function(){var a=this,b;if(a.resume){a.resume()}b=stream.Stream.prototype.pipe.apply(a,arguments);if(this.piped){return b}process.nextTick(function(){if(a.chunks){a.chunks.forEach(function(d){a.emit("data",d)});a.size=0;delete a.chunks}if(!a.readable){if(a.ended){a.emit("end")}else{if(a.closed){a.emit("close")}}}});this.piped=true;return b};BufferedStream.prototype.write=function(a){if(!this.chunks||this.piped){this.emit("data",a);return}this.chunks.push(a);this.size+=a.length;if(this.limit<this.size){this.pause()}};BufferedStream.prototype.end=function(){this.readable=false;this.ended=true;this.emit("end")};BufferedStream.prototype.destroy=function(){this.readable=false;this.writable=false;delete this.chunks};BufferedStream.prototype.close=function(){this.readable=false;this.closed=true};if(!stream.Stream.prototype.pause){BufferedStream.prototype.pause=function(){this.emit("pause")}}if(!stream.Stream.prototype.resume){BufferedStream.prototype.resume=function(){this.emit("resume")}};