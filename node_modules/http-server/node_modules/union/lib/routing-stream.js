var util=require("util"),union=require("./index"),RequestStream=require("./request-stream"),ResponseStream=require("./response-stream");var RoutingStream=module.exports=function(a){a=a||{};RequestStream.call(this,a);this.before=a.before||[];this.after=a.after||[];this.response=a.response||a.res;this.headers=a.headers||{"x-powered-by":"union "+union.version};this.target=new ResponseStream({response:this.response,headers:this.headers});this.once("pipe",this.route)};util.inherits(RoutingStream,RequestStream);RoutingStream.prototype.route=function(f){var a=this,g,c,d;this.target.writable=f.method!=="HEAD";g=[this.target].concat(this.after,this.response);for(d=0;d<g.length-1;d++){g[d].req=f;g[d+1].req=f;g[d].res=this.response;g[d+1].res=this.response;g[d].pipe(g[d+1]);g[d].on("error",this.onError)}function e(){c=new Error("Not found");c.status=404;a.onError(c)}(function b(h){if(a.target.modified){return}else{if(++h===a.before.length){return e()}}a.target.once("next",b.bind(null,h));if(a.before[h].length===3){a.before[h](a,a.target,function(i){if(i){a.onError(i)}else{a.target.emit("next")}})}else{a.before[h](a,a.target)}})(-1)};RoutingStream.prototype.onError=function(a){this.emit("error",a)};