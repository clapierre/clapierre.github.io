var path=require("path"),util=require("util"),fs=require("fs"),async=require("async"),mkdirp=require("mkdirp"),writer=require("./writer"),Writer=writer.Writer,ContentWriter=writer.ContentWriter;function extend(a,b){Object.keys(b).forEach(function(c){a.prototype[c]=b[c]})}function BufferedContentWriter(){ContentWriter.call(this);this.content=""}util.inherits(BufferedContentWriter,ContentWriter);extend(BufferedContentWriter,{write:function(a){this.content+=a},getContent:function(){return this.content}});function StreamContentWriter(a){ContentWriter.call(this);this.stream=a}util.inherits(StreamContentWriter,ContentWriter);extend(StreamContentWriter,{write:function(a){this.stream.write(a)}});function SyncFileWriter(){Writer.call(this)}util.inherits(SyncFileWriter,Writer);extend(SyncFileWriter,{writeFile:function(b,c){mkdirp.sync(path.dirname(b));var a=new BufferedContentWriter();c(a);fs.writeFileSync(b,a.getContent(),"utf8")},done:function(){this.emit("done")}});function AsyncFileWriter(){this.queue=async.queue(this.processFile.bind(this),20);this.openFileMap={}}util.inherits(AsyncFileWriter,Writer);extend(AsyncFileWriter,{writeFile:function(a,b){this.openFileMap[a]=true;this.queue.push({file:a,callback:b})},processFile:function(d,a){var e=d.file,b=d.callback,f=this,g,c;mkdirp.sync(path.dirname(e));g=fs.createWriteStream(e);g.on("close",function(){delete f.openFileMap[e];a();f.checkDone()});g.on("error",function(h){f.emit("error",h)});c=new StreamContentWriter(g);b(c);g.end()},done:function(){this.doneCalled=true;this.checkDone()},checkDone:function(){if(!this.doneCalled){return}if(Object.keys(this.openFileMap).length===0){this.emit("done")}}});function FileWriter(b){Writer.call(this);var a=this;this.delegate=b?new SyncFileWriter():new AsyncFileWriter();this.delegate.on("error",function(c){a.emit("error",c)});this.delegate.on("done",function(){a.emit("done")})}util.inherits(FileWriter,Writer);extend(FileWriter,{copyFile:function(b,a){mkdirp.sync(path.dirname(a));fs.writeFileSync(a,fs.readFileSync(b))},writeFile:function(a,b){this.delegate.writeFile(a,b)},done:function(){this.delegate.done()}});module.exports=FileWriter;