var path=require("path"),fs=require("fs"),Module=require("module"),vm=require("vm"),originalLoaders={},originalCreateScript=vm.createScript,originalRunInThisContext=vm.runInThisContext;function transformFn(c,a,b){return function(h,d){var g=typeof d==="string"&&c(path.resolve(d)),e,i=false;if(g){if(b){console.error("Module load hook: transform ["+d+"]")}try{e=a(h,d);i=true}catch(f){console.error("Transformation error; return original code");console.error(f);e=h}}else{e=h}return{code:e,changed:i}}}function unloadRequireCache(a){if(a&&typeof require!=="undefined"&&require&&require.cache){Object.keys(require.cache).forEach(function(b){if(a(b)){delete require.cache[b]}})}}function hookRequire(f,b,c){c=c||{};var e,d=transformFn(f,b,c.verbose),a=c.postLoadHook&&typeof c.postLoadHook==="function"?c.postLoadHook:null;e=c.extensions||[".js"];e.forEach(function(g){if(!(g in originalLoaders)){originalLoaders[g]=Module._extensions[g]||Module._extensions[".js"]}Module._extensions[g]=function(j,h){var i=d(fs.readFileSync(h,"utf8"),h);if(i.changed){j._compile(i.code,h)}else{originalLoaders[g](j,h)}if(a){a(h)}}})}function unhookRequire(){Object.keys(originalLoaders).forEach(function(a){Module._extensions[a]=originalLoaders[a]})}function hookCreateScript(d,a,c){c=c||{};var b=transformFn(d,a,c.verbose);vm.createScript=function(g,f){var e=b(g,f);return originalCreateScript(e.code,f)}}function unhookCreateScript(){vm.createScript=originalCreateScript}function hookRunInThisContext(d,a,c){c=c||{};var b=transformFn(d,a,c.verbose);vm.runInThisContext=function(g,f){var e=b(g,f);return originalRunInThisContext(e.code,f)}}function unhookRunInThisContext(){vm.runInThisContext=originalRunInThisContext}module.exports={hookRequire:hookRequire,unhookRequire:unhookRequire,hookCreateScript:hookCreateScript,unhookCreateScript:unhookCreateScript,hookRunInThisContext:hookRunInThisContext,unhookRunInThisContext:unhookRunInThisContext,unloadRequireCache:unloadRequireCache};