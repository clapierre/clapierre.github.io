var nopt=require("nopt"),Report=require("../report"),Reporter=require("../reporter"),path=require("path"),fs=require("fs"),Collector=require("../collector"),helpFormatter=require("../util/help-formatter"),formatOption=helpFormatter.formatOption,formatPara=helpFormatter.formatPara,filesFor=require("../util/file-matcher").filesFor,util=require("util"),Command=require("./index"),configuration=require("../config");function ReportCommand(){Command.call(this)}ReportCommand.TYPE="report";util.inherits(ReportCommand,Command);function printDeprecationMessage(b,a){console.error("**********************************************************************");console.error("DEPRECATION WARNING! You are probably using the old format of the report command");console.error("This will stop working soon, see `istanbul help report` for the new command format");console.error("Assuming you meant: istanbul report --include="+b+" "+a);console.error("**********************************************************************")}Command.mix(ReportCommand,{synopsis:function(){return"writes reports for coverage JSON objects produced in a previous run"},usage:function(){console.error("\nUsage: "+this.toolName()+" "+this.type()+" <options> [ <format> ... ]\n\nOptions are:\n\n"+[formatOption("--config <path-to-config>","the configuration file to use, defaults to .istanbul.yml"),formatOption("--root <input-directory>","The input root directory for finding coverage files"),formatOption("--dir <report-directory>","The output directory where files will be written. This defaults to ./coverage/"),formatOption("--include <glob>","The fileset pattern to select one or more coverage files, defaults to **/coverage*.json"),formatOption("--verbose, -v","verbose mode")].join("\n\n"));console.error("\n");console.error("<format> is one of ");Report.getReportList().forEach(function(a){console.error(formatOption(a,Report.create(a).synopsis()))});console.error("");console.error(formatPara(["Default format is lcov unless otherwise specified in the config file.","In addition you can tweak the file names for various reports using the config file.","Type `istanbul help config` to see what can be tweaked."].join(" ")));console.error("\n")},run:function(f,j){var i={config:path,root:path,dir:path,include:String,verbose:Boolean},a=nopt(i,{v:"--verbose"},f,0),d=a.include||"**/coverage*.json",h,e=new Collector(),b=configuration.loadFile(a.config,{verbose:a.verbose,reporting:{dir:a.dir}}),g=a.argv.remain,c=new Reporter(b);if(g.length===2&&Report.getReportList().indexOf(g[1])<0){d=g[1];g=[g[0]];printDeprecationMessage(d,g[0])}if(g.length===0){g=b.reporting.reports()}if(g.length===0){g=["lcov"]}c.addAll(g);h=a.root||process.cwd();filesFor({root:h,includes:[d]},function(l,k){if(l){throw l}k.forEach(function(n){var m=JSON.parse(fs.readFileSync(n,"utf8"));e.add(m)});c.write(e,false,function(m){console.log("Done");return j(m)})})}});module.exports=ReportCommand;