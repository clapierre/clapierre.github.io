var path=require("path"),mkdirp=require("mkdirp"),util=require("util"),fs=require("fs"),defaults=require("./common/defaults"),Report=require("./index"),TreeSummarizer=require("../util/tree-summarizer"),utils=require("../object-utils"),PCT_COLS=9,MISSING_COL=15,TAB_SIZE=1,DELIM=" |",COL_DELIM="-|";function TextReport(a){Report.call(this);a=a||{};this.dir=a.dir||process.cwd();this.file=a.file;this.summary=a.summary;this.maxCols=a.maxCols||0;this.watermarks=a.watermarks||defaults.watermarks()}TextReport.TYPE="text";util.inherits(TextReport,Report);function padding(a,c){var d="",b;c=c||" ";for(b=0;b<a;b+=1){d+=c}return d}function fill(g,a,j,i,e){i=i||0;g=String(g);var b=i*TAB_SIZE,d=a-b,h=padding(b),c="",f,k=g.length;if(d>0){if(d>=k){f=padding(d-k);c=j?f+g:g+f}else{c=g.substring(k-d);c="... "+c.substring(4)}}c=defaults.colorize(c,e);return h+c}function formatName(c,b,d,a){return fill(c,b,false,d,a)}function formatPct(c,a,b){return fill(c,b||PCT_COLS,true,0,a)}function nodeName(a){return a.displayShortName()||"All files"}function tableHeader(b){var a=[];a.push(formatName("File",b,0));a.push(formatPct("% Stmts"));a.push(formatPct("% Branch"));a.push(formatPct("% Funcs"));a.push(formatPct("% Lines"));a.push(formatPct("Uncovered Lines",undefined,MISSING_COL));return a.join(" |")+" |"}function collectMissingLines(c,b){var a=[];if(c!=="file"){return[]}Object.keys(b).forEach(function(d){if(!b[d]){a.push(d)}});return a}function tableRow(e,h,b,g){var c=nodeName(e),i=e.metrics.statements.pct,j=e.metrics.branches.pct,f=e.metrics.functions.pct,k=e.metrics.lines.pct,d=collectMissingLines(e.kind,e.metrics.linesCovered),a=[];a.push(formatName(c,h,b,defaults.classFor("statements",e.metrics,g)));a.push(formatPct(i,defaults.classFor("statements",e.metrics,g)));a.push(formatPct(j,defaults.classFor("branches",e.metrics,g)));a.push(formatPct(f,defaults.classFor("functions",e.metrics,g)));a.push(formatPct(k,defaults.classFor("lines",e.metrics,g)));a.push(formatPct(d.join(","),"low",MISSING_COL));return a.join(DELIM)+DELIM}function findNameWidth(c,d,b){b=b||0;d=d||0;var a=TAB_SIZE*d+nodeName(c).length;if(a>b){b=a}c.children.forEach(function(e){b=findNameWidth(e,d+1,b)});return b}function makeLine(d){var a=padding(d,"-"),c=padding(PCT_COLS,"-"),b=[];b.push(a);b.push(c);b.push(c);b.push(c);b.push(c);b.push(padding(MISSING_COL,"-"));return b.join(COL_DELIM)+COL_DELIM}function walk(c,d,f,e,a){var b;if(e===0){b=makeLine(d);f.push(b);f.push(tableHeader(d));f.push(b)}else{f.push(tableRow(c,d,e,a))}c.children.forEach(function(g){walk(g,d,f,e+1,a)});if(e===0){f.push(b);f.push(tableRow(c,d,e,a));f.push(b)}}Report.mix(TextReport,{synopsis:function(){return"text report that prints a coverage line for every file, typically to console"},getDefaultConfig:function(){return{file:null,maxCols:0}},writeReport:function(d){var b=new TreeSummarizer(),i,e,a,c=4*(PCT_COLS+2)+MISSING_COL,f,g=[],h;d.files().forEach(function(j){b.addFileCoverageSummary(j,utils.summarizeFileCoverage(d.fileCoverageFor(j)))});i=b.getTreeSummary();e=i.root;a=findNameWidth(e);if(this.maxCols>0){f=this.maxCols-c-2;if(a>f){a=f}}walk(e,a,g,0,this.watermarks);h=g.join("\n")+"\n";if(this.file){mkdirp.sync(this.dir);fs.writeFileSync(path.join(this.dir,this.file),h,"utf8")}else{console.log(h)}this.emit("done")}});module.exports=TextReport;