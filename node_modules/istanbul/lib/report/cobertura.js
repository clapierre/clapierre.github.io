var path=require("path"),util=require("util"),Report=require("./index"),FileWriter=require("../util/file-writer"),TreeSummarizer=require("../util/tree-summarizer"),utils=require("../object-utils");function CoberturaReport(a){Report.call(this);a=a||{};this.projectRoot=process.cwd();this.dir=a.dir||this.projectRoot;this.file=a.file||this.getDefaultConfig().file;this.opts=a}CoberturaReport.TYPE="cobertura";util.inherits(CoberturaReport,Report);function asJavaPackage(a){return a.displayShortName().replace(/\//g,".").replace(/\\/g,".").replace(/\.$/,"")}function asClassName(a){return a.fullPath().replace(/.*[\\\/]/,"")}function quote(a){return'"'+a+'"'}function attr(b,a){return" "+b+"="+quote(a)+" "}function branchCoverageByLine(d){var a=d.branchMap,b=d.b,c={};Object.keys(a).forEach(function(f){var e=a[f].line,g=b[f];c[e]=c[e]||[];c[e].push.apply(c[e],g)});Object.keys(c).forEach(function(g){var e=c[g],f=e.filter(function(i){return i>0}),h=f.length/e.length*100;c[g]={covered:f.length,total:e.length,coverage:h}});return c}function addClassStats(e,g,f,b){g=utils.incrementIgnoredTotals(g);var d=e.metrics,h=branchCoverageByLine(g),a,c;f.println("\t\t<class"+attr("name",asClassName(e))+attr("filename",path.relative(b,e.fullPath()))+attr("line-rate",d.lines.pct/100)+attr("branch-rate",d.branches.pct/100)+">");f.println("\t\t<methods>");a=g.fnMap;Object.keys(a).forEach(function(j){var l=a[j].name,i=g.f[j];f.println("\t\t\t<method"+attr("name",l)+attr("hits",i)+attr("signature","()V")+">");f.println("\t\t\t\t<lines><line"+attr("number",a[j].line)+attr("hits",g.f[j])+"/></lines>");f.println("\t\t\t</method>")});f.println("\t\t</methods>");f.println("\t\t<lines>");c=g.l;Object.keys(c).forEach(function(j){var l="\t\t\t<line"+attr("number",j)+attr("hits",c[j]),i=h[j];if(!i){l+=attr("branch",false)}else{l+=attr("branch",true)+attr("condition-coverage",i.coverage+"% ("+i.covered+"/"+i.total+")")}f.println(l+"/>")});f.println("\t\t</lines>");f.println("\t\t</class>")}function walk(c,e,d,f,a){var b;if(f===0){b=c.metrics;d.println('<?xml version="1.0" ?>');d.println('<!DOCTYPE coverage SYSTEM "http://cobertura.sourceforge.net/xml/coverage-04.dtd">');d.println("<coverage"+attr("lines-valid",b.lines.total)+attr("lines-covered",b.lines.covered)+attr("line-rate",b.lines.pct/100)+attr("branches-valid",b.branches.total)+attr("branches-covered",b.branches.covered)+attr("branch-rate",b.branches.pct/100)+attr("timestamp",Date.now())+'complexity="0" version="0.1">');d.println("<sources>");d.println("\t<source>"+a+"</source>");d.println("</sources>");d.println("<packages>")}if(c.packageMetrics){b=c.packageMetrics;d.println("\t<package"+attr("name",asJavaPackage(c))+attr("line-rate",b.lines.pct/100)+attr("branch-rate",b.branches.pct/100)+">");d.println("\t<classes>");c.children.filter(function(g){return g.kind!=="dir"}).forEach(function(g){addClassStats(g,e.fileCoverageFor(g.fullPath()),d,a)});d.println("\t</classes>");d.println("\t</package>")}c.children.filter(function(g){return g.kind==="dir"}).forEach(function(g){walk(g,e,d,f+1,a)});if(f===0){d.println("</packages>");d.println("</coverage>")}}Report.mix(CoberturaReport,{synopsis:function(){return"XML coverage report that can be consumed by the cobertura tool"},getDefaultConfig:function(){return{file:"cobertura-coverage.xml"}},writeReport:function(c,h){var a=new TreeSummarizer(),e=path.join(this.dir,this.file),b=this.opts.writer||new FileWriter(h),f=this.projectRoot,d=this,i,g;c.files().forEach(function(j){a.addFileCoverageSummary(j,utils.summarizeFileCoverage(c.fileCoverageFor(j)))});i=a.getTreeSummary();g=i.root;b.on("done",function(){d.emit("done")});b.writeFile(e,function(j){walk(g,c,j,0,f);b.done()})}});module.exports=CoberturaReport;