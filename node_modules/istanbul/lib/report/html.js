var handlebars=require("handlebars"),defaults=require("./common/defaults"),path=require("path"),fs=require("fs"),util=require("util"),FileWriter=require("../util/file-writer"),Report=require("./index"),Store=require("../store"),InsertionText=require("../util/insertion-text"),TreeSummarizer=require("../util/tree-summarizer"),utils=require("../object-utils"),templateFor=function(a){return handlebars.compile(fs.readFileSync(path.resolve(__dirname,"templates",a+".txt"),"utf8"))},headerTemplate=templateFor("head"),footerTemplate=templateFor("foot"),pathTemplate=handlebars.compile('<div class="path">{{{html}}}</div>'),detailTemplate=handlebars.compile(["<tr>",'<td class="line-count">{{#show_lines}}{{maxLines}}{{/show_lines}}</td>','<td class="line-coverage">{{#show_line_execution_counts fileCoverage}}{{maxLines}}{{/show_line_execution_counts}}</td>','<td class="text"><pre class="prettyprint lang-js">{{#show_code structured}}{{/show_code}}</pre></td>',"</tr>\n"].join("")),summaryTableHeader=['<div class="coverage-summary">',"<table>","<thead>","<tr>",'   <th data-col="file" data-fmt="html" data-html="true" class="file">File</th>','   <th data-col="pic" data-type="number" data-fmt="html" data-html="true" class="pic"></th>','   <th data-col="statements" data-type="number" data-fmt="pct" class="pct">Statements</th>','   <th data-col="statements_raw" data-type="number" data-fmt="html" class="abs"></th>','   <th data-col="branches" data-type="number" data-fmt="pct" class="pct">Branches</th>','   <th data-col="branches_raw" data-type="number" data-fmt="html" class="abs"></th>','   <th data-col="functions" data-type="number" data-fmt="pct" class="pct">Functions</th>','   <th data-col="functions_raw" data-type="number" data-fmt="html" class="abs"></th>','   <th data-col="lines" data-type="number" data-fmt="pct" class="pct">Lines</th>','   <th data-col="lines_raw" data-type="number" data-fmt="html" class="abs"></th>',"</tr>","</thead>","<tbody>"].join("\n"),summaryLineTemplate=handlebars.compile(["<tr>",'<td class="file {{reportClasses.statements}}" data-value="{{file}}"><a href="{{output}}">{{file}}</a></td>','<td data-value="{{metrics.statements.pct}}" class="pic {{reportClasses.statements}}">{{#show_picture}}{{metrics.statements.pct}}{{/show_picture}}</td>','<td data-value="{{metrics.statements.pct}}" class="pct {{reportClasses.statements}}">{{metrics.statements.pct}}%</td>','<td data-value="{{metrics.statements.total}}" class="abs {{reportClasses.statements}}">({{metrics.statements.covered}}&nbsp;/&nbsp;{{metrics.statements.total}})</td>','<td data-value="{{metrics.branches.pct}}" class="pct {{reportClasses.branches}}">{{metrics.branches.pct}}%</td>','<td data-value="{{metrics.branches.total}}" class="abs {{reportClasses.branches}}">({{metrics.branches.covered}}&nbsp;/&nbsp;{{metrics.branches.total}})</td>','<td data-value="{{metrics.functions.pct}}" class="pct {{reportClasses.functions}}">{{metrics.functions.pct}}%</td>','<td data-value="{{metrics.functions.total}}" class="abs {{reportClasses.functions}}">({{metrics.functions.covered}}&nbsp;/&nbsp;{{metrics.functions.total}})</td>','<td data-value="{{metrics.lines.pct}}" class="pct {{reportClasses.lines}}">{{metrics.lines.pct}}%</td>','<td data-value="{{metrics.lines.total}}" class="abs {{reportClasses.lines}}">({{metrics.lines.covered}}&nbsp;/&nbsp;{{metrics.lines.total}})</td>',"</tr>\n"].join("\n\t")),summaryTableFooter=["</tbody>","</table>","</div>"].join("\n"),lt="\u0001",gt="\u0002",RE_LT=/</g,RE_GT=/>/g,RE_AMP=/&/g,RE_lt=/\u0001/g,RE_gt=/\u0002/g;handlebars.registerHelper("show_picture",function(d){var b=Number(d.fn(this)),c,a="";if(isFinite(b)){if(b===100){a=" cover-full"}b=Math.floor(b);c=100-b;return'<span class="cover-fill'+a+'" style="width: '+b+'px;"></span><span class="cover-empty" style="width:'+c+'px;"></span>'}else{return""}});handlebars.registerHelper("show_ignores",function(d){var c=d.statements.skipped,e=d.functions.skipped,b=d.branches.skipped,a;if(c===0&&e===0&&b===0){return'<span class="ignore-none">none</span>'}a=[];if(c>0){a.push(c===1?"1 statement":c+" statements")}if(e>0){a.push(e===1?"1 function":e+" functions")}if(b>0){a.push(b===1?"1 branch":b+" branches")}return a.join(", ")});handlebars.registerHelper("show_lines",function(c){var a=Number(c.fn(this)),b,d=[];for(b=0;b<a;b+=1){d[b]=b+1}return d.join("\n")});handlebars.registerHelper("show_line_execution_counts",function(b,a){var j=b.l,g=Number(a.fn(this)),d,c,f=[],e,h="";for(d=0;d<g;d+=1){c=d+1;h="&nbsp;";e="neutral";if(j.hasOwnProperty(c)){if(j[c]>0){e="yes";h=j[c]}else{e="no"}}f.push('<span class="cline-any cline-'+e+'">'+h+"</span>")}return f.join("\n")});function customEscape(a){a=a.toString();return a.replace(RE_AMP,"&amp;").replace(RE_LT,"&lt;").replace(RE_GT,"&gt;").replace(RE_lt,"<").replace(RE_gt,">")}handlebars.registerHelper("show_code",function(a){var b=[];a.forEach(function(c){b.push(customEscape(c.text)||"&nbsp;")});return b.join("\n")});function title(a){return' title="'+a+'" '}function annotateLines(b,a){var c=b.l;if(!c){return}Object.keys(c).forEach(function(d){var e=c[d];if(a[d]){a[d].covered=e>0?"yes":"no"}});a.forEach(function(d){if(d.covered===null){d.covered="neutral"}})}function annotateStatements(d,b){var a=d.s,c=d.statementMap;Object.keys(a).forEach(function(k){var i=a[k],o=c[k],l=i>0?"yes":"no",e=o.start.column,j=o.end.column+1,n=o.start.line,g=o.end.line,h=lt+'span class="'+(o.skip?"cstat-skip":"cstat-no")+'"'+title("statement not covered")+gt,f=lt+"/span"+gt,m;if(l==="no"){if(g!==n){g=n;j=b[n].text.originalLength()}m=b[n].text;m.wrap(e,h,n===g?j:m.originalLength(),f)}})}function annotateFunctions(d,c){var a=d.f,b=d.fnMap;if(!a){return}Object.keys(a).forEach(function(i){var j=a[i],o=b[i],l=j>0?"yes":"no",e=o.loc.start.column,k=o.loc.end.column+1,n=o.loc.start.line,g=o.loc.end.line,h=lt+'span class="'+(o.skip?"fstat-skip":"fstat-no")+'"'+title("function not covered")+gt,f=lt+"/span"+gt,m;if(l==="no"){if(g!==n){g=n;k=c[n].text.originalLength()}m=c[n].text;m.wrap(e,h,n===g?k:m.originalLength(),f)}})}function annotateBranches(d,c){var a=d.b,b=d.branchMap;if(!a){return}Object.keys(a).forEach(function(n){var k=a[n],p=k.reduce(function(i,u){return i+u},0),f=b[n].locations,l,m,t,q,e,o,s,h,j,g,r;if(p>0){for(l=0;l<k.length;l+=1){m=k[l];t=f[l];q=m>0?"yes":"no";e=t.start.column;o=t.end.column+1;s=t.start.line;h=t.end.line;j=lt+'span class="branch-'+l+" "+(t.skip?"cbranch-skip":"cbranch-no")+'"'+title("branch not covered")+gt;g=lt+"/span"+gt;if(m===0){if(h!==s){h=s;o=c[s].text.originalLength()}r=c[s].text;if(b[n].type==="if"){r.insertAt(e,lt+'span class="'+(t.skip?"skip-if-branch":"missing-if-branch")+'"'+title((l===0?"if":"else")+" path not taken")+gt+(l===0?"I":"E")+lt+"/span"+gt,true,false)}else{r.wrap(e,j,s===h?o:r.originalLength(),g)}}}}})}function getReportClass(d,b){var a=d.pct,c=1;if(a*c===a){return a>=b[1]?"high":a>=b[0]?"medium":"low"}else{return""}}function cleanPath(b){var a=path.sep||"/";return(a!=="/")?b.split(a).join("/"):b}function isEmptySourceStore(b){if(!b){return true}var a=b.sourceCache;return a&&!Object.keys(a).length}function HtmlReport(a){Report.call(this);this.opts=a||{};this.opts.dir=this.opts.dir||path.resolve(process.cwd(),"html-report");this.opts.sourceStore=isEmptySourceStore(this.opts.sourceStore)?Store.create("fslookup"):this.opts.sourceStore;this.opts.linkMapper=this.opts.linkMapper||this.standardLinkMapper();this.opts.writer=this.opts.writer||null;this.opts.templateData={datetime:Date()};this.opts.watermarks=this.opts.watermarks||defaults.watermarks()}HtmlReport.TYPE="html";util.inherits(HtmlReport,Report);Report.mix(HtmlReport,{synopsis:function(){return"Navigable HTML coverage report for every file and directory"},getPathHtml:function(e,f){var d=e.parent,c=[],a=[],b;while(d){c.push(d);d=d.parent}for(b=0;b<c.length;b+=1){a.push('<a href="'+f.ancestor(e,b+1)+'">'+(cleanPath(c[b].relativeName)||"All files")+"</a>")}a.reverse();return a.length>0?a.join(" &#187; ")+" &#187; "+cleanPath(e.displayShortName()):""},fillTemplate:function(c,a){var b=this.opts,d=b.linkMapper;a.entity=c.name||"All files";a.metrics=c.metrics;a.reportClass=getReportClass(c.metrics.statements,b.watermarks.statements);a.pathHtml=pathTemplate({html:this.getPathHtml(c,d)});a.base={css:d.asset(c,"base.css")};a.sorter={js:d.asset(c,"sorter.js"),image:d.asset(c,"sort-arrow-sprite.png")};a.prettify={js:d.asset(c,"prettify.js"),css:d.asset(c,"prettify.css")}},writeDetailPage:function(e,d,i){var a=this.opts,j=a.sourceStore,f=a.templateData,k=i.code&&Array.isArray(i.code)?i.code.join("\n")+"\n":j.get(i.path),c=k.split(/(?:\r?\n)|\r/),g=0,h=c.map(function(l){g+=1;return{line:g,covered:null,text:new InsertionText(l,true)}}),b;h.unshift({line:0,covered:null,text:new InsertionText("")});this.fillTemplate(d,f);e.write(headerTemplate(f));e.write('<pre><table class="coverage">\n');annotateLines(i,h);annotateBranches(i,h);annotateFunctions(i,h);annotateStatements(i,h);h.shift();b={structured:h,maxLines:h.length,fileCoverage:i};e.write(detailTemplate(b));e.write("</table></pre>\n");e.write(footerTemplate(f))},writeIndexPage:function(e,d){var f=this.opts.linkMapper,c=this.opts.templateData,b=Array.prototype.slice.apply(d.children),a=this.opts.watermarks;b.sort(function(h,g){return h.name<g.name?-1:1});this.fillTemplate(d,c);e.write(headerTemplate(c));e.write(summaryTableHeader);b.forEach(function(j){var g=j.metrics,i={statements:getReportClass(g.statements,a.statements),lines:getReportClass(g.lines,a.lines),functions:getReportClass(g.functions,a.functions),branches:getReportClass(g.branches,a.branches)},h={metrics:g,reportClasses:i,file:cleanPath(j.displayShortName()),output:f.fromParent(j)};e.write(summaryLineTemplate(h)+"\n")});e.write(summaryTableFooter);e.write(footerTemplate(c))},writeFiles:function(e,d,b,f){var c=this,g=path.resolve(b,"index.html"),a;if(this.opts.verbose){console.error("Writing "+g)}e.writeFile(g,function(h){c.writeIndexPage(h,d)});d.children.forEach(function(h){if(h.kind==="dir"){c.writeFiles(e,h,path.resolve(b,h.relativeName),f)}else{a=path.resolve(b,h.relativeName+".html");if(c.opts.verbose){console.error("Writing "+a)}e.writeFile(a,function(i){c.writeDetailPage(i,h,f.fileCoverageFor(h.fullPath()))})}})},standardLinkMapper:function(){return{fromParent:function(a){var b=cleanPath(a.relativeName);return a.kind==="dir"?b+"index.html":b+".html"},ancestorHref:function(f,d){var b="",h=function(i){return i!=="."},a,g,e,c;for(e=0;e<d;e+=1){a=cleanPath(f.relativeName).split("/").filter(h);g=a.length-1;for(c=0;c<g;c+=1){b+="../"}f=f.parent}return b},ancestor:function(b,a){return this.ancestorHref(b,a)+"index.html"},asset:function(d,a){var b=0,c=d.parent;while(c){b+=1;c=c.parent}return this.ancestorHref(d,b)+a}}},writeReport:function(e,g){var a=this.opts,c=a.dir,b=new TreeSummarizer(),d=a.writer||new FileWriter(g),f=this,i,h=function(j){var k=path.resolve(__dirname,"..","assets",j);fs.readdirSync(k).forEach(function(n){var o=path.resolve(k,n),l=path.resolve(c,n),m=fs.statSync(o);if(m.isFile()){if(a.verbose){console.log("Write asset: "+l)}d.copyFile(o,l)}})};e.files().forEach(function(j){b.addFileCoverageSummary(j,utils.summarizeFileCoverage(e.fileCoverageFor(j)))});i=b.getTreeSummary();[".","vendor"].forEach(function(j){h(j)});d.on("done",function(){f.emit("done")});this.writeFiles(d,i.root,c,e);d.done()}});module.exports=HtmlReport;