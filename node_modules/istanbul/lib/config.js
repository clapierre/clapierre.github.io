var path=require("path"),fs=require("fs"),existsSync=fs.existsSync||path.existsSync,CAMEL_PATTERN=/([a-z])([A-Z])/g,YML_PATTERN=/\.ya?ml$/,yaml=require("js-yaml"),defaults=require("./report/common/defaults");function defaultConfig(b){var a={verbose:false,instrumentation:{root:".",extensions:[".js"],"default-excludes":true,excludes:[],"embed-source":false,variable:"__coverage__",compact:true,"preserve-comments":false,"complete-copy":false,"save-baseline":false,"baseline-file":"./coverage/coverage-baseline.json","include-all-sources":false,"include-pid":false},reporting:{print:"summary",reports:["lcov"],dir:"./coverage"},hooks:{"hook-run-in-context":false,"post-require-hook":null,"handle-sigint":false},check:{global:{statements:0,lines:0,branches:0,functions:0,excludes:[]},each:{statements:0,lines:0,branches:0,functions:0,excludes:[]}}};a.reporting.watermarks=defaults.watermarks();a.reporting["report-config"]=defaults.defaultReportConfig();if(b){a.instrumentation["preload-sources"]=false}return a}function dasherize(a){return a.replace(CAMEL_PATTERN,function(c,b,d){return b+"-"+d.toLowerCase()})}function isScalar(a){if(a===null){return true}return a!==undefined&&!Array.isArray(a)&&typeof a!=="object"}function isObject(a){return typeof a==="object"&&a!==null&&!Array.isArray(a)}function mergeObjects(a,c){var b={};Object.keys(c).forEach(function(d){var f=c[d],e=a[d];if(Array.isArray(f)){b[d]=Array.isArray(e)&&e.length>0?e:f}else{if(isObject(f)){e=isObject(e)?e:{};b[d]=mergeObjects(e,f)}else{b[d]=isScalar(e)?e:f}}});return b}function mergeDefaults(b,a){return mergeObjects(b||{},a)}function addMethods(){var b=Array.prototype.slice.call(arguments),a=b.shift();b.forEach(function(c){var e=c,d=dasherize(c);a.prototype[e]=function(){return this.config[d]}})}function InstrumentOptions(a){if(a["preload-sources"]){console.error("The preload-sources option is deprecated, please use include-all-sources instead.");a["include-all-sources"]=a["preload-sources"]}this.config=a}addMethods(InstrumentOptions,"extensions","defaultExcludes","completeCopy","embedSource","variable","compact","preserveComments","saveBaseline","baselineFile","includeAllSources","includePid");InstrumentOptions.prototype.root=function(){return path.resolve(this.config.root)};InstrumentOptions.prototype.excludes=function(b){var a;if(this.defaultExcludes()){a=["**/node_modules/**"];if(b){a=a.concat(["**/test/**","**/tests/**"])}return a.concat(this.config.excludes)}return this.config.excludes};function ReportingOptions(a){this.config=a}addMethods(ReportingOptions,"print","reports","dir","reportConfig");function isInvalidMark(a,b){var c="Watermark for ["+b+"] :";if(a.length!==2){return c+"must be an array of length 2"}a[0]=Number(a[0]);a[1]=Number(a[1]);if(isNaN(a[0])||isNaN(a[1])){return c+"must have valid numbers"}if(a[0]<0||a[1]<0){return c+"must be positive numbers"}if(a[1]>100){return c+"cannot exceed 100"}if(a[1]<=a[0]){return c+"low must be less than high"}return null}ReportingOptions.prototype.watermarks=function(){var b=this.config.watermarks,a=defaults.watermarks(),c={};Object.keys(a).forEach(function(d){var f=b[d],e=isInvalidMark(f,d);if(e){console.error(e);c[d]=a[d]}else{c[d]=f}});return c};function HookOptions(a){this.config=a}addMethods(HookOptions,"hookRunInContext","postRequireHook","handleSigint");function Configuration(b,c){var a=mergeDefaults(b,defaultConfig(true));if(isObject(c)){a=mergeDefaults(c,a)}if(a.verbose){console.error("Using configuration");console.error("-------------------");console.error(yaml.safeDump(a,{indent:4,flowLevel:3}));console.error("-------------------\n")}this.verbose=a.verbose;this.instrumentation=new InstrumentOptions(a.instrumentation);this.reporting=new ReportingOptions(a.reporting);this.hooks=new HookOptions(a.hooks);this.check=a.check}function loadFile(a,d){var c=path.resolve(".istanbul.yml"),b;if(a){if(!existsSync(a)){throw new Error("Invalid configuration file specified:"+a)}}else{if(existsSync(c)){a=c}}if(a){console.error("Loading config: "+a);b=a.match(YML_PATTERN)?yaml.safeLoad(fs.readFileSync(a,"utf8"),{filename:a}):require(path.resolve(a))}return new Configuration(b,d)}function loadObject(a,b){return new Configuration(a,b)}module.exports={loadFile:loadFile,loadObject:loadObject,defaultConfig:defaultConfig};