var Utils=require("./util"),Headers=require("./headers"),Constants=Utils.Constants,Methods=require("./methods");module.exports=function(h){var k=new Headers.EntryHeader(),j=new Buffer(0),e=new Buffer(0),g=false,d=null,f=new Buffer(0);function b(){if(!h||!Buffer.isBuffer(h)){return new Buffer(0)}k.loadDataHeaderFromBinary(h);return h.slice(k.realDataOffset,k.realDataOffset+k.compressedSize)}function i(l){if(k.flags&8!=8){if(Utils.crc32(l)!=k.crc){return false}}else{}return true}function a(m,p){if(g){if(m&&p){p(new Buffer(0),Utils.Errors.DIRECTORY_CONTENT_ERROR)}return new Buffer(0)}var l=b();if(l.length==0){if(m&&p){p(l,Utils.Errors.NO_DATA)}return l}var n=new Buffer(k.size);n.fill(0);switch(k.method){case Utils.Constants.STORED:l.copy(n);if(!i(n)){if(m&&p){p(n,Utils.Errors.BAD_CRC)}return Utils.Errors.BAD_CRC}else{if(m&&p){p(n)}return n}break;case Utils.Constants.DEFLATED:var o=new Methods.Inflater(l);if(!m){o.inflate(n);if(!i(n)){console.warn(Utils.Errors.BAD_CRC+" "+j.toString())}return n}else{o.inflateAsync(function(q){q.copy(n,0);if(i(n)){if(p){p(n,Utils.Errors.BAD_CRC)}}else{if(p){p(n)}}})}break;default:if(m&&p){p(new Buffer(0),Utils.Errors.UNKNOWN_METHOD)}return Utils.Errors.UNKNOWN_METHOD}}function c(m,p){if((!d||!d.length)&&Buffer.isBuffer(h)){if(m&&p){p(b())}return b()}if(d.length&&!g){var l;switch(k.method){case Utils.Constants.STORED:k.compressedSize=k.size;l=new Buffer(d.length);d.copy(l);if(m&&p){p(l)}return l;break;default:case Utils.Constants.DEFLATED:var n=new Methods.Deflater(d);if(!m){var o=n.deflate();k.compressedSize=o.length;return o}else{n.deflateAsync(function(q){l=new Buffer(q.length);k.compressedSize=q.length;q.copy(l);p&&p(l)})}n=null;break}}else{if(m&&p){p(new Buffer(0))}else{return new Buffer(0)}}}return{get entryNamefunction(){return j.toString()},get rawEntryNamefunction(){return j},set entryNamefunction(m){j=Utils.toBuffer(m);var l=j[j.length-1];g=(l==47)||(l==92);k.fileNameLength=j.length},get extrafunction(){return f},set extrafunction(l){f=l;k.extraLength=l.length},get commentfunction(){return e.toString()},set commentfunction(l){e=Utils.toBuffer(l);k.commentLength=e.length},get namefunction(){var l=j.toString();return g?l.substr(l.length-1).split("/").pop():l.split("/").pop()},get isDirectoryfunction(){return g},getCompressedData:function(){return c(false,null)},getCompressedDataAsync:function(l){c(true,l)},setData:function(l){d=Utils.toBuffer(l);if(!g&&d.length){k.size=d.length;k.method=Utils.Constants.DEFLATED;k.crc=Utils.crc32(l)}else{k.method=Utils.Constants.STORED}},getData:function(){return a(false,null)},getDataAsync:function(l){a(true,l)},set headerfunction(l){k.loadFromBinary(l)},get headerfunction(){return k},packHeader:function(){var l=k.entryHeaderToBinary();j.copy(l,Utils.Constants.CENHDR);if(k.extraLength){f.copy(l,Utils.Constants.CENHDR+j.length)}if(k.commentLength){e.copy(l,Utils.Constants.CENHDR+j.length+k.extraLength,e.length)}return l},toString:function(){return'{\n\t"entryName" : "'+j.toString()+'",\n\t"name" : "'+j.toString().split("/").pop()+'",\n\t"comment" : "'+e.toString()+'",\n\t"isDirectory" : '+g+',\n\t"header" : '+k.toString().replace(/\t/mg,"\t\t")+',\n\t"compressedData" : <'+(h&&h.length+" bytes buffer"||"null")+'>\n\t"data" : <'+(d&&d.length+" bytes buffer"||"null")+">\n}"}}};