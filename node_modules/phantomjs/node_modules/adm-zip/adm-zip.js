var fs=require("fs"),pth=require("path");fs.existsSync=fs.existsSync||pth.existsSync;var ZipEntry=require("./zipEntry"),ZipFile=require("./zipFile"),Utils=require("./util");module.exports=function(b){var d=undefined,c="";if(b&&typeof b==="string"){if(fs.existsSync(b)){c=b;d=new ZipFile(b,Utils.Constants.FILE)}else{throw Utils.Errors.INVALID_FILENAME}}else{if(b&&Buffer.isBuffer(b)){d=new ZipFile(b,Utils.Constants.BUFFER)}else{d=new ZipFile(null,Utils.Constants.NONE)}}function a(f){if(f&&d){var e;if(typeof f==="string"){e=d.getEntry(f)}if(typeof f==="object"&&f.entryName!=undefined&&f.header!=undefined){e=d.getEntry(f.entryName)}if(e){return e}}return null}return{readFile:function(f){var e=a(f);return e&&e.getData()||null},readFileAsync:function(f,g){var e=a(f);if(e){e.getDataAsync(g)}else{g(null,"getEntry failed for:"+f)}},readAsText:function(g,f){var e=a(g);if(e){var h=e.getData();if(h&&h.length){return h.toString(f||"utf8")}}return""},readAsTextAsync:function(g,h,f){var e=a(g);if(e){e.getDataAsync(function(i){if(i&&i.length){h(i.toString(f||"utf8"))}else{h("")}})}else{h("")}},deleteFile:function(f){var e=a(f);if(e){d.deleteEntry(e.entryName)}},addZipComment:function(e){d.comment=e},getZipComment:function(){return d.comment||""},addZipEntryComment:function(f,g){var e=a(f);if(e){e.comment=g}},getZipEntryComment:function(f){var e=a(f);if(e){return e.comment||""}return""},updateFile:function(g,f){var e=a(g);if(e){e.setData(f)}},addLocalFile:function(f,e){if(fs.existsSync(f)){if(e){e=e.split("\\").join("/");if(e.charAt(e.length-1)!="/"){e+="/"}}else{e=""}var g=f.split("\\").join("/").split("/").pop();this.addFile(e+g,fs.readFileSync(f),"",0)}else{throw Utils.Errors.FILE_NOT_FOUND.replace("%s",f)}},addLocalFolder:function(h,g){if(g){g=g.split("\\").join("/");if(g.charAt(g.length-1)!="/"){g+="/"}}else{g=""}h=h.split("\\").join("/");if(h.charAt(h.length-1)!="/"){h+="/"}if(fs.existsSync(h)){var f=Utils.findFiles(h),e=this;if(f.length){f.forEach(function(j){var i=j.split("\\").join("/").replace(h,"");if(i.charAt(i.length-1)!=="/"){e.addFile(g+i,fs.readFileSync(j),"",0)}else{e.addFile(g+i,new Buffer(0),"",0)}})}}else{throw Utils.Errors.FILE_NOT_FOUND.replace("%s",h)}},addFile:function(h,g,i,e){var f=new ZipEntry();f.entryName=h;f.comment=i||"";f.attr=e||438;if(f.isDirectory&&g.length){}f.setData(g);d.setEntry(f)},getEntries:function(){if(d){return d.entries}else{return[]}},getEntry:function(e){return a(e)},extractEntryTo:function(j,l,e,f){f=f||false;e=typeof e=="undefined"?true:e;var i=a(j);if(!i){throw Utils.Errors.NO_ENTRY}var k=pth.resolve(l,e?i.entryName:pth.basename(i.entryName));if(i.isDirectory){k=pth.resolve(k,"..");var g=d.getEntryChildren(i);g.forEach(function(n){if(n.isDirectory){return}var m=n.getData();if(!m){throw Utils.Errors.CANT_EXTRACT_FILE}Utils.writeFileTo(pth.resolve(l,e?n.entryName:n.entryName.substr(i.entryName.length)),m,f)});return true}var h=i.getData();if(!h){throw Utils.Errors.CANT_EXTRACT_FILE}if(fs.existsSync(l)&&!f){throw Utils.Errors.CANT_OVERRIDE}Utils.writeFileTo(k,h,f);return true},extractAllTo:function(f,e){e=e||false;if(!d){throw Utils.Errors.NO_ZIP}d.entries.forEach(function(h){if(h.isDirectory){Utils.makeDir(pth.resolve(f,h.entryName.toString()));return}var g=h.getData();if(!g){throw Utils.Errors.CANT_EXTRACT_FILE+"2"}Utils.writeFileTo(pth.resolve(f,h.entryName.toString()),g,e)})},writeZip:function(f,g){if(arguments.length==1){if(typeof f=="function"){g=f;f=""}}if(!f&&c){f=c}if(!f){return}var e=d.compressToBuffer();if(e){Utils.writeFileTo(f,e,true)}},toBuffer:function(g,h,f,e){this.valueOf=2;if(typeof g=="function"){d.toAsyncBuffer(g,h,f,e);return null}return d.compressToBuffer()}}};