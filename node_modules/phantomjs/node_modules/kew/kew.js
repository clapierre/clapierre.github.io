function Promise(a,b){this.promise=this;this._isPromise=true;this._successFn=a;this._failFn=b;this._scope=this;this._boundArgs=null;this._hasContext=false;this._nextContext=undefined;this._currentContext=undefined}Promise.prototype._useContext=function(a){this._nextContext=this._currentContext=a;this._hasContext=true;return this};Promise.prototype.clearContext=function(){this._hasContext=false;this._nextContext=undefined;return this};Promise.prototype.setContext=function(a){this._nextContext=a;this._hasContext=true;return this};Promise.prototype.getContext=function(){return this._nextContext};Promise.prototype.resolve=function(b){if(this._error||this._hasData){throw new Error("Unable to resolve or reject the same promise twice")}var a;if(b&&isPromise(b)){this._child=b;if(this._promises){for(a=0;a<this._promises.length;a+=1){b._chainPromise(this._promises[a])}delete this._promises}if(this._onComplete){for(a=0;a<this._onComplete.length;a+=1){b.fin(this._onComplete[a])}delete this._onComplete}}else{if(b&&isPromiseLike(b)){b.then(function(c){this.resolve(c)}.bind(this),function(c){this.reject(c)}.bind(this))}else{this._hasData=true;this._data=b;if(this._onComplete){for(a=0;a<this._onComplete.length;a++){this._onComplete[a]()}}if(this._promises){for(a=0;a<this._promises.length;a+=1){this._promises[a]._withInput(b)}delete this._promises}}}};Promise.prototype.reject=function(c){if(this._error||this._hasData){throw new Error("Unable to resolve or reject the same promise twice")}var a;this._error=c;if(this._ended){process.nextTick(function b(){throw c})}if(this._onComplete){for(a=0;a<this._onComplete.length;a++){this._onComplete[a]()}}if(this._promises){for(a=0;a<this._promises.length;a+=1){this._promises[a]._withError(c)}delete this._promises}};Promise.prototype.then=function(b,c){var a=new Promise(b,c);if(this._nextContext){a._useContext(this._nextContext)}if(this._child){this._child._chainPromise(a)}else{this._chainPromise(a)}return a};Promise.prototype.thenBound=function(d,a,c){var b=new Promise(d);if(this._nextContext){b._useContext(this._nextContext)}b._scope=a;if(arguments.length>2){b._boundArgs=Array.prototype.slice.call(arguments,2)}if(this._child){this._child._chainPromise(b)}else{this._chainPromise(b)}return b};Promise.prototype.fail=function(a){return this.then(null,a)};Promise.prototype.failBound=function(d,a,c){var b=new Promise(null,d);if(this._nextContext){b._useContext(this._nextContext)}b._scope=a;if(arguments.length>2){b._boundArgs=Array.prototype.slice.call(arguments,2)}if(this._child){this._child._chainPromise(b)}else{this._chainPromise(b)}return b};Promise.prototype.fin=function(a){if(this._hasData||this._error){a();return this}if(this._child){this._child.fin(a)}else{if(!this._onComplete){this._onComplete=[a]}else{this._onComplete.push(a)}}return this};Promise.prototype.end=function(){this._end();return this};Promise.prototype._end=function(){if(this._error){throw this._error}this._ended=true;return this};Promise.prototype.done=function(c,b){var a=this;if(c||b){a=a.then(c,b)}a._end()};Promise.prototype.timeout=function(d,b){var c=new Promise();var a=false;var e=setTimeout(function(){c.reject(new Error(b||"Promise timeout after "+d+" ms."));a=true},d);this.then(function(f){if(!a){clearTimeout(e);c.resolve(f)}},function(f){if(!a){clearTimeout(e);c.reject(f)}});return c.promise};Promise.prototype._withInput=function(a){if(this._successFn){try{this.resolve(this._call(this._successFn,[a,this._currentContext]))}catch(b){this.reject(b)}}else{this.resolve(a)}delete this._currentContext};Promise.prototype._withError=function(b){if(this._failFn){try{this.resolve(this._call(this._failFn,[b,this._currentContext]))}catch(a){this.reject(a)}}else{this.reject(b)}delete this._currentContext};Promise.prototype._call=function(b,a){if(this._boundArgs){a=this._boundArgs.concat(a)}return b.apply(this._scope,a)};Promise.prototype._chainPromise=function(b){var a;if(this._hasContext){b._useContext(this._nextContext)}if(this._child){this._child._chainPromise(b)}else{if(this._hasData){b._withInput(this._data)}else{if(this._error){b._withError(this._error)}else{if(!this._promises){this._promises=[b]}else{this._promises.push(b)}}}}};function resolver(a,b,c){if(b){a.reject(b)}else{a.resolve(c)}}Promise.prototype.makeNodeResolver=function(){return resolver.bind(null,this)};function isPromise(a){return !!a._isPromise}function isPromiseLike(a){return typeof a==="object"&&typeof a.then==="function"}function resolve(a){var b=new Promise();b.resolve(a);return b}function reject(a){var b=new Promise();b.reject(a);return b}function replaceEl(b,a,c){b[a]=c;return c}function replaceElFulfilled(b,a,c){b[a]={state:"fulfilled",value:c};return c}function replaceElRejected(b,a,c){b[a]={state:"rejected",reason:c};return c}function all(d){if(arguments.length!=1||!Array.isArray(d)){d=Array.prototype.slice.call(arguments,0)}if(!d.length){return resolve([])}var g=[];var h=false;var f=new Promise();var a=d.length;for(var c=0;c<d.length;c+=1){if(!d[c]||!isPromiseLike(d[c])){g[c]=d[c];a-=1}else{d[c].then(replaceEl.bind(null,g,c)).then(function e(){a--;if(!h&&a===0){h=true;f.resolve(g)}},function b(i){if(!h){h=true;f.reject(i)}})}}if(a===0&&!h){h=true;f.resolve(g)}return f}function allSettled(c){if(!Array.isArray(c)){throw Error('The input to "allSettled()" should be an array of Promise or values')}if(!c.length){return resolve([])}var e=[];var d=new Promise();var a=c.length;for(var b=0;b<c.length;b+=1){if(!c[b]||!isPromiseLike(c[b])){replaceElFulfilled(e,b,c[b]);if((--a)===0){d.resolve(e)}}else{c[b].then(replaceElFulfilled.bind(null,e,b),replaceElRejected.bind(null,e,b)).then(function(){if((--a)===0){d.resolve(e)}})}}return d}function defer(){return new Promise()}function delay(f,a){var b=undefined;var d=f;if(typeof a!="undefined"){d=a;b=f}if(typeof d!="number"){throw new Error("Bad delay value "+d)}var e=new Promise();setTimeout(function c(){e.resolve(b)},d);return e}Promise.prototype.delay=function(a){return this.then(function(b){return delay(b,a)})};function fcall(b,d){var e=Array.prototype.slice.call(arguments,1);var c=new Promise();process.nextTick(function a(){try{c.resolve(b.apply(undefined,e))}catch(f){c.reject(f)}});return c}function nfcall(b,c){var a=Array.prototype.slice.call(arguments,0);a.splice(1,0,undefined);return bindPromise.apply(undefined,a)()}function bindPromise(b,a,c){var e=Array.prototype.slice.call(arguments,2);return function d(h){var g=new Promise();try{b.apply(a,e.concat(Array.prototype.slice.call(arguments,0),g.makeNodeResolver()))}catch(f){g.reject(f)}return g}}module.exports={all:all,bindPromise:bindPromise,defer:defer,delay:delay,fcall:fcall,isPromise:isPromise,isPromiseLike:isPromiseLike,nfcall:nfcall,resolve:resolve,reject:reject,allSettled:allSettled,Promise:Promise};