var CC=require("config-chain").ConfigChain;var inherits=require("inherits");var configDefs=require("./config-defs.js");var types=configDefs.types;var once=require("once");var fs=require("fs");var path=require("path");var nopt=require("nopt");var ini=require("ini");var Octal=configDefs.Octal;var mkdirp=require("mkdirp");exports.load=load;exports.Conf=Conf;exports.loaded=false;exports.rootConf=null;exports.usingBuiltin=false;exports.defs=configDefs;Object.defineProperty(exports,"defaults",{get:function(){return configDefs.defaults},enumerable:true});Object.defineProperty(exports,"types",{get:function(){return configDefs.types},enumerable:true});exports.validate=validate;var myUid=process.env.SUDO_UID!==undefined?process.env.SUDO_UID:(process.getuid&&process.getuid());var myGid=process.env.SUDO_GID!==undefined?process.env.SUDO_GID:(process.getgid&&process.getgid());var loading=false;var loadCbs=[];function load(j,h,b){var d,g,c;for(var e=0;e<arguments.length;e++){switch(typeof arguments[e]){case"string":g=arguments[e];break;case"object":d=arguments[e];break;case"function":c=arguments[e];break}}if(!c){c=function(){}}if(exports.loaded){var f=exports.loaded;if(d){f=new Conf(f);f.unshift(d)}return process.nextTick(c.bind(null,null,f))}if(!d){d={}}else{d=Object.keys(d).reduce(function(l,i){l[i]=d[i];return l},{})}loadCbs.push(c);if(loading){return}loading=true;c=once(function(k,i){if(!k){exports.loaded=i}loadCbs.forEach(function(l){l(k,i)});loadCbs.length=0});exports.usingBuiltin=!!g;var a=exports.rootConf=new Conf();if(g){a.addFile(g,"builtin")}else{a.add({},"builtin")}a.on("load",function(){load_(g,a,d,c)})}function load_(j,a,f,c){var d=configDefs.defaults;var g=new Conf(a);g.usingBuiltin=!!j;g.sources.builtin=a.sources.builtin;g.add(f,"cli");g.addEnv();g.loadPrefix(function(n){if(n){return c(n)}var l=path.resolve(g.localPrefix,".npmrc");var m=a.get("userconfig");var k=g.get("userconfig");if(!g.get("global")&&l!==m&&l!==k){g.addFile(l,"project");g.once("load",b)}else{g.add({},"project");b()}});function b(){g.addFile(g.get("userconfig"),"user");g.once("error",c);g.once("load",e)}function e(){if(g.get("prefix")){var k=path.resolve(g.get("prefix"),"etc");d.globalconfig=path.resolve(k,"npmrc");d.globalignorefile=path.resolve(k,"npmignore")}g.addFile(g.get("globalconfig"),"global");g.root=d;g.add(a.shift(),"builtin");g.once("load",function(){g.loadExtras(i)})}function i(l){if(l){return c(l)}validate(g);var k=g.get("cafile");if(k){return g.loadCAFile(k,h)}h()}function h(k){if(k){return c(k)}exports.loaded=g;c(k,g)}}inherits(Conf,CC);function Conf(a){if(!(this instanceof Conf)){return new Conf(a)}CC.apply(this);if(a){if(a instanceof Conf){this.root=a.list[0]||a.root}else{this.root=a}}else{this.root=configDefs.defaults}}Conf.prototype.loadPrefix=require("./lib/load-prefix.js");Conf.prototype.loadCAFile=require("./lib/load-cafile.js");Conf.prototype.loadUid=require("./lib/load-uid.js");Conf.prototype.setUser=require("./lib/set-user.js");Conf.prototype.findPrefix=require("./lib/find-prefix.js");Conf.prototype.getCredentialsByURI=require("./lib/get-credentials-by-uri.js");Conf.prototype.setCredentialsByURI=require("./lib/set-credentials-by-uri.js");Conf.prototype.loadExtras=function(a){this.setUser(function(b){if(b){return a(b)}this.loadUid(function(c){if(c){return a(c)}mkdirp(this.prefix,a)}.bind(this))}.bind(this))};Conf.prototype.save=function(e,a){var g=this.sources[e];if(!g||!(g.path||g.source)||!g.data){if(e!=="builtin"){var h=new Error("bad save target: "+e)}if(a){process.nextTick(a.bind(null,h));return this}return this.emit("error",h)}if(g.source){var i=g.prefix||"";Object.keys(g.data).forEach(function(j){g.source[i+j]=g.data[j]});if(a){process.nextTick(a)}return this}var d=ini.stringify(g.data);c=c.bind(this);b=b.bind(this);this._saving++;var f=e==="user"?"0600":"0666";if(!d.trim()){fs.unlink(g.path,function(j){b(null)})}else{mkdirp(path.dirname(g.path),function(j){if(j){return c(j)}fs.writeFile(g.path,d,"utf8",function(k){if(k){return c(k)}if(e==="user"&&myUid&&myGid){fs.chown(g.path,+myUid,+myGid,c)}else{c()}})})}function c(j){if(j){return b(j)}fs.chmod(g.path,f,b)}function b(j){if(j){if(a){return a(j)}else{return this.emit("error",j)}}this._saving--;if(this._saving===0){if(a){a()}this.emit("save")}}return this};Conf.prototype.addFile=function(c,b){b=b||c;var a={__source__:b};this.sources[b]={path:c,type:"ini"};this.push(a);this._await();fs.readFile(c,"utf8",function(e,d){if(e){return this.add({},a)}this.addString(d,c,"ini",a)}.bind(this));return this};Conf.prototype.parse=function(b,a){return CC.prototype.parse.call(this,b,a,"ini")};Conf.prototype.add=function(b,a){Object.keys(b).forEach(function(c){b[c]=parseField(b[c],c)});return CC.prototype.add.call(this,b,a)};Conf.prototype.addEnv=function(b){b=b||process.env;var a={};Object.keys(b).filter(function(c){return c.match(/^npm_config_/i)}).forEach(function(c){if(!b[c]){return}var d=c.toLowerCase().replace(/^npm_config_/,"").replace(/(?!^)_/g,"-");a[d]=b[c]});return CC.prototype.addEnv.call(this,"",a,"env")};function parseField(g,d){if(typeof g!=="string"&&!(g instanceof String)){return g}var c=[].concat(types[d]);var e=-1!==c.indexOf(path);var i=-1!==c.indexOf(Boolean);var a=-1!==c.indexOf(String);var b=-1!==c.indexOf(Octal);var j=b||(-1!==c.indexOf(Number));g=(""+g).trim();if(g.match(/^".*"$/)){g=JSON.parse(g)}if(i&&!a&&g===""){return true}switch(g){case"true":return true;case"false":return false;case"null":return null;case"undefined":return undefined}g=envReplace(g);if(e){var h=process.platform==="win32"?/^~(\/|\\)/:/^~\//;if(g.match(h)&&process.env.HOME){g=path.resolve(process.env.HOME,g.substr(2))}g=path.resolve(g)}if(j&&!isNaN(g)){g=b?parseInt(g,8):+g}return g}function envReplace(b){if(typeof b!=="string"||!b){return b}var a=/(\\*)\$\{([^}]+)\}/g;return b.replace(a,function(e,c,d){c=c.length&&c.length%2;if(c){return e}if(undefined===process.env[d]){throw new Error("Failed to replace env in config: "+e)}return process.env[d]})}function validate(a){a.list.forEach(function(b){nopt.clean(b,configDefs.types)});nopt.clean(a.root,configDefs.types)};