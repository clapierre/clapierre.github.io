var ProtoList=require("proto-list"),path=require("path"),fs=require("fs"),ini=require("ini"),EE=require("events").EventEmitter,url=require("url"),http=require("http");var exports=module.exports=function(){var d=[].slice.call(arguments),c=new ConfigChain();while(d.length){var b=d.shift();if(b){c.push("string"===typeof b?json(b):b)}}return c};var find=exports.find=function(){var a=path.join.apply(null,[].slice.call(arguments));function b(f,c){var d=path.join(f,c);try{fs.statSync(d);return d}catch(e){if(path.dirname(f)!==f){return b(path.dirname(f),c)}}}return b(__dirname,a)};var parse=exports.parse=function(c,a,b){c=""+c;if(!b){try{return JSON.parse(c)}catch(d){return ini.parse(c)}}else{if(b==="json"){if(this.emit){try{return JSON.parse(c)}catch(d){this.emit("error",d)}}else{return JSON.parse(c)}}else{return ini.parse(c)}}};var json=exports.json=function(){var a=[].slice.call(arguments).filter(function(e){return e!=null});var b=path.join.apply(null,a);var d;try{d=fs.readFileSync(b,"utf-8")}catch(c){return}return parse(d,b,"json")};var env=exports.env=function(d,c){c=c||process.env;var e={};var a=d.length;for(var b in c){if(b.indexOf(d)===0){e[b.substring(a)]=c[b]}}return e};exports.ConfigChain=ConfigChain;function ConfigChain(){EE.apply(this);ProtoList.apply(this,arguments);this._awaiting=0;this._saving=0;this.sources={}}var extras={constructor:{value:ConfigChain}};Object.keys(EE.prototype).forEach(function(a){extras[a]=Object.getOwnPropertyDescriptor(EE.prototype,a)});ConfigChain.prototype=Object.create(ProtoList.prototype,extras);ConfigChain.prototype.del=function(d,b){if(b){var e=this.sources[b];e=e&&e.data;if(!e){return this.emit("error",new Error("not found "+b))}delete e[d]}else{for(var c=0,a=this.list.length;c<a;c++){delete this.list[c][d]}}return this};ConfigChain.prototype.set=function(b,c,a){var d;if(a){d=this.sources[a];d=d&&d.data;if(!d){return this.emit("error",new Error("not found "+a))}}else{d=this.list[0];if(!d){return this.emit("error",new Error("cannot set, no confs!"))}}d[b]=c;return this};ConfigChain.prototype.get=function(b,a){if(a){a=this.sources[a];if(a){a=a.data}if(a&&Object.hasOwnProperty.call(a,b)){return a[b]}return undefined}return this.list[0][b]};ConfigChain.prototype.save=function(c,d,b){if(typeof d==="function"){b=d,d=null}var f=this.sources[c];if(!f||!(f.path||f.source)||!f.data){return this.emit("error",new Error("bad save target: "+c))}if(f.source){var a=f.prefix||"";Object.keys(f.data).forEach(function(g){f.source[a+g]=f.data[g]});return this}var d=d||f.type;var e=f.data;if(f.type==="json"){e=JSON.stringify(e)}else{e=ini.stringify(e)}this._saving++;fs.writeFile(f.path,e,"utf8",function(g){this._saving--;if(g){if(b){return b(g)}else{return this.emit("error",g)}}if(this._saving===0){if(b){b()}this.emit("save")}}.bind(this));return this};ConfigChain.prototype.addFile=function(c,d,b){b=b||c;var a={__source__:b};this.sources[b]={path:c,type:d};this.push(a);this._await();fs.readFile(c,"utf8",function(f,e){if(f){this.emit("error",f)}this.addString(e,c,d,a)}.bind(this));return this};ConfigChain.prototype.addEnv=function(d,b,a){a=a||"env";var c=exports.env(d,b);this.sources[a]={data:c,source:b,prefix:d};return this.add(c,a)};ConfigChain.prototype.addUrl=function(e,d,c){this._await();var b=url.format(e);c=c||b;var a={__source__:c};this.sources[c]={href:b,type:d};this.push(a);http.request(e,function(g){var h=[];var f=g.headers["content-type"];if(!d){d=f.indexOf("json")!==-1?"json":f.indexOf("ini")!==-1?"ini":b.match(/\.json$/)?"json":b.match(/\.ini$/)?"ini":null;a.type=d}g.on("data",h.push.bind(h)).on("end",function(){this.addString(Buffer.concat(h),b,d,a)}.bind(this)).on("error",this.emit.bind(this,"error"))}.bind(this)).on("error",this.emit.bind(this,"error")).end();return this};ConfigChain.prototype.addString=function(d,b,c,a){d=this.parse(d,b,c);this.add(d,a);return this};ConfigChain.prototype.add=function(c,a){if(a&&typeof a==="object"){var b=this.list.indexOf(a);if(b===-1){return this.emit("error",new Error("bad marker"))}this.splice(b,1,c);a=a.__source__;this.sources[a]=this.sources[a]||{};this.sources[a].data=c;this._resolve()}else{if(typeof a==="string"){this.sources[a]=this.sources[a]||{};this.sources[a].data=c}this._await();this.push(c);process.nextTick(this._resolve.bind(this))}return this};ConfigChain.prototype.parse=exports.parse;ConfigChain.prototype._await=function(){this._awaiting++};ConfigChain.prototype._resolve=function(){this._awaiting--;if(this._awaiting===0){this.emit("load",this)}};