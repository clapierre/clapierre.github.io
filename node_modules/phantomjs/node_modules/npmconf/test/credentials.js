var test=require("tap").test,npmconf=require("../npmconf.js"),common=require("./00-setup.js"),URI="https://registry.lvh.me:8661/";test("getting scope with no credentials set",function(e){npmconf.load({},function(n,o){e.ifError(n,"configuration loaded");var t=o.getCredentialsByURI(URI);e.equal(t.scope,"//registry.lvh.me:8661/","nerfed URL extracted"),e.end()})}),test("trying to set credentials with no URI",function(e){npmconf.load(common.builtin,function(n,o){e.ifError(n,"configuration loaded"),e["throws"](function(){o.setCredentialsByURI()},"enforced missing URI"),e.end()})}),test("set with missing credentials object",function(e){npmconf.load(common.builtin,function(n,o){e.ifError(n,"configuration loaded"),e["throws"](function(){o.setCredentialsByURI(URI)},"enforced missing credentials"),e.end()})}),test("set with empty credentials object",function(e){npmconf.load(common.builtin,function(n,o){e.ifError(n,"configuration loaded"),e["throws"](function(){o.setCredentialsByURI(URI,{})},"enforced missing credentials"),e.end()})}),test("set with token",function(e){npmconf.load(common.builtin,function(n,o){e.ifError(n,"configuration loaded"),e.doesNotThrow(function(){o.setCredentialsByURI(URI,{token:"simple-token"})},"needs only token");var t={scope:"//registry.lvh.me:8661/",token:"simple-token",username:void 0,password:void 0,email:void 0,auth:void 0,alwaysAuth:void 0};e.same(o.getCredentialsByURI(URI),t,"got bearer token and scope"),e.end()})}),test("set with missing username",function(e){npmconf.load(common.builtin,function(n,o){e.ifError(n,"configuration loaded");var t={password:"password",email:"ogd@aoaioxxysz.net"};e["throws"](function(){o.setCredentialsByURI(URI,t)},"enforced missing email"),e.end()})}),test("set with missing password",function(e){npmconf.load(common.builtin,function(n,o){e.ifError(n,"configuration loaded");var t={username:"username",email:"ogd@aoaioxxysz.net"};e["throws"](function(){o.setCredentialsByURI(URI,t)},"enforced missing email"),e.end()})}),test("set with missing email",function(e){npmconf.load(common.builtin,function(n,o){e.ifError(n,"configuration loaded");var t={username:"username",password:"password"};e["throws"](function(){o.setCredentialsByURI(URI,t)},"enforced missing email"),e.end()})}),test("set with old-style credentials",function(e){npmconf.load(common.builtin,function(n,o){e.ifError(n,"configuration loaded");var t={username:"username",password:"password",email:"ogd@aoaioxxysz.net"};e.doesNotThrow(function(){o.setCredentialsByURI(URI,t)},"requires all of username, password, and email");var a={scope:"//registry.lvh.me:8661/",token:void 0,username:"username",password:"password",email:"ogd@aoaioxxysz.net",auth:"dXNlcm5hbWU6cGFzc3dvcmQ=",alwaysAuth:!1};e.same(o.getCredentialsByURI(URI),a,"got credentials"),e.end()})}),test("get old-style credentials for default registry",function(e){npmconf.load(common.builtin,function(n,o){var t=o.getCredentialsByURI(o.get("registry")),a={scope:"//registry.npmjs.org/",token:void 0,password:"password",username:"username",email:"i@izs.me",auth:"dXNlcm5hbWU6cGFzc3dvcmQ=",alwaysAuth:!1};e.same(t,a),e.end()})}),test("set with always-auth enabled",function(e){npmconf.load(common.builtin,function(n,o){e.ifError(n,"configuration loaded");var t={username:"username",password:"password",email:"ogd@aoaioxxysz.net",alwaysAuth:!0};o.setCredentialsByURI(URI,t);var a={scope:"//registry.lvh.me:8661/",token:void 0,username:"username",password:"password",email:"ogd@aoaioxxysz.net",auth:"dXNlcm5hbWU6cGFzc3dvcmQ=",alwaysAuth:!0};e.same(o.getCredentialsByURI(URI),a,"got credentials"),e.end()})}),test("set with always-auth disabled",function(e){npmconf.load(common.builtin,function(n,o){e.ifError(n,"configuration loaded");var t={username:"username",password:"password",email:"ogd@aoaioxxysz.net",alwaysAuth:!1};o.setCredentialsByURI(URI,t);var a={scope:"//registry.lvh.me:8661/",token:void 0,username:"username",password:"password",email:"ogd@aoaioxxysz.net",auth:"dXNlcm5hbWU6cGFzc3dvcmQ=",alwaysAuth:!1};e.same(o.getCredentialsByURI(URI),a,"got credentials"),e.end()})}),test("set with global always-auth enabled",function(e){npmconf.load(common.builtin,function(n,o){e.ifError(n,"configuration loaded");var t=o.get("always-auth");o.set("always-auth",!0);var a={username:"username",password:"password",email:"ogd@aoaioxxysz.net"};o.setCredentialsByURI(URI,a);var s={scope:"//registry.lvh.me:8661/",token:void 0,username:"username",password:"password",email:"ogd@aoaioxxysz.net",auth:"dXNlcm5hbWU6cGFzc3dvcmQ=",alwaysAuth:!0};e.same(o.getCredentialsByURI(URI),s,"got credentials"),o.set("always-auth",t),e.end()})}),test("set with global always-auth disabled",function(e){npmconf.load(common.builtin,function(n,o){e.ifError(n,"configuration loaded");var t=o.get("always-auth");o.set("always-auth",!1);var a={username:"username",password:"password",email:"ogd@aoaioxxysz.net"};o.setCredentialsByURI(URI,a);var s={scope:"//registry.lvh.me:8661/",token:void 0,username:"username",password:"password",email:"ogd@aoaioxxysz.net",auth:"dXNlcm5hbWU6cGFzc3dvcmQ=",alwaysAuth:!1};e.same(o.getCredentialsByURI(URI),s,"got credentials"),o.set("always-auth",t),e.end()})});