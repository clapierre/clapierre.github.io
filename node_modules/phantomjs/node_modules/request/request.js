var optional=require("./lib/optional"),http=require("http"),https=optional("https"),tls=optional("tls"),url=require("url"),util=require("util"),stream=require("stream"),qs=require("qs"),querystring=require("querystring"),crypto=require("crypto"),zlib=require("zlib"),bl=require("bl"),oauth=optional("oauth-sign"),hawk=optional("hawk"),aws=optional("aws-sign2"),httpSignature=optional("http-signature"),uuid=require("node-uuid"),mime=require("mime-types"),tunnel=require("tunnel-agent"),_safeStringify=require("json-stringify-safe"),stringstream=optional("stringstream"),caseless=require("caseless"),ForeverAgent=require("forever-agent"),FormData=optional("form-data"),cookies=require("./lib/cookies"),globalCookieJar=cookies.jar(),copy=require("./lib/copy"),debug=require("./lib/debug"),net=require("net");function safeStringify(c){var a;try{a=JSON.stringify(c)}catch(b){a=_safeStringify(c)}return a}var globalPool={};var isUrl=/^https?:|^unix:/;var defaultProxyHeaderWhiteList=["accept","accept-charset","accept-encoding","accept-language","accept-ranges","cache-control","content-encoding","content-language","content-length","content-location","content-md5","content-range","content-type","connection","date","expect","max-forwards","pragma","proxy-authorization","referer","te","transfer-encoding","user-agent","via"];function isReadStream(a){return a.readable&&a.path&&a.mode}function toBase64(a){return(new Buffer(a||"","ascii")).toString("base64")}function md5(a){return crypto.createHash("md5").update(a).digest("hex")}function requestToJSON(){return{uri:this.uri,method:this.method,headers:this.headers}}function responseToJSON(){return{statusCode:this.statusCode,body:this.body,headers:this.headers,request:requestToJSON.call(this.request)}}function Request(b){stream.Stream.call(this);this.readable=true;this.writable=true;if(typeof b==="string"){b={uri:b}}var a=Object.keys(Request.prototype);for(var c in b){if(a.indexOf(c)===-1){this[c]=b[c]}else{if(typeof b[c]==="function"){delete b[c]}}}if(b.method){this.explicitMethod=true}if(typeof b.tunnel==="undefined"){b.tunnel=false}this.init(b)}util.inherits(Request,stream.Stream);Request.prototype.setupTunnel=function(){var e=this;if(typeof e.proxy=="string"){e.proxy=url.parse(e.proxy)}if(!e.proxy){return false}if(!e.tunnel&&e.uri.protocol!=="https:"){return}var d=e.uri.hostname+":";if(e.uri.port){d+=e.uri.port}else{if(e.uri.protocol==="https:"){d+="443"}else{d+="80"}}if(!e.proxyHeaderWhiteList){e.proxyHeaderWhiteList=defaultProxyHeaderWhiteList}var g=Object.keys(e.headers).filter(function(i){return e.proxyHeaderWhiteList.indexOf(i.toLowerCase())!==-1}).reduce(function(j,i){j[i]=e.headers[i];return j},{});g.host=d;var f=(e.uri.protocol==="https:"?"https":"http")+"Over"+(e.proxy.protocol==="https:"?"Https":"Http");var c=tunnel[f];var b;if(e.proxy.auth){b=e.proxy.auth}else{if(e.proxyAuthorization){g["Proxy-Authorization"]=e.proxyAuthorization}}var a={proxy:{host:e.proxy.hostname,port:+e.proxy.port,proxyAuth:b,headers:g},rejectUnauthorized:e.rejectUnauthorized,headers:e.headers,ca:e.ca,cert:e.cert,key:e.key};e.agent=c(a);e.tunnel=true;return true};Request.prototype.init=function(c){var b=this;if(!c){c={}}caseless.httpify(b,b.headers||{});if(b.hasHeader("proxy-authorization")){b.proxyAuthorization=b.getHeader("proxy-authorization");b.removeHeader("proxy-authorization")}if(!b.method){b.method=c.method||"GET"}b.localAddress=c.localAddress;debug(c);if(!b.pool&&b.pool!==false){b.pool=globalPool}b.dests=b.dests||[];b.__isRequestRequest=true;if(!b._callback&&b.callback){b._callback=b.callback;b.callback=function(){if(b._callbackCalled){return}b._callbackCalled=true;b._callback.apply(b,arguments)};b.on("error",b.callback.bind());b.on("complete",b.callback.bind(b,null))}if(b.url&&!b.uri){b.uri=b.url;delete b.url}if(!b.uri){return b.emit("error",new Error("options.uri is a required argument"))}else{if(typeof b.uri=="string"){b.uri=url.parse(b.uri)}}if(b.strictSSL===false){b.rejectUnauthorized=false}if(!b.hasOwnProperty("proxy")){if(b.uri.protocol=="http:"){b.proxy=process.env.HTTP_PROXY||process.env.http_proxy||null}else{if(b.uri.protocol=="https:"){b.proxy=process.env.HTTPS_PROXY||process.env.https_proxy||process.env.HTTP_PROXY||process.env.http_proxy||null}}}b.tunnel=!!c.tunnel;if(b.proxy){b.setupTunnel()}if(!b.uri.pathname){b.uri.pathname="/"}if(!b.uri.host&&!b.protocol=="unix:"){var a=url.format(b.uri);var d='Invalid URI "'+a+'"';if(Object.keys(c).length===0){d+=". This can be caused by a crappy redirection."}b.emit("error",new Error(d));return}b._redirectsFollowed=b._redirectsFollowed||0;b.maxRedirects=(b.maxRedirects!==undefined)?b.maxRedirects:10;b.allowRedirect=(typeof b.followRedirect==="function")?b.followRedirect:function(e){return true};b.followRedirect=(b.followRedirect!==undefined)?!!b.followRedirect:true;b.followAllRedirects=(b.followAllRedirects!==undefined)?b.followAllRedirects:false;if(b.followRedirect||b.followAllRedirects){b.redirects=b.redirects||[]}b.setHost=false;if(!b.hasHeader("host")){b.setHeader("host",b.uri.hostname);if(b.uri.port){if(!(b.uri.port===80&&b.uri.protocol==="http:")&&!(b.uri.port===443&&b.uri.protocol==="https:")){b.setHeader("host",b.getHeader("host")+(":"+b.uri.port))}}b.setHost=true}b.jar(b._jar||c.jar);if(!b.uri.port){if(b.uri.protocol=="http:"){b.uri.port=80}else{if(b.uri.protocol=="https:"){b.uri.port=443}}}if(b.proxy&&!b.tunnel){b.port=b.proxy.port;b.host=b.proxy.hostname}else{b.port=b.uri.port;b.host=b.uri.hostname}b.clientErrorHandler=function(e){if(b._aborted){return}if(b.req&&b.req._reusedSocket&&e.code==="ECONNRESET"&&b.agent.addRequestNoreuse){b.agent={addRequest:b.agent.addRequestNoreuse.bind(b.agent)};b.start();b.req.end();return}if(b.timeout&&b.timeoutTimer){clearTimeout(b.timeoutTimer);b.timeoutTimer=null}b.emit("error",e)};b._parserErrorHandler=function(e){if(this.res){if(this.res.request){this.res.request.emit("error",e)}else{this.res.emit("error",e)}}else{this._httpMessage.emit("error",e)}};b._buildRequest=function(){var h=this;if(c.form){h.form(c.form)}if(c.qs){h.qs(c.qs)}if(h.uri.path){h.path=h.uri.path}else{h.path=h.uri.pathname+(h.uri.search||"")}if(h.path.length===0){h.path="/"}if(c.oauth){h.oauth(c.oauth)}if(c.aws){h.aws(c.aws)}if(c.hawk){h.hawk(c.hawk)}if(c.httpSignature){h.httpSignature(c.httpSignature)}if(c.auth){if(Object.prototype.hasOwnProperty.call(c.auth,"username")){c.auth.user=c.auth.username}if(Object.prototype.hasOwnProperty.call(c.auth,"password")){c.auth.pass=c.auth.password}h.auth(c.auth.user,c.auth.pass,c.auth.sendImmediately,c.auth.bearer)}if(h.gzip&&!h.hasHeader("accept-encoding")){h.setHeader("accept-encoding","gzip")}if(h.uri.auth&&!h.hasHeader("authorization")){var f=h.uri.auth.split(":").map(function(i){return querystring.unescape(i)});h.auth(f[0],f.slice(1).join(":"),true)}if(h.proxy&&!h.tunnel){if(h.proxy.auth&&!h.proxyAuthorization){var f=h.proxy.auth.split(":").map(function(i){return querystring.unescape(i)});var k="Basic "+toBase64(f.join(":"));h.proxyAuthorization=k}if(h.proxyAuthorization){h.setHeader("proxy-authorization",h.proxyAuthorization)}}if(h.proxy&&!h.tunnel){h.path=(h.uri.protocol+"//"+h.uri.host+h.path)}if(c.json){h.json(c.json)}else{if(c.multipart){h.boundary=uuid();h.multipart(c.multipart)}}if(h.body){var l=0;if(!Buffer.isBuffer(h.body)){if(Array.isArray(h.body)){for(var j=0;j<h.body.length;j++){l+=h.body[j].length}}else{h.body=new Buffer(h.body);l=h.body.length}}else{l=h.body.length}if(l){if(!h.hasHeader("content-length")){h.setHeader("content-length",l)}}else{throw new Error("Argument error, options.body.")}}var m=h.proxy&&!h.tunnel?h.proxy.protocol:h.uri.protocol,g={"http:":http,"https:":https,"unix:":http},e=h.httpModules||{};h.httpModule=e[m]||g[m];if(!h.httpModule){return this.emit("error",new Error("Invalid protocol: "+m))}if(c.ca){h.ca=c.ca}if(!h.agent){if(c.agentOptions){h.agentOptions=c.agentOptions}if(c.agentClass){h.agentClass=c.agentClass}else{if(c.forever){h.agentClass=m==="http:"?ForeverAgent:ForeverAgent.SSL}else{h.agentClass=h.httpModule.Agent}}}if(h.pool===false){h.agent=false}else{h.agent=h.agent||h.getAgent();if(h.maxSockets){h.agent.maxSockets=h.maxSockets}if(h.pool.maxSockets){h.agent.maxSockets=h.pool.maxSockets}}h.on("pipe",function(o){if(h.ntick&&h._started){throw new Error("You cannot pipe to this stream after the outbound request has started.")}h.src=o;if(isReadStream(o)){if(!h.hasHeader("content-type")){h.setHeader("content-type",mime.lookup(o.path))}}else{if(o.headers){for(var n in o.headers){if(!h.hasHeader(n)){h.setHeader(n,o.headers[n])}}}if(h._json&&!h.hasHeader("content-type")){h.setHeader("content-type","application/json")}if(o.method&&!h.explicitMethod){h.method=o.method}}});process.nextTick(function(){if(h._aborted){return}var i=function(){if(h._form){h._form.pipe(h)}if(h.body){if(Array.isArray(h.body)){h.body.forEach(function(n){h.write(n)})}else{h.write(h.body)}h.end()}else{if(h.requestBodyStream){console.warn("options.requestBodyStream is deprecated, please pass the request object to stream.pipe.");h.requestBodyStream.pipe(h)}else{if(!h.src){if(h.method!=="GET"&&typeof h.method!=="undefined"){h.setHeader("content-length",0)}h.end()}}}};if(h._form&&!h.hasHeader("content-length")){h.setHeader(h._form.getHeaders());h._form.getLength(function(o,n){if(!o){h.setHeader("content-length",n)}i()})}else{i()}h.ntick=true})};b._handleUnixSocketURI=function(e){e.unixsocket=true;var h=e.uri.href.replace(e.uri.protocol+"/","");var j=h.split("/");var g=true;var f={};do{f[j.join("/")]={}}while(j.pop());for(r in f){i(r)}function i(n){var m=net.connect(n);m.path=n;m.on("error",function(){f[this.path].error_connecting=true;this.end()});m.on("connect",function(){f[this.path].error_connecting=false;this.end()});n.client=m}k();response_counter=0;function k(){var m;if("undefined"==typeof setImmediate){m=process.nextTick}else{m=setImmediate}m(function(){response_counter++;var n=false;for(r in f){if("undefined"==typeof f[r].error_connecting){n=true}}if(n&&response_counter<1000){k()}else{l()}})}function l(){var m;for(r in f){if(f[r].error_connecting===false){m=r}}if(!m){e.emit("error",new Error("Failed to connect to any socket in "+h))}var n=h.replace(m,"");e.socketPath=m;e.uri.pathname=n;e.uri.href=n;e.uri.path=n;e.host="";e.hostname="";delete e.host;delete e.hostname;e._buildRequest()}};if(/^unix:/.test(b.uri.protocol)){b._handleUnixSocketURI(b)}else{b._buildRequest()}};Request.prototype._updateProtocol=function(){var a=this;var b=a.uri.protocol;if(b==="https:"||a.tunnel){if(a.proxy){if(a.setupTunnel()){return}}a.httpModule=https;switch(a.agentClass){case ForeverAgent:a.agentClass=ForeverAgent.SSL;break;case http.Agent:a.agentClass=https.Agent;break;default:return}if(a.agent){a.agent=a.getAgent()}}else{a.httpModule=http;switch(a.agentClass){case ForeverAgent.SSL:a.agentClass=ForeverAgent;break;case https.Agent:a.agentClass=http.Agent;break;default:return}if(a.agent){a.agent=null;a.agent=a.getAgent()}}};Request.prototype.getAgent=function(){var a=this.agentClass;var b={};if(this.agentOptions){for(var d in this.agentOptions){b[d]=this.agentOptions[d]}}if(this.ca){b.ca=this.ca}if(this.ciphers){b.ciphers=this.ciphers}if(this.secureProtocol){b.secureProtocol=this.secureProtocol}if(this.secureOptions){b.secureOptions=this.secureOptions}if(typeof this.rejectUnauthorized!=="undefined"){b.rejectUnauthorized=this.rejectUnauthorized}if(this.cert&&this.key){b.key=this.key;b.cert=this.cert}var f="";if(a!==this.httpModule.Agent){f+=a.name}if(!this.httpModule.globalAgent){b.host=this.host;b.port=this.port;if(f){f+=":"}f+=this.host+":"+this.port}var c=this.proxy;if(typeof c==="string"){c=url.parse(c)}var e=(c&&c.protocol==="https:")||this.uri.protocol==="https:";if(e){if(b.ca){if(f){f+=":"}f+=b.ca}if(typeof b.rejectUnauthorized!=="undefined"){if(f){f+=":"}f+=b.rejectUnauthorized}if(b.cert){f+=b.cert.toString("ascii")+b.key.toString("ascii")}if(b.ciphers){if(f){f+=":"}f+=b.ciphers}if(b.secureProtocol){if(f){f+=":"}f+=b.secureProtocol}if(b.secureOptions){if(f){f+=":"}f+=b.secureOptions}}if(this.pool===globalPool&&!f&&Object.keys(b).length===0&&this.httpModule.globalAgent){return this.httpModule.globalAgent}f=this.uri.protocol+f;if(this.pool[f]){return this.pool[f]}return this.pool[f]=new a(b)};Request.prototype.start=function(){var a=this;if(a._aborted){return}a._started=true;a.method=a.method||"GET";a.href=a.uri.href;if(a.src&&a.src.stat&&a.src.stat.size&&!a.hasHeader("content-length")){a.setHeader("content-length",a.src.stat.size)}if(a._aws){a.aws(a._aws,true)}var b=copy(a);delete b.auth;debug("make request",a.uri.href);a.req=a.httpModule.request(b,a.onResponse.bind(a));if(a.timeout&&!a.timeoutTimer){a.timeoutTimer=setTimeout(function(){a.req.abort();var c=new Error("ETIMEDOUT");c.code="ETIMEDOUT";a.emit("error",c)},a.timeout);if(a.req.setTimeout){a.req.setTimeout(a.timeout,function(){if(a.req){a.req.abort();var c=new Error("ESOCKETTIMEDOUT");c.code="ESOCKETTIMEDOUT";a.emit("error",c)}})}}a.req.on("error",a.clientErrorHandler);a.req.on("drain",function(){a.emit("drain")});a.on("end",function(){if(a.req.connection){a.req.connection.removeListener("error",a._parserErrorHandler)}});a.emit("request",a.req)};Request.prototype.onResponse=function(b){var p=this;debug("onResponse",p.uri.href,b.statusCode,b.headers);b.on("end",function(){debug("response end",p.uri.href,b.statusCode,b.headers)});if(b.connection&&b.connection.listeners("error").indexOf(p._parserErrorHandler)===-1){b.connection.setMaxListeners(0);b.connection.once("error",p._parserErrorHandler)}if(p._aborted){debug("aborted",p.uri.href);b.resume();return}if(p._paused){b.pause()}else{b.resume&&b.resume()}p.response=b;b.request=p;b.toJSON=responseToJSON;if(p.httpModule===https&&p.strictSSL&&(!b.hasOwnProperty("client")||!b.client.authorized)){debug("strict ssl error",p.uri.href);var u=b.hasOwnProperty("client")?b.client.authorizationError:p.uri.href+" does not support SSL";p.emit("error",new Error("SSL Error: "+u));return}if(p.setHost){p.removeHeader("host")}if(p.timeout&&p.timeoutTimer){clearTimeout(p.timeoutTimer);p.timeoutTimer=null}var f=(p._jar&&p._jar.setCookie)?p._jar:globalCookieJar;var m=function(k){try{f.setCookie(k,p.uri.href,{ignoreError:true})}catch(C){p.emit("error",C)}};b.caseless=caseless(b.headers);if(b.caseless.has("set-cookie")&&(!p._disableCookies)){var o=b.caseless.has("set-cookie");if(Array.isArray(b.headers[o])){b.headers[o].forEach(m)}else{m(b.headers[o])}}var w=null;if(b.statusCode>=300&&b.statusCode<400&&b.caseless.has("location")){var a=b.caseless.get("location");debug("redirect",a);if(p.followAllRedirects){w=a}else{if(p.followRedirect){switch(p.method){case"PATCH":case"PUT":case"POST":case"DELETE":break;default:w=a;break}}}}else{if(b.statusCode==401&&p._hasAuth&&!p._sentAuth){var z=b.caseless.get("www-authenticate");var v=z&&z.split(" ")[0].toLowerCase();debug("reauth",v);switch(v){case"basic":p.auth(p._user,p._pass,true);w=p.uri;break;case"bearer":p.auth(null,null,true,p._bearer);w=p.uri;break;case"digest":var B={};var q=/([a-z0-9_-]+)=(?:"([^"]+)"|([a-z0-9_-]+))/gi;for(;;){var i=q.exec(z);if(!i){break}B[i[1]]=i[2]||i[3]}var n=md5(p._user+":"+B.realm+":"+p._pass);var l=md5(p.method+":"+p.uri.path);var A=/(^|,)\s*auth\s*($|,)/.test(B.qop)&&"auth";var h=A&&"00000001";var y=A&&uuid().replace(/-/g,"");var x=A?md5(n+":"+B.nonce+":"+h+":"+y+":"+A+":"+l):md5(n+":"+B.nonce+":"+l);var d={username:p._user,realm:B.realm,nonce:B.nonce,uri:p.uri.path,qop:A,response:x,nc:h,cnonce:y,algorithm:B.algorithm,opaque:B.opaque};z=[];for(var t in d){if(!d[t]){}else{if(t==="qop"||t==="nc"||t==="algorithm"){z.push(t+"="+d[t])}else{z.push(t+'="'+d[t]+'"')}}}z="Digest "+z.join(", ");p.setHeader("authorization",z);p._sentAuth=true;w=p.uri;break}}}if(w&&p.allowRedirect.call(p,b)){debug("redirect to",w);if(p._paused){b.resume()}if(p._redirectsFollowed>=p.maxRedirects){p.emit("error",new Error("Exceeded maxRedirects. Probably stuck in a redirect loop "+p.uri.href));return}p._redirectsFollowed+=1;if(!isUrl.test(w)){w=url.resolve(p.uri.href,w)}var c=p.uri;p.uri=url.parse(w);if(p.uri.protocol!==c.protocol){p._updateProtocol()}p.redirects.push({statusCode:b.statusCode,redirectUri:w});if(p.followAllRedirects&&b.statusCode!=401&&b.statusCode!=307){p.method="GET"}delete p.src;delete p.req;delete p.agent;delete p._started;if(b.statusCode!=401&&b.statusCode!=307){delete p.body;delete p._form;if(p.headers){p.removeHeader("host");p.removeHeader("content-type");p.removeHeader("content-length")}}p.emit("redirect");p.init();return}else{p._redirectsFollowed=p._redirectsFollowed||0;b.on("close",function(){if(!p._ended){p.response.emit("end")}});b.on("end",function(){p._ended=true});var j;if(p.gzip){var g=b.headers["content-encoding"]||"identity";g=g.trim().toLowerCase();if(g==="gzip"){j=zlib.createGunzip();b.pipe(j)}else{if(g!=="identity"){debug("ignoring unrecognized Content-Encoding "+g)}j=b}}else{j=b}if(p.encoding){if(p.dests.length!==0){console.error("Ignoring encoding parameter as this stream is being piped to another stream which makes the encoding option invalid.")}else{if(j.setEncoding){j.setEncoding(p.encoding)}else{j=j.pipe(stringstream(p.encoding))}}}p.emit("response",b);p.dests.forEach(function(k){p.pipeDest(k)});j.on("data",function(k){p._destdata=true;p.emit("data",k)});j.on("end",function(k){p.emit("end",k)});j.on("close",function(){p.emit("close")});if(p.callback){var s=bl(),e=[];p.on("data",function(k){if(Buffer.isBuffer(k)){s.append(k)}else{e.push(k)}});p.on("end",function(){debug("end event",p.uri.href);if(p._aborted){debug("aborted",p.uri.href);return}if(s.length){debug("has body",p.uri.href,s.length);if(p.encoding===null){b.body=s.slice()}else{b.body=s.toString(p.encoding)}}else{if(e.length){if(p.encoding==="utf8"&&e[0].length>0&&e[0][0]==="\uFEFF"){e[0]=e[0].substring(1)}b.body=e.join("")}}if(p._json){try{b.body=JSON.parse(b.body)}catch(k){}}debug("emitting complete",p.uri.href);if(b.body==undefined&&!p._json){b.body=""}p.emit("complete",b,b.body)})}else{p.on("end",function(){if(p._aborted){debug("aborted",p.uri.href);return}p.emit("complete",b)})}}debug("finish init function",p.uri.href)};Request.prototype.abort=function(){this._aborted=true;if(this.req){this.req.abort()}else{if(this.response){this.response.abort()}}this.emit("abort")};Request.prototype.pipeDest=function(b){var a=this.response;if(b.headers&&!b.headersSent){if(a.caseless.has("content-type")){var e=a.caseless.has("content-type");if(b.setHeader){b.setHeader(e,a.headers[e])}else{b.headers[e]=a.headers[e]}}if(a.caseless.has("content-length")){var d=a.caseless.has("content-length");if(b.setHeader){b.setHeader(d,a.headers[d])}else{b.headers[d]=a.headers[d]}}}if(b.setHeader&&!b.headersSent){for(var c in a.headers){if(!this.gzip||c!=="content-encoding"){b.setHeader(c,a.headers[c])}}b.statusCode=a.statusCode}if(this.pipefilter){this.pipefilter(a,b)}};Request.prototype.qs=function(c,d){var b;if(!d&&this.uri.query){b=qs.parse(this.uri.query)}else{b={}}for(var a in c){b[a]=c[a]}if(qs.stringify(b)===""){return this}this.uri=url.parse(this.uri.href.split("?")[0]+"?"+qs.stringify(b));this.url=this.uri;this.path=this.uri.path;return this};Request.prototype.form=function(a){if(a){this.setHeader("content-type","application/x-www-form-urlencoded; charset=utf-8");this.body=(typeof a==="string")?a.toString("utf8"):qs.stringify(a).toString("utf8");return this}this._form=new FormData();return this._form};Request.prototype.multipart=function(b){var a=this;a.body=[];if(!a.hasHeader("content-type")){a.setHeader("content-type","multipart/related; boundary="+a.boundary)}else{var c=a.hasHeader("content-type");a.setHeader(c,a.headers[c].split(";")[0]+"; boundary="+a.boundary)}if(!b.forEach){throw new Error("Argument error, options.multipart.")}if(a.preambleCRLF){a.body.push(new Buffer("\r\n"))}b.forEach(function(e){var d=e.body;if(d==null){throw Error("Body attribute missing in multipart.")}delete e.body;var f="--"+a.boundary+"\r\n";Object.keys(e).forEach(function(g){f+=g+": "+e[g]+"\r\n"});f+="\r\n";a.body.push(new Buffer(f));a.body.push(new Buffer(d));a.body.push(new Buffer("\r\n"))});a.body.push(new Buffer("--"+a.boundary+"--"));return a};Request.prototype.json=function(b){var a=this;if(!a.hasHeader("accept")){a.setHeader("accept","application/json")}this._json=true;if(typeof b==="boolean"){if(typeof this.body==="object"){this.body=safeStringify(this.body);if(!a.hasHeader("content-type")){a.setHeader("content-type","application/json")}}}else{this.body=safeStringify(b);if(!a.hasHeader("content-type")){a.setHeader("content-type","application/json")}}return this};Request.prototype.getHeader=function(c,e){var a,d,b;if(!e){e=this.headers}Object.keys(e).forEach(function(f){if(f.length!==c.length){return}d=new RegExp(c,"i");b=f.match(d);if(b){a=e[f]}});return a};var getHeader=Request.prototype.getHeader;Request.prototype.auth=function(b,d,a,c){if(c!==undefined){this._bearer=c;this._hasAuth=true;if(a||typeof a=="undefined"){if(typeof c==="function"){c=c()}this.setHeader("authorization","Bearer "+c);this._sentAuth=true}return this}if(typeof b!=="string"||(d!==undefined&&typeof d!=="string")){throw new Error("auth() received invalid user or password")}this._user=b;this._pass=d;this._hasAuth=true;var e=typeof d!=="undefined"?b+":"+d:b;if(a||typeof a=="undefined"){this.setHeader("authorization","Basic "+toBase64(e));this._sentAuth=true}return this};Request.prototype.aws=function(d,b){if(!b){this._aws=d;return this}var a=new Date();this.setHeader("date",a.toUTCString());var c={key:d.key,secret:d.secret,verb:this.method.toUpperCase(),date:a,contentType:this.getHeader("content-type")||"",md5:this.getHeader("content-md5")||"",amazonHeaders:aws.canonicalizeHeaders(this.headers)};var e=this.uri.path;if(d.bucket&&e){c.resource="/"+d.bucket+e}else{if(d.bucket&&!e){c.resource="/"+d.bucket}else{if(!d.bucket&&e){c.resource=e}else{if(!d.bucket&&!e){c.resource="/"}}}}c.resource=aws.canonicalizeResource(c.resource);this.setHeader("authorization",aws.authorization(c));return this};Request.prototype.httpSignature=function(b){var a=this;httpSignature.signRequest({getHeader:function(c){return getHeader(c,a.headers)},setHeader:function(d,c){a.setHeader(d,c)},method:this.method,path:this.path},b);debug("httpSignature authorization",this.getHeader("authorization"));return this};Request.prototype.hawk=function(a){this.setHeader("Authorization",hawk.client.header(this.uri,this.method,a).field)};Request.prototype.oauth=function(m){var b,l;if(this.hasHeader("content-type")&&this.getHeader("content-type").slice(0,"application/x-www-form-urlencoded".length)==="application/x-www-form-urlencoded"){b=this.body}if(this.uri.query){l=this.uri.query}var c={};for(var g in m){c["oauth_"+g]=m[g]}if("oauth_realm" in c){delete c.oauth_realm}if(!c.oauth_version){c.oauth_version="1.0"}if(!c.oauth_timestamp){c.oauth_timestamp=Math.floor(Date.now()/1000).toString()}if(!c.oauth_nonce){c.oauth_nonce=uuid().replace(/-/g,"")}c.oauth_signature_method="HMAC-SHA1";var a=c.oauth_consumer_secret;delete c.oauth_consumer_secret;var f=c.oauth_token_secret;delete c.oauth_token_secret;var j=this.uri.protocol+"//"+this.uri.host+this.uri.pathname;var e=qs.parse([].concat(l,b,qs.stringify(c)).join("&"));var d=oauth.hmacsign(this.method,j,e,a,f);var h=m.realm?'realm="'+m.realm+'",':"";var k="OAuth "+h+Object.keys(c).sort().map(function(n){return n+'="'+oauth.rfc3986(c[n])+'"'}).join(",");k+=',oauth_signature="'+oauth.rfc3986(d)+'"';this.setHeader("Authorization",k);return this};Request.prototype.jar=function(d){var c;if(this._redirectsFollowed===0){this.originalCookieHeader=this.getHeader("cookie")}if(!d){c=false;this._disableCookies=true}else{var b=(d&&d.getCookieString)?d:globalCookieJar;var a=this.uri.href;if(b){c=b.getCookieString(a)}}if(c&&c.length){if(this.originalCookieHeader){this.setHeader("cookie",this.originalCookieHeader+"; "+c)}else{this.setHeader("cookie",c)}}this._jar=d;return this};Request.prototype.pipe=function(a,b){if(this.response){if(this._destdata){throw new Error("You cannot pipe after data has been emitted from the response.")}else{if(this._ended){throw new Error("You cannot pipe after the response has been ended.")}else{stream.Stream.prototype.pipe.call(this,a,b);this.pipeDest(a);return a}}}else{this.dests.push(a);stream.Stream.prototype.pipe.call(this,a,b);return a}};Request.prototype.write=function(){if(!this._started){this.start()}return this.req.write.apply(this.req,arguments)};Request.prototype.end=function(a){if(a){this.write(a)}if(!this._started){this.start()}this.req.end()};Request.prototype.pause=function(){if(!this.response){this._paused=true}else{this.response.pause.apply(this.response,arguments)}};Request.prototype.resume=function(){if(!this.response){this._paused=false}else{this.response.resume.apply(this.response,arguments)}};Request.prototype.destroy=function(){if(!this._ended){this.end()}else{if(this.response){this.response.destroy()}}};Request.prototype.toJSON=requestToJSON;Request.defaultProxyHeaderWhiteList=defaultProxyHeaderWhiteList.slice();module.exports=Request;