var fs=require("./fs.js");var constants=require("constants");var origCwd=process.cwd;var cwd=null;process.cwd=function(){if(!cwd){cwd=origCwd.call(process)}return cwd};try{process.cwd()}catch(er){}var chdir=process.chdir;process.chdir=function(a){cwd=null;chdir.call(process,a)};module.exports=patch;function patch(a){if(constants.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)){patchLchmod(a)}if(!a.lutimes){patchLutimes(a)}a.chown=chownFix(a.chown);a.fchown=chownFix(a.fchown);a.lchown=chownFix(a.lchown);a.chmod=chownFix(a.chmod);a.fchmod=chownFix(a.fchmod);a.lchmod=chownFix(a.lchmod);a.chownSync=chownFixSync(a.chownSync);a.fchownSync=chownFixSync(a.fchownSync);a.lchownSync=chownFixSync(a.lchownSync);a.chmodSync=chownFix(a.chmodSync);a.fchmodSync=chownFix(a.fchmodSync);a.lchmodSync=chownFix(a.lchmodSync);if(!a.lchmod){a.lchmod=function(c,d,b){process.nextTick(b)};a.lchmodSync=function(){}}if(!a.lchown){a.lchown=function(e,c,d,b){process.nextTick(b)};a.lchownSync=function(){}}if(process.platform==="win32"){a.rename=(function(b){return function(g,f,c){var e=Date.now();b(g,f,function d(h){if(h&&(h.code==="EACCES"||h.code==="EPERM")&&Date.now()-e<1000){return b(g,f,d)}if(c){c(h)}})}})(a.rename)}a.read=(function(b){return function(f,d,i,g,c,e){var j;if(e&&typeof e==="function"){var h=0;j=function(m,k,l){if(m&&m.code==="EAGAIN"&&h<10){h++;return b.call(a,f,d,i,g,c,j)}e.apply(this,arguments)}}return b.call(a,f,d,i,g,c,j)}})(a.read);a.readSync=(function(b){return function(e,d,h,f,c){var g=0;while(true){try{return b.call(a,e,d,h,f,c)}catch(i){if(i.code==="EAGAIN"&&g<10){g++;continue}throw i}}}})(a.readSync)}function patchLchmod(a){a.lchmod=function(b,c,d){d=d||noop;a.open(b,constants.O_WRONLY|constants.O_SYMLINK,c,function(f,e){if(f){d(f);return}a.fchmod(e,c,function(g){a.close(e,function(h){d(g||h)})})})};a.lchmodSync=function(d,e){var c=a.openSync(d,constants.O_WRONLY|constants.O_SYMLINK,e);var g=true;var b;try{b=a.fchmodSync(c,e);g=false}finally{if(g){try{a.closeSync(c)}catch(f){}}else{a.closeSync(c)}}return b}}function patchLutimes(a){if(constants.hasOwnProperty("O_SYMLINK")){a.lutimes=function(e,c,d,b){a.open(e,constants.O_SYMLINK,function(g,f){b=b||noop;if(g){return b(g)}a.futimes(f,c,d,function(h){a.close(f,function(i){return b(h||i)})})})};a.lutimesSync=function(f,b,c){var e=a.openSync(f,constants.O_SYMLINK);var d;var h=true;try{d=a.futimesSync(e,b,c);h=false}finally{if(h){try{a.closeSync(e)}catch(g){}}else{a.closeSync(e)}}return d}}else{a.lutimes=function(e,d,c,b){process.nextTick(b)};a.lutimesSync=function(){}}}function chownFix(a){if(!a){return a}return function(e,c,d,b){return a.call(fs,e,c,d,function(g,f){if(chownErOk(g)){g=null}b(g,f)})}}function chownFixSync(a){if(!a){return a}return function(d,b,c){try{return a.call(fs,d,b,c)}catch(e){if(!chownErOk(e)){throw e}}}}function chownErOk(b){if(!b){return true}if(b.code==="ENOSYS"){return true}var a=!process.getuid||process.getuid()!==0;if(a){if(b.code==="EINVAL"||b.code==="EPERM"){return true}}return false};