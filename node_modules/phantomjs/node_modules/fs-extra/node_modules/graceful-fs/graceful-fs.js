var fs=require("fs");var polyfills=require("./polyfills.js");var legacy=require("./legacy-streams.js");var queue=[];var util=require("util");function noop(){}var debug=noop;if(util.debuglog){debug=util.debuglog("gfs4")}else{if(/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")){debug=function(){var a=util.format.apply(util,arguments);a="GFS4: "+a.split(/\n/).join("\nGFS4: ");console.error(a)}}}if(/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")){process.on("exit",function(){debug(queue);require("assert").equal(queue.length,0)})}module.exports=patch(require("./fs.js"));if(process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH){module.exports=patch(fs)}fs.close=(function(a){return function(c,b){return a.call(fs,c,function(d){if(!d){retry()}if(typeof b==="function"){b.apply(this,arguments)}})}})(fs.close);fs.closeSync=(function(a){return function(b){var c=a.apply(fs,arguments);retry();return c}})(fs.closeSync);function patch(h){polyfills(h);h.gracefulify=patch;h.FileReadStream=q;h.FileWriteStream=p;h.createReadStream=k;h.createWriteStream=m;var c=h.readFile;h.readFile=b;function b(x,w,u){if(typeof w==="function"){u=w,w=null}return v(x,w,u);function v(A,z,y){return c(A,z,function(B){if(B&&(B.code==="EMFILE"||B.code==="ENFILE")){enqueue([v,[A,z,y]])}else{if(typeof y==="function"){y.apply(this,arguments)}retry()}})}}var t=h.writeFile;h.writeFile=n;function n(y,x,v,u){if(typeof v==="function"){u=v,v=null}return w(y,x,v,u);function w(C,B,A,z){return t(C,B,A,function(D){if(D&&(D.code==="EMFILE"||D.code==="ENFILE")){enqueue([w,[C,B,A,z]])}else{if(typeof z==="function"){z.apply(this,arguments)}retry()}})}}var e=h.appendFile;if(e){h.appendFile=f}function f(y,x,v,u){if(typeof v==="function"){u=v,v=null}return w(y,x,v,u);function w(C,B,A,z){return e(C,B,A,function(D){if(D&&(D.code==="EMFILE"||D.code==="ENFILE")){enqueue([w,[C,B,A,z]])}else{if(typeof z==="function"){z.apply(this,arguments)}retry()}})}}var s=h.readdir;h.readdir=r;function r(w,u){return v(w,u);function v(){return s(w,function(y,x){if(x&&x.sort){x.sort()}if(y&&(y.code==="EMFILE"||y.code==="ENFILE")){enqueue([v,[w,u]])}else{if(typeof u==="function"){u.apply(this,arguments)}retry()}})}}if(process.version.substr(0,4)==="v0.8"){var j=legacy(h);q=j.ReadStream;p=j.WriteStream}var d=h.ReadStream;q.prototype=Object.create(d.prototype);q.prototype.open=o;var g=h.WriteStream;p.prototype=Object.create(g.prototype);p.prototype.open=a;h.ReadStream=q;h.WriteStream=p;function q(v,u){if(this instanceof q){return d.apply(this,arguments),this}else{return q.apply(Object.create(q.prototype),arguments)}}function o(){var u=this;l(u.path,u.flags,u.mode,function(w,v){if(w){if(u.autoClose){u.destroy()}u.emit("error",w)}else{u.fd=v;u.emit("open",v);u.read()}})}function p(v,u){if(this instanceof p){return g.apply(this,arguments),this}else{return p.apply(Object.create(p.prototype),arguments)}}function a(){var u=this;l(u.path,u.flags,u.mode,function(w,v){if(w){u.destroy();u.emit("error",w)}else{u.fd=v;u.emit("open",v)}})}function k(v,u){return new q(v,u)}function m(v,u){return new p(v,u)}var i=h.open;h.open=l;function l(x,v,y,u){if(typeof y==="function"){u=y,y=null}return w(x,v,y,u);function w(B,A,C,z){return i(B,A,C,function(E,D){if(E&&(E.code==="EMFILE"||E.code==="ENFILE")){enqueue([w,[B,A,C,z]])}else{if(typeof z==="function"){z.apply(this,arguments)}retry()}})}}return h}function enqueue(a){debug("ENQUEUE",a[0].name,a[1]);queue.push(a)}function retry(){var a=queue.shift();if(a){debug("RETRY",a[0].name,a[1]);a[0].apply(null,a[1])}};