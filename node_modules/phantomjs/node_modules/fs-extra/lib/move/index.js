var fs=require("graceful-fs");var ncp=require("../copy/ncp");var path=require("path");var rimraf=require("rimraf");var mkdirp=require("../mkdirs").mkdirs;function mv(a,f,i,h){if(typeof i==="function"){h=i;i={}}var c=("mkdirp" in i)?i.mkdirp:true;var g=("clobber" in i)?i.clobber:false;var d=i.limit||16;if(c){b()}else{e()}function b(){mkdirp(path.dirname(f),function(j){if(j){return h(j)}e()})}function e(){if(g){fs.rename(a,f,function(j){if(!j){return h()}if(j.code==="ENOTEMPTY"||j.code==="EEXIST"){rimraf(f,function(k){if(k){return h(k)}i.clobber=false;mv(a,f,i,h)});return}if(j.code==="EPERM"){setTimeout(function(){rimraf(f,function(k){if(k){return h(k)}i.clobber=false;mv(a,f,i,h)})},200);return}if(j.code!=="EXDEV"){return h(j)}moveAcrossDevice(a,f,g,d,h)})}else{fs.link(a,f,function(j){if(j){if(j.code==="EXDEV"||j.code==="EISDIR"||j.code==="EPERM"){moveAcrossDevice(a,f,g,d,h);return}h(j);return}fs.unlink(a,h)})}}}function moveAcrossDevice(c,b,e,a,d){fs.stat(c,function(g,f){if(g){d(g);return}if(f.isDirectory()){moveDirAcrossDevice(c,b,e,a,d)}else{moveFileAcrossDevice(c,b,e,a,d)}})}function moveFileAcrossDevice(a,g,h,d,i){var c=h?"w":"wx";var e=fs.createReadStream(a);var b=fs.createWriteStream(g,{flags:c});e.on("error",function(j){e.destroy();b.destroy();b.removeListener("close",f);fs.unlink(g,function(){if(j.code==="EISDIR"||j.code==="EPERM"){moveDirAcrossDevice(a,g,h,d,i)}else{i(j)}})});b.on("error",function(j){e.destroy();b.destroy();b.removeListener("close",f);i(j)});b.once("close",f);e.pipe(b);function f(){fs.unlink(a,i)}}function moveDirAcrossDevice(e,d,g,b,f){var c={stopOnErr:true,clobber:false,limit:b};function a(){ncp(e,d,c,function(h){if(h){return f(h[0])}rimraf(e,f)})}if(g){rimraf(d,function(h){if(h){return f(h)}a()})}else{a()}}module.exports={move:mv};