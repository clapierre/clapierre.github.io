var fs=require("graceful-fs");var path=require("path");var utimes=require("../util/utimes");function ncp(y,q,i,j){if(!j){j=i;i={}}var E=process.cwd();var c=path.resolve(E,y);var h=path.resolve(E,q);var s=i.filter;var t=i.transform;var w=i.clobber!==false;var p=i.dereference;var d=i.preserveTimestamps===true;var r=null;var b=0;var m=0;var f=0;var C=i.limit||512;D(c);function D(F){b++;if(s){if(s instanceof RegExp){if(!s.test(F)){return v(true)}}else{if(typeof s==="function"){if(!s(F)){return v(true)}}}}return o(F)}function o(G){var F=p?fs.stat:fs.lstat;if(f>=C){return setImmediate(function(){o(G)})}f++;F(G,function(J,H){if(J){return k(J)}var I={name:G,mode:H.mode,mtime:H.mtime,atime:H.atime,stats:H};if(H.isDirectory()){return B(I)}else{if(H.isFile()){return x(I)}else{if(H.isSymbolicLink()){return a(G)}}}})}function x(F){var G=F.name.replace(c,h);u(G,function(H){if(H){l(F,G)}else{if(w){n(G,function(){l(F,G)})}else{v()}}})}function l(G,I){var F=fs.createReadStream(G.name);var H=fs.createWriteStream(I,{mode:G.mode});F.on("error",k);H.on("error",k);if(t){t(F,H,G)}else{H.on("open",function(){F.pipe(H)})}H.once("finish",function(){fs.chmod(I,G.mode,function(J){if(J){return k(J)}if(d){utimes.utimesMillis(I,G.atime,G.mtime,function(K){if(K){return k(K)}return v()})}else{v()}})})}function n(G,F){fs.unlink(G,function(H){if(H){return k(H)}return F()})}function B(F){var G=F.name.replace(c,h);u(G,function(H){if(H){return e(F,G)}A(F.name)})}function e(F,G){fs.mkdir(G,F.mode,function(H){if(H){return k(H)}fs.chmod(G,F.mode,function(I){if(I){return k(I)}A(F.name)})})}function A(F){fs.readdir(F,function(H,G){if(H){return k(H)}G.forEach(function(I){D(path.join(F,I))});return v()})}function a(F){var G=F.replace(c,h);fs.readlink(F,function(I,H){if(I){return k(I)}z(H,G)})}function z(F,G){if(p){F=path.resolve(E,F)}u(G,function(H){if(H){return g(F,G)}fs.readlink(G,function(J,I){if(J){return k(J)}if(p){I=path.resolve(E,I)}if(I===F){return v()}return n(G,function(){g(F,G)})})})}function g(F,G){fs.symlink(F,G,function(H){if(H){return k(H)}return v()})}function u(G,F){fs.lstat(G,function(H){if(H){if(H.code==="ENOENT"){return F(true)}return F(false)}return F(false)})}function k(F){if(i.stopOnError){return j(F)}else{if(!r&&i.errs){r=fs.createWriteStream(i.errs)}else{if(!r){r=[]}}}if(typeof r.write==="undefined"){r.push(F)}else{r.write(F.stack+"\n\n")}return v()}function v(F){if(!F){f--}m++;if((b===m)&&(f===0)){if(j!==undefined){return r?j(r):j(null)}}}}module.exports=ncp;