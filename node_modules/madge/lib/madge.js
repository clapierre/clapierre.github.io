"use strict";var util=require("util"),requirejs=require("./requirejs"),cyclic=require("./cyclic"),CJS=require("./parse/cjs"),AMD=require("./parse/amd"),ES6=require("./parse/es6"),graph=require("./graph");function mergeTrees(d,c){Object.keys(c).forEach(function(a){if(!d[a]){d[a]=[]}c[a].forEach(function(b){if(d[a].indexOf(b)<0){d[a].push(b)}})})}function convertPathsToIds(i,h,g){var j,b,d,e,a,c,f;if(g){g+="/"}else{g=""}Object.keys(h).forEach(function(k){j=h[k];if(!/^[^\/]+:\/\/|^\//m.test(j)){j=g+j}if(j!==k&&i[j]){if(i[k]&&i[k].length>0){b=i[j].slice(0,i[j].length-1);for(d=0,e=b.length;d<e;++d){for(a=0,c=i[k].length;a<c;++a){if(b[d]===i[k][a]){b.splice(d--,1);break}}}i[k]=i[k].concat(b)}else{i[k]=i[j]}delete i[j]}else{if(!i[k]){i[k]=[]}}Object.keys(h).forEach(function(l){j=g+h[l];if(i[l]){for(d=0,e=i[l].length;d<e;++d){if(i[l][d]===j){i[l][d]=l}}}})})}module.exports=function(b,a){return new Madge(b,a)};function Madge(d,c){var a=[];this.opts=c||{};this.opts.format=String(this.opts.format||"cjs").toLowerCase();if(typeof(d)==="object"&&!Array.isArray(d)){this.tree=d;return}if(typeof(d)==="string"){d=[d]}if(d&&d.length){a=this.parse(d)}if(this.opts.requireConfig){var b=d.length?d[0].replace(/\\/g,"/"):"";b=requirejs.getBaseUrlFromConfig(this.opts.requireConfig,b);convertPathsToIds(a,requirejs.getPathsFromConfig(this.opts.requireConfig,this.opts.exclude),b);mergeTrees(a,requirejs.getShimDepsFromConfig(this.opts.requireConfig,this.opts.exclude))}this.tree=a}Madge.prototype.parse=function(a){if(this.opts.format==="cjs"){return new CJS(a,this.opts,this).tree}else{if(this.opts.format==="amd"){return new AMD(a,this.opts,this).tree}else{if(this.opts.format==="es6"){return new ES6(a,this.opts,this).tree}else{throw new Error('invalid module format "'+this.opts.format+'"')}}}};Madge.prototype.obj=function(){return this.tree};Madge.prototype.circular=function(){return cyclic(this.tree)};Madge.prototype.depends=function(a){return Object.keys(this.tree).filter(function(b){if(this.tree[b]){return this.tree[b].reduce(function(d,c){if(c===a){d=b}return d},false)}},this)};Madge.prototype.dot=function(){return graph.dot(this.tree)};Madge.prototype.image=function(a,b){graph.image(this.tree,a,b)};