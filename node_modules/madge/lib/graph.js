"use strict";var exec=require("child_process").exec,cyclic=require("./cyclic"),graphviz=require("graphviz");function nodeColor(b,a){b.set("color",a);b.set("fontcolor",a)}function noDependencyNode(b,a){nodeColor(b,a||"#cfffac")}function checkGraphvizInstalled(){exec("gvpr -V",function(c,a,b){if(c!==null){throw new Error('Graphviz could not be found. Ensure that "gvpr" is in your $PATH.\n'+c)}})}function createGraphvizOptions(b){var a={layout:b.layout||"dot",overlap:false,bgcolor:"#ffffff"},d={fontname:b.fontFace||"Times-Roman",fontsize:b.fontSize||14},c={};if(b.colors){a.bgcolor=b.imageColors.bgcolor||"#000000";c.color=b.imageColors.edge||"#757575";d.color=b.imageColors.dependencies||"#c6c5fe";d.fontcolor=b.imageColors.fontColor||b.imageColors.dependencies||"#c6c5fe"}return{type:"png",G:a,E:c,N:d}}module.exports.image=function(c,e,f){var d=graphviz.digraph("G");checkGraphvizInstalled();e.imageColors=e.imageColors||{};var b={},a=cyclic(c);Object.keys(c).forEach(function(g){b[g]=b[g]||d.addNode(g);if(e.colors&&c[g]){if(!c[g].length){noDependencyNode(b[g],e.imageColors.noDependencies)}else{if(a.isCyclic(g)){nodeColor(b[g],(e.imageColors.circular||"#ff6c60"))}}}c[g].forEach(function(h){b[h]=b[h]||d.addNode(h);if(e.colors&&!c[h]){noDependencyNode(b[h],e.imageColors.noDependencies)}d.addEdge(b[g],b[h])})});d.output(createGraphvizOptions(e),f)};module.exports.dot=function(b){var a={},c=graphviz.digraph("G");checkGraphvizInstalled();Object.keys(b).forEach(function(e){var d=a[e]=a[e]||c.addNode(e);b[e].forEach(function(f){a[f]=a[f]||c.addNode(f);c.addEdge(a[e],a[f])})});return c.to_dot()};