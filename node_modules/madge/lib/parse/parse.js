"use strict";var uglify=require("uglify-js"),parser=uglify.parser,processor=uglify.uglify,ostring=Object.prototype.toString,isArray;if(Array.isArray){isArray=Array.isArray}else{isArray=function(a){return ostring.call(a)==="[object Array]"}}function isArrayLiteral(a){return a[0]==="array"}function isObjectLiteral(a){return a[0]==="object"}function toAstArray(c){var a=["array",[]],b,d;for(b=0;(d=c[b]);b++){a[1].push(["string",d])}return a}function validateDeps(b){var c=["array",[]],e,a,d;if(!b){return null}if(isObjectLiteral(b)||b[0]==="function"){return b}if(!isArrayLiteral(b)){return null}e=b[1];for(a=0;a<e.length;a++){d=e[a];if(d[0]==="string"){c[1].push(d)}}return c[1].length?c:null}function getValidDeps(b){var c=[],e,a,d;if(!b){return null}if(isObjectLiteral(b)||b[0]==="function"){return null}if(!isArrayLiteral(b)){return null}e=b[1];for(a=0;a<e.length;a++){d=e[a];if(d[0]==="string"){c.push(d[1])}}return c.length?c:null}function parse(b,c,a,l){l=l||{};var j=[],m="",f=[],e=true,h=parser.parse(a),d,k,g;parse.recurse(h,function(o,n,i,p){if(i&&isArrayLiteral(i)){p=i;i=null}if(!(p=getValidDeps(p))){p=[]}if(i&&i[0]==="string"){i=i[1]}else{i=null}if(o==="define"&&(!i||i===b)){e=false}if(!i){j=j.concat(p)}else{f.push({name:i,deps:p})}return !l.findNestedDependencies},l);if(l.insertNeedsDefine&&e){m+='require.needsDefine("'+b+'");'}if(j.length||f.length){for(d=0;(k=f[d]);d++){if(m){m+="\n"}if(k.name===b){k.deps=k.deps.concat(j);j=[]}g=k.deps.length?'["'+k.deps.join('","')+'"]':"[]";m+='define("'+k.name+'",'+g+");"}if(j.length){if(m){m+="\n"}g=j.length?'["'+j.join('","')+'"]':"[]";m+='define("'+b+'",'+g+");"}}return m?m:null}parse.isArray=isArray;parse.isObjectLiteral=isObjectLiteral;parse.isArrayLiteral=isArrayLiteral;parse.recurse=function(a,g,c,f){var b=c&&c.has,d,e;f=f||this.parseNode;if(isArray(a)){for(d=0;d<a.length;d++){e=a[d];if(isArray(e)){if(b&&e[0]==="if"&&e[1]&&e[1][0]==="name"&&(e[1][1]==="true"||e[1][1]==="false")){if(e[1][1]==="true"){this.recurse([e[2]],g,c,f)}else{this.recurse([e[3]],g,c,f)}}else{if(f(e,g)){continue}this.recurse(e,g,c,f)}}}}};parse.definesRequire=function(c,a){var b=parser.parse(a);return this.nodeHasRequire(b)};parse.getAnonDeps=function(d,a){var c=parser.parse(a),b=this.findAnonDefineFactory(c);return parse.getAnonDepsFromNode(b)};parse.getAnonDepsFromNode=function(a){var c=[],b;if(a){this.findRequireDepNames(a,c);b=a[2]&&a[2].length;if(b){c=(b>1?["require","exports","module"]:["require"]).concat(c)}}return c};parse.findAnonDefineFactory=function(d){var f,b,e,c,a;if(isArray(d)){if(d[0]==="call"){c=d[1];a=d[2];if((c[0]==="name"&&c[1]==="define")||(c[0]==="dot"&&c[1][1]==="require"&&c[2]==="def")){if(a.length===1&&a[0][0]==="function"){return a[0]}else{if(a.length===2&&a[0][0]==="string"&&a[1][0]==="function"){return a[1]}}}}for(b=0;b<d.length;b++){e=d[b];if((f=this.findAnonDefineFactory(e))){return f}}}return null};parse.findConfig=function(fileName,fileContents){var foundConfig=null,astRoot=parser.parse(fileContents);parse.recurse(astRoot,function(configNode){var jsConfig;if(!foundConfig&&configNode){jsConfig=parse.nodeToString(configNode);foundConfig=eval("("+jsConfig+")");return foundConfig}return undefined},null,parse.parseConfigNode);return foundConfig};parse.findDependencies=function(e,b,a){var c=[],d=parser.parse(b);parse.recurse(d,function(h,g,f,i){if(f&&isArrayLiteral(f)){i=f;f=null}if((i=getValidDeps(i))){c=c.concat(i)}},a);return c};parse.findCjsDependencies=function(e,b,a){var c=[],d=parser.parse(b);parse.recurse(d,function(f){c.push(f)},a,function(i,h){var g,f;if(!isArray(i)){return false}if(i[0]==="call"){g=i[1];f=i[2];if(g){if(g[0]==="name"&&g[1]==="require"&&f[0][0]==="string"){return h(f[0][1])}}}return false});return c};parse.usesAmdOrRequireJs=function(e,c,b){var d=parser.parse(c),a;parse.recurse(d,function(f){if(!a){a={}}a[f]=true},b,parse.findAmdOrRequireJsNode);return a};parse.usesCommonJs=function(f,c,b){var a=null,e=false,d=parser.parse(c);parse.recurse(d,function(g){if(g==="varExports"){e=true}else{if(g!=="exports"||!e){if(!a){a={}}a[g]=true}}},b,function(j,i){var h,g;if(!isArray(j)){return false}if(j[0]==="name"&&(j[1]==="__dirname"||j[1]==="__filename")){return i(j[1].substring(2))}else{if(j[0]==="var"&&j[1]&&j[1][0]&&j[1][0][0]==="exports"){return i("varExports")}else{if(j[0]==="assign"&&j[2]&&j[2][0]==="dot"){g=j[2][1];if(g){if(g[0]==="name"&&g[1]==="module"&&j[2][2]==="exports"){return i("moduleExports")}else{if(g[0]==="name"&&g[1]==="exports"){return i("exports")}}}}else{if(j[0]==="call"){h=j[1];g=j[2];if(h){if(h[0]==="name"&&h[1]==="require"&&g[0][0]==="string"){return i("require")}}}}}}return false});return a};parse.findRequireDepNames=function(e,f){var b,c,g,d,a;if(isArray(e)){if(e[0]==="call"){d=e[1];a=e[2];if(d&&d[0]==="name"&&d[1]==="require"){b=a[0];if(b[0]==="string"){f.push(b[1])}}}for(c=0;c<e.length;c++){g=e[c];this.findRequireDepNames(g,f)}}};parse.nodeHasRequire=function(b){if(this.isDefineNode(b)){return true}if(isArray(b)){for(var a=0,c;a<b.length;a++){c=b[a];if(this.nodeHasRequire(c)){return true}}}return false};parse.isDefineNode=function(b){var a;if(!b){return null}if(b[0]==="assign"&&b[1]===true){a=b[2];if(a[0]==="dot"&&a[1][0]==="name"&&a[1][1]==="define"&&a[2]==="amd"){return true}}return false};parse.parseNode=function(g,f){var e,d,c,h,b,a;if(!isArray(g)){return false}if(g[0]==="call"){e=g[1];b=g[2];if(e){if(e[0]==="name"&&(e[1]==="require"||e[1]==="requirejs")){c=b[0];h=b[1];if(isArrayLiteral(c)){h=c;c=null}if(!(h=validateDeps(h))){return null}return f("require",null,null,h)}else{if(e[0]==="name"&&e[1]==="define"){d=b[0];h=b[1];if(((d[0]==="string"||isArrayLiteral(d)||d[0]==="function"||isObjectLiteral(d)))&&(!h||isArrayLiteral(h)||h[0]==="function"||isObjectLiteral(h)||(isArrayLiteral(d)&&h[0]==="name"&&b.length===2))){if(d&&d[0]==="function"){a=parse.getAnonDepsFromNode(d);if(a.length){d=toAstArray(a)}}else{if(h&&h[0]==="function"){a=parse.getAnonDepsFromNode(h);if(a.length){h=toAstArray(a)}}}return f("define",null,d,h)}}}}}return false};parse.findAmdOrRequireJsNode=function(f,e){var d,b,a,c;if(!isArray(f)){return false}if(f[0]==="defun"&&f[1]==="define"){c="declaresDefine"}else{if(f[0]==="assign"&&f[2]&&f[2][2]==="amd"&&f[2][1]&&f[2][1][0]==="name"&&f[2][1][1]==="define"){c="defineAmd"}else{if(f[0]==="call"){d=f[1];b=f[2];if(d){if((d[0]==="dot"&&(d[1]&&d[1][0]==="name"&&(d[1][1]==="require"||d[1][1]==="requirejs"))&&d[2]==="config")){c=d[1][1]+"Config"}else{if(d[0]==="name"&&(d[1]==="require"||d[1]==="requirejs")){a=b[0];if(a[0]==="object"||a[0]==="array"){c=d[1]}}else{if(d[0]==="name"&&d[1]==="define"){c="define"}}}}}}}if(c){return e(c)}return false};parse.parseConfigNode=function(e,d){var c,a,b;if(!isArray(e)){return false}if(e[0]==="call"){c=e[1];b=e[2];if(c){if((c[0]==="dot"&&(c[1]&&c[1][0]==="name"&&(c[1][1]==="require"||c[1][1]==="requirejs"))&&c[2]==="config")||(c[0]==="name"&&(c[1]==="require"||c[1]==="requirejs"))){a=b[0];if(a[0]!=="object"){return null}return d(a)}}}return false};parse.nodeToString=function(a){return processor.gen_code(a,true)};module.exports=parse;