"use strict";var fs=require("fs"),path=require("path"),util=require("util"),resolve=require("resolve"),EventEmitter=require("events").EventEmitter,commondir=require("commondir"),finder=require("walkdir"),coffee=require("coffee-script"),jsx=require("react-tools");var Base=module.exports=function(c,b,a){if(b.onParseFile){this.on("parseFile",b.onParseFile.bind(a))}if(b.onAddModule){this.on("addModule",b.onAddModule.bind(a))}this.opts=b;if(typeof this.opts.extensions==="undefined"){this.opts.extensions=[".js"]}this.tree={};this.extRegEx=new RegExp("\\.(coffee|jsx|"+this.opts.extensions.map(function(d){return d.substring(1)}).join("|")+")$","g");this.coffeeExtRegEx=/\.coffee$/;this.jsxExtRegEx=/\.jsx$/;c=this.resolveTargets(c);this.excludeRegex=b.exclude?new RegExp(b.exclude):false;this.baseDir=this.getBaseDir(c);this.readFiles(c);this.sortDependencies()};util.inherits(Base,EventEmitter);Base.prototype.resolve=function(a,c){try{return resolve.sync(c,{basedir:a,paths:this.opts.paths,extensions:this.opts.extensions})}catch(b){if(this.opts.breakOnError){console.log(String("\nError while resolving module from: "+c).red);throw b}return c}};Base.prototype.getBaseDir=function(b){var a=commondir(b);if(!fs.statSync(a).isDirectory()){a=path.dirname(a)}return a};Base.prototype.resolveTargets=function(a){return a.map(function(b){return path.resolve(b)})};Base.prototype.normalize=function(a){return this.replaceBackslashInPath(path.relative(this.baseDir,a).replace(this.extRegEx,""))};Base.prototype.isExcluded=function(a){return this.excludeRegex&&a.match(this.excludeRegex)};Base.prototype.addModule=function(a){var b=this.normalize(a);if(!this.isExcluded(b)&&fs.existsSync(a)){this.tree[b]=this.parseFile(a);this.emit("addModule",{id:b,dependencies:this.tree[b]})}};Base.prototype.readFiles=function(a){a.forEach(function(b){if(fs.statSync(b).isDirectory()){finder.sync(b).filter(function(c){return c.match(this.extRegEx)},this).forEach(function(c){this.addModule(c)},this)}else{this.addModule(b)}},this)};Base.prototype.getFileSource=function(a){var b=fs.readFileSync(a,"utf8");if(a.match(this.coffeeExtRegEx)){b=coffee.compile(b,{header:false,bare:true})}else{if(a.match(this.jsxExtRegEx)){b=jsx.transform(b)}}return b};Base.prototype.sortDependencies=function(){var a=this;this.tree=Object.keys(this.tree).sort().reduce(function(b,c){(b[c]=a.tree[c]).sort();return b},{})};Base.prototype.replaceBackslashInPath=function(a){return a.replace(/\\/g,"/")};