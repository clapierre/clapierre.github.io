"use strict";var fs=require("fs"),path=require("path"),util=require("util"),amdetective=require("amdetective"),colors=require("colors"),Base=require("./base");var AMD=module.exports=function(){Base.apply(this,arguments)};util.inherits(AMD,Base);AMD.prototype.normalize=function(a){return this.replaceBackslashInPath(path.relative(this.baseDir,a).replace(this.extRegEx,""))};AMD.prototype.parseFile=function(a){try{var c=[],f=this.getFileSource(a),b={filename:a,src:f};this.emit("parseFile",b);if(/define|require\s*\(/m.test(b.src)){amdetective(b.src,{findNestedDependencies:this.opts.findNestedDependencies}).map(function(e){return typeof(e)==="string"?[e]:e.deps}).filter(function(e){e.filter(function(g){return g!=="require"&&g!=="exports"&&g!=="module"&&!g.match(/\.?\w\!/)}).map(function(h){if(h.charAt(0)!=="."){return h}var g=path.resolve(path.dirname(b.filename),h);if(g){return this.normalize(g)}},this).forEach(function(g){if(!this.isExcluded(g)&&c.indexOf(g)<0){c.push(g)}},this)},this);return c}}catch(d){if(this.opts.breakOnError){console.log(String("\nError while parsing file: "+a).red);throw d}}return[]};AMD.prototype.addOptimizedModules=function(c){var b=this,a=[];amdetective(this.getFileSource(c)).filter(function(d){var e=d.name||d;return e!=="require"&&e!=="exports"&&e!=="module"&&!e.match(/\.?\w\!/)&&!b.isExcluded(e)}).forEach(function(d){if(typeof(d)==="string"){a.push(d);return}if(!b.isExcluded(d.name)){b.tree[d.name]=d.deps.filter(function(e){return e!=="require"&&e!=="exports"&&e!=="module"&&!e.match(/\.?\w\!/)&&!b.isExcluded(e)})}});if(a.length>0){this.tree[this.opts.mainRequireModule||""]=a}};AMD.prototype.addModule=function(a){if(this.opts.optimized){return this.addOptimizedModules(a)}else{return Base.prototype.addModule.call(this,a)}};