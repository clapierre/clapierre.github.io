function Option(t,n){this.flags=t,this.required=~t.indexOf("<"),this.optional=~t.indexOf("["),this.bool=!~t.indexOf("-no-"),t=t.split(/[ ,|]+/),t.length>1&&!/^[[<]/.test(t[1])&&(this["short"]=t.shift()),this["long"]=t.shift(),this.description=n||""}function Command(t){this.commands=[],this.options=[],this._execs=[],this._args=[],this._name=t}function camelcase(t){return t.split("-").reduce(function(t,n){return t+n[0].toUpperCase()+n.slice(1)})}function pad(t,n){var o=Math.max(0,n-t.length);return t+Array(o+1).join(" ")}function outputHelpIfNecessary(t,n){n=n||[];for(var o=0;o<n.length;o++)("--help"==n[o]||"-h"==n[o])&&(t.outputHelp(),process.exit(0))}var EventEmitter=require("events").EventEmitter,spawn=require("child_process").spawn,path=require("path"),dirname=path.dirname,basename=path.basename;exports=module.exports=new Command,exports.Command=Command,exports.Option=Option,Option.prototype.name=function(){return this["long"].replace("--","").replace("no-","")},Option.prototype.is=function(t){return t==this["short"]||t==this["long"]},Command.prototype.__proto__=EventEmitter.prototype,Command.prototype.command=function(t,n){var o=t.split(/ +/),e=new Command(o.shift());return n&&e.description(n),n&&(this.executables=!0),n&&(this._execs[e._name]=!0),this.commands.push(e),e.parseExpectedArgs(o),e.parent=this,n?this:e},Command.prototype.addImplicitHelpCommand=function(){this.command("help [cmd]","display help for [cmd]")},Command.prototype.parseExpectedArgs=function(t){if(t.length){var n=this;return t.forEach(function(t){switch(t[0]){case"<":n._args.push({required:!0,name:t.slice(1,-1)});break;case"[":n._args.push({required:!1,name:t.slice(1,-1)})}}),this}},Command.prototype.action=function(t){var n=this,o=function(o,e){o=o||[],e=e||[];var i=n.parseOptions(e);outputHelpIfNecessary(n,i.unknown),i.unknown.length>0&&n.unknownOption(i.unknown[0]),i.args.length&&(o=i.args.concat(o)),n._args.forEach(function(t,e){t.required&&null==o[e]&&n.missingArgument(t.name)}),n._args.length?o[n._args.length]=n:o.push(n),t.apply(this,o)};return this.parent.on(this._name,o),this._alias&&this.parent.on(this._alias,o),this},Command.prototype.option=function(t,n,o,e){var i=this,s=new Option(t,n),r=s.name(),a=camelcase(r);return"function"!=typeof o&&(e=o,o=null),(0==s.bool||s.optional||s.required)&&(0==s.bool&&(e=!0),void 0!==e&&(i[a]=e)),this.options.push(s),this.on(r,function(t){null!==t&&o&&(t=o(t,void 0===i[a]?e:i[a])),"boolean"==typeof i[a]||"undefined"==typeof i[a]?i[a]=null==t?s.bool?e||!0:!1:t:null!==t&&(i[a]=t)}),this},Command.prototype.parse=function(t){this.executables&&this.addImplicitHelpCommand(),this.rawArgs=t,this._name=this._name||basename(t[1],".js");var n=this.parseOptions(this.normalize(t.slice(2))),o=this.args=n.args,e=this.parseArgs(this.args,n.unknown),i=e.args[0];return this._execs[i]?this.executeSubCommand(t,o,n.unknown):e},Command.prototype.executeSubCommand=function(t,n,o){n=n.concat(o),n.length||this.help(),"help"==n[0]&&1==n.length&&this.help(),"help"==n[0]&&(n[0]=n[1],n[1]="--help");var e=dirname(t[1]),i=basename(t[1],".js")+"-"+n[0],s=path.join(e,i);n=n.slice(1),n.unshift(s);var r=spawn("node",n,{stdio:"inherit",customFds:[0,1,2]});r.on("error",function(t){"ENOENT"==t.code?console.error("\n  %s(1) does not exist, try --help\n",i):"EACCES"==t.code&&console.error("\n  %s(1) not executable. try chmod or run with root\n",i)}),this.runningCommand=r},Command.prototype.normalize=function(t){for(var n,o,e,i=[],s=0,r=t.length;r>s;++s)n=t[s],s>0&&(o=this.optionFor(t[s-1])),o&&o.required?i.push(n):n.length>1&&"-"==n[0]&&"-"!=n[1]?n.slice(1).split("").forEach(function(t){i.push("-"+t)}):/^--/.test(n)&&~(e=n.indexOf("="))?i.push(n.slice(0,e),n.slice(e+1)):i.push(n);return i},Command.prototype.parseArgs=function(t,n){{var o,e=this.commands;e.length}return t.length?(o=t[0],this.listeners(o).length?this.emit(t.shift(),t,n):this.emit("*",t)):(outputHelpIfNecessary(this,n),n.length>0&&this.unknownOption(n[0])),this},Command.prototype.optionFor=function(t){for(var n=0,o=this.options.length;o>n;++n)if(this.options[n].is(t))return this.options[n]},Command.prototype.parseOptions=function(t){for(var n,o,e,i=[],s=t.length,r=[],a=0;s>a;++a)if(e=t[a],"--"!=e)if(n)i.push(e);else if(o=this.optionFor(e))if(o.required){if(e=t[++a],null==e)return this.optionMissingArgument(o);this.emit(o.name(),e)}else o.optional?(e=t[a+1],null==e||"-"==e[0]&&"-"!=e?e=null:++a,this.emit(o.name(),e)):this.emit(o.name());else e.length>1&&"-"==e[0]?(r.push(e),t[a+1]&&"-"!=t[a+1][0]&&r.push(t[++a])):i.push(e);else n=!0;return{args:i,unknown:r}},Command.prototype.missingArgument=function(t){console.error(),console.error("  error: missing required argument `%s'",t),console.error(),process.exit(1)},Command.prototype.optionMissingArgument=function(t,n){console.error(),n?console.error("  error: option `%s' argument missing, got `%s'",t.flags,n):console.error("  error: option `%s' argument missing",t.flags),console.error(),process.exit(1)},Command.prototype.unknownOption=function(t){console.error(),console.error("  error: unknown option `%s'",t),console.error(),process.exit(1)},Command.prototype.version=function(t,n){return 0==arguments.length?this._version:(this._version=t,n=n||"-V, --version",this.option(n,"output the version number"),this.on("version",function(){console.log(t),process.exit(0)}),this)},Command.prototype.description=function(t){return 0==arguments.length?this._description:(this._description=t,this)},Command.prototype.alias=function(t){return 0==arguments.length?this._alias:(this._alias=t,this)},Command.prototype.usage=function(t){var n=this._args.map(function(t){return t.required?"<"+t.name+">":"["+t.name+"]"}),o="[options"+(this.commands.length?"] [command":"")+"]"+(this._args.length?" "+n:"");return 0==arguments.length?this._usage||o:(this._usage=t,this)},Command.prototype.largestOptionLength=function(){return this.options.reduce(function(t,n){return Math.max(t,n.flags.length)},0)},Command.prototype.optionHelp=function(){var t=this.largestOptionLength();return[pad("-h, --help",t)+"  output usage information"].concat(this.options.map(function(n){return pad(n.flags,t)+"  "+n.description})).join("\n")},Command.prototype.commandHelp=function(){return this.commands.length?["","  Commands:","",this.commands.map(function(t){var n=t._args.map(function(t){return t.required?"<"+t.name+">":"["+t.name+"]"}).join(" ");return t._name+(t._alias?"|"+t._alias:"")+(t.options.length?" [options]":"")+" "+n+(t.description()?"\n   "+t.description():"")+"\n"}).join("\n").replace(/^/gm,"    "),""].join("\n"):""},Command.prototype.helpInformation=function(){return["","  Usage: "+this._name+(this._alias?"|"+this._alias:"")+" "+this.usage(),""+this.commandHelp(),"  Options:","",""+this.optionHelp().replace(/^/gm,"    "),"",""].join("\n")},Command.prototype.outputHelp=function(){process.stdout.write(this.helpInformation()),this.emit("--help")},Command.prototype.help=function(){this.outputHelp(),process.exit()};