/*!
 * Jade - Compiler
 * Copyright(c) 2010 TJ Holowaychuk <tj@vision-media.ca>
 * MIT Licensed
 */
var nodes=require("./nodes"),filters=require("./filters"),doctypes=require("./doctypes"),selfClosing=require("./self-closing"),runtime=require("./runtime"),utils=require("./utils");var Compiler=module.exports=function Compiler(b,a){this.options=a=a||{};this.node=b;this.hasCompiledDoctype=false;this.hasCompiledTag=false;this.pp=a.pretty||false;this.debug=false!==a.compileDebug;this.indents=0;this.parentIndents=0;if(a.doctype){this.setDoctype(a.doctype)}};Compiler.prototype={compile:function(){this.buf=["var interp;"];if(this.pp){this.buf.push("var __indent = [];")}this.lastBufferedIdx=-1;this.visit(this.node);return this.buf.join("\n")},setDoctype:function(b){var a=doctypes[(b||"default").toLowerCase()];a=a||"<!DOCTYPE "+b+">";this.doctype=a;this.terse="5"==b||"html"==b;this.xml=0==this.doctype.indexOf("<?xml")},buffer:function(b,a){if(a){b=utils.escape(b)}if(this.lastBufferedIdx==this.buf.length){this.lastBuffered+=b;this.buf[this.lastBufferedIdx-1]="buf.push('"+this.lastBuffered+"');"}else{this.buf.push("buf.push('"+b+"');");this.lastBuffered=b;this.lastBufferedIdx=this.buf.length}},prettyIndent:function(b,a){b=b||0;a=a?"\\n":"";this.buffer(a+Array(this.indents+b).join("  "));if(this.parentIndents){this.buf.push("buf.push.apply(buf, __indent);")}},visit:function(b){var a=this.debug;if(a){this.buf.push("__jade.unshift({ lineno: "+b.line+", filename: "+(b.filename?JSON.stringify(b.filename):"__jade[0].filename")+" });")}if(false===b.debug&&this.debug){this.buf.pop();this.buf.pop()}this.visitNode(b);if(a){this.buf.push("__jade.shift();")}},visitNode:function(b){var a=b.constructor.name||b.constructor.toString().match(/function ([^(\s]+)()/)[1];return this["visit"+a](b)},visitCase:function(b){var a=this.withinCase;this.withinCase=true;this.buf.push("switch ("+b.expr+"){");this.visit(b.block);this.buf.push("}");this.withinCase=a},visitWhen:function(a){if("default"==a.expr){this.buf.push("default:")}else{this.buf.push("case "+a.expr+":")}this.visit(a.block);this.buf.push("  break;")},visitLiteral:function(a){var b=a.str.replace(/\n/g,"\\\\n");this.buffer(b)},visitBlock:function(e){var a=e.nodes.length,d=this.escape,b=this.pp;if(this.parentIndents&&e.mode){if(b){this.buf.push("__indent.push('"+Array(this.indents+1).join("  ")+"');")}this.buf.push("block && block();");if(b){this.buf.push("__indent.pop();")}return}if(b&&a>1&&!d&&e.nodes[0].isText&&e.nodes[1].isText){this.prettyIndent(1,true)}for(var c=0;c<a;++c){if(b&&c>0&&!d&&e.nodes[c].isText&&e.nodes[c-1].isText){this.prettyIndent(1,false)}this.visit(e.nodes[c]);if(e.nodes[c+1]&&e.nodes[c].isText&&e.nodes[c+1].isText){this.buffer("\\n")}}},visitDoctype:function(a){if(a&&(a.val||!this.doctype)){this.setDoctype(a.val||"default")}if(this.doctype){this.buffer(this.doctype)}this.hasCompiledDoctype=true},visitMixin:function(b){var e=b.name.replace(/-/g,"_")+"_mixin",d=b.args||"",h=b.block,c=b.attrs,a=this.pp;if(b.call){if(a){this.buf.push("__indent.push('"+Array(this.indents+1).join("  ")+"');")}if(h||c.length){this.buf.push(e+".call({");if(h){this.buf.push("block: function(){");this.parentIndents++;var f=this.indents;this.indents=0;this.visit(b.block);this.indents=f;this.parentIndents--;if(c.length){this.buf.push("},")}else{this.buf.push("}")}}if(c.length){var g=this.attrs(c);if(g.inherits){this.buf.push("attributes: merge({"+g.buf+"}, attributes), escaped: merge("+g.escaped+", escaped, true)")}else{this.buf.push("attributes: {"+g.buf+"}, escaped: "+g.escaped)}}if(d){this.buf.push("}, "+d+");")}else{this.buf.push("});")}}else{this.buf.push(e+"("+d+");")}if(a){this.buf.push("__indent.pop();")}}else{this.buf.push("var "+e+" = function("+d+"){");this.buf.push("var block = this.block, attributes = this.attributes || {}, escaped = this.escaped || {};");this.parentIndents++;this.visit(h);this.parentIndents--;this.buf.push("};")}},visitTag:function(a){this.indents++;var c=a.name,b=this.pp;if(a.buffer){c="' + ("+c+") + '"}if(!this.hasCompiledTag){if(!this.hasCompiledDoctype&&"html"==c){this.visitDoctype()}this.hasCompiledTag=true}if(b&&!a.isInline()){this.prettyIndent(0,true)}if((~selfClosing.indexOf(c)||a.selfClosing)&&!this.xml){this.buffer("<"+c);this.visitAttributes(a.attrs);this.terse?this.buffer(">"):this.buffer("/>")}else{if(a.attrs.length){this.buffer("<"+c);if(a.attrs.length){this.visitAttributes(a.attrs)}this.buffer(">")}else{this.buffer("<"+c+">")}if(a.code){this.visitCode(a.code)}this.escape="pre"==a.name;this.visit(a.block);if(b&&!a.isInline()&&"pre"!=a.name&&!a.canInline()){this.prettyIndent(0,true)}this.buffer("</"+c+">")}this.indents--},visitFilter:function(b){var a=filters[b.name];if(!a){if(b.isASTFilter){throw new Error('unknown ast filter "'+b.name+':"')}else{throw new Error('unknown filter ":'+b.name+'"')}}if(b.isASTFilter){this.buf.push(a(b.block,this,b.attrs))}else{var c=b.block.nodes.map(function(d){return d.val}).join("\n");b.attrs=b.attrs||{};b.attrs.filename=this.options.filename;this.buffer(utils.text(a(c,b.attrs)))}},visitText:function(a){a=utils.text(a.val.replace(/\\/g,"\\\\"));if(this.escape){a=escape(a)}this.buffer(a)},visitComment:function(a){if(!a.buffer){return}if(this.pp){this.prettyIndent(1,true)}this.buffer("<!--"+utils.escape(a.val)+"-->")},visitBlockComment:function(a){if(!a.buffer){return}if(0==a.val.trim().indexOf("if")){this.buffer("<!--["+a.val.trim()+"]>");this.visit(a.block);this.buffer("<![endif]-->")}else{this.buffer("<!--"+a.val);this.visit(a.block);this.buffer("-->")}},visitCode:function(a){if(a.buffer){var b=a.val.trimLeft();this.buf.push("var __val__ = "+b);b='null == __val__ ? "" : __val__';if(a.escape){b="escape("+b+")"}this.buf.push("buf.push("+b+");")}else{this.buf.push(a.val)}if(a.block){if(!a.buffer){this.buf.push("{")}this.visit(a.block);if(!a.buffer){this.buf.push("}")}}},visitEach:function(a){this.buf.push("// iterate "+a.obj+"\n;(function(){\n  if ('number' == typeof "+a.obj+".length) {\n    for (var "+a.key+" = 0, $$l = "+a.obj+".length; "+a.key+" < $$l; "+a.key+"++) {\n      var "+a.val+" = "+a.obj+"["+a.key+"];\n");this.visit(a.block);this.buf.push("    }\n  } else {\n    for (var "+a.key+" in "+a.obj+") {\n      var "+a.val+" = "+a.obj+"["+a.key+"];\n");this.visit(a.block);this.buf.push("   }\n  }\n}).call(this);\n")},visitAttributes:function(attrs){var val=this.attrs(attrs);if(val.inherits){this.buf.push("buf.push(attrs(merge({ "+val.buf+" }, attributes), merge("+val.escaped+", escaped, true)));")}else{if(val.constant){eval("var buf={"+val.buf+"};");this.buffer(runtime.attrs(buf,JSON.parse(val.escaped)),true)}else{this.buf.push("buf.push(attrs({ "+val.buf+" }, "+val.escaped+"));")}}},attrs:function(b){var a=[],c=[],e={},d=b.every(function(g){return isConstant(g.val)}),f=false;if(this.terse){a.push("terse: true")}b.forEach(function(g){if(g.name=="attributes"){return f=true}e[g.name]=g.escaped;if(g.name=="class"){c.push("("+g.val+")")}else{var h="'"+g.name+"':("+g.val+")";a.push(h)}});if(c.length){c=c.join(" + ' ' + ");a.push("class: "+c)}return{buf:a.join(", ").replace("class:",'"class":'),escaped:JSON.stringify(e),inherits:f,constant:d}}};function isConstant(b){if(/^ *("([^"\\]*(\\.[^"\\]*)*)"|'([^'\\]*(\\.[^'\\]*)*)'|true|false|null|undefined) *$/i.test(b)){return true}if(!isNaN(Number(b))){return true}var a;if(a=/^ *\[(.*)\] *$/.exec(b)){return a[1].split(",").every(isConstant)}return false}function escape(a){return String(a).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};