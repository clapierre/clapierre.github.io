/*!
 * Jade - Parser
 * Copyright(c) 2010 TJ Holowaychuk <tj@vision-media.ca>
 * MIT Licensed
 */
var Lexer=require("./lexer"),nodes=require("./nodes");var Parser=exports=module.exports=function Parser(c,a,b){this.input=c;this.lexer=new Lexer(c,b);this.filename=a;this.blocks={};this.mixins={};this.options=b;this.contexts=[this]};var textOnly=exports.textOnly=["script","style"];Parser.prototype={context:function(a){if(a){this.contexts.push(a)}else{return this.contexts.pop()}},advance:function(){return this.lexer.advance()},skip:function(a){while(a--){this.advance()}},peek:function(){return this.lookahead(1)},line:function(){return this.lexer.lineno},lookahead:function(a){return this.lexer.lookahead(a)},parse:function(){var c=new nodes.Block,d;c.line=this.line();while("eos"!=this.peek().type){if("newline"==this.peek().type){this.advance()}else{c.push(this.parseExpr())}}if(d=this.extending){this.context(d);var a=d.parse();this.context();for(var b in this.mixins){a.unshift(this.mixins[b])}return a}return c},expect:function(a){if(this.peek().type===a){return this.advance()}else{throw new Error('expected "'+a+'", but got "'+this.peek().type+'"')}},accept:function(a){if(this.peek().type===a){return this.advance()}},parseExpr:function(){switch(this.peek().type){case"tag":return this.parseTag();case"mixin":return this.parseMixin();case"block":return this.parseBlock();case"case":return this.parseCase();case"when":return this.parseWhen();case"default":return this.parseDefault();case"extends":return this.parseExtends();case"include":return this.parseInclude();case"doctype":return this.parseDoctype();case"filter":return this.parseFilter();case"comment":return this.parseComment();case"text":return this.parseText();case"each":return this.parseEach();case"code":return this.parseCode();case"call":return this.parseCall();case"interpolation":return this.parseInterpolation();case"yield":this.advance();var b=new nodes.Block;b.yield=true;return b;case"id":case"class":var a=this.advance();this.lexer.defer(this.lexer.tok("tag","div"));this.lexer.defer(a);return this.parseExpr();default:throw new Error('unexpected token "'+this.peek().type+'"')}},parseText:function(){var a=this.expect("text"),b=new nodes.Text(a.val);b.line=this.line();return b},parseBlockExpansion:function(){if(":"==this.peek().type){this.advance();return new nodes.Block(this.parseExpr())}else{return this.block()}},parseCase:function(){var b=this.expect("case").val,a=new nodes.Case(b);a.line=this.line();a.block=this.block();return a},parseWhen:function(){var a=this.expect("when").val;return new nodes.Case.When(a,this.parseBlockExpansion())},parseDefault:function(){this.expect("default");return new nodes.Case.When("default",this.parseBlockExpansion())},parseCode:function(){var a=this.expect("code"),c=new nodes.Code(a.val,a.buffer,a.escape),d,b=1;c.line=this.line();while(this.lookahead(b)&&"newline"==this.lookahead(b).type){++b}d="indent"==this.lookahead(b).type;if(d){this.skip(b-1);c.block=this.block()}return c},parseComment:function(){var a=this.expect("comment"),b;if("indent"==this.peek().type){b=new nodes.BlockComment(a.val,this.block(),a.buffer)}else{b=new nodes.Comment(a.val,a.buffer)}b.line=this.line();return b},parseDoctype:function(){var a=this.expect("doctype"),b=new nodes.Doctype(a.val);b.line=this.line();return b},parseFilter:function(){var d,a=this.expect("filter"),b=this.accept("attrs");this.lexer.pipeless=true;d=this.parseTextBlock();this.lexer.pipeless=false;var c=new nodes.Filter(a.val,d,b&&b.attrs);c.line=this.line();return c},parseASTFilter:function(){var d,a=this.expect("tag"),b=this.accept("attrs");this.expect(":");d=this.block();var c=new nodes.Filter(a.val,d,b&&b.attrs);c.line=this.line();return c},parseEach:function(){var a=this.expect("each"),b=new nodes.Each(a.code,a.val,a.key);b.line=this.line();b.block=this.block();return b},parseExtends:function(){var f=require("path"),a=require("fs"),e=f.dirname,d=f.basename,c=f.join;if(!this.filename){throw new Error('the "filename" option is required to extend templates')}var f=this.expect("extends").val.trim(),b=e(this.filename);var f=c(b,f+".jade"),g=a.readFileSync(f,"utf8"),h=new Parser(g,f,this.options);h.blocks=this.blocks;h.contexts=this.contexts;this.extending=h;return new nodes.Literal("")},parseBlock:function(){var d=this.expect("block"),c=d.mode,a=d.val.trim();d="indent"==this.peek().type?this.block():new nodes.Block(new nodes.Literal(""));var b=this.blocks[a];if(b){switch(b.mode){case"append":d.nodes=d.nodes.concat(b.nodes);b=d;break;case"prepend":d.nodes=b.nodes.concat(d.nodes);b=d;break}}d.mode=c;return this.blocks[a]=b||d},parseInclude:function(){var i=require("path"),e=require("fs"),f=i.dirname,h=i.basename,c=i.join;var i=this.expect("include").val.trim(),d=f(this.filename);if(!this.filename){throw new Error('the "filename" option is required to use includes')}if(!~h(i).indexOf(".")){i+=".jade"}if(".jade"!=i.substr(-5)){var i=c(d,i),g=e.readFileSync(i,"utf8");return new nodes.Literal(g)}var i=c(d,i),g=e.readFileSync(i,"utf8"),b=new Parser(g,i,this.options);b.blocks=this.blocks;b.mixins=this.mixins;this.context(b);var a=b.parse();this.context();a.filename=i;if("indent"==this.peek().type){a.includeBlock().push(this.block())}return a},parseCall:function(){var b=this.expect("call"),d=b.val,c=b.args,a=new nodes.Mixin(d,c,new nodes.Block,true);this.tag(a);if(a.block.isEmpty()){a.block=null}return a},parseMixin:function(){var b=this.expect("mixin"),d=b.val,c=b.args,a;if("indent"==this.peek().type){a=new nodes.Mixin(d,c,this.block(),false);this.mixins[d]=a;return a}else{return new nodes.Mixin(d,c,null,true)}},parseTextBlock:function(){var d=new nodes.Block;d.line=this.line();var b=this.expect("indent").val;if(null==this._spaces){this._spaces=b}var a=Array(b-this._spaces+1).join(" ");while("outdent"!=this.peek().type){switch(this.peek().type){case"newline":this.advance();break;case"indent":this.parseTextBlock().nodes.forEach(function(e){d.push(e)});break;default:var c=new nodes.Text(a+this.advance().val);c.line=this.line();d.push(c)}}if(b==this._spaces){this._spaces=null}this.expect("outdent");return d},block:function(){var a=new nodes.Block;a.line=this.line();this.expect("indent");while("outdent"!=this.peek().type){if("newline"==this.peek().type){this.advance()}else{a.push(this.parseExpr())}}this.expect("outdent");return a},parseInterpolation:function(){var b=this.advance();var a=new nodes.Tag(b.val);a.buffer=true;return this.tag(a)},parseTag:function(){var c=2;if("attrs"==this.lookahead(c).type){++c}if(":"==this.lookahead(c).type){if("indent"==this.lookahead(++c).type){return this.parseASTFilter()}}var b=this.advance(),a=new nodes.Tag(b.val);a.selfClosing=b.selfClosing;return this.tag(a)},tag:function(m){var c;m.line=this.line();out:while(true){switch(this.peek().type){case"id":case"class":var l=this.advance();m.setAttribute(l.type,"'"+l.val+"'");continue;case"attrs":var l=this.advance(),f=l.attrs,b=l.escaped,k=Object.keys(f);if(l.selfClosing){m.selfClosing=true}for(var g=0,h=k.length;g<h;++g){var a=k[g],d=f[a];m.setAttribute(a,d,b[a])}continue;default:break out}}if("."==this.peek().val){c=m.textOnly=true;this.advance()}switch(this.peek().type){case"text":m.block.push(this.parseText());break;case"code":m.code=this.parseCode();break;case":":this.advance();m.block=new nodes.Block;m.block.push(this.parseExpr());break}while("newline"==this.peek().type){this.advance()}m.textOnly=m.textOnly||~textOnly.indexOf(m.name);if("script"==m.name){var j=m.getAttribute("type");if(!c&&j&&"text/javascript"!=j.replace(/^['"]|['"]$/g,"")){m.textOnly=false}}if("indent"==this.peek().type){if(m.textOnly){this.lexer.pipeless=true;m.block=this.parseTextBlock();this.lexer.pipeless=false}else{var e=this.block();if(m.block){for(var g=0,h=e.nodes.length;g<h;++g){m.block.push(e.nodes[g])}}else{m.block=e}}}return m}};