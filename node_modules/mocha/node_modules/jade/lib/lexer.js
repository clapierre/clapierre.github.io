/*!
 * Jade - Lexer
 * Copyright(c) 2010 TJ Holowaychuk <tj@vision-media.ca>
 * MIT Licensed
 */
var Lexer=module.exports=function Lexer(b,a){a=a||{};this.input=b.replace(/\r\n|\r/g,"\n");this.colons=a.colons;this.deferredTokens=[];this.lastIndents=0;this.lineno=1;this.stash=[];this.indentStack=[];this.indentRe=null;this.pipeless=false};Lexer.prototype={tok:function(a,b){return{type:a,line:this.lineno,val:b}},consume:function(a){this.input=this.input.substr(a)},scan:function(c,b){var a;if(a=c.exec(this.input)){this.consume(a[0].length);return this.tok(b,a[1])}},defer:function(a){this.deferredTokens.push(a)},lookahead:function(b){var a=b-this.stash.length;while(a-->0){this.stash.push(this.next())}return this.stash[--b]},indexOfDelimiters:function(h,d){var f=this.input,c=0,b=0,g=0;for(var e=0,a=f.length;e<a;++e){if(h==f.charAt(e)){++c}else{if(d==f.charAt(e)){if(++b==c){g=e;break}}}}return g},stashed:function(){return this.stash.length&&this.stash.shift()},deferred:function(){return this.deferredTokens.length&&this.deferredTokens.shift()},eos:function(){if(this.input.length){return}if(this.indentStack.length){this.indentStack.shift();return this.tok("outdent")}else{return this.tok("eos")}},blank:function(){var a;if(a=/^\n *\n/.exec(this.input)){this.consume(a[0].length-1);if(this.pipeless){return this.tok("text","")}return this.next()}},comment:function(){var b;if(b=/^ *\/\/(-)?([^\n]*)/.exec(this.input)){this.consume(b[0].length);var a=this.tok("comment",b[2]);a.buffer="-"!=b[1];return a}},interpolation:function(){var a;if(a=/^#\{(.*?)\}/.exec(this.input)){this.consume(a[0].length);return this.tok("interpolation",a[1])}},tag:function(){var b;if(b=/^(\w[-:\w]*)(\/?)/.exec(this.input)){this.consume(b[0].length);var a,c=b[1];if(":"==c[c.length-1]){c=c.slice(0,-1);a=this.tok("tag",c);this.defer(this.tok(":"));while(" "==this.input[0]){this.input=this.input.substr(1)}}else{a=this.tok("tag",c)}a.selfClosing=!!b[2];return a}},filter:function(){return this.scan(/^:(\w+)/,"filter")},doctype:function(){return this.scan(/^(?:!!!|doctype) *([^\n]+)?/,"doctype")},id:function(){return this.scan(/^#([\w-]+)/,"id")},className:function(){return this.scan(/^\.([\w-]+)/,"class")},text:function(){return this.scan(/^(?:\| ?| ?)?([^\n]+)/,"text")},"extends":function(){return this.scan(/^extends? +([^\n]+)/,"extends")},prepend:function(){var b;if(b=/^prepend +([^\n]+)/.exec(this.input)){this.consume(b[0].length);var d="prepend",c=b[1],a=this.tok("block",c);a.mode=d;return a}},append:function(){var b;if(b=/^append +([^\n]+)/.exec(this.input)){this.consume(b[0].length);var d="append",c=b[1],a=this.tok("block",c);a.mode=d;return a}},block:function(){var b;if(b=/^block\b *(?:(prepend|append) +)?([^\n]*)/.exec(this.input)){this.consume(b[0].length);var d=b[1]||"replace",c=b[2],a=this.tok("block",c);a.mode=d;return a}},yield:function(){return this.scan(/^yield */,"yield")},include:function(){return this.scan(/^include +([^\n]+)/,"include")},"case":function(){return this.scan(/^case +([^\n]+)/,"case")},when:function(){return this.scan(/^when +([^:\n]+)/,"when")},"default":function(){return this.scan(/^default */,"default")},assignment:function(){var a;if(a=/^(\w+) += *([^;\n]+)( *;? *)/.exec(this.input)){this.consume(a[0].length);var b=a[1],c=a[2];return this.tok("code","var "+b+" = ("+c+");")}},call:function(){var b;if(b=/^\+([-\w]+)/.exec(this.input)){this.consume(b[0].length);var a=this.tok("call",b[1]);if(b=/^ *\((.*?)\)/.exec(this.input)){if(!/^ *[-\w]+ *=/.test(b[1])){this.consume(b[0].length);a.args=b[1]}}return a}},mixin:function(){var b;if(b=/^mixin +([-\w]+)(?: *\((.*)\))?/.exec(this.input)){this.consume(b[0].length);var a=this.tok("mixin",b[1]);a.args=b[2];return a}},conditional:function(){var a;if(a=/^(if|unless|else if|else)\b([^\n]*)/.exec(this.input)){this.consume(a[0].length);var b=a[1],c=a[2];switch(b){case"if":c="if ("+c+")";break;case"unless":c="if (!("+c+"))";break;case"else if":c="else if ("+c+")";break;case"else":c="else";break}return this.tok("code",c)}},"while":function(){var a;if(a=/^while +([^\n]+)/.exec(this.input)){this.consume(a[0].length);return this.tok("code","while ("+a[1]+")")}},each:function(){var b;if(b=/^(?:- *)?(?:each|for) +(\w+)(?: *, *(\w+))? * in *([^\n]+)/.exec(this.input)){this.consume(b[0].length);var a=this.tok("each",b[1]);a.key=b[2]||"$index";a.code=b[3];return a}},code:function(){var c;if(c=/^(!?=|-)([^\n]+)/.exec(this.input)){this.consume(c[0].length);var a=c[1];c[1]=c[2];var b=this.tok("code",c[1]);b.escape=a[0]==="=";b.buffer=a[0]==="="||a[1]==="=";return b}},attrs:function(){if("("==this.input.charAt(0)){var k=this.indexOfDelimiters("(",")"),o=this.input.substr(1,k-1),r=this.tok("attrs"),l=o.length,j=this.colons,s=["key"],g,q="",e="",a,n,d;function b(){return s[s.length-1]}function m(c){return c.replace(/#\{([^}]+)\}/g,function(i,p){return a+" + ("+p+") + "+a})}this.consume(k+1);r.attrs={};r.escaped={};function f(p){var i=p;if(j&&":"==p){p="="}switch(p){case",":case"\n":switch(b()){case"expr":case"array":case"string":case"object":e+=p;break;default:s.push("key");e=e.trim();q=q.trim();if(""==q){return}q=q.replace(/^['"]|['"]$/g,"").replace("!","");r.escaped[q]=g;r.attrs[q]=""==e?true:m(e);q=e=""}break;case"=":switch(b()){case"key char":q+=i;break;case"val":case"expr":case"array":case"string":case"object":e+=i;break;default:g="!"!=d;s.push("val")}break;case"(":if("val"==b()||"expr"==b()){s.push("expr")}e+=p;break;case")":if("expr"==b()||"val"==b()){s.pop()}e+=p;break;case"{":if("val"==b()){s.push("object")}e+=p;break;case"}":if("object"==b()){s.pop()}e+=p;break;case"[":if("val"==b()){s.push("array")}e+=p;break;case"]":if("array"==b()){s.pop()}e+=p;break;case'"':case"'":switch(b()){case"key":s.push("key char");break;case"key char":s.pop();break;case"string":if(p==a){s.pop()}e+=p;break;default:s.push("string");e+=p;a=p}break;case"":break;default:switch(b()){case"key":case"key char":q+=p;break;default:e+=p}}d=p}for(var h=0;h<l;++h){f(o.charAt(h))}f(",");if("/"==this.input.charAt(0)){this.consume(1);r.selfClosing=true}return r}},indent:function(){var b,c;if(this.indentRe){b=this.indentRe.exec(this.input)}else{c=/^\n(\t*) */;b=c.exec(this.input);if(b&&!b[1].length){c=/^\n( *)/;b=c.exec(this.input)}if(b&&b[1].length){this.indentRe=c}}if(b){var a,d=b[1].length;++this.lineno;this.consume(d+1);if(" "==this.input[0]||"\t"==this.input[0]){throw new Error("Invalid indentation, you can use tabs or spaces but not both")}if("\n"==this.input[0]){return this.tok("newline")}if(this.indentStack.length&&d<this.indentStack[0]){while(this.indentStack.length&&this.indentStack[0]>d){this.stash.push(this.tok("outdent"));this.indentStack.shift()}a=this.stash.pop()}else{if(d&&d!=this.indentStack[0]){this.indentStack.unshift(d);a=this.tok("indent",d)}else{a=this.tok("newline")}}return a}},pipelessText:function(){if(this.pipeless){if("\n"==this.input[0]){return}var a=this.input.indexOf("\n");if(-1==a){a=this.input.length}var b=this.input.substr(0,a);this.consume(b.length);return this.tok("text",b)}},colon:function(){return this.scan(/^: */,":")},advance:function(){return this.stashed()||this.next()},next:function(){return this.deferred()||this.blank()||this.eos()||this.pipelessText()||this.yield()||this.doctype()||this.interpolation()||this["case"]()||this.when()||this["default"]()||this["extends"]()||this.append()||this.prepend()||this.block()||this.include()||this.mixin()||this.call()||this.conditional()||this.each()||this["while"]()||this.assignment()||this.tag()||this.filter()||this.code()||this.id()||this.className()||this.attrs()||this.indent()||this.comment()||this.colon()||this.text()}};