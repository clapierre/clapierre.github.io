/*!
 * mocha
 * Copyright(c) 2011 TJ Holowaychuk <tj@vision-media.ca>
 * MIT Licensed
 */
var path=require("path"),escapeRe=require("escape-string-regexp"),utils=require("./utils");exports=module.exports=Mocha;if(typeof process!=="undefined"&&typeof process.cwd==="function"){var join=path.join,cwd=process.cwd();module.paths.push(cwd,join(cwd,"node_modules"))}exports.utils=utils;exports.interfaces=require("./interfaces");exports.reporters=require("./reporters");exports.Runnable=require("./runnable");exports.Context=require("./context");exports.Runner=require("./runner");exports.Suite=require("./suite");exports.Hook=require("./hook");exports.Test=require("./test");function image(a){return __dirname+"/../images/"+a+".png"}function Mocha(a){a=a||{};this.files=[];this.options=a;if(a.grep){this.grep(new RegExp(a.grep))}if(a.fgrep){this.grep(a.fgrep)}this.suite=new exports.Suite("",new exports.Context);this.ui(a.ui);this.bail(a.bail);this.reporter(a.reporter,a.reporterOptions);if(null!=a.timeout){this.timeout(a.timeout)}this.useColors(a.useColors);if(a.enableTimeouts!==null){this.enableTimeouts(a.enableTimeouts)}if(a.slow){this.slow(a.slow)}this.suite.on("pre-require",function(b){exports.afterEach=b.afterEach||b.teardown;exports.after=b.after||b.suiteTeardown;exports.beforeEach=b.beforeEach||b.setup;exports.before=b.before||b.suiteSetup;exports.describe=b.describe||b.suite;exports.it=b.it||b.test;exports.setup=b.setup||b.beforeEach;exports.suiteSetup=b.suiteSetup||b.before;exports.suiteTeardown=b.suiteTeardown||b.after;exports.suite=b.suite||b.describe;exports.teardown=b.teardown||b.afterEach;exports.test=b.test||b.it;exports.run=b.run})}Mocha.prototype.bail=function(a){if(0==arguments.length){a=true}this.suite.bail(a);return this};Mocha.prototype.addFile=function(a){this.files.push(a);return this};Mocha.prototype.reporter=function(a,c){if("function"==typeof a){this._reporter=a}else{a=a||"spec";var b;try{b=require("./reporters/"+a)}catch(d){}if(!b){try{b=require(a)}catch(d){d.message.indexOf("Cannot find module")!==-1?console.warn('"'+a+'" reporter not found'):console.warn('"'+a+'" reporter blew up with error:\n'+d.stack)}}if(!b&&a==="teamcity"){console.warn("The Teamcity reporter was moved to a package named mocha-teamcity-reporter (https://npmjs.org/package/mocha-teamcity-reporter).")}if(!b){throw new Error('invalid reporter "'+a+'"')}this._reporter=b}this.options.reporterOptions=c;return this};Mocha.prototype.ui=function(a){a=a||"bdd";this._ui=exports.interfaces[a];if(!this._ui){try{this._ui=require(a)}catch(b){}}if(!this._ui){throw new Error('invalid interface "'+a+'"')}this._ui=this._ui(this.suite);return this};Mocha.prototype.loadFiles=function(c){var a=this;var b=this.suite;var d=this.files.length;this.files.forEach(function(e){e=path.resolve(e);b.emit("pre-require",global,e,a);b.emit("require",require(e),e,a);b.emit("post-require",global,e,a);--d||(c&&c())})};Mocha.prototype._growl=function(c,a){var b=require("growl");c.on("end",function(){var d=a.stats;if(d.failures){var e=d.failures+" of "+c.total+" tests failed";b(e,{name:"mocha",title:"Failed",image:image("error")})}else{b(d.passes+" tests passed in "+d.duration+"ms",{name:"mocha",title:"Passed",image:image("ok")})}})};Mocha.prototype.grep=function(a){this.options.grep="string"==typeof a?new RegExp(escapeRe(a)):a;return this};Mocha.prototype.invert=function(){this.options.invert=true;return this};Mocha.prototype.ignoreLeaks=function(a){this.options.ignoreLeaks=!!a;return this};Mocha.prototype.checkLeaks=function(){this.options.ignoreLeaks=false;return this};Mocha.prototype.fullTrace=function(){this.options.fullStackTrace=true;return this};Mocha.prototype.growl=function(){this.options.growl=true;return this};Mocha.prototype.globals=function(a){this.options.globals=(this.options.globals||[]).concat(a);return this};Mocha.prototype.useColors=function(a){if(a!==undefined){this.options.useColors=a}return this};Mocha.prototype.useInlineDiffs=function(a){this.options.useInlineDiffs=arguments.length&&a!=undefined?a:false;return this};Mocha.prototype.timeout=function(a){this.suite.timeout(a);return this};Mocha.prototype.slow=function(a){this.suite.slow(a);return this};Mocha.prototype.enableTimeouts=function(a){this.suite.enableTimeouts(arguments.length&&a!==undefined?a:true);return this};Mocha.prototype.asyncOnly=function(){this.options.asyncOnly=true;return this};Mocha.prototype.noHighlighting=function(){this.options.noHighlighting=true;return this};Mocha.prototype.delay=function delay(){this.options.delay=true;return this};Mocha.prototype.run=function(e){if(this.files.length){this.loadFiles()}var d=this.suite;var c=this.options;c.files=this.files;var f=new exports.Runner(d,c.delay);var b=new this._reporter(f,c);f.ignoreLeaks=false!==c.ignoreLeaks;f.fullStackTrace=c.fullStackTrace;f.asyncOnly=c.asyncOnly;if(c.grep){f.grep(c.grep,c.invert)}if(c.globals){f.globals(c.globals)}if(c.growl){this._growl(f,b)}if(c.useColors!==undefined){exports.reporters.Base.useColors=c.useColors}exports.reporters.Base.inlineDiffs=c.useInlineDiffs;function a(g){if(b.done){b.done(g,e)}else{e&&e(g)}}return f.run(a)};