var EventEmitter=require("events").EventEmitter,debug=require("debug")("mocha:runnable"),Pending=require("./pending"),milliseconds=require("./ms"),utils=require("./utils");var Date=global.Date,setTimeout=global.setTimeout,setInterval=global.setInterval,clearTimeout=global.clearTimeout,clearInterval=global.clearInterval;var toString=Object.prototype.toString;module.exports=Runnable;function Runnable(b,a){this.title=b;this.fn=a;this.async=a&&a.length;this.sync=!this.async;this._timeout=2000;this._slow=75;this._enableTimeouts=true;this.timedOut=false;this._trace=new Error("done() called multiple times")}Runnable.prototype.__proto__=EventEmitter.prototype;Runnable.prototype.timeout=function(a){if(0==arguments.length){return this._timeout}if(a===0){this._enableTimeouts=false}if("string"==typeof a){a=milliseconds(a)}debug("timeout %d",a);this._timeout=a;if(this.timer){this.resetTimeout()}return this};Runnable.prototype.slow=function(a){if(0===arguments.length){return this._slow}if("string"==typeof a){a=milliseconds(a)}debug("timeout %d",a);this._slow=a;return this};Runnable.prototype.enableTimeouts=function(a){if(arguments.length===0){return this._enableTimeouts}debug("enableTimeouts %s",a);this._enableTimeouts=a;return this};Runnable.prototype.skip=function(){throw new Pending()};Runnable.prototype.fullTitle=function(){return this.parent.fullTitle()+" "+this.title};Runnable.prototype.clearTimeout=function(){clearTimeout(this.timer)};Runnable.prototype.inspect=function(){return JSON.stringify(this,function(a,b){if("_"==a[0]){return}if("parent"==a){return"#<Suite>"}if("ctx"==a){return"#<Context>"}return b},2)};Runnable.prototype.resetTimeout=function(){var a=this;var b=this.timeout()||1000000000;if(!this._enableTimeouts){return}this.clearTimeout();this.timer=setTimeout(function(){if(!a._enableTimeouts){return}a.callback(new Error("timeout of "+b+"ms exceeded. Ensure the done() callback is being called in this test."));a.timedOut=true},b)};Runnable.prototype.globals=function(a){var b=this;this._allowedGlobals=a};Runnable.prototype.run=function(g){var h=this,b=new Date,i=this.ctx,d,f;if(i&&i.runnable){i.runnable(this)}function j(k){if(f){return}f=true;h.emit("error",k||new Error("done() called multiple times; stacktrace may be inaccurate"))}function e(l){var k=h.timeout();if(h.timedOut){return}if(d){return j(l||h._trace)}if(h.state){return}h.clearTimeout();h.duration=new Date-b;d=true;if(!l&&h.duration>k&&h._enableTimeouts){l=new Error("timeout of "+k+"ms exceeded. Ensure the done() callback is being called in this test.")}g(l)}this.callback=e;if(this.async){this.resetTimeout();try{this.fn.call(i,function(k){if(k instanceof Error||toString.call(k)==="[object Error]"){return e(k)}if(null!=k){if(Object.prototype.toString.call(k)==="[object Object]"){return e(new Error("done() invoked with non-Error: "+JSON.stringify(k)))}else{return e(new Error("done() invoked with non-Error: "+k))}}e()})}catch(c){e(utils.getError(c))}return}if(this.asyncOnly){return e(new Error("--async-only option in use without declaring `done()`"))}try{if(this.pending){e()}else{a(this.fn)}}catch(c){e(utils.getError(c))}function a(l){var k=l.call(i);if(k&&typeof k.then==="function"){h.resetTimeout();k.then(function(){e()},function(m){e(m||new Error("Promise rejected with no or falsy reason"))})}else{e()}}};