var EventEmitter=require("events").EventEmitter,debug=require("debug")("mocha:runner"),Pending=require("./pending"),Test=require("./test"),utils=require("./utils"),filter=utils.filter,keys=utils.keys,type=utils.type,stringify=utils.stringify,stackFilter=utils.stackTraceFilter();var globals=["setTimeout","clearTimeout","setInterval","clearInterval","XMLHttpRequest","Date","setImmediate","clearImmediate"];module.exports=Runner;function Runner(c,b){var a=this;this._globals=[];this._abort=false;this._delay=b;this.suite=c;this.total=c.total();this.failures=0;this.on("test end",function(d){a.checkGlobals(d)});this.on("hook end",function(d){a.checkGlobals(d)});this.grep(/.*/);this.globals(this.globalProps().concat(extraGlobals()))}Runner.immediately=global.setImmediate||process.nextTick;Runner.prototype.__proto__=EventEmitter.prototype;Runner.prototype.grep=function(a,b){debug("grep %s",a);this._grep=a;this._invert=b;this.total=this.grepTotal(this.suite);return this};Runner.prototype.grepTotal=function(b){var a=this;var c=0;b.eachTest(function(e){var d=a._grep.test(e.fullTitle());if(a._invert){d=!d}if(d){c++}});return c};Runner.prototype.globalProps=function(){var b=utils.keys(global);for(var a=0;a<globals.length;++a){if(~utils.indexOf(b,globals[a])){continue}b.push(globals[a])}return b};Runner.prototype.globals=function(a){if(0==arguments.length){return this._globals}debug("globals %j",a);this._globals=this._globals.concat(a);return this};Runner.prototype.checkGlobals=function(d){if(this.ignoreLeaks){return}var b=this._globals;var c=this.globalProps();var a;if(d){b=b.concat(d._allowedGlobals||[])}if(this.prevGlobalsLength==c.length){return}this.prevGlobalsLength=c.length;a=filterLeaks(b,c);this._globals=this._globals.concat(a);if(a.length>1){this.fail(d,new Error("global leaks detected: "+a.join(", ")+""))}else{if(a.length){this.fail(d,new Error("global leak detected: "+a[0]))}}};Runner.prototype.fail=function(b,a){++this.failures;b.state="failed";if(!(a instanceof Error)){a=new Error("the "+type(a)+" "+stringify(a)+" was thrown, throw an Error :)")}a.stack=(this.fullStackTrace||!a.stack)?a.stack:stackFilter(a.stack);this.emit("fail",b,a)};Runner.prototype.failHook=function(b,a){this.fail(b,a);if(this.suite.bail()){this.emit("end")}};Runner.prototype.hook=function(c,f){var e=this.suite,a=e["_"+c],b=this,g;function d(h){var j=a[h];if(!j){return f()}b.currentRunnable=j;j.ctx.currentTest=b.test;b.emit("hook",j);j.on("error",function(i){b.failHook(j,i)});j.run(function(k){j.removeAllListeners("error");var i=j.error();if(i){b.fail(b.test,i)}if(k){if(k instanceof Pending){e.pending=true}else{b.failHook(j,k);return f(k)}}b.emit("hook end",j);delete j.ctx.currentTest;d(++h)})}Runner.immediately(function(){d(0)})};Runner.prototype.hooks=function(b,e,d){var a=this,f=this.suite;function c(g){a.suite=g;if(!g){a.suite=f;return d()}a.hook(b,function(h){if(h){var i=a.suite;a.suite=f;return d(h,i)}c(e.pop())})}c(e.pop())};Runner.prototype.hookUp=function(a,b){var c=[this.suite].concat(this.parents()).reverse();this.hooks(a,c,b)};Runner.prototype.hookDown=function(a,b){var c=[this.suite].concat(this.parents());this.hooks(a,c,b)};Runner.prototype.parents=function(){var a=this.suite,b=[];while(a=a.parent){b.push(a)}return b};Runner.prototype.runTest=function(b){var d=this.test,a=this;if(this.asyncOnly){d.asyncOnly=true}try{d.on("error",function(e){a.fail(d,e)});d.run(b)}catch(c){b(c)}};Runner.prototype.runTests=function(f,e){var a=this,d=f.tests.slice(),g;function b(h,i,j){var k=a.suite;a.suite=j?i.parent:i;if(a.suite){a.hookUp("afterEach",function(l,m){a.suite=k;if(l){return b(l,m,true)}e(i)})}else{a.suite=k;e(i)}}function c(i,j){if(a.failures&&f._bail){return e()}if(a._abort){return e()}if(i){return b(i,j,true)}g=d.shift();if(!g){return e()}var h=a._grep.test(g.fullTitle());if(a._invert){h=!h}if(!h){return c()}if(g.pending){a.emit("pending",g);a.emit("test end",g);return c()}a.emit("test",a.test=g);a.hookDown("beforeEach",function(k,l){if(f.pending){a.emit("pending",g);a.emit("test end",g);return c()}if(k){return b(k,l,false)}a.currentRunnable=a.test;a.runTest(function(m){g=a.test;if(m){if(m instanceof Pending){a.emit("pending",g)}else{a.fail(g,m)}a.emit("test end",g);if(m instanceof Pending){return c()}return a.hookUp("afterEach",c)}g.state="passed";a.emit("pass",g);a.emit("test end",g);a.hookUp("afterEach",c)})})}this.next=c;c()};Runner.prototype.runSuite=function(f,e){var g=this.grepTotal(f),b=this,c=0;debug("run suite %s",f.fullTitle());if(!g){return e()}this.emit("suite",this.suite=f);function d(h){if(h){if(h==f){return a()}else{return a(h)}}if(b._abort){return a()}var i=f.suites[c++];if(!i){return a()}b.runSuite(i,d)}function a(h){b.suite=f;b.hook("afterAll",function(){b.emit("suite end",f);e(h)})}this.hook("beforeAll",function(h){if(h){return a()}b.runTests(f,d)})};Runner.prototype.uncaught=function(a){if(a){debug("uncaught exception %s",a!==function(){return this}.call(a)?a:(a.message||a))}else{debug("uncaught undefined exception");a=utils.undefinedError()}a.uncaught=true;var b=this.currentRunnable;if(!b){return}b.clearTimeout();if(b.state){return}this.fail(b,a);if("test"==b.type){this.emit("test end",b);this.hookUp("afterEach",this.next);return}this.emit("end")};Runner.prototype.run=function(d){var b=this,c=this.suite;d=d||function(){};function a(f){b.uncaught(f)}function e(){b.emit("start");b.runSuite(c,function(){debug("finished running");b.emit("end")})}debug("start");this.on("end",function(){debug("end");process.removeListener("uncaughtException",a);d(b.failures)});process.on("uncaughtException",a);if(this._delay){this.emit("waiting",c);c.once("run",e)}else{e()}return this};Runner.prototype.abort=function(){debug("aborting");this._abort=true};function filterLeaks(a,b){return filter(b,function(d){if(/^d+/.test(d)){return false}if(global.navigator&&/^getInterface/.test(d)){return false}if(global.navigator&&/^\d+/.test(d)){return false}if(/^mocha-/.test(d)){return false}var c=filter(a,function(e){if(~e.indexOf("*")){return 0==d.indexOf(e.split("*")[0])}return d==e});return c.length==0&&(!global.navigator||"onerror"!==d)})}function extraGlobals(){if(typeof(process)==="object"&&typeof(process.version)==="string"){var a=process.version.split(".").reduce(function(b,c){return b<<8|c});if(a<2315){return["errno"]}}return[]};