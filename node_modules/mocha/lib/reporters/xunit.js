var Base=require("./base"),utils=require("../utils"),fs=require("fs"),escape=utils.escape;var Date=global.Date,setTimeout=global.setTimeout,setInterval=global.setInterval,clearTimeout=global.clearTimeout,clearInterval=global.clearInterval;exports=module.exports=XUnit;function XUnit(e,b){Base.call(this,e);var c=this.stats,d=[],a=this;if(b.reporterOptions&&b.reporterOptions.output){if(!fs.createWriteStream){throw new Error("file output not supported in browser")}a.fileStream=fs.createWriteStream(b.reporterOptions.output)}e.on("pending",function(f){d.push(f)});e.on("pass",function(f){d.push(f)});e.on("fail",function(f){d.push(f)});e.on("end",function(){a.write(tag("testsuite",{name:"Mocha Tests",tests:c.tests,failures:c.failures,errors:c.failures,skipped:c.tests-c.failures-c.passes,timestamp:(new Date).toUTCString(),time:(c.duration/1000)||0},false));d.forEach(function(f){a.test(f)});a.write("</testsuite>")})}XUnit.prototype.done=function(b,a){if(this.fileStream){this.fileStream.end(function(){a(b)})}else{a(b)}};XUnit.prototype.__proto__=Base.prototype;XUnit.prototype.write=function(a){if(this.fileStream){this.fileStream.write(a+"\n")}else{console.log(a)}};XUnit.prototype.test=function(d,b){var a={classname:d.parent.fullTitle(),name:d.title,time:(d.duration/1000)||0};if("failed"==d.state){var c=d.err;this.write(tag("testcase",a,false,tag("failure",{},false,cdata(escape(c.message)+"\n"+c.stack))))}else{if(d.pending){this.write(tag("testcase",a,false,tag("skipped",{},true)))}else{this.write(tag("testcase",a,true))}}};function tag(d,c,h,f){var b=h?"/>":">",g=[],a;for(var e in c){g.push(e+'="'+escape(c[e])+'"')}a="<"+d+(g.length?" "+g.join(" "):"")+b;if(f){a+=f+"</"+d+b}return a}function cdata(a){return"<![CDATA["+escape(a)+"]]>"};