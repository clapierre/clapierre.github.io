var Base=require("./base"),utils=require("../utils"),Progress=require("../browser/progress"),escape=utils.escape;var Date=global.Date,setTimeout=global.setTimeout,setInterval=global.setInterval,clearTimeout=global.clearTimeout,clearInterval=global.clearInterval;exports=module.exports=HTML;var statsTemplate='<ul id="mocha-stats"><li class="progress"><canvas width="40" height="40"></canvas></li><li class="passes"><a href="#">passes:</a> <em>0</em></li><li class="failures"><a href="#">failures:</a> <em>0</em></li><li class="duration">duration: <em>0</em>s</li></ul>';function HTML(h){Base.call(this,h);var i=this,q=this.stats,r=h.total,p=fragment(statsTemplate),j=p.getElementsByTagName("li"),d=j[1].getElementsByTagName("em")[0],o=j[1].getElementsByTagName("a")[0],b=j[2].getElementsByTagName("em")[0],k=j[2].getElementsByTagName("a")[0],a=j[3].getElementsByTagName("em")[0],c=p.getElementsByTagName("canvas")[0],n=fragment('<ul id="mocha-report"></ul>'),f=[n],e,l,m=document.getElementById("mocha");if(c.getContext){var g=window.devicePixelRatio||1;c.style.width=c.width;c.style.height=c.height;c.width*=g;c.height*=g;l=c.getContext("2d");l.scale(g,g);e=new Progress}if(!m){return error("#mocha div missing, add it to your document")}on(o,"click",function(){unhide();var s=/pass/.test(n.className)?"":" pass";n.className=n.className.replace(/fail|pass/g,"")+s;if(n.className.trim()){hideSuitesWithout("test pass")}});on(k,"click",function(){unhide();var s=/fail/.test(n.className)?"":" fail";n.className=n.className.replace(/fail|pass/g,"")+s;if(n.className.trim()){hideSuitesWithout("test fail")}});m.appendChild(p);m.appendChild(n);if(e){e.size(40)}h.on("suite",function(u){if(u.root){return}var s=i.suiteURL(u);var t=fragment('<li class="suite"><h1><a href="%s">%s</a></h1></li>',s,escape(u.title));f[0].appendChild(t);f.unshift(document.createElement("ul"));t.appendChild(f[0])});h.on("suite end",function(s){if(s.root){return}f.shift()});h.on("fail",function(t,s){if("hook"==t.type){h.emit("test end",t)}});h.on("test end",function(z){var w=q.tests/this.total*100|0;if(e){e.update(w).draw(l)}var u=new Date-q.start;text(d,q.passes);text(b,q.failures);text(a,(u/1000).toFixed(2));if("passed"==z.state){var t=i.testURL(z);var v=fragment('<li class="test pass %e"><h2>%e<span class="duration">%ems</span> <a href="%s" class="replay">‣</a></h2></li>',z.speed,z.title,z.duration,t)}else{if(z.pending){var v=fragment('<li class="test pass pending"><h2>%e</h2></li>',z.title)}else{var v=fragment('<li class="test fail"><h2>%e <a href="%e" class="replay">‣</a></h2></li>',z.title,i.testURL(z));var y=z.err.stack||z.err.toString();if(!~y.indexOf(z.err.message)){y=z.err.message+"\n"+y}if("[object Error]"==y){y=z.err.message}if(!z.err.stack&&z.err.sourceURL&&z.err.line!==undefined){y+="\n("+z.err.sourceURL+":"+z.err.line+")"}v.appendChild(fragment('<pre class="error">%e</pre>',y))}}if(!z.pending){var s=v.getElementsByTagName("h2")[0];on(s,"click",function(){x.style.display="none"==x.style.display?"block":"none"});var x=fragment("<pre><code>%e</code></pre>",utils.clean(z.fn.toString()));v.appendChild(x);x.style.display="none"}if(f[0]){f[0].appendChild(v)}})}var makeUrl=function makeUrl(b){var a=window.location.search;if(a){a=a.replace(/[?&]grep=[^&\s]*/g,"").replace(/^&/,"?")}return window.location.pathname+(a?a+"&":"?")+"grep="+encodeURIComponent(b)};HTML.prototype.suiteURL=function(a){return makeUrl(a.fullTitle())};HTML.prototype.testURL=function(a){return makeUrl(a.fullTitle())};function error(a){document.body.appendChild(fragment('<div id="mocha-error">%s</div>',a))}function fragment(c){var a=arguments,d=document.createElement("div"),b=1;d.innerHTML=c.replace(/%([se])/g,function(e,f){switch(f){case"s":return String(a[b++]);case"e":return escape(a[b++])}});return d.firstChild}function hideSuitesWithout(d){var c=document.getElementsByClassName("suite");for(var b=0;b<c.length;b++){var a=c[b].getElementsByClassName(d);if(0==a.length){c[b].className+=" hidden"}}}function unhide(){var b=document.getElementsByClassName("suite hidden");for(var a=0;a<b.length;++a){b[a].className=b[a].className.replace("suite hidden","suite")}}function text(a,b){if(a.textContent){a.textContent=b}else{a.innerText=b}}function on(b,c,a){if(b.addEventListener){b.addEventListener(c,a,false)}else{b.attachEvent("on"+c,a)}};