var tty=require("tty"),diff=require("diff"),ms=require("../ms"),utils=require("../utils"),supportsColor=process.env?require("supports-color"):null;var Date=global.Date,setTimeout=global.setTimeout,setInterval=global.setInterval,clearTimeout=global.clearTimeout,clearInterval=global.clearInterval;var isatty=tty.isatty(1)&&tty.isatty(2);exports=module.exports=Base;exports.useColors=process.env?(supportsColor||(process.env.MOCHA_COLORS!==undefined)):false;exports.inlineDiffs=false;exports.colors={pass:90,fail:31,"bright pass":92,"bright fail":91,"bright yellow":93,pending:36,suite:0,"error title":0,"error message":31,"error stack":90,checkmark:32,fast:90,medium:33,slow:31,green:32,light:90,"diff gutter":90,"diff added":32,"diff removed":31};exports.symbols={ok:"✓",err:"✖",dot:"․"};if("win32"==process.platform){exports.symbols.ok="\u221A";exports.symbols.err="\u00D7";exports.symbols.dot="."}var color=exports.color=function(a,b){if(!exports.useColors){return String(b)}return"\u001b["+exports.colors[a]+"m"+b+"\u001b[0m"};exports.window={width:isatty?process.stdout.getWindowSize?process.stdout.getWindowSize(1)[0]:tty.getWindowSize()[1]:75};exports.cursor={hide:function(){isatty&&process.stdout.write("\u001b[?25l")},show:function(){isatty&&process.stdout.write("\u001b[?25h")},deleteLine:function(){isatty&&process.stdout.write("\u001b[2K")},beginningOfLine:function(){isatty&&process.stdout.write("\u001b[0G")},CR:function(){if(isatty){exports.cursor.deleteLine();exports.cursor.beginningOfLine()}else{process.stdout.write("\r")}}};exports.list=function(a){console.log();a.forEach(function(h,d){var b=color("error title","  %s) %s:\n")+color("error message","     %s")+color("error stack","\n%s\n");var c=h.err,m=c.message||"",j=c.stack||m,g=j.indexOf(m),l=c.actual,f=c.expected,k=true;if(g===-1){msg=m}else{g+=m.length;msg=j.slice(0,g);j=j.slice(g+1)}if(c.uncaught){msg="Uncaught "+msg}if(c.showDiff!==false&&sameType(l,f)&&f!==undefined){k=false;if(!(utils.isString(l)&&utils.isString(f))){c.actual=l=utils.stringify(l);c.expected=f=utils.stringify(f)}b=color("error title","  %s) %s:\n%s")+color("error stack","\n%s\n");var e=m.match(/^([^:]+): expected/);msg="\n      "+color("error message",e?e[1]:msg);if(exports.inlineDiffs){msg+=inlineDiff(c,k)}else{msg+=unifiedDiff(c,k)}}j=j.replace(/^/gm,"  ");console.log(b,(d+1),h.fullTitle(),msg,j)})};function Base(d){var a=this,b=this.stats={suites:0,tests:0,passes:0,pending:0,failures:0},c=this.failures=[];if(!d){return}this.runner=d;d.stats=b;d.on("start",function(){b.start=new Date});d.on("suite",function(e){b.suites=b.suites||0;e.root||b.suites++});d.on("test end",function(e){b.tests=b.tests||0;b.tests++});d.on("pass",function(f){b.passes=b.passes||0;var e=f.slow()/2;f.speed=f.duration>f.slow()?"slow":f.duration>e?"medium":"fast";b.passes++});d.on("fail",function(f,e){b.failures=b.failures||0;b.failures++;f.err=e;c.push(f)});d.on("end",function(){b.end=new Date;b.duration=new Date-b.start});d.on("pending",function(){b.pending++})}Base.prototype.epilogue=function(){var b=this.stats;var c;var a;console.log();a=color("bright pass"," ")+color("green"," %d passing")+color("light"," (%s)");console.log(a,b.passes||0,ms(b.duration));if(b.pending){a=color("pending"," ")+color("pending"," %d pending");console.log(a,b.pending)}if(b.failures){a=color("fail","  %d failing");console.log(a,b.failures);Base.list(this.failures);console.log()}console.log()};function pad(b,a){b=String(b);return Array(a-b.length+1).join(" ")+b}function inlineDiff(d,c){var e=errorDiff(d,"WordsWithSpace",c);var a=e.split("\n");if(a.length>4){var b=String(a.length).length;e=a.map(function(g,f){return pad(++f,b)+" | "+g}).join("\n")}e="\n"+color("diff removed","actual")+" "+color("diff added","expected")+"\n\n"+e+"\n";e=e.replace(/^/gm,"      ");return e}function unifiedDiff(d,c){var a="      ";function e(h){if(c){h=escapeInvisibles(h)}if(h[0]==="+"){return a+colorLines("diff added",h)}if(h[0]==="-"){return a+colorLines("diff removed",h)}if(h.match(/\@\@/)){return null}if(h.match(/\\ No newline/)){return null}else{return a+h}}function g(h){return h!=null}var f=diff.createPatch("string",d.actual,d.expected);var b=f.split("\n").splice(4);return"\n      "+colorLines("diff added","+ expected")+" "+colorLines("diff removed","- actual")+"\n\n"+b.map(e).filter(g).join("\n")}function errorDiff(d,a,c){var e=c?escapeInvisibles(d.actual):d.actual;var b=c?escapeInvisibles(d.expected):d.expected;return diff["diff"+a](e,b).map(function(f){if(f.added){return colorLines("diff added",f.value)}if(f.removed){return colorLines("diff removed",f.value)}return f.value}).join("")}function escapeInvisibles(a){return a.replace(/\t/g,"<tab>").replace(/\r/g,"<CR>").replace(/\n/g,"<LF>\n")}function colorLines(a,b){return b.split("\n").map(function(c){return color(a,c)}).join("\n")}function sameType(d,c){d=Object.prototype.toString.call(d);c=Object.prototype.toString.call(c);return d==c};