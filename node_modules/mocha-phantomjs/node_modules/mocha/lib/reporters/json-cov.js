var Base=require("./base");exports=module.exports=JSONCov;function JSONCov(f,b){var a=this,b=1==arguments.length?true:b;Base.call(this,f);var d=[],c=[],e=[];f.on("test end",function(g){d.push(g)});f.on("pass",function(g){e.push(g)});f.on("fail",function(g){c.push(g)});f.on("end",function(){var h=global._$jscoverage||{};var g=a.cov=map(h);g.stats=a.stats;g.tests=d.map(clean);g.failures=c.map(clean);g.passes=e.map(clean);if(!b){return}process.stdout.write(JSON.stringify(g,null,2))})}function map(c){var b={instrumentation:"node-jscoverage",sloc:0,hits:0,misses:0,coverage:0,files:[]};for(var a in c){var d=coverage(a,c[a]);b.files.push(d);b.hits+=d.hits;b.misses+=d.misses;b.sloc+=d.sloc}b.files.sort(function(f,e){return f.filename.localeCompare(e.filename)});if(b.sloc>0){b.coverage=(b.hits/b.sloc)*100}return b}function coverage(a,c){var b={filename:a,coverage:0,hits:0,misses:0,sloc:0,source:{}};c.source.forEach(function(d,e){e++;if(c[e]===0){b.misses++;b.sloc++}else{if(c[e]!==undefined){b.hits++;b.sloc++}}b.source[e]={source:d,coverage:c[e]===undefined?"":c[e]}});b.coverage=b.hits/b.sloc*100;return b}function clean(a){return{title:a.title,fullTitle:a.fullTitle(),duration:a.duration}};