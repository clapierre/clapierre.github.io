var tty=require("tty"),diff=require("diff"),ms=require("../ms"),utils=require("../utils");var Date=global.Date,setTimeout=global.setTimeout,setInterval=global.setInterval,clearTimeout=global.clearTimeout,clearInterval=global.clearInterval;var isatty=tty.isatty(1)&&tty.isatty(2);exports=module.exports=Base;exports.useColors=isatty||(process.env.MOCHA_COLORS!==undefined);exports.inlineDiffs=false;exports.colors={pass:90,fail:31,"bright pass":92,"bright fail":91,"bright yellow":93,pending:36,suite:0,"error title":0,"error message":31,"error stack":90,checkmark:32,fast:90,medium:33,slow:31,green:32,light:90,"diff gutter":90,"diff added":42,"diff removed":41};exports.symbols={ok:"✓",err:"✖",dot:"․"};if("win32"==process.platform){exports.symbols.ok="\u221A";exports.symbols.err="\u00D7";exports.symbols.dot="."}var color=exports.color=function(a,b){if(!exports.useColors){return b}return"\u001b["+exports.colors[a]+"m"+b+"\u001b[0m"};exports.window={width:isatty?process.stdout.getWindowSize?process.stdout.getWindowSize(1)[0]:tty.getWindowSize()[1]:75};exports.cursor={hide:function(){isatty&&process.stdout.write("\u001b[?25l")},show:function(){isatty&&process.stdout.write("\u001b[?25h")},deleteLine:function(){isatty&&process.stdout.write("\u001b[2K")},beginningOfLine:function(){isatty&&process.stdout.write("\u001b[0G")},CR:function(){if(isatty){exports.cursor.deleteLine();exports.cursor.beginningOfLine()}else{process.stdout.write("\r")}}};exports.list=function(a){console.error();a.forEach(function(j,e){var c=color("error title","  %s) %s:\n")+color("error message","     %s")+color("error stack","\n%s\n");var d=j.err,n=d.message||"",k=d.stack||n,h=k.indexOf(n)+n.length,b=k.slice(0,h),m=d.actual,g=d.expected,l=true;if(d.uncaught){b="Uncaught "+b}if(d.showDiff&&sameType(m,g)){l=false;d.actual=m=stringify(canonicalize(m));d.expected=g=stringify(canonicalize(g))}if("string"==typeof m&&"string"==typeof g){c=color("error title","  %s) %s:\n%s")+color("error stack","\n%s\n");var f=n.match(/^([^:]+): expected/);b="\n      "+color("error message",f?f[1]:b);if(exports.inlineDiffs){b+=inlineDiff(d,l)}else{b+=unifiedDiff(d,l)}}k=k.slice(h?h+1:h).replace(/^/gm,"  ");console.error(c,(e+1),j.fullTitle(),b,k)})};function Base(d){var a=this,b=this.stats={suites:0,tests:0,passes:0,pending:0,failures:0},c=this.failures=[];if(!d){return}this.runner=d;d.stats=b;d.on("start",function(){b.start=new Date});d.on("suite",function(e){b.suites=b.suites||0;e.root||b.suites++});d.on("test end",function(e){b.tests=b.tests||0;b.tests++});d.on("pass",function(f){b.passes=b.passes||0;var e=f.slow()/2;f.speed=f.duration>f.slow()?"slow":f.duration>e?"medium":"fast";b.passes++});d.on("fail",function(f,e){b.failures=b.failures||0;b.failures++;f.err=e;c.push(f)});d.on("end",function(){b.end=new Date;b.duration=new Date-b.start});d.on("pending",function(){b.pending++})}Base.prototype.epilogue=function(){var b=this.stats;var c;var a;console.log();a=color("bright pass"," ")+color("green"," %d passing")+color("light"," (%s)");console.log(a,b.passes||0,ms(b.duration));if(b.pending){a=color("pending"," ")+color("pending"," %d pending");console.log(a,b.pending)}if(b.failures){a=color("fail","  %d failing");console.error(a,b.failures);Base.list(this.failures);console.error()}console.log()};function pad(b,a){b=String(b);return Array(a-b.length+1).join(" ")+b}function inlineDiff(d,c){var e=errorDiff(d,"WordsWithSpace",c);var a=e.split("\n");if(a.length>4){var b=String(a.length).length;e=a.map(function(g,f){return pad(++f,b)+" | "+g}).join("\n")}e="\n"+color("diff removed","actual")+" "+color("diff added","expected")+"\n\n"+e+"\n";e=e.replace(/^/gm,"      ");return e}function unifiedDiff(d,c){var a="      ";function e(g){if(c){g=escapeInvisibles(g)}if(g[0]==="+"){return a+colorLines("diff added",g)}if(g[0]==="-"){return a+colorLines("diff removed",g)}if(g.match(/\@\@/)){return null}if(g.match(/\\ No newline/)){return null}else{return a+g}}function f(g){return g!=null}msg=diff.createPatch("string",d.actual,d.expected);var b=msg.split("\n").splice(4);return"\n      "+colorLines("diff added","+ expected")+" "+colorLines("diff removed","- actual")+"\n\n"+b.map(e).filter(f).join("\n")}function errorDiff(d,a,c){var e=c?escapeInvisibles(d.actual):d.actual;var b=c?escapeInvisibles(d.expected):d.expected;return diff["diff"+a](e,b).map(function(f){if(f.added){return colorLines("diff added",f.value)}if(f.removed){return colorLines("diff removed",f.value)}return f.value}).join("")}function escapeInvisibles(a){return a.replace(/\t/g,"<tab>").replace(/\r/g,"<CR>").replace(/\n/g,"<LF>\n")}function colorLines(a,b){return b.split("\n").map(function(c){return color(a,c)}).join("\n")}function stringify(a){if(a instanceof RegExp){return a.toString()}return JSON.stringify(a,null,2)}function canonicalize(c,a){a=a||[];if(utils.indexOf(a,c)!==-1){return c}var b;if("[object Array]"=={}.toString.call(c)){a.push(c);b=utils.map(c,function(d){return canonicalize(d,a)});a.pop()}else{if(typeof c==="object"&&c!==null){a.push(c);b={};utils.forEach(utils.keys(c).sort(),function(d){b[d]=canonicalize(c[d],a)});a.pop()}else{b=c}}return b}function sameType(d,c){d=Object.prototype.toString.call(d);c=Object.prototype.toString.call(c);return d==c};