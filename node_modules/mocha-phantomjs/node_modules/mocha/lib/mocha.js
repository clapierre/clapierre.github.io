/*!
 * mocha
 * Copyright(c) 2011 TJ Holowaychuk <tj@vision-media.ca>
 * MIT Licensed
 */
var path=require("path"),utils=require("./utils");exports=module.exports=Mocha;exports.utils=utils;exports.interfaces=require("./interfaces");exports.reporters=require("./reporters");exports.Runnable=require("./runnable");exports.Context=require("./context");exports.Runner=require("./runner");exports.Suite=require("./suite");exports.Hook=require("./hook");exports.Test=require("./test");function image(a){return __dirname+"/../images/"+a+".png"}function Mocha(a){a=a||{};this.files=[];this.options=a;this.grep(a.grep);this.suite=new exports.Suite("",new exports.Context);this.ui(a.ui);this.bail(a.bail);this.reporter(a.reporter);if(null!=a.timeout){this.timeout(a.timeout)}this.useColors(a.useColors);if(a.slow){this.slow(a.slow)}this.suite.on("pre-require",function(b){exports.afterEach=b.afterEach||b.teardown;exports.after=b.after||b.suiteTeardown;exports.beforeEach=b.beforeEach||b.setup;exports.before=b.before||b.suiteSetup;exports.describe=b.describe||b.suite;exports.it=b.it||b.test;exports.setup=b.setup||b.beforeEach;exports.suiteSetup=b.suiteSetup||b.before;exports.suiteTeardown=b.suiteTeardown||b.after;exports.suite=b.suite||b.describe;exports.teardown=b.teardown||b.afterEach;exports.test=b.test||b.it})}Mocha.prototype.bail=function(a){if(0==arguments.length){a=true}this.suite.bail(a);return this};Mocha.prototype.addFile=function(a){this.files.push(a);return this};Mocha.prototype.reporter=function(a){if("function"==typeof a){this._reporter=a}else{a=a||"dot";var b;try{b=require("./reporters/"+a)}catch(c){}if(!b){try{b=require(a)}catch(c){}}if(!b&&a==="teamcity"){console.warn("The Teamcity reporter was moved to a package named mocha-teamcity-reporter (https://npmjs.org/package/mocha-teamcity-reporter).")}if(!b){throw new Error('invalid reporter "'+a+'"')}this._reporter=b}return this};Mocha.prototype.ui=function(a){a=a||"bdd";this._ui=exports.interfaces[a];if(!this._ui){try{this._ui=require(a)}catch(b){}}if(!this._ui){throw new Error('invalid interface "'+a+'"')}this._ui=this._ui(this.suite);return this};Mocha.prototype.loadFiles=function(c){var a=this;var b=this.suite;var d=this.files.length;this.files.forEach(function(e){e=path.resolve(e);b.emit("pre-require",global,e,a);b.emit("require",require(e),e,a);b.emit("post-require",global,e,a);--d||(c&&c())})};Mocha.prototype._growl=function(c,a){var b=require("growl");c.on("end",function(){var d=a.stats;if(d.failures){var e=d.failures+" of "+c.total+" tests failed";b(e,{name:"mocha",title:"Failed",image:image("error")})}else{b(d.passes+" tests passed in "+d.duration+"ms",{name:"mocha",title:"Passed",image:image("ok")})}})};Mocha.prototype.grep=function(a){this.options.grep="string"==typeof a?new RegExp(utils.escapeRegexp(a)):a;return this};Mocha.prototype.invert=function(){this.options.invert=true;return this};Mocha.prototype.ignoreLeaks=function(a){this.options.ignoreLeaks=!!a;return this};Mocha.prototype.checkLeaks=function(){this.options.ignoreLeaks=false;return this};Mocha.prototype.growl=function(){this.options.growl=true;return this};Mocha.prototype.globals=function(a){this.options.globals=(this.options.globals||[]).concat(a);return this};Mocha.prototype.useColors=function(a){this.options.useColors=arguments.length&&a!=undefined?a:true;return this};Mocha.prototype.useInlineDiffs=function(a){this.options.useInlineDiffs=arguments.length&&a!=undefined?a:false;return this};Mocha.prototype.timeout=function(a){this.suite.timeout(a);return this};Mocha.prototype.slow=function(a){this.suite.slow(a);return this};Mocha.prototype.asyncOnly=function(){this.options.asyncOnly=true;return this};Mocha.prototype.run=function(d){if(this.files.length){this.loadFiles()}var c=this.suite;var b=this.options;b.files=this.files;var e=new exports.Runner(c);var a=new this._reporter(e,b);e.ignoreLeaks=false!==b.ignoreLeaks;e.asyncOnly=b.asyncOnly;if(b.grep){e.grep(b.grep,b.invert)}if(b.globals){e.globals(b.globals)}if(b.growl){this._growl(e,a)}exports.reporters.Base.useColors=b.useColors;exports.reporters.Base.inlineDiffs=b.useInlineDiffs;return e.run(d)};