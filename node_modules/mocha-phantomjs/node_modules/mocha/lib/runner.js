function Runner(t){var e=this;this._globals=[],this._abort=!1,this.suite=t,this.total=t.total(),this.failures=0,this.on("test end",function(t){e.checkGlobals(t)}),this.on("hook end",function(t){e.checkGlobals(t)}),this.grep(/.*/),this.globals(this.globalProps().concat(extraGlobals()))}function filterLeaks(t,e){return filter(e,function(e){if(/^d+/.test(e))return!1;if(global.navigator&&/^getInterface/.test(e))return!1;if(global.navigator&&/^\d+/.test(e))return!1;if(/^mocha-/.test(e))return!1;var n=filter(t,function(t){return~t.indexOf("*")?0==e.indexOf(t.split("*")[0]):e==t});return 0==n.length&&(!global.navigator||"onerror"!==e)})}function extraGlobals(){if("object"==typeof process&&"string"==typeof process.version){var t=process.version.split(".").reduce(function(t,e){return t<<8|e});if(2315>t)return["errno"]}return[]}var EventEmitter=require("events").EventEmitter,debug=require("debug")("mocha:runner"),Test=require("./test"),utils=require("./utils"),filter=utils.filter,keys=utils.keys,globals=["setTimeout","clearTimeout","setInterval","clearInterval","XMLHttpRequest","Date"];module.exports=Runner,Runner.immediately=global.setImmediate||process.nextTick,Runner.prototype.__proto__=EventEmitter.prototype,Runner.prototype.grep=function(t,e){return debug("grep %s",t),this._grep=t,this._invert=e,this.total=this.grepTotal(this.suite),this},Runner.prototype.grepTotal=function(t){var e=this,n=0;return t.eachTest(function(t){var r=e._grep.test(t.fullTitle());e._invert&&(r=!r),r&&n++}),n},Runner.prototype.globalProps=function(){for(var t=utils.keys(global),e=0;e<globals.length;++e)~utils.indexOf(t,globals[e])||t.push(globals[e]);return t},Runner.prototype.globals=function(t){return 0==arguments.length?this._globals:(debug("globals %j",t),this._globals=this._globals.concat(t),this)},Runner.prototype.checkGlobals=function(t){if(!this.ignoreLeaks){var e,n=this._globals,r=this.globalProps();t&&(n=n.concat(t._allowedGlobals||[])),this.prevGlobalsLength!=r.length&&(this.prevGlobalsLength=r.length,e=filterLeaks(n,r),this._globals=this._globals.concat(e),e.length>1?this.fail(t,new Error("global leaks detected: "+e.join(", "))):e.length&&this.fail(t,new Error("global leak detected: "+e[0])))}},Runner.prototype.fail=function(t,e){++this.failures,t.state="failed","string"==typeof e&&(e=new Error('the string "'+e+'" was thrown, throw an Error :)')),this.emit("fail",t,e)},Runner.prototype.failHook=function(t,e){this.fail(t,e),this.suite.bail()&&this.emit("end")},Runner.prototype.hook=function(t,e){function n(t){var s=i[t];return s?o.failures&&r.bail()?e():(o.currentRunnable=s,s.ctx.currentTest=o.test,o.emit("hook",s),s.on("error",function(t){o.failHook(s,t)}),void s.run(function(r){s.removeAllListeners("error");var i=s.error();return i&&o.fail(o.test,i),r?(o.failHook(s,r),e(r)):(o.emit("hook end",s),delete s.ctx.currentTest,void n(++t))})):e()}var r=this.suite,i=r["_"+t],o=this;Runner.immediately(function(){n(0)})},Runner.prototype.hooks=function(t,e,n){function r(s){return i.suite=s,s?void i.hook(t,function(t){if(t){var s=i.suite;return i.suite=o,n(t,s)}r(e.pop())}):(i.suite=o,n())}var i=this,o=this.suite;r(e.pop())},Runner.prototype.hookUp=function(t,e){var n=[this.suite].concat(this.parents()).reverse();this.hooks(t,n,e)},Runner.prototype.hookDown=function(t,e){var n=[this.suite].concat(this.parents());this.hooks(t,n,e)},Runner.prototype.parents=function(){for(var t=this.suite,e=[];t=t.parent;)e.push(t);return e},Runner.prototype.runTest=function(t){var e=this.test,n=this;this.asyncOnly&&(e.asyncOnly=!0);try{e.on("error",function(t){n.fail(e,t)}),e.run(t)}catch(r){t(r)}},Runner.prototype.runTests=function(t,e){function n(t,r,i){var s=o.suite;o.suite=i?r.parent:r,o.suite?o.hookUp("afterEach",function(t,i){return o.suite=s,t?n(t,i,!0):void e(r)}):(o.suite=s,e(r))}function r(u,a){if(o.failures&&t._bail)return e();if(o._abort)return e();if(u)return n(u,a,!0);if(i=s.shift(),!i)return e();var l=o._grep.test(i.fullTitle());return o._invert&&(l=!l),l?i.pending?(o.emit("pending",i),o.emit("test end",i),r()):(o.emit("test",o.test=i),void o.hookDown("beforeEach",function(t,e){return t?n(t,e,!1):(o.currentRunnable=o.test,void o.runTest(function(t){return i=o.test,t?(o.fail(i,t),o.emit("test end",i),o.hookUp("afterEach",r)):(i.state="passed",o.emit("pass",i),o.emit("test end",i),void o.hookUp("afterEach",r))}))})):r()}var i,o=this,s=t.tests.slice();this.next=r,r()},Runner.prototype.runSuite=function(t,e){function n(e){if(e)return e==t?r():r(e);if(o._abort)return r();var i=t.suites[s++];return i?void o.runSuite(i,n):r()}function r(n){o.suite=t,o.hook("afterAll",function(){o.emit("suite end",t),e(n)})}var i=this.grepTotal(t),o=this,s=0;return debug("run suite %s",t.fullTitle()),i?(this.emit("suite",this.suite=t),void this.hook("beforeAll",function(e){return e?r():void o.runTests(t,n)})):e()},Runner.prototype.uncaught=function(t){debug("uncaught exception %s",t.message);var e=this.currentRunnable;if(e&&"failed"!=e.state)return e.clearTimeout(),t.uncaught=!0,this.fail(e,t),"test"==e.type?(this.emit("test end",e),void this.hookUp("afterEach",this.next)):void this.emit("end")},Runner.prototype.run=function(t){function e(t){n.uncaught(t)}var n=this,t=t||function(){};return debug("start"),this.on("end",function(){debug("end"),process.removeListener("uncaughtException",e),t(n.failures)}),this.emit("start"),this.runSuite(this.suite,function(){debug("finished running"),n.emit("end")}),process.on("uncaughtException",e),this},Runner.prototype.abort=function(){debug("aborting"),this._abort=!0};