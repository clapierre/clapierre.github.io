require(["tests/options","tests/utils","chai","jquery","underscore","vellum/datasources","vellum/itemset","vellum/form","text!static/itemset/test1.xml","text!static/itemset/inner-filters.xml","text!static/itemset/dropdown-fixture.xml"],function(o,j,i,h,l,g,c,d,k,f,b){var a=i.assert,n=j.call,m=j.clickQuestion,e=l.union(j.options.options.plugins||[],["itemset"]);describe("The Dynamic Itemset plugin",function(){function p(q){j.init({plugins:e,javaRosa:{langs:["en"]},core:{onReady:q},features:{advanced_itemsets:false},})}before(p);beforeEach(g.reset);it("adds a new instance to the form",function(){j.loadXML(k);var s=j.getMug("question1/itemset");s.p.itemsetData={instance:{id:"somefixture",src:"jr://somefixture"},nodeset:"instance('somefixture')/some/items",labelRef:"label",valueRef:"value",};var q=n("createXML"),r=h(q);a(r.find("instance[id=somefixture]").length,"somefixture instance not found:\n"+q)});it("changes instance when nodeset changes",function(){var s=j.loadXML(k),t=j.getMug("question1/itemset");s.updateKnownInstances({foo:"jr://foo"});t.p.itemsetData={nodeset:"instance('foo')/some/items",labelRef:"label",valueRef:"value",};var q=n("createXML"),r=h(q);a(r.find("instance[id=foo]").length,"foo instance not found:\n"+q);a.equal(r.find("instance[id=casedb]").length,0,"somefixture instance not found:\n"+q)});it("renames instance on add itemset with matching instance",function(){j.loadXML(k);j.addQuestion("SelectDynamic","select2");var t=j.getMug("select2/itemset");t.p.itemsetData={instance:{id:"cases",src:"jr://instance/casedb"},nodeset:"instance('cases')/cases/case[@case_id > 2]",labelRef:"label",valueRef:"value",};var s=t.p.itemsetData;a.equal(s.instance.id,"casedb");a.equal(s.instance.src,"jr://instance/casedb");a.equal(s.nodeset,"instance('casedb')/cases/case[@case_id > 2]");var q=n("createXML"),r=h(q);a(r.find("instance[id=casedb]").length,"casedb instance not found:\n"+q);a(r.find("instance[id=cases]").length===0,"cases instance should have been renamed/merged:\n"+q)});it("should select first lookup table for new itemset",function(){j.loadXML("");j.addQuestion("SelectDynamic","select");j.clickQuestion("select/itemset");var q=j.getMug("select/itemset");q.validate();a.equal(j.getMessages(q),"")});it("should load dynamic select without errors",function(){j.loadXML(k);var q=j.getMug("question1/itemset");q.validate();a.equal(j.getMessages(q),"")});it("should not trigger change on click itemset",function(){j.loadXML(k);j.saveButtonEnabled(false);m("question1/itemset");a(!j.saveButtonEnabled(),"save button should not be enabled")});describe("parsing and serializing",function(){before(p);it("preserves XML with itemsets in <select>s",function(){a(k.indexOf("select1")!==-1);j.loadXML(k);j.assertXmlEqual(n("createXML"),k)});it("preserves XML with itemsets in <select1>s",function(){var q=k.replace(/select1/g,"select");j.loadXML(q);j.assertXmlEqual(n("createXML"),q)})});describe("UI",function(){it("preserves inner filters if you never change the data source",function(){j.loadXML(f);m("question2/itemset");h("[name='label_ref']").val("dummy").change();j.assertXmlEqual(f.replace("case_name","dummy"),n("createXML"))});it("uses a dropdown when the nodeset is known",function(){j.loadXML(b);m("question2/itemset");a(h("[name=property-itemsetData]").is("select"))});describe("with a custom fixture",function(){it("should not warn on unrecognized values and labels",function(){j.loadXML(b);var q=j.getMug("/data/question2/itemset");a.strictEqual(q.spec.itemsetData.validationFunc(q),"pass");q.p.itemsetData.instance.src="blah";a.strictEqual(q.spec.itemsetData.validationFunc(q),"pass")})});describe("with recognized fixture",function(){it("should warn on unrecognized values and labels",function(){j.loadXML(b);var q=j.getMug("/data/question2/itemset");a.strictEqual(q.spec.itemsetData.validationFunc(q),"pass");m("question2/itemset");h("[name=value_ref]").val("blah").change();a.notStrictEqual(q.spec.itemsetData.validationFunc(q),"pass")});it("should not warn on values with a filter attached",function(){j.loadXML(b);var q=j.getMug("/data/question2/itemset");a.strictEqual(q.spec.itemsetData.validationFunc(q),"pass");m("question2/itemset");var r=h("[name=value_ref]");r.val(r.val()+"[filter]").change();a.strictEqual(q.spec.itemsetData.validationFunc(q),"pass")});it("should not warn on labels with a filter attached",function(){j.loadXML(b);var q=j.getMug("/data/question2/itemset");a.strictEqual(q.spec.itemsetData.validationFunc(q),"pass");m("question2/itemset");var r=h("[name=label_ref]");r.val(r.val()+"[filter]").change();a.strictEqual(q.spec.itemsetData.validationFunc(q),"pass")});it("should not warn on inner filters",function(){j.loadXML(b);var q=j.getMug("/data/question2/itemset");a.strictEqual(q.spec.itemsetData.validationFunc(q),"pass");m("question2/itemset");h("[name=label_ref]").val("inner-attribute[filter1]/extra-inner-attribute[filter2]").change();a.strictEqual(q.spec.itemsetData.validationFunc(q),"pass")})})})})});