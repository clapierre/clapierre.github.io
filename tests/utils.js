define(["./options","chai","equivalent-xml","jsdiff","underscore","jquery","vellum/tsv","vellum/copy-paste","jquery.jstree","jquery.vellum"],function(e,a,u,n,G,f,A,y){var c=a.assert,H=null,p=0,w=["Form Builder clip","version 1"];c.equal=c.strictEqual;c.notEqual=c.notStrictEqual;function I(L,J){var M=u.xml(L),K=u.xml(J);return u.isEquivalent(M,K,{element_order:true})}function x(N,L,K){K=K||{};if(K.normalize_xmlns){var M=f(f.parseXML(L)).find("data").attr("xmlns");N=N.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+M+'"')}var J=I(N,L);if(K.not){J=!J}if(!J){N=k(N);L=k(L);g(N,L,"XML "+(K.not?"should not be equivalent":"mismatch"))}}function F(L,K,J){J=J||{};J.not=true;x(L,K,J)}function b(){function J(P,R){var O,M,Q,N=[];if(P.id==="#"){R=-1}else{N.push(Array(R*2+1).join(" ")+P.text)}for(O=0,M=P.children.length;O<M;O++){Q=C("jstree","get_node",P.children[O]);N.push(J(Q,R+1))}return N.join("\n")}var K=Array.prototype.slice.call(arguments).join("\n")+"\n",L=J(C("jstree","get_node","#"))+"\n";g(L,K,"Unexpected jstree state")}function q(J){function K(Q,S){var P,N,R,O=[];if(Q.isRootNode){S=-1}else{O.push(Array(S*2+1).join(" ")+Q.value.p.nodeID)}for(P=0,N=Q.children.length;P<N;P++){R=Q.children[P];O.push(K(R,S+1))}return O.join("\n")}var L=Array.prototype.slice.call(arguments,1).join("\n")+"\n",M=K(J.rootNode,0)+"\n";g(M,L,"Unexpected tree state")}function g(M,K,J){if(M!==K){var L=n.createPatch("",M,K,"actual","expected");L=L.replace(/^Index:/,J||"Not equal:");c(false,j(L))}}function k(J){J=J.replace(/^\t+/mg,function(K){return K.replace(/\t/g,"  ")});if(!J.match(/\n$/)){J=J+"\n"}return J}function j(L){if(!window.mochaPhantomJS){return L}var J={"-":31,"+":32};function K(N){var M=J[N[0]]||0;return"\u001b["+M+"m"+N+"\u001b[0m"}return L.replace(/^.+?$/gm,K)}function E(J){return C("getCurrentMugInput",J)}function v(L,K,J){if(G.isString(L)){J=" for "+(J?J+" ":"")+L;L=E(L)}else{J=J?" for "+J:""}c.equal(L.length,K,"wrong number of inputs"+J)}function z(M){M=M||{};var N=f.extend(true,{},e.options,M);if(M.javaRosa&&M.javaRosa.langs){N.javaRosa.langs=M.javaRosa.langs}if(M.plugins){N.plugins=M.plugins}N.core=N.core||{};var L=N.core.saveUrl||function(){};N.core.saveUrl=function(O){H=O.xform;p++;L(O)};var K=f("#vellum"),J=K.vellum("get");if(J){J.destroy();f("body > div.modal, body > div.modal-backdrop").remove()}K.empty().vellum(N)}function C(){var J=Array.prototype.slice.call(arguments),K=f("#vellum");return K.vellum.apply(K,J)}function d(N,K,L){var J=[],M=C("getData");M.core.parseWarnings=[];C("loadXML",N,K||{});if(!L){J=M.core.parseWarnings}else{if(G.isRegExp(L)){J=G.filter(M.core.parseWarnings,function(O){return !L.test(O)})}}c(!J.length,"unexpected parse warnings:\n- "+J.join("\n- "));delete M.core.parseWarnings;return M.core.form}function o(K,L,J){if(!G.isString(K)){K=A.tabDelimit([w].concat(K))}if(J){window.console.log(K)}c.deepEqual(y.paste(K),L||[])}function i(){var K=[],J=G.map(arguments,function(M){var L=m(M);if(!(L&&L.ufid)){throw new Error("mug not found: "+M)}K.push(L);return L.ufid});C("jstree","deselect_all",true);C("jstree","select_node",J);return K}function D(){C("jstree","select_all")}function m(Q){if(Q.indexOf("/")!==0){Q="/data/"+Q}var K=C("getMugByPath",Q);if(!K){var O=Q.split("/"),J=O.slice(0,-1).join("/"),N=C("getMugByPath",J);if(N&&N.__className.indexOf("Select")>-1){var M=C("getData").core.form.getChildren(N),P=O[O.length-1];if(M.length===1&&P==="itemset"&&M[0].options.tagName==="itemset"){return M[0]}for(var L=0;L<M.length;L++){if(M[L].p.nodeID===P){return M[L]}}}}return K}function t(){var J=G.map(arguments,function(L){var K=m(L);c(K,"mug not found: "+L);return K});C("getData").core.form.removeMugsFromForm(J);G.each(arguments,function(K){c(!m(K),"mug not removed: "+K)})}function l(L){var J=C("getData").core.saveButton;if(!G.isUndefined(L)){var K=L?"save":"saved";J.setStateWhenReady(K);c.equal(J.state,K,"sanity check failed")}return J.state==="save"}function r(J){C("jstree","open_node",J.ufid);C("jstree","redraw_node",J.ufid,true,false,false)}function s(J){C("jstree","close_node",J.ufid);C("jstree","redraw_node",J.ufid,true,false,false)}function B(J){var L=[],K=null;if(G.isString(J)){var M=J;J=m(M);c(J,"mug not found: "+M)}J.messages.each(function(O,N){if(N!==K){L.push(N+":");K=N}L.push("  - "+O.message)});return L.join("\n")}function h(K,J,L){if(G.isString(J)){var N=J;J=function(O){return O.text===N}}function M(R){var Q,P,O;if(J(R)){return R}for(Q=0,P=R.children.length;Q<P;Q++){O=M(K.get_node(R.children[Q]));if(O){return O}}return null}return M(L||K.get_node("#"))}return{options:e,init:z,call:C,loadXML:d,saveAndReload:function(J){C("loadXFormOrError",C("createXML"),J)},getMug:m,getInput:E,assertEqual:g,assertInputCount:v,assertXmlEqual:x,assertXmlNotEqual:F,assertJSTreeState:b,assertTreeState:q,xmlines:function(J){return J.replace(/>(\s\s+)</g,">\n$1<")},addQuestion:function(M,L,K){K=K||{};if(this.prevId){i(this.prevId)}var J=C("addQuestion",M);if(L){c(G.isUndefined(K.nodeID),"unexpected attribute for "+M+"["+L+"]");if(J.p.labelItext){J.p.labelItext.set(L)}J.p.nodeID=L}G.each(K,function(O,N){if(!G.isBoolean(O)){O=String(O)}J.p[N]=O});return J},paste:o,clickQuestion:i,selectAll:D,deleteQuestion:t,saveButtonEnabled:l,expandGroup:r,collapseGroup:s,getMessages:B,findNode:h,isTreeNodeValid:function(K){if(G.isString(K)){var L=K;K=m(L);c(K,"mug not found: "+L)}var J=f("#vellum").find("#"+K.ufid+" > a");return J.children(".fd-tree-valid-alert-icon").length===0}}});