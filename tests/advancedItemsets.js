require(["tests/options","tests/utils","chai","jquery","underscore","vellum/itemset","vellum/form","text!static/itemset/test1.xml","text!static/itemset/inner-filters.xml"],function(m,h,g,f,j,b,c,i,e){var a=g.assert,l=h.call,k=h.clickQuestion,d=j.union(h.options.options.plugins||[],["itemset"]);describe("The Advanced Itemset plugin",function(){function n(o){h.init({plugins:d,javaRosa:{langs:["en"]},core:{onReady:o},features:{advanced_itemsets:true}})}before(n);it("adds a new instance node to the form when necessary",function(){h.loadXML(i);var q=h.getMug("question1/itemset");q.p.itemsetData={instance:{id:"somefixture",src:"jr://somefixture"},nodeset:"instance('somefixture')/some/items",labelRef:"label",valueRef:"value",};var o=l("createXML"),p=f(o);a(p.find("instance[id=somefixture]").length,"somefixture instance not found:\n"+o)});it("renames instance on add itemset with matching instance",function(){h.loadXML(i);h.addQuestion("SelectDynamic","select2");var r=h.getMug("select2/itemset");r.p.itemsetData={instance:{id:"cases",src:"jr://instance/casedb"},nodeset:"instance('cases')/cases/case[@case_id > 2]",labelRef:"label",valueRef:"value",};var q=r.p.itemsetData;a.equal(q.instance.id,"casedb");a.equal(q.instance.src,"jr://instance/casedb");a.equal(q.nodeset,"instance('casedb')/cases/case[@case_id > 2]");var o=l("createXML"),p=f(o);a(p.find("instance[id=casedb]").length,"casedb instance not found:\n"+o);a(p.find("instance[id=cases]").length===0,"cases instance should have been renamed/merged:\n"+o)});describe("parsing and serializing",function(){before(n);it("preserves XML with itemsets in <select>s",function(){a(i.indexOf("select1")!==-1);h.loadXML(i);h.assertXmlEqual(l("createXML"),i)});it("preserves XML with itemsets in <select1>s",function(){var o=i.replace(/select1/g,"select");h.loadXML(o);h.assertXmlEqual(l("createXML"),o)})});describe("UI",function(){before(n);it("preserves inner filters if you never change the data source",function(){h.loadXML(e);k("question2/itemset");f("[name='label_ref']").val("dummy").change();h.assertXmlEqual(e.replace("case_name","dummy"),l("createXML"))});it("includes filter when in advanced mode",function(){h.loadXML(i);k("question1/itemset");var o=h.getMug("question1/itemset");o.p.filter="'blah' = /data/question2";f("button:contains(...)").click();a(f("[name=query]").val().indexOf(o.p.filter)>1)});it("changes filter when in advanced mode",function(){h.loadXML(i);k("question1/itemset");var o=h.getMug("question1/itemset");o.p.filter="'blah' = /data/question2";f("button:contains(...)").click();var p=f("[name=query]").val();f("[name=query]").val(p.replace(/question2/,"no_question")).change();f(".fd-data-source-save-button").click();a.strictEqual(f("[name=property-filter]").val(),"'blah' = /data/no_question")})})})});