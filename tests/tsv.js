require(["chai","vellum/tsv"],function(c,d){var b=c.assert;function a(h,f,g){var e=h.replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t");b.deepEqual(d.parseRows(h,f.length+5),f,"parsed '"+e+"'");if(g){b.strictEqual(d.tabDelimit(f),h)}}describe("The TSV parser",function(){it("should parse empty string",function(){a("",[],true)});it("should parse simple TSV",function(){a("a\tb",[["a","b"]],true);a("a\tb\r",[["a","b"]]);a("a\tb\n",[["a","b"]]);a("a\tb\u2028",[["a","b"]]);a("a\tb\u2029",[["a","b"]]);a("a\tb\r\n",[["a","b"]]);a("a\tb\n\r",[["a","b"],[""]])});it("should parse simple mutli-line TSV",function(){a("a\tb\nc",[["a","b"],["c"]],true);a("a\tb\rc\r",[["a","b"],["c"]]);a("a\tb\nc\n",[["a","b"],["c"]]);a("a\tb\u2028c\u2028",[["a","b"],["c"]]);a("a\tb\u2029c\u2029",[["a","b"],["c"]]);a("a\tb\r\nc\r\n",[["a","b"],["c"]]);a("a\tb\n\rc\n",[["a","b"],[""],["c"]])});it("should parse quoted field",function(){a('a\t"b\tc"',[["a","b\tc"]],true);a('"a"\t"b\tc"\r',[["a","b\tc"]]);a('"a"\t"b\tc"\n',[["a","b\tc"]]);a('"a"\t"b\tc"\u2028',[["a","b\tc"]]);a('"a"\t"b\tc"\u2029',[["a","b\tc"]]);a('"a"\t"b\tc"\r\n',[["a","b\tc"]]);a('"a"\t"b\tc"\n\r',[["a","b\tc"],[""]]);a('"a"\t"b\tc"\n"a"\t"b\tc"\n',[["a","b\tc"],["a","b\tc"]])});it("should parse empty quoted field",function(){a('""\t""\n',[["",""]])});it("should parse quoted field with escaped quotes",function(){a('"a""x"\t"b""\t""c"',[['a"x','b"\t"c']],true);a('"a""x"\t"b""""""c"',[['a"x','b"""c']],true);a('"a""x"\t"b""\t""c"\n"a""x"\t"b""\t""c"',[['a"x','b"\t"c'],['a"x','b"\t"c']],true)});it("should parse quoted multi-line field",function(){a('"a""x"\t"b\nc\rd\r\ne"',[['a"x',"b\nc\rd\r\ne"]],true);a('"a""x"\t"b\u2028c\u2029d"',[['a"x',"b\u2028c\u2029d"]],true);a('"a""x"\t"b\nc\rd\r\ne"\n"a""x"\t"b\nc\rd\r\ne"',[['a"x',"b\nc\rd\r\ne"],['a"x',"b\nc\rd\r\ne"]],true)});it("should parse malformed quoted field",function(){a('abc\t"def"ghi\t"jkl',[["abc",'"def"ghi','"jkl']]);a('abc\t"def"ghi"\t"jkl',[["abc",'"def"ghi"','"jkl']]);a('abc\t"def\t"ghi\t"jkl',[["abc",'"def','"ghi','"jkl']])})});describe("The TSV writer",function(){it("should convert null to empty string",function(){b.strictEqual(d.escape(null),"")});it("should convert undefined to empty string",function(){(function(e){b.strictEqual(d.escape(e),"")})()});it("should not convert zero to empty string",function(){b.strictEqual(d.escape(0),"0")});it("should escape special characters",function(){var e=[['""',"\t\t\t","\n\n\n","\r\r\r",""],["  "]],f='""""""\t"\t\t\t"\t"\n\n\n"\t"\r\r\r"\t\n  ';b.strictEqual(d.tabDelimit(e),f);a(f,e,true)})})});