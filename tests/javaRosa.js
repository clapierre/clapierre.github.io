require(["chai","jquery","underscore","tests/utils","vellum/javaRosa","vellum/util","text!static/javaRosa/outputref-group-rename.xml","text!static/javaRosa/text-question.xml","text!static/javaRosa/multi-lang-trans.xml","text!static/javaRosa/multi-line-trans.xml","text!static/javaRosa/output-refs.xml","text!static/javaRosa/outputref-with-inequality.xml","text!static/javaRosa/group-with-constraint.xml","text!static/javaRosa/text-with-constraint.xml","text!static/javaRosa/itext-item-rename.xml","text!static/javaRosa/itext-item-rename-group-move.xml","text!static/javaRosa/itext-item-non-auto-id.xml","text!static/javaRosa/select1-help.xml","text!static/javaRosa/no-label-text-one-lang.xml","text!static/javaRosa/test-xml-1.xml","text!static/javaRosa/test-xml-2.xml","text!static/javaRosa/test-xml-3.xml","text!static/javaRosa/test-xml-4.xml","text!static/javaRosa/non-default-lang-first.xml"],function(d,j,z,c,q,v,a,i,b,p,r,m,y,x,f,t,o,n,u,l,k,h,g,s){var e=d.assert,w=c.call;describe("The javaRosa plugin with multiple languages",function(){before(function(A){c.init({javaRosa:{langs:["en"]},core:{onReady:function(){A()}}})});describe("and non default language is first",function(){before(function(A){c.init({javaRosa:{langs:["en"]},core:{onReady:function(){A()}}})});it("should load xml",function(){c.loadXML(s)})});it("should not show itext errors when there is text in any language",function(A){c.loadXML(l);j("textarea[name=itext-en-constraintMsg]").val("").change();c.saveAndReload(function(){var B=j(".alert-block");e.equal(B.length,0,B.text());A()})});it("should show warning on load for with unknown language",function(){c.loadXML(h,null,/You have languages in your form/);var B=j(".alert-block"),A=B.text();e.equal(B.length,1,A);e(A.indexOf("You have languages in your form that are not specified")>-1,A);e(A.indexOf("page: es.")>-1,A)});it("should preserve itext values on load + save",function(){c.loadXML("");c.addQuestion("Text","question1");j(".btn:contains(image)").click();j(".btn:contains(audio)").click();j(".btn:contains(video)").click();j(".btn:contains(long)").click();j(".btn:contains(short)").click();j(".btn:contains(custom)").click();j(".fd-modal-generic-container").find("input").val("custom");j(".fd-modal-generic-container").find(".btn:contains(Add)").click();j("[name='itext-en-label']").val("question1 en label").change();j("[name='itext-hin-label']").val("question1 hin label").change();j("[name='itext-en-constraintMsg']").val("question1 en validation").change();j("[name='itext-hin-constraintMsg']").val("question1 hin validation").change();j("[name='itext-en-hint']").val("question1 en hint").change();j("[name='itext-hin-hint']").val("question1 hin hint").change();j("[name='itext-en-help']").val("question1 en help").change();j("[name='itext-hin-help']").val("question1 hin help").change();j("[name='itext-en-label-long']").val("question1 en long").change();j("[name='itext-hin-label-long']").val("question1 hin long").change();j("[name='itext-en-label-short']").val("question1 en short").change();j("[name='itext-hin-label-short']").val("question1 hin short").change();j("[name='itext-en-label-custom']").val("question1 en custom").change();j("[name='itext-hin-label-custom']").val("question1 hin custom").change();c.assertXmlEqual(w("createXML"),c.xmlines(k),{normalize_xmlns:true})});it("itext widget should change as default language value changes when equal",function(){c.loadXML(l);c.addQuestion("Text","temp");c.clickQuestion("question1");var A=j("[name='itext-en-label']"),B=j("[name='itext-hin-label']");A.val("English").change();e.equal(A.val(),"English");e.equal(B.val(),"English");c.clickQuestion("temp");c.clickQuestion("question1");A=j("[name='itext-en-label']");B=j("[name='itext-hin-label']");e.equal(A.val(),"English");e.equal(B.val(),"English")});it("itext widget should be blank when empty",function(){c.loadXML(l);c.addQuestion("Text","temp");c.clickQuestion("question1");var A=j("[name='itext-en-label']"),B=j("[name='itext-hin-label']");A.val("").change();e.equal(A.val(),"");e.equal(B.val(),"");c.clickQuestion("temp");c.clickQuestion("question1");A=j("[name='itext-en-label']");B=j("[name='itext-hin-label']");e.equal(A.val(),"");e.equal(B.val(),"")});it("non-labelItext widget should allow non default language to be blank",function(){c.loadXML(x);c.clickQuestion("text");var B=j("[name='itext-en-constraintMsg']"),A=j("[name='itext-hin-constraintMsg']");A.val("").change();e.equal(B.val(),"English");e.equal(A.val(),"");B.val("").change();e.equal(B.val(),"");e.equal(A.val(),"")});it("should display correct language for question that was collapsed when language changed",function(){c.loadXML("");var A=c.addQuestion("Group","group");c.addQuestion("Text","question2");c.clickQuestion("group/question2");j("[name='itext-en-label']").val("english").change();j("[name='itext-hin-label']").val("hindi").change();c.collapseGroup(A);e.equal(j(".fd-question-tree .jstree-anchor").length,1);j(".fd-question-tree-display").val("hin").change();c.expandGroup(A);e.equal(j(".fd-question-tree .jstree-anchor:last").text(),"hindi")});it("itext widget should not overwrite label with question id",function(){c.loadXML("");var B=c.addQuestion("Text");c.addQuestion("Text");c.clickQuestion("question1");j("[name='itext-en-label']").val("English").change();B.p.nodeID="newid";c.clickQuestion("question2");c.clickQuestion("newid");var A=j("[name='itext-en-label']"),C=j("[name='itext-hin-label']");e.equal(A.val(),"English");e.equal(C.val(),"English")});it("tree should note when default language is being displayed instead of selected language",function(){c.loadXML("");c.addQuestion("Text","question1");c.clickQuestion("question1");j("[name='itext-en-label']").val("english").change();var A=".fd-question-tree .jstree-anchor";e.equal(j(A).text(),"english");j(".fd-question-tree-display").val("hin").change();e.equal(j(A).text(),"english [en]");j("[name='itext-hin-label']").val("hindi").change();e.equal(j(A).text(),"hindi")});it("non-labelItext widget should contain value on load",function(){c.loadXML(x);c.clickQuestion("text");e.equal(j("[name='itext-en-constraintMsg']").val(),"English");e.equal(j("[name='itext-hin-constraintMsg']").val(),"Hindi")});it("should enable save button on itext label change",function(){c.loadXML(i);c.saveButtonEnabled(false);c.clickQuestion("question1");e(!c.saveButtonEnabled(),"click should not cause change");j("[name='itext-en-label']").val("new").change();e(c.saveButtonEnabled(),"save button is disabled")});it("should enable save button on itext constraintMsg change",function(){c.loadXML(i);c.saveButtonEnabled(false);c.clickQuestion("question1");e(!c.saveButtonEnabled(),"click should not cause change");j("[name='itext-hin-constraintMsg']").val("new").change();e(c.saveButtonEnabled(),"save button is disabled")});it("should update output refs when question ids change",function(){c.loadXML("");c.addQuestion("Text","question1");c.addQuestion("Text","question2");j("[name='itext-en-label']").val('<output value="/data/question1" /> a <output value="/data/question1"/> b <output value="/data/question1"></output> c <output value="/data/question1" ></output> d <output value="if(/data/question1 = \'\', \'\', format-date(date(/data/question1), \'%a%b%c\'))" />').change();j("[name='itext-hin-label']").val('<output value="/data/question1"></output>').change();c.clickQuestion("question1");j("[name='property-nodeID']").val("first_question").change();c.assertXmlEqual(w("createXML"),c.xmlines(g),{normalize_xmlns:true})});it("should only update exact output ref matches when question ids change",function(){c.loadXML("");c.addQuestion("Text","question1");c.addQuestion("Text","question2");j("[name='itext-en-label']").val('<output value="/data/question1" /> <output value="/data/question11" /> <output value="/data/question1/b" /> <output value="/data/question1b" /> ').change();j("[name='itext-hin-label']").val("question2").change();c.clickQuestion("question1");j("[name='property-nodeID']").val("first_question").change();c.assertXmlEqual(w("createXML"),r,{normalize_xmlns:true})});it("should escape inequality operators in output ref",function(){c.loadXML(m);var A=c.getMug("product");e.equal(A.p.labelItext.get(),"<output value=\"if(1 < 2 or 2 > 3 or 3 <= 3 or 4 >= 5, 'product', 'other')\"/>");c.assertXmlEqual(w("createXML"),m,{normalize_xmlns:true})});it("should only update exact output ref matches when question ids change (word boundary)",function(){c.loadXML("");c.addQuestion("Text","load-one");var A=c.addQuestion("Trigger","label"),B=c.addQuestion("Text","text2");A.p.labelItext.set('<output value="/data/load-one" />');B.p.nodeID="load";B.p.nodeID="load-two";e.equal(A.p.labelItext.get(),'<output value="/data/load-one" />')});it("itext changes do not bleed back after copy",function(){c.loadXML("");var A=c.addQuestion("Text","question"),B=A.form.duplicateMug(A);B.p.labelItext.set("q2");c.saveAndReload(function(){var C=w("getMugByPath","/data/question");e.equal(C.p.labelItext.defaultValue(),"question")})});it("itext changes do not bleed back from copy of copy",function(){c.loadXML("");var A=c.addQuestion("Text","question"),C=A.form.duplicateMug(A),B=A.form.duplicateMug(C);B.p.labelItext.set("copy");c.saveAndReload(function(){var D=w("getMugByPath","/data/question"),F=w("getMugByPath","/data/copy-1-of-question"),E=w("getMugByPath","/data/copy-2-of-question");e.equal(D.p.labelItext.defaultValue(),"question");e.equal(F.p.labelItext.defaultValue(),"question");e.equal(E.p.labelItext.defaultValue(),"copy")})});it("drag question into label makes output ref in correct position",function(){c.loadXML("");var D=c.addQuestion("Text","question1"),C=c.addQuestion("Text","question2");var A=j("[name='itext-en-label']");A.val("test string").change();v.setCaretPosition(A[0],4);w("handleDropFinish",A,D.absolutePath,D);var B=C.p.labelItext.get("default","en");e.equal(B,'test<output value="/data/question1" /> string')});it("output ref deleted with single backspace",function(){c.loadXML("");var A=c.addQuestion("Text","question1");var B=j("[name='itext-en-label']");B.val('question1 <output value="/data/question2" /> end').change();v.setCaretPosition(B[0],44);B.trigger({type:"keydown",which:8,ctrlKey:false});B.change();var C=A.p.labelItext.get("default","en");e.equal(C,"question1  end")});it("output ref deleted with single delete keypress",function(){c.loadXML("");var A=c.addQuestion("Text","question1");var B=j("[name='itext-en-label']");B.val('question1 <output value="/data/question2" /> end').change();v.setCaretPosition(B[0],10);B.trigger({type:"keydown",which:46,ctrlKey:false});B.change();var C=A.p.labelItext.get("default","en");e.equal(C,"question1  end")});it("should update output ref on group rename",function(){c.loadXML(a);var C=c.call("getMugByPath","/data/question2"),A=c.call("getMugByPath","/data/question1"),B=A.p.labelItext;e(B.get().indexOf('"/data/question2/question3"')>0,'"/data/question2/question3" not in '+B.get());C.p.nodeID="group";e(B.get("default","en").indexOf('"/data/group/question3"')>0,'"/data/group/question3" not in '+B.get("default","en"));e(B.get("default","hin").indexOf('"/data/group/question3"')>0,'"/data/group/question3" not in '+B.get("default","hin"))});it("should add warning on add Audio output ref to itext",function(){c.loadXML("");var A=c.addQuestion("Audio","audio"),C=c.addQuestion("Text","text"),B=j("[name='itext-en-label']");w("handleDropFinish",B,A.ufid,A);d.expect(c.getMessages(C)).to.include("Audio Capture nodes cannot be used in an output value")});it("should bulk update multi-line translation",function(){var C=c.loadXML(i),D=c.call("getData").javaRosa.Itext,B=('label\tdefault-en\tdefault-hin\nquestion1-label\t"First ""line\nSecond"" line\nThird line"\tHindu trans\n');q.parseXLSItext(C,B,D);var A=c.getMug("question1");e.equal(A.p.labelItext.get("default","en"),'First "line\nSecond" line\nThird line');e.equal(A.p.labelItext.get("default","hin"),"Hindu trans")});it("should not get stuck on bulk update non-existent questions",function(){var B=c.loadXML(""),C=c.call("getData").javaRosa.Itext,A=("label\tdefault-en\tdefault-hin\nquestion1-label\tlabel\tHindu trans\n");q.parseXLSItext(B,A,C);e(!c.getMug("question1"),"question1 should not exist")});it("should generate bulk multi-line translation with user-friendly newlines",function(){var A=c.loadXML(p),B=c.call("getData").javaRosa.Itext;e.equal(q.generateItextXLS(A,B),'label\tdefault_en\tdefault_hin\taudio_en\taudio_hin\timage_en\timage_hin\tvideo_en\tvideo_hin\nquestion1-label\t"First ""line\nSecond"" line\nThird line"\tHindu trans\t\t\t\t\t\t')});it("should escape all languages when generating bulk translations",function(){var A=c.loadXML(b),B=c.call("getData").javaRosa.Itext;e.equal(q.generateItextXLS(A,B),'label\tdefault_en\tdefault_hin\taudio_en\taudio_hin\timage_en\timage_hin\tvideo_en\tvideo_hin\ntext-label\t"""Text"\t"""Text"\t\t\t\t\t\t')});it("bulk translation tool should not create empty itext forms",function(){var C=c.loadXML(i),D=c.call("getData").javaRosa.Itext,B=('label\tdefault-en\tdefault-hin\taudio-en\taudio-hin\nquestion1-label\t"First ""line\nSecond"" line\nThird line"\t\t\t\n');q.parseXLSItext(C,B,D);var A=c.getMug("question1");e.equal(A.p.labelItext.get("default","en"),'First "line\nSecond" line\nThird line');e.equal(A.p.labelItext.get("default","hin"),"");e(!A.p.labelItext.hasForm("audio"),"unexpected form: audio")});it("bulk translation tool should enable the save button on update",function(){var B=c.loadXML(i);c.saveButtonEnabled(false);var C=c.call("getData").javaRosa.Itext,A=('label\tdefault-en\tdefault-hin\taudio-en\taudio-hin\nquestion1-label\t"First ""line\nSecond"" line\nThird line"\t\t\t\n');q.parseXLSItext(B,A,C);e(c.saveButtonEnabled(),"save button not enabled")});it("should highlight label after tab",function(){c.loadXML(h,null,/You have languages in your form/);c.clickQuestion("question1");var A=j("[name='itext-en-label']"),B=j("[name='itext-hin-label']");A.val("test string").change();A.focus();B.val("hin test string").change();B.focus();e.equal(A[0].selectionStart,0);e.equal(A[0].selectionEnd,11);e.equal(B[0].selectionStart,0);e.equal(B[0].selectionEnd,15)});it("should not create duplicate <help> node on select",function(){c.loadXML(n);var A=w("createXML"),B=j(A);e.strictEqual(B.find("help").length,1,"wrong <help> node count\n"+A)});it("should rename itext item ID after move",function(){c.loadXML("");c.addQuestion("Select","ns");c.addQuestion("Select","ew");var B=c.getMug("ns/item1"),A=c.getMug("ew/item1");B.p.nodeID="north";A.p.nodeID="south";B.form.moveMug(A,"after",B);c.assertXmlEqual(c.call("createXML"),f,{normalize_xmlns:true})});it("should rename group's child itext item IDs after move group",function(){c.loadXML("");var B=c.addQuestion("Group","green"),A=c.addQuestion("Group","blue");c.addQuestion("Text","text");A.form.moveMug(A,"before",B);c.assertXmlEqual(c.call("createXML"),t,{normalize_xmlns:true})});it("should not auto-update itext ID when multiple questions point to auto-ish-id",function(){c.loadXML(o);var C=c.getMug("north");C.p.nodeID="west";var A=w("createXML"),B=j(A);e.strictEqual(B.find("text#north-label").length,2,"wrong <text> node count\n"+A)});it("should unlink auto itext id from other questions with shared itext",function(){c.loadXML(o);e.equal(j(o).find("text#south-label").length,0,"wrong <text#south> node count\n"+o);c.clickQuestion("south");var B=j("[name='property-labelItext']").closest(".control-group"),A=B.find("input[type=checkbox]");A.prop("checked",true).change();j("[name='itext-en-label']").val("south").change();e.equal(c.getMug("north").p.labelItext.get(),"north");e.equal(c.getMug("south").p.labelItext.get(),"south");var C=w("createXML"),D=j(C);e.equal(D.find("text#north-label").length,2,"wrong <text#north> node count\n"+C);e.equal(D.find("text#south-label").length,2,"wrong <text#south> node count\n"+C)});z.each(["hint","help","constraintMsg"],function(A){it("should not serialize empty "+A+" itext item with non-empty id and autoId = true",function(){c.loadXML("");var C=c.addQuestion("Text"),B=C.p[A+"Itext"];B.id=A;B.autoId=true;var D=w("createXML"),E=j(D);if(A==="constraintMsg"){e.strictEqual(E.find("[jr\\:"+A+"]").length,0,"wrong "+A+" count\n"+D)}else{e.strictEqual(E.find(A).length,0,"wrong <"+A+"> node count\n"+D)}})});it("should not allow apostrophes in item labels",function(){c.loadXML("");c.addQuestion("Select","select");c.clickQuestion("select/item1");j("[name='property-nodeID']").val("blah ' blah").change();e.strictEqual(j("[name='property-labelItext']").val(),"select-blah___blah-labelItext")});it("should not change with node id when blank",function(){c.loadXML("");c.addQuestion("Text","text");c.clickQuestion("text");j("[name=itext-en-label]").val("").change();j("[name=itext-hin-label]").val("").change();j("[name=property-nodeID]").val("nodeid").change();e.strictEqual(j("[name=itext-en-label]").val(),"");e.strictEqual(j("[name=itext-hin-label]").val(),"")})});describe("The javaRosaplugin with one language",function(){before(function(A){c.init({javaRosa:{langs:["en"]},core:{onReady:function(){A()}}})});it("should allow a value to be blank",function(){c.loadXML("");c.addQuestion("Trigger","label");c.clickQuestion("label");j("[name=itext-en-label]").val("blah").change();j(".itext-block-label-add-form-image").click();j("[name=itext-en-label]").val("").change();c.assertXmlEqual(w("createXML"),u,{normalize_xmlns:true})})});describe("The javaRosa plugin itext widgets",function(){before(function(C){c.init({javaRosa:{langs:["en"]},core:{onReady:function(){var D=c.loadXML(""),E=D.vellum.data.javaRosa.Itext;A=c.addQuestion("Text");q.parseXLSItext(D,"",E);C()}}})});var A;function B(C){it("should not display "+C+" validation error for autoId itext",function(){var D=A.p[C],E=A.spec[C],F=D.id;D.autoId=true;e(D.id,C+".id should have a value");e.equal(E.validationFunc(A),"pass");D.id="";try{e.equal(E.validationFunc(A),"pass")}finally{D.id=F}});it("should display "+C+" validation error for non-autoId non-empty itext with blank ID",function(){var D=A.p[C],E=A.spec[C],F=[D.id,D.get()];D.autoId=false;D.id="";D.set("not empty");try{e.notEqual(E.validationFunc(A),"pass",C)}finally{D.id=F[0];D.set(F[1])}});it("should not display "+C+" validation error for non-autoId empty itext with blank ID",function(){var D=A.p[C],E=A.spec[C],F=[D.id,D.get()];D.autoId=false;D.id="";D.set("");try{e.equal(E.validationFunc(A),"pass")}finally{D.id=F[0];D.set(F[1])}});it("should not display "+C+" validation error for non-autoId valid itext id",function(){var D=A.p[C],E=A.spec[C],F=[D.id,D.get(),A.p.constraintAttr];if(C==="constraintMsgItext"){A.p.constraintAttr="x = y"}D.autoId=false;D.id="node-id-label-itext";D.set("node-id-label-itext");try{e.equal(E.validationFunc(A),"pass")}finally{D.id=F[0];D.set(F[1]);A.p.constraintAttr=F[2]}});it("should display "+C+" validation error for non-autoId invalid itext id",function(){var D=A.p[C],E=A.spec[C],F=[D.id,D.get(),A.p.constraintAttr];if(C==="constraintMsgItext"){A.p.constraintAttr="x = y"}D.autoId=false;D.id="node-id-label-itext'&";D.set("node-id-label-itext'&");try{e.notEqual(E.validationFunc(A),"pass",C)}finally{D.id=F[0];D.set(F[1]);A.p.constraintAttr=F[2]}});it("should not have "+C+"ID validator (it will not be invoked)",function(){e(!A.spec[C+"ID"].validationFunc,C+"ID virtual property validator will not be invoked")})}B("labelItext");B("hintItext");B("helpItext");B("constraintMsgItext");it("should display constraintMsgItext validation error for non-autoId itext without validation condition",function(){var C=A.p.constraintMsgItext,D=A.spec.constraintMsgItext,E=A.p.constraintAttr;C.autoId=false;A.p.constraintAttr="";try{e(C.id,"constraintMsgItext.id should have a value");e.equal(D.validationFunc(A),"Can't have a Validation Message Itext ID without a Validation Condition")}finally{A.p.constraintAttr=E}});it("should not display constraintMsgItext validation error for autoId itext with validation condition",function(){var C=A.p.constraintMsgItext,D=A.spec.constraintMsgItext,E=A.p.constraintAttr;C.autoId=true;A.p.constraintAttr="x = y";try{e.equal(D.validationFunc(A),"pass")}finally{A.p.constraintAttr=E}});it("should show and hide the validation message as appropriate",function(){c.loadXML(y);j("[name='property-constraintAttr']").val("true()").change();j("[name='itext-en-constraintMsg']").val("This is not possible").change();e(j("[name='itext-en-constraintMsg']").is(":visible"));j("[name='itext-en-constraintMsg']").val("").change();j("[name='property-constraintAttr']").val("").change();e(!j("[name='itext-en-constraintMsg']").is(":visible"))});it("should show a validation error when dropping a self reference",function(){c.loadXML("");var C=c.addQuestion("Text","question1"),D="itext-en-label";c.clickQuestion("question1");e.deepEqual(C.messages.get(D),[]);C.form.vellum.handleDropFinish(j("[name="+D+"]"),".",C);e.equal(C.messages.get(D).length,1,c.getMessages(C));C.dropMessage(D,"core-circular-reference-warning");e.deepEqual(C.messages.get(D),[])})});describe("The javaRosa plugin language selector",function(){before(function(A){c.init({javaRosa:{langs:["en"]},core:{onReady:A}})});it("should have option to display IDs",function(){c.loadXML("");c.addQuestion("Text","question1");c.clickQuestion("question1");var B=j(".fd-question-tree-display");var A=".fd-question-tree .jstree-anchor";j("[name='itext-en-label']").val("x").change();e.equal(j(A).text(),"x");j("[name='itext-en-label']").val("").change();e.equal(j(A).text(),"question1");B.val("en").change();j("[name='itext-en-label']").val("english").change();e.equal(j(A).text(),"english");B.val("_ids").change();e.equal(j(A).text(),"question1")})})});