require(["tests/options","tests/utils","chai","jquery","underscore","vellum/databrowser","vellum/datasources",],function(j,f,e,d,i,h,c){var a=e.assert,b=i.union(f.options.options.plugins||[],["databrowser"]),g=[{id:"commcaresession",uri:"jr://instance/session",path:"/session/data",name:"Session",structure:{case_id:{reference:{source:"casedb",subset:"child",key:"@case_id",},},},},{id:"casedb",uri:"jr://instance/casedb",path:"/cases/case",name:"Cases",structure:{name:{},},subsets:[{id:"mother",key:"@case_type",structure:{edd:{},},related:{"first-child":"child",}},{id:"child",key:"@case_type",structure:{dob:{},},related:{parent:"mother",},}],}];describe("The data browser",function(){var l;before(function(m){f.init({plugins:b,javaRosa:{langs:["en"]},core:{dataSourcesEndpoint:function(n){n(g)},onReady:function(){var n=this;c.getDataSources(function(){h.initDataBrowser(n);l=n.$f.find(".fd-external-sources-tree").jstree(true);m()})}}})});function k(m,o){var n=i.find(m.instanceMetadata,function(p){return p.attributes.src===o});return n?n.attributes.id:null}it("should add ref on drag/drop",function(){f.loadXML("");var o=f.addQuestion("DataBindOnly","mug"),q=d("[name=property-calculateAttr]"),n=g[0].uri,m=g[1].uri,p="@case_id=instance('commcaresession')/session/data/case_id";a.equal(k(o.form,n),null);a.equal(k(o.form,m),null);a.equal(q.length,1);f.findNode(l,"dob").data.handleDrop(q);a.equal(o.p.calculateAttr,"instance('casedb')/cases/case["+p+"]/dob");a.equal(k(o.form,n),"commcaresession");a.equal(k(o.form,m),"casedb")});it("should add parent ref on drag/drop",function(){f.loadXML("");var o=f.addQuestion("DataBindOnly","mug"),p=d("[name=property-calculateAttr]"),n=g[0].uri,m=g[1].uri,q="@case_id=instance('commcaresession')/session/data/case_id",r="@case_id=instance('casedb')/cases/case["+q+"]/index/parent";a.equal(k(o.form,n),null);a.equal(k(o.form,m),null);a.equal(p.length,1);f.findNode(l,"edd").data.handleDrop(p);a.equal(o.p.calculateAttr,"instance('casedb')/cases/case["+r+"]/edd");a.equal(k(o.form,n),"commcaresession");a.equal(k(o.form,m),"casedb")});it("should add recursive ref on drag/drop",function(){f.loadXML("");var o=f.addQuestion("DataBindOnly","mug"),p=d("[name=property-calculateAttr]"),n=g[0].uri,m=g[1].uri,r="@case_id=instance('commcaresession')/session/data/case_id",t="@case_id=instance('casedb')/cases/case["+r+"]/index/parent",s="@case_id=instance('casedb')/cases/case["+t+"]/index/first-child";a.equal(k(o.form,n),null);a.equal(k(o.form,m),null);a.equal(p.length,1);var q=f.findNode(l,"first-child (child)");l.open_node(q);f.findNode(l,"dob",q).data.handleDrop(p);a.equal(o.p.calculateAttr,"instance('casedb')/cases/case["+s+"]/dob");a.equal(k(o.form,n),"commcaresession");a.equal(k(o.form,m),"casedb")})})});