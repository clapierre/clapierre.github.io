require(["chai","jquery","underscore","tests/utils","text!static/modeliteration/case-list-iteration.xml","text!static/modeliteration/case-list-iteration-with-questions.xml","text!static/modeliteration/fixture-iteration.xml","text!static/modeliteration/regular-repeat.xml","tests/modeliteration"],function(g,f,k,h,j,b,e,i){var a=g.assert,l=h.call,d=h.options.options.plugins||[],c=k.union(d,["modeliteration"]);describe("The model iteration plugin",function(){before(function(m){h.init({plugins:c,javaRosa:{langs:["en"]},core:{onReady:function(){a(this.isPluginEnabled("modeliteration"),"modeliteration plugin should be enabled");m()}}})});it("should load a case list repeat",function(){h.loadXML(j);var m=h.getMug("child/item");a.deepEqual(m.p.dataSource,{instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"});h.assertXmlEqual(l("createXML"),j)});it("should load a case list repeat with questions",function(){h.loadXML(b);h.assertJSTreeState("group","  phone","  hidden");var o=h.getMug("group/item"),m=h.getMug("group/item/phone"),n=h.getMug("group/item/hidden");a.deepEqual(o.p.dataSource,{instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"});a.equal(m.__className,"PhoneNumber");a.equal(n.p.calculateAttr,"/data/group/item/phone = '12345'");h.assertXmlEqual(l("createXML"),b)});it("should create a case list repeat",function(){h.loadXML("");var m=h.addQuestion("Repeat","child");m.p.dataSource={instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"};h.assertXmlEqual(l("createXML"),j,{normalize_xmlns:true})});it("should create a case list repeat with questions",function(){h.loadXML("");var n=h.addQuestion("Repeat","group");n.p.dataSource={instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"};h.addQuestion("PhoneNumber","phone");var m=h.addQuestion("DataBindOnly","hidden");m.p.calculateAttr="/data/group/item/phone = '12345'";h.assertXmlEqual(l("createXML"),b,{normalize_xmlns:true})});it("should load a fixture repeat",function(){h.loadXML(e);var m=h.getMug("product/item");a.deepEqual(m.p.dataSource,{instance:{id:"products",src:"jr://fixture/commtrack:products"},idsQuery:"instance('products')/products/product/@id"});h.assertXmlEqual(l("createXML"),e)});it("should create a fixture repeat",function(){h.loadXML("");var m=h.addQuestion("Repeat","product");m.p.dataSource={instance:{id:"products",src:"jr://fixture/commtrack:products"},idsQuery:"instance('products')/products/product/@id"};h.assertXmlEqual(l("createXML"),e,{normalize_xmlns:true})});it("should convert fixture repeat to regular repeat when data source is removed",function(){h.loadXML(e);var m=h.getMug("product/item");m.p.dataSource={};m.p.repeat_count="";h.assertXmlEqual(l("createXML"),i)});it("should create a fixture repeat containing a text input",function(){h.loadXML("");var m=h.addQuestion("Repeat","product");m.p.dataSource={instance:{id:"products",src:"jr://fixture/commtrack:products"},idsQuery:"instance('products')/products/product/@id"};h.addQuestion("Text","text");h.assertJSTreeState("product","  text")});it("should change a fixture repeat to a case list repeat",function(){h.loadXML(e);var m=h.getMug("product/item");m.p.dataSource={instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"};h.assertXmlEqual(l("createXML").replace(/product/g,"child"),j)});it("should not remove instance when ignore/retain is active",function(){var o='<bind nodeset="/data/product/item" />',p='<bind nodeset="/data/product/item" wierd="true()" vellum:ignore="retain" />',m=e.replace(o,o+p);a(m.indexOf(p)>0,p+" not found in XML:\n\n"+m);h.loadXML(m);var n=h.getMug("product/item");n.p.dataSource={};n.p.repeat_count="";m=l("createXML");a(f(m).find("instance[id=products]").length===1,"products instance not found in XML\n\n"+m)});it("should not write duplicate <setvalue> nodes after rename",function(){h.loadXML("");var o=h.addQuestion("Repeat","product");o.p.dataSource={instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"};var m=l("createXML"),n=f(m).find("setvalue").length;o.p.nodeID="group";m=l("createXML");a.equal(f(m).find("setvalue").length,n,"wrong number of <setvalue> nodes\n\n"+m)});it("should drop setvalue nodes on delete model repeat",function(){h.loadXML(e);h.deleteQuestion("product/item");var m=l("createXML");a.equal(f(m).find("setvalue").length,0,"wrong number of <setvalue> nodes\n\n"+m)});it("should update expressions on set data source",function(){h.loadXML("");var q=h.addQuestion("Repeat","product"),m=h.addQuestion("Text","blue"),r=h.addQuestion("Text","text"),n=m.form.getAbsolutePath.bind(m.form);a.equal(n(m),"/data/product/blue");a.equal(n(r),"/data/product/text");r.p.calculateAttr=n(m);m.p.labelItext.set('<output value="'+n(r)+'"/>');q.p.dataSource={instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"};var p=f(l("createXML"));a.equal(n(m),"/data/product/item/blue");a.equal(n(r),"/data/product/item/text");var o=p.find("bind[nodeset='"+n(r)+"']");a.equal(o.attr("calculate"),"/data/product/item/blue",o.attr("nodeset")+" calculate expression mismatch");a.equal(p.find("output:first").attr("value"),"/data/product/item/text","output value mismatch");var s=k.flatten(k.map([m,r],function(t){return t.getErrors()}));a(!s.length,s.join("\n"))});it("should update expressions on clear data source",function(){h.loadXML("");var q=h.addQuestion("Repeat","product");q.p.dataSource={instance:{id:"casedb",src:"jr://instance/casedb"},idsQuery:"instance('casedb')/mother/child/@case_id"};var m=h.addQuestion("Text","blue"),r=h.addQuestion("Text","text"),n=m.form.getAbsolutePath.bind(m.form);r.p.calculateAttr=n(m);m.p.labelItext.set('<output value="'+n(r)+'"/>');a.equal(n(m),"/data/product/item/blue");a.equal(n(r),"/data/product/item/text");q.p.dataSource={};a.equal(n(m),"/data/product/blue");a.equal(n(r),"/data/product/text");var p=f(l("createXML")),o=p.find("bind[nodeset='"+n(r)+"']");a.equal(o.attr("calculate"),"/data/product/blue",o.attr("nodeset")+" calculate expression mismatch");a.equal(p.find("output:first").attr("value"),"/data/product/text","output value mismatch");var s=k.flatten(k.map([m,r],function(t){return t.getErrors()}));a(!s.length,s.join("\n"))});it("should show repeat count for regular repeat",function(){h.loadXML(i);h.clickQuestion("product");a.equal(f("[name=property-repeat_count]").length,1,"repeat count should be visible for regular repeat")});it("should hide repeat count for model repeat",function(){h.loadXML(e);h.clickQuestion("product/item");a.equal(f("[name=property-repeat_count]").length,0,"repeat count should not be visible for model repeat")});it("should change instance name when editing its sole reference",function(){h.loadXML(e);var m=h.getMug("product/item");a.equal(m.p.dataSource.instance.id,"products");m.p.dataSource={instance:{id:"new-name",src:"jr://fixture/commtrack:products"},idsQuery:"instance('new-name')/products/product/@id"};a.deepEqual(m.p.dataSource,{instance:{id:"new-name",src:"jr://fixture/commtrack:products"},idsQuery:"instance('new-name')/products/product/@id"})});it("should change instance when idsQuery changes",function(){var o=h.loadXML(e),p=h.getMug("product/item");o.updateKnownInstances({foo:"jr://foo"});p.p.dataSource={idsQuery:"instance('foo')/products/product/@id"};var m=l("createXML"),n=f(m);a(n.find("instance[id=foo]").length,"foo instance not found:\n"+m);a.equal(n.find("instance[id=products]").length,0,"somefixture instance not found:\n"+m)});it("should sync instance name with existing instance",function(){h.loadXML(e);var n=h.getMug("product/item"),m=h.addQuestion("Repeat","product2");m.p.dataSource={instance:{id:"products",src:"jr://fixture/commtrack:products"},idsQuery:"instance('products')/products/product/@id"};a.equal(n.p.dataSource.instance.id,"products");a.equal(m.p.dataSource.instance.id,"products");n.p.dataSource={instance:{id:"new-name",src:"jr://fixture/commtrack:products"},idsQuery:"instance('new-name')/products/product/@id"};a.deepEqual(n.p.dataSource,{instance:{id:"products",src:"jr://fixture/commtrack:products"},idsQuery:"instance('products')/products/product/@id"})})})});