define(["tpl!vellum/templates/widget_control_keyvalue","tpl!vellum/templates/widget_control_message","underscore","jquery","vellum/util"],function(m,t,u,f,a){var g=function(x,y){var z={};z.options=y;z.mug=x;z.id=y.id;a.eventuality(z);z.isDisabled=function(){if(!z.path){return false}return x.form.vellum.isPropertyLocked(x.absolutePath,z.path)};z.getDisplayName=function(){return this.definition.lstring?this.definition.lstring:this.path};z.getControl=function(){throw ("must be overridden")};z.setValue=function(A){};z.getValue=function(){};z.getHelp=function(){if(this.definition&&this.definition.help){return{text:this.definition.help,url:this.definition.helpURL}}return null};z.refreshMessages=function(){};z.handleChange=function(){z.updateValue();if(z.path){x.validate(z.path)}z.fire("change")};z.updateValue=function(){z.save()};z.save=function(){throw"Not Implemented"};z.getUIElement=function(){return k(z.getControl(),z.getDisplayName(),!!z.isDisabled(),z.getHelp())};z.addInstanceRef=function(A,B){if(!B){B=z.path;if(!B){throw new Error("widget has no path: "+z)}}return x.form.addInstanceIfNotExists(A,x,B)};return z};var v=function(y,z){var C=z.widgetValuePath||z.path,x=z.id||"property-"+C,A=z.disabled||false,B=g(y,z);B.mugValue=z.mugValue||function(D,E){if(arguments.length===1){return D.p[C]}D.p[C]=E};B.path=C;B.definition=y.p.getDefinition(z.path);B.currentValue=B.mugValue(y);B.id=x;B.saving=false;B.input=f("<input />").attr("name",x).attr("id",x).prop("disabled",A);B.getControl=function(){return B.input};B.getMessagesContainer=function(){return B.getControl().closest(".widget.control-group").find(".messages:last")};B.getMessages=function(D,E){return p(D,E)};B.refreshMessages=function(){B.getMessagesContainer().empty().append(B.getMessages(y,C))};y.on("messages-changed",function(){B.refreshMessages()},null,"teardown-mug-properties");B.save=function(){B.saving=true;try{B.mugValue(y,B.getValue())}finally{B.saving=false}};return B};var i=function(y,z){var A=v(y,z),x=A.input;x.attr("type","text").addClass("input-block-level");if(z.placeholder){x.attr("placeholder",z.placeholder)}A.setValue=function(C){if(C){C=C.replace(/\n/g,"&#10;")}var B=a.getCaretPosition(x[0]);var D=x.val();x.val(C);if(x.is(":focus")&&D.length===C.length){a.setCaretPosition(x[0],B,B)}};A.getValue=function(){return x.val().replace(/&#10;/g,"\n")};x.bind("change input",function(){A.handleChange()});return A};var o=function(x,y){var z=v(x,y);z.input=f("<textarea></textarea>").attr("name",z.id).attr("id",z.id).attr("rows","2").addClass("input-block-level").on("change input",function(A){z.handleChange()}).focus(function(){this.select()}).keyup(function(A){if(A.which===9){this.select()}});z.getControl=function(){return z.input};z.setValue=function(A){z.input.val(A)};z.getValue=function(){return z.input.val()};return z};var e=function(x,y){var A=i(x,y),z=A.updateValue;A.updateValue=function(){var B=A.getValue();if(B.indexOf(" ")!==-1){A.setValue(B.replace(/\s/g,"_"))}if(B===""){return}z()};x.on("property-changed",function(B){if(B.property==="conflictedNodeId"&&!A.saving){A.setValue(A.mugValue(x))}},null,"teardown-mug-properties");return A};var l=function(x,y){var z=i(x,y);z.input.addClass("jstree-drop").attr("placeholder","Hint: drag a question here.").change(function(){z.handleChange()});return z};l.hasLogicReferences=true;var j=function(y,z){var A=v(y,z),x=A.input;x.attr("type","checkbox");A.setValue=function(B){x.prop("checked",B)};A.getValue=function(){return x.prop("checked")};x.change(function(){A.handleChange()});return A};var r=function(x,y){var A=i(x,y),B=A.getValue,z=A.setValue;A.getValue=function(){var C=B();if(f.trim(C)===""){return""}return C};A.getUIElement=function(){var E=A.getControl(),C=k(E,A.getDisplayName(),!!A.isDisabled(),A.getHelp()),D;if(A.definition.xpathType==="generic"){E.addClass("jstree-drop")}if(y.autocompleteChoices){D=function(){return y.autocompleteChoices(x)}}return c(C,function(){A.options.displayXPathEditor({leftPlaceholder:y.leftPlaceholder,rightPlaceholder:y.rightPlaceholder,leftAutocompleteChoices:D,value:B(),xpathType:A.definition.xpathType,onLoad:function(F){q(F,A)},done:function(F){if(F!==false){z(F);A.handleChange()}},mug:x,});if(window.analytics){window.analytics.usage("Form Builder","Logic",y.lstring)}},!!A.isDisabled())};a.questionAutocomplete(A.input,x,{property:y.path});return A};r.hasLogicReferences=true;var w=function(y,z){var A=g(y,z),B=z.widgetValuePath||z.path,C=z.id||"property-"+B;A.definition=y.p.getDefinition(z.path);A.mugValue=z.mugValue||function(D,E){if(arguments.length===1){return D.p[B]}D.p[B]=E};A.currentValue=A.mugValue(y);A.kvInput=f('<div class="control-row" />').attr("name",C);A.getControl=function(){if(A.isDisabled()){}return A.kvInput};A.setValue=function(D){A.kvInput.html(m({pairs:u.clone(D)}));A.kvInput.find("input").bind("change keyup",function(){A.handleChange()});A.kvInput.find(".fd-kv-add-pair").click(function(E){A.refreshControl();E.preventDefault()});A.kvInput.find(".fd-kv-remove-pair").click(function(E){f(this).parent().parent().remove();A.refreshControl();A.save();E.preventDefault()})};function x(){var D={};u.each(A.kvInput.find(".fd-kv-pair"),function(F){var G=f(F),E=G.find(".fd-kv-key").val(),H=G.find(".fd-kv-val").val();if(D.hasOwnProperty(E)){if(u.isArray(D[E])){D[E].push(H)}else{D[E]=[D[E],H]}}else{D[E]=H}});return D}A.getValue=function(){return u.omit(x(),"")};A.updateValue=function(){if(!x().hasOwnProperty("")){A.kvInput.find(".btn").removeClass("hide");A.kvInput.find(".fd-kv-remove-pair").removeClass("hide")}A.save()};A.refreshControl=function(){A.setValue(A.getValue())};A.save=function(){A.saving=true;try{A.mugValue(y,A.getValue())}finally{A.saving=false}};return A};var n=function(y,z){var A=v(y,z);A.input=f("<select />").attr("name",A.id).addClass("input-block-level");var x=A.input;A.setValue=function(B){var C=A.equivalentOption(B);if(C){x.val(C.value)}else{A.addOption(B,"Custom");x.val(B)}};A.getValue=function(){return x.val()};A.updateValue=function(){A.save()};x.change(function(){A.handleChange()});A.addOption=function(C,D){var B=f("<option />").attr("value",C).text(D);this.input.append(B)};A.addOptions=function(B){var C=this;u.forEach(B,function(D){C.addOption(D.value,D.text)})};A.clearOptions=function(){this.input.empty()};A.getOptions=function(){return u.map(A.input.find("option"),function(B){return{value:B.value,text:B.text}})};A.equivalentOption=function(B){B=B?JSON.parse(B):"";return u.find(A.getOptions(),function(C){return u.isEqual(C.value?JSON.parse(C.value):"",B)})};return A};var b=function(x,y){y.id="readonly-control";var z=g(x,y);z.definition={};z.currentValue=f("<div>").append(x.p.rawControlXML).clone().html();z.getControl=function(){var A=f("<p />").text(this.currentValue);return A};return z};var h=function(x,y){var z=v(x,y);z.form="text";z.getValue=function(){return z.input.val()};z.setValue=function(A){return z.input.val(A)};z.mug.form.vellum.initWidget(z);return z};var s=function(B,A,x){var y=B.find("input");if(u.isUndefined(x)){x=y?y.prop("disabled"):false}var z=f("<button />").addClass("fd-edit-button pull-right").text("Edit").stopLink().addClass("btn").attr("type","button").prop("disabled",x).click(A);B.css("position","relative");B.find(".controls").not(".messages").addClass("fd-edit-controls").css("margin-right","60px").after(z);return B};var c=function(A,z,x){var y=A.find("input");if(u.isUndefined(x)){x=y?y.prop("disabled"):false}A.css("position","relative");A.find(".controls").not(".messages").addClass("fd-edit-controls").css("margin-right","0px");return A};var k=function(F,z,H,B){var A=f("<div />").addClass("widget control-group"),C=f('<div class="controls" />'),x=f('<div class="controls messages" />'),G=f("<div />").append(f("<label />").text(z));G.addClass("control-label");if(B){var E="";if(B.url){E="<p><a href='"+B.url+"' target='_blank'>See more</a></p>"}var D=f("<a />").attr({href:"#","data-title":z,"data-content":B.text+E});if(!B.url){D.click(function(I){I.preventDefault()})}var y=f("<div/>").addClass("fd-help");y.append(D);G.append(y)}A.append(G);F.prop("disabled",!!H);C.append(F);A.append(C);A.append(x);return A};function p(y,A){var z=f(),x={};y.messages.each(A,function(C){if(x.hasOwnProperty(C.message)){return}x[C.message]=true;var B=f(t({msg:C,html:/\n/.test(C.message)?a.markdown(C.message):""}));B.find("button.close").click(function(){y.dropMessage(A,C.key)});z=z.add(B)});return z}function d(y,x){var A=y,z;while(A&&A.length){z=A.data("vellum_widget");if(z&&x===A.vellum("get")){return z}A=A.parent()}return null}function q(x,y){x.data("vellum_widget",y);return x}return{base:g,normal:v,text:i,multilineText:o,identifier:e,droppableText:l,checkbox:j,dropdown:n,xPath:r,baseKeyValue:w,readOnlyControl:b,media:h,util:{getWidget:d,setWidget:q,getMessages:p,getUIElementWithEditButton:s,getUIElement:k}}});