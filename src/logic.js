define(["xpath","xpathmodels","jquery","underscore"],function(c,e,g,d){var b=["relevantAttr","calculateAttr","constraintAttr","dataParent","repeat_count","filter","defaultValue"],f=d.without(b,"constraintAttr");function a(i){this._text=i||"";if(g.trim(i)){try{this.parsed=c.parse(i)}catch(j){this.parsed=null;this.error=j}}else{this.parsed=null}}a.prototype={analyze:function(){var y=[],s=[],v=[],t=e.XPathInitialContextEnum.ROOT,q=e.XPathInitialContextEnum.RELATIVE,u=e.XPathInitialContextEnum.EXPR,w;this.paths=y;this.absolutePaths=s;this.instanceRefs={};this.referencesSelf=false;this.topLevelPaths=v;if(this.parsed){var r=[{xpath:this.parsed,insideFilter:false}],m,p,l,o,n,x;while(r.length>0){n=r.shift();m=n.xpath;x=n.insideFilter;if(m instanceof e.XPathPathExpr){y.push(m);if(!x){v.push(m)}x=true;if(m.initial_context===t){s.push(m)}else{if(m.initial_context===q&&m.steps.length===1&&m.steps[0].axis==="self"){this.referencesSelf=true}else{if(m.initial_context===u){if(!this._addInstanceRef(m.filter.expr)){r.push({xpath:m.filter.expr,insideFilter:x})}w=m.filter.predicates;for(p=0;p<w.length;p++){r.push({xpath:w[p],insideFilter:x})}}}}}else{if(m instanceof e.XPathFuncExpr){this._addInstanceRef(m)}}l=m.getChildren();for(p=0;p<l.length;p++){r.push({xpath:l[p],insideFilter:x});if(l[p].predicates&&l[p].predicates.length){w=l[p].predicates;for(o=0;o<w.length;o++){r.push({xpath:w[o],insideFilter:x})}}}}}},_addInstanceRef:function(i){if(i.id==="instance"&&i.args.length===1&&i.args[0] instanceof e.XPathStringLiteral){var j=i.args[0].value;this.instanceRefs[j]=null;return true}return false},getPaths:function(){if(!this.paths){this.analyze()}return this.paths},getTopLevelPaths:function(){if(!this.topLevelPaths){this.analyze()}return this.topLevelPaths},updatePath:function(o,n){var m=this.getPaths(),l;var k=function(p,i){i.initial_context=p.initial_context;i.steps=p.steps;i.filter=p.filter};for(var j=0;j<m.length;j++){l=m[j];if(l.toXPath()===o){k(c.parse(n),l)}}},getText:function(){if(this._text&&this.parsed){return this.parsed.toXPath()}else{return this._text}}};function h(j,i){i.allowedDataNodeReferences=i.allowedDataNodeReferences||{};this.opts=i;this.form=j;this.all=[];this.errors={}}h.prototype={clearReferences:function(i,j){i.form.dropAllInstanceReferences(i,j,true);this.all=this.all.filter(function(k){return k.mug!==i.ufid||k.property!==j})},addReferences:function(l,r,q){var n=this,i=l.form,p=new a(q||l.p[r]),k=[],j=[],o="",m=l.spec[r]?l.spec[r].lstring:r;p.analyze();if(p.referencesSelf&&d.contains(f,r)){o="The "+m+" for a question is not allowed to reference the question itself. Please remove the . from the "+m+" or your form will have errors."}j.push({key:"core-circular-reference-warning",level:l.WARNING,message:o});this.all=this.all.concat(p.absolutePaths.map(function(v){var t=v.pathWithoutPredicates(),u=t.substring(1+t.indexOf("/",1)),w=i.getMugByPath(t),s=v.toXPath();if(!w&&(!l.options.ignoreReferenceWarning||!l.options.ignoreReferenceWarning(l))&&n.opts.allowedDataNodeReferences.indexOf(u)===-1&&!(r==="dataParent"&&t===i.getBasePath().slice(0,-1))){k.push(s)}return{mug:l.ufid,ref:w?w.ufid:"",property:r,path:s,sourcePath:i.getAbsolutePath(l)}}));d.each(p.instanceRefs,function(t,s){i.referenceInstance(s,l,r)});if(k.length>0){if(!this.errors[l.ufid]){this.errors[l.ufid]={}}this.errors[l.ufid][r]=true}else{if(this.errors[l.ufid]){delete this.errors[l.ufid][r]}}j.push({key:"logic-bad-path-warning",level:l.WARNING,message:(function(){if(!k.length){return""}else{if(k.length===1){return"Unknown question: "+k[0]}}return"Unknown questions:\n- "+k.join("\n- ")})()});return j},updateReferences:function(i,l,k){function n(o){m.clearReferences(i,o);j[o]=m.addReferences(i,o,k)}var m=this,j={};if(l){if(arguments.length>2||b.indexOf(l)!==-1){n(l)}}else{d.each(b,n)}i.addMessages(j)},updatePath:function(i,m,l,k){if(m===l){return}var j={};j[i]=[m,l];this.updatePaths(j,k)},updatePaths:function(l,k){var i={};function j(m,n,q){var p=m.ufid+" "+n+" "+q[0];if(i.hasOwnProperty(p)){return}i[p]=null;var o=new a(m.p[n]),r=o.getText();o.updatePath(q[0],q[1]);if(r!==o.getText()){m.p.set(n,o.getText())}}this.forEachReferencingProperty(l,j,k)},forEachBrokenReference:function(i){d.each(d.keys(this.errors),function(k){var j=this.form.getMugByUFID(k);if(j){i(j)}else{delete this.errors[k]}},this)},forEachReferencingProperty:function(i,j,k){var l=this;d(this.all).each(function(n){if(i.hasOwnProperty(n.ref)&&(!k||n.sourcePath===k||n.sourcePath.indexOf(k+"/")===0)){var m=l.form.getMugByUFID(n.mug);j(m,n.property,i[n.ref])}})},reset:function(){this.all=[]}};return{LogicManager:h,LogicExpression:a,XPATH_REFERENCES:b,NO_SELF_REFERENCES:f,}});