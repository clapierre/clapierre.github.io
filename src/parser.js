define(["vellum/form","vellum/util","vellum/xml","jquery","underscore","xpath","xpathmodels"],function(m,b,g,h,A,q,l){var w="data";function u(D){var E=D.data.core;E.controlNodeAdaptorMap=C();D.updateControlNodeAdaptorMap(E.controlNodeAdaptorMap)}function n(G){var E=h(G)[0].attributes,D={};for(var F=0;F<E.length;F++){D[E[F].nodeName]=E[F].nodeValue}return D}function j(O,S,G,J){var L=m.Form,M=m.InstanceMetadata,E=new L(S,G,S.mugTypes);E.parseErrors=[];E.parseWarnings=J;E.isLoadingXForm=true;if(!O){E.isLoadingXForm=false;return E}var T=h.parseXML(O),K=h(T),P=K.find("h\\:head, head"),Q=P.children("h\\:title, title"),F=P.find("bind"),D=t(K),I=h(D[0]).children(),N=P.find("> model > setvalue");if(h(K).find("parsererror").length>0){throw"PARSE ERROR!:"+h(K).find("parsererror").find("div").html()}if(Q.length>0){E.formName=h(Q).text()}E.instanceMetadata=D.map(function(U){return M(n(U),h(U).children())});E.updateKnownInstances();if(I.length===0){E.parseErrors.push("No Data block was found in the form.  Please check that your form is valid!")}e(E,I[0]);z(E,F);f(E,N);var R=K.find("h\\:body, body").children();o(E,R);var H;if(E.parseErrors){for(H=0;H<E.parseErrors.length;H++){E.updateError({level:"error",message:E.parseErrors[H]})}}if(E.parseWarnings){for(H=0;H<E.parseWarnings.length;H++){E.updateError({level:"parse-warning",message:E.parseWarnings[H]})}}E.isLoadingXForm=false;return E}function e(G,H){var E=h(H),D=G.tree,F;F=function(I){var J=G.vellum.parseDataElement(G,this,I),K=J.options.parseDataNode(J,h(this),I);D.insertMug(J,"into",I);G._fixMugState(J);K.each(function(){F.call(this,J)})};if(E.children().length===0){G.parseErrors.push("Data block has no children elements! Please make sure your form is a valid JavaRosa XForm!")}if(E[0]){G.setFormID(E[0].tagName)}else{G.setFormID(w)}E.children().each(function(){F.call(this,null)});G.formUuid=E.attr("xmlns");G.formJRM=E.attr("xmlns:jrm");G.formUIVersion=E.attr("uiVersion");G.formVersion=E.attr("version");G.formName=E.attr("name");if(!G.formUuid){G.parseWarnings.push("Form does not have a unique xform XMLNS (in data block). Will be added automatically")}if(!G.formJRM){G.parseWarnings.push("Form JRM namespace attribute was not found in data block. One will be added automatically")}if(!G.formUIVersion){G.parseWarnings.push("Form does not have a UIVersion attribute, one will be generated automatically")}if(!G.formVersion){G.parseWarnings.push("Form does not have a Version attribute (in the data block), one will be added automatically")}if(!G.formName){G.parseWarnings.push("Form does not have a Name! The default form name will be used")}}function y(D,E,H,G){var L=h(E),J=E.nodeName,K=L.children().length?null:L.text(),F=L.popAttr("xmlns")||null;G=G||L.attr("vellum:role");if(G&&D.mugTypes.allTypes.hasOwnProperty(G)&&D.mugTypes.allTypes[G].supportsDataNodeRole){L.popAttr("vellum:role")}else{G="DataBindOnly"}var I=D.mugTypes.make(G,D);I.p.nodeID=J;I.p.dataValue=K;if(F&&(F!==D.formUuid)){I.p.xmlnsAttr=F}I.p.rawDataAttributes=n(E);return I}function f(F,E){var D=F.tree.getRootNode().getID();E.each(function(){var G=h(this);F.vellum.parseSetValue(F,G,v(G.attr("ref"),D))})}function d(H,E,J){var D=H.getMugByPath(J),G=E.attr("event"),F=E.attr("ref"),I=E.attr("value");if(!D||(G!=="xforms-ready"&&G!=="jr-insert")){H.addSetValue(G,F,I)}else{D.p.defaultValue=I}}var s=function(E,D){return E.popAttr("jr:"+D)||E.popAttr("jr\\:"+D)||null};function k(D,G,H){var E=G[0].nodeName.toLowerCase(),J=G.popAttr("appearance"),K,I=null;var M=D.vellum.getControlNodeAdaptorFactory(E);if(M){K=M(G,J,D,H)}if(!K){K=r(G,J,D,H)}if(!K.ignoreDataNode){var L=K.path;if(!L){L=i(G,D,H)}I=D.getMugByPath(L)}I=K(I,D);var F=D.tree.getNodeFromMug(I);if(!F){I.options.isControlOnly=true;F=D.tree.insertMug(I,"into",H);D.mugMap[I.ufid]=I}else{if(F.parent.value!==H){I.p.dataParent=F.parent.getAbsolutePath();F=D.tree.insertMug(I,"into",H)}}if(J){I.p.appearance=J}if(!K.skipPopulate){D.vellum.populateControlMug(I,G);I.p.rawControlAttributes=n(G)}return F}function c(D,H){var E=H.children("label"),F=H.children("hint");if(E.length&&D.getPresence("label")!=="notallowed"){var G=g.humanize(E);if(G){D.p.label=G}}if(F.length&&D.getPresence("hintLabel")!=="notallowed"){D.p.hintLabel=g.humanize(F)}}function a(E){var D=function(F,G){if(F){G.changeMugType(F,E)}else{F=G.mugTypes.make(E,G)}return F};D.type=E;return D}function x(E){var D=function(F,G){return G.mugTypes.make(E,G)};D.type=E;D.ignoreDataNode=true;return D}function r(H,F,G,E){var D=function(I,J){I=a("ReadOnly")(I,J);if(H.length===1&&H[0].poppedAttributes){A.each(H[0].poppedAttributes,function(L,K){H.attr(K,L)})}I.p.rawControlXML=H;return I};D.skipPopulate=true;return D}function C(){var H={string:a("Text"),"long":a("Long"),"int":a("Int"),"double":a("Double"),date:a("Date"),datetime:a("DateTime"),time:a("Time"),geopoint:a("Geopoint"),barcode:a("Barcode"),intent:a("AndroidIntent")},G=a("Select"),E=x("Item"),D=a("Trigger"),F=function(I){return function(J,K){J=D(J,K);J.p.appearance=I;return J}};return{secret:function(){return a("Secret")},select:function(){return a("MSelect")},select1:function(){return G},trigger:function(J,I){return F(I)},input:function(J,I){if(J.popAttr("readonly")==="true()"){return F(I)}return function(L,M){var K=L&&L.p.rawBindAttributes&&L.p.rawBindAttributes.type;if(K){K=K.replace("xsd:","");K=K.toLowerCase();if(H.hasOwnProperty(K)){delete L.p.rawBindAttributes.type;if(K==="string"&&I==="numeric"){return a("PhoneNumber")(L,M)}return H[K](L,M)}}return H.string(L,M)}},item:function(J){var I=function(K,L){K=E(K,L);var M=g.humanize(J.children("value"));if(M){K.p.nodeID=M}return K};I.type=E.type;I.ignoreDataNode=true;return I},group:function(O,K,M,J){var L;if(K==="field-list"){L="FieldList"}else{var N=O.children("repeat");if(N.length===1){var I=function(P,Q){P=a("Repeat")(P,Q);P.p.repeat_count=N.popAttr("jr:count")||null;P.p.rawRepeatAttributes=n(N);return P};I.repeat=N;I.path=i(N,M,J);I.type="Repeat";return I}else{L="Group"}}return a(L)},upload:function(N,K,M,J){var I=N.popAttr("mediatype");if(!I){throw"Unable to parse binary question type. The question has no MediaType attribute assigned to it!"}var L;I=I.toLowerCase();if(I==="video/*"){L="Video"}else{if(I==="image/*"){if(K==="signature"){L="Signature"}else{L="Image"}}else{if(I==="audio/*"){L="Audio"}else{throw"Unrecognized upload question type for Element: "+i(N,M,J)}}}return a(L)}}}function p(D,F){if(!D){return F}var E=D.toLowerCase().replace(/\s/g,"");if(E==="true()"){return true}else{if(E==="false()"){return false}else{return F}}}function i(F,H,D,G){if(!F){return null}var I=G?F.attr("ref"):F.popAttr("ref"),K,J;if(!I){I=G?F.attr("nodeset"):F.popAttr("nodeset")}if(!I){K=G?F.attr("bind"):F.popAttr("bind");if(K){J=v(K);if(!H.getMugByPath(J)){H.parseWarnings.push("Ambiguous bind: "+K)}else{I=J}}}I=I||K||null;if(I&&I[0]!=="/"){if(D){var E=D.absolutePath;if(E){I=E+"/"+I}}else{I=H.getBasePath()+I}}return I}function o(H,D){function G(L,J){var K=0,M=L.length;return function(){if(K>=M){return null}var P=h(L[K++]),O=k(H,P,J),N=O.value;if(N.options.controlNodeChildren){I(O,N.options.controlNodeChildren(P))}return O}}function F(J){var K=0,L=J.length;return function(){return K<L?J[K++]:null}}function E(J){return J.value.ufid}function I(L,M){var J=F(L.children),R=G(M,L.value),P=J(),O=R(),Q=[],K={},N=false;while(O){if(P){if(P===O){Q.push(O);O=R()}K[E(P)]=null;P=J()}else{N=N||K.hasOwnProperty(E(O));Q.push(O);O=R()}}if(N){L.children=A.union(Q,L.children)}}I(H.tree.getRootNode(),D)}function v(G,E){var F;var D=q.parse(G);if(!(D instanceof l.XPathPathExpr)){return null}if(D.initial_context===l.XPathInitialContextEnum.RELATIVE){D.steps.splice(0,0,l.XPathStep({axis:"child",test:E}));D.initial_context=l.XPathInitialContextEnum.ROOT}else{return G}F=D.toXPath();return F}function z(E,F){var D=E.tree.getRootNode().getID();F.each(function(){var G=h(this),H=G.popAttr("nodeset")||G.popAttr("ref");E.vellum.parseBindElement(E,G,v(H,D))})}function B(H,G,I){var D=H.getMugByPath(I);if(!D){H.parseWarnings.push("Bind Node ["+I+"] found but has no associated Data node. This bind node will be discarded!");return}var F={relevantAttr:G.popAttr("relevant"),calculateAttr:G.popAttr("calculate"),constraintAttr:G.popAttr("constraint"),constraintMsgAttr:s(G,"constraintMsg"),requiredAttr:p(G.popAttr("required")),};var E=F.rawBindAttributes=n(G);if(E.type&&E.type.toLowerCase()==="xsd:integer"){E.type="xsd:int"}D.p.setAttrs(F)}var t=function(E){var H=E.find("instance");var G=false;var D=[];for(var F=0;F<H.length;F++){if(!h(H[F]).attr("id")){if(G){throw"multiple unnamed instance elements found in the form! this is not allowed. please add id's to all but 1 instance."}D.splice(0,0,H[F]);G=true}else{D.push(H[F])}}return D};return{init:u,parseXForm:j,parseDataElement:y,parseBindElement:B,parseSetValue:d,populateControlMug:c,getAttributes:n,getPathFromControlElement:i,makeControlOnlyMugAdaptor:x,makeMugAdaptor:a}});