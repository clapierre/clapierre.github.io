define(["underscore","jquery","vellum/mugs","vellum/parser","vellum/util","vellum/core"],function(o,g,e,a,h){var m=new XMLSerializer(),b="mug",k="parent";g.vellum.plugin("ignore",{},{loadXML:function(x,z){this.data.ignore.ignoredNodes=[];if(!x){this.__callOld();return}var t=this,v=[],y=g.parseXML(x),q=g(y),u=q.find('[vellum\\:ignore="retain"]');this.data.ignore.active=u.length;if(!this.data.ignore.active){this.__callOld();return}z.enableInstanceRefCounting=false;this.data.ignore.ignoredMugs=[];var r=q.find("h\\:html > h\\:head > model:first"),w=r.find("instance:first"),s=q.find("h\\:html > h\\:body:first, h\\:html > body:first");o.each([r,w,s],function(A){if(!A.length){window.console.log("WARNING",A.selector,"not found")}});u=u.not(function(A,B){var C=o.any(g(B).parents(),function(D){return w.is(D)||s.is(D)||o.any(u,function(E){return g(E).is(D)})});if(!C&&B.nodeName==="bind"){return g(B).parent().is(r)}return C});u.each(function(A,B){t.data.ignore.ignoredNodes.push(j(B));v.push(B)});o.each(v,function(A){A.parentElement.removeChild(A)});this.__callOld(m.serializeToString(q[0]),z)},createXML:function(){var t=this.__callOld(),s=this.data.ignore.ignoredNodes;if(!this.data.ignore.active){return t}var q=g(g.parseXML(t));o.each(s,function(y){if(y.path==="h\\:html > h\\:body"){y.path="h\\:html > body, h\\:html > h\\:body"}else{if(y.path==="h\\:html > h\\:head"){y.path="h\\:html > head, h\\:html > h\\:head"}}var u=q.find(y.path),v=g(g.parseXML(y.nodeXML).childNodes[0]),x=y.prev&&u.find(y.prev),w=y.next&&u.find(y.next);if(x&&x.length){x.first().after(v)}else{if(w&&w.length){w.first().before(v)}else{u.append(v)}}});var r=0;return m.serializeToString(q[0]).replace(/ xmlns=""/g,"").replace(/ xmlns:vellum="(.+?)"/g,function(u){return r++?"":u})},getMugTypes:function(){var q=this.__callOld();q.normal.Ignored=f;return q},parseDataElement:function(u,t,q){if(this.data.ignore.active){var s=g(t);if(s.attr("vellum:ignore")==="retain"){var r=u.mugTypes.make("Ignored",u);r.p.nodeID=t.nodeName;r.p.rawDataAttributes=a.getAttributes(t);if(s.children().length){r.p.dataNodeXML=c(s).replace(/^<[^>]+>([^]*)<\/[^>]+>$/,"$1")}else{r.p.dataNodeXML=""}this.data.ignore.ignoredMugs.push(r);return r}}return this.__callOld()},parseBindElement:function(u,t,v){if(this.data.ignore.active){var q=u.getMugByPath(v);if(!q){q=p(v,u)}if((q&&q.__className==="Ignored")||t.attr("vellum:ignore")==="retain"){var w,s;if(q&&q.__className==="Ignored"){w=q.absolutePath;s=b}else{var r=null;if(q){r=q.options.isSpecialGroup?q:q.parentMug}q=i(u,r);u.tree.insertMug(q,"into",r);u._fixMugState(q);w=r?r.absolutePath:u.getBasePath(true);s=k;this.data.ignore.ignoredMugs.push(q)}q.p.binds.push({path:v.startsWith(w)?v.slice(w.length):v,relativeTo:v.startsWith(w)?s:null,attrs:a.getAttributes(t)});return}}this.__callOld()},parseSetValue:function(u,t,v){if(this.data.ignore.active){var q=u.getMugByPath(v);if(!q){q=p(v,u)}if((q&&q.__className==="Ignored")||t.attr("vellum:ignore")==="retain"){var w,s;if(q&&q.__className==="Ignored"){w=q.absolutePath;s=b}else{var r=null;if(q){r=q.options.isSpecialGroup?q:q.parentMug}q=i(u,r);u.tree.insertMug(q,"into",r);u._fixMugState(q);w=r?r.absolutePath:u.getBasePath(true);s=k;this.data.ignore.ignoredMugs.push(q)}q.p.setValues.push({ref:t.attr("ref"),event:t.attr("event"),value:t.attr("value")});return}}this.__callOld()},getControlNodeAdaptorFactory:function(s){var q=this.__callOld();if(this.data.ignore.active){var r=this.data.ignore.ignoredMugs;return function(A,v,y,u){function t(){if(!w||w.__className!=="Ignored"){w=i(y,u);r.push(w)}d(A);w.p.controlNode=c(A);return w}t.skipPopulate=true;var z=a.getPathFromControlElement(A,y,u,true),w=y.getMugByPath(z);if(A.attr("vellum:ignore")==="retain"){t.ignoreDataNode=w&&w.__className!=="Ignored";return t}if(w&&w.__className==="Ignored"){return t}var x=Array.prototype.slice.call(arguments);return q&&q.apply(null,x)}}return q},getSections:function(q){if(this.data.ignore.active&&q.__className==="Ignored"){return[{slug:"advanced",type:"accordion",displayName:"Advanced",properties:["nodeID",],isCollapsed:true,help:{title:"Advanced",text:"This question represents advanced content that is not supported by the form builder. Please only change it if you have a specific need!"}}]}return this.__callOld()},handleMugRename:function(s,u,x,v,w,q){this.__callOld();if(this.data.ignore.active&&q){var r=RegExp.escape(q),t=new RegExp(r+"(\\W|$)","g"),y=w+"$1";o.each(this.data.ignore.ignoredNodes,function(z){z.nodeXML=z.nodeXML.replace(t,y)});o.each(this.data.ignore.ignoredMugs,function(z){if(z.p.controlNode){z.p.controlNode=z.p.controlNode.replace(t,y)}o.each(z.p.binds,function(A){A.attrs=o.object(o.map(A.attrs,function(C,B){return[B,C.replace(t,y)]}))})})}}});var f={typeName:"Ignored XML",icon:"icon-question-sign",isTypeChangeable:false,isRemoveable:false,isCopyable:false,init:function(q){q.p.binds=[];q.p.setValues=[]},parseDataNode:function(q,r){return g([])},getTagName:function(q,r){return q.p.rawDataAttributes?r:null},writeDataNodeXML:function(r,q){if(q.p.dataNodeXML){r.writeXML(q.p.dataNodeXML)}},getBindList:function(q){return o.map(q.p.binds,function(u){var r=o.clone(u.attrs),t="";if(u.relativeTo===b){t=q.absolutePath}else{if(u.relativeTo===k){var s=q.parentMug;t=s?s.absolutePath:q.form.getBasePath(true)}}r.nodeset=t+u.path;return r})},getSetValues:function(q){return q.p.setValues},writesOnlyCustomXML:true,writeCustomXML:function(r,q){if(q.p.controlNode){r.writeXML(q.p.controlNode)}},spec:{label:{presence:"notallowed"},labelItext:{presence:"notallowed"},labelItextID:{presence:"notallowed"},hintLabel:{presence:"notallowed"},hintItext:{presence:"notallowed"},hintItextID:{presence:"notallowed"},helpItext:{presence:"notallowed"},helpItextID:{presence:"notallowed"},mediaItext:{presence:"notallowed"},otherItext:{presence:"notallowed"},appearance:{presence:"notallowed"},}};function p(t,s){var q=null,r=/[\/[][^\/[]+$/;while(!q&&t&&r.test(t)){t=t.replace(r,"");if(t){q=s.getMugByPath(t)}}return q}function i(s,r){var q=s.mugTypes.make("Ignored",s);q.p.nodeID=s.generate_item_label(r,"ignored--",1);return q}function d(q){if(q.length&&q[0].poppedAttributes){q.attr(q[0].poppedAttributes)}}function c(r){var q=m.serializeToString(r[0]),s=q.indexOf(">");if(s===-1){return q}return q.slice(0,s).replace(/ xmlns(:.*?)?="(.*?)"/g,"")+q.slice(s)}function j(u){var t=u,v=[],s,r;s=l(u,"previous");r=l(u,"next");u=u.parentElement;while(u){v.unshift(n(u));u=u.parentElement}var q=m.serializeToString(t).replace(/xmlns="(.*?)"/,"");return{prev:s,next:r,path:v.join(" > "),nodeXML:"\n"+q}}function l(r,q){var s=n(r[q+"ElementSibling"]);return s&&s+", "+s.replace(/\w+:([^:]*)$/,"$1")}function n(u){if(!u){return null}var r=g(u),q=r.attr("nodeset"),t=r.attr("ref"),v=r.attr("id"),s=(r.prop("tagName")||"").toLowerCase();if(s==="setvalue"){return'[event="'+r.attr("event")+'"][ref="'+t+'"]'}else{if(q){return'[nodeset="'+q+'"]'}else{if(t){return'[ref="'+t+'"]'}else{if(v){return'[id="'+v+'"]'}else{return u.nodeName.replace(":","\\:")}}}}}});