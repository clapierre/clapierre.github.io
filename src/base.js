define(["jquery","underscore"],function(d,b,e){var c=["core","intents","javaRosa","lock","ignore","uploader","windowManager","copyPaste",];function a(g,f,h){if(h==="init"&&g!=="core"){return}if(h.indexOf("_")===0){if(this[h]!==e){throw ("private plugin method "+g+"."+h+" would overwrite existing: "+this[h])}this[h]=f;return}f.plugin=g;f.old=this[h];this[h]=function(){var k=f,j=Array.prototype.slice.call(arguments),i=this.__callOld;this.__callOld=function(){return k.old.apply(this,(arguments.length?Array.prototype.slice.call(arguments):j))};try{return k.apply(this,j)}finally{this.__callOld=i}};this[h].old=f.old;this[h].plugin=g}d.fn.vellum=function(i){var g=typeof i==="string",h=Array.prototype.slice.call(arguments,1),f;if(g){if(i==="get"){var j=this;while(j&&j.length){f=j.data("vellum_instance");if(f instanceof d.vellum._instance){return f}j=j.parent()}return null}f=this.data("vellum_instance");return f[i].apply(f,h)}else{this.each(function(){var k=new d.vellum._instance(d(this),i);d.data(this,"vellum_instance",k)});return this}};d.vellum={defaults:{},_plugins:{},_fn:{},_instance:function(g,h){h.plugins=b.filter(b.union(c,h.plugins||[]),function(i){return !b.isUndefined(d.vellum._plugins[i])});h=d.extend(true,{},d.vellum.defaults,h);var f=this;this.$f=g;this.data={};this.opts=function(){return d.extend(true,{},h)};this.getData=function(){return this.data}.bind(this);this.isPluginEnabled=function(i){return h.plugins.indexOf(i)!==-1};b.each(h.plugins,function(l,k){f.data[l]={};var j=d.vellum._plugins[l];if(j){b.each(j,function(i,m){if(k===0){f[m]=i}else{a.call(f,l,i,m)}})}});b.each(h.plugins,function(j){var i=d.vellum._plugins[j].init;if(i){i.apply(f)}});f.postInit()},plugin:function(g,h,f){d.vellum.defaults[g]=h;d.vellum._plugins[g]=f;return d}};return});