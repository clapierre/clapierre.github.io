define(["json!langCodes","underscore","jsdiff","vellum/markdown","jquery","jquery.bootstrap-popout","vellum/jquery-extensions"],function(f,b,a,c,e){RegExp.escape=function(g){return g.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")};var d={};d.extend=function(){var g=Array.prototype.slice.call(arguments);return e.extend.apply(null,[true,{}].concat(g))};d.langCodeToName={};b.each(f,function(h){var g=h.names[0];d.langCodeToName[h.three]=g;d.langCodeToName[h.two]=g});d.formatExc=function(g){return g&&g.stack?g.stack:String(g)};d.getTemplateObject=function(g,h){return e(b.template(e(g).text(),h))};d.validAttributeRegex=/^[^<&'"]*$/;d.invalidAttributeRegex=/[<&'"]/;d.isValidAttributeValue=function(g){return d.validAttributeRegex.test(g)};d.eventuality=function(h){var g={},i={};h.fire=function(n){var o,m,l,j,k=typeof n==="string"?n:n.type;if(g.hasOwnProperty(k)){o=g[k];for(j=0;j<o.length;j+=1){l=o[j];m=l.method;if(typeof m==="string"){m=this[m]}m.apply(this,l.parameters||[n])}}return this};h.on=function(l,o,m,n,j){if(arguments.length<5){j=null}var k={method:o,parameters:m,context:j};if(g.hasOwnProperty(l)){g[l].push(k)}else{g[l]=[k]}if(n){if(!i[n]){i[n]=[]}if(i[n].indexOf(j)===-1){i[n].push(j);h.on(n,function(){h.unbind(j);i[n]=b.filter(i[n],function(p){return p!==j})},null,null,j)}}return this};h.unbind=function(j,k){if(b.isUndefined(k)){g=b.object(b.map(g,function(l,n,m){l=b.filter(l,function(o){return o.context!==j});return[n,l]}))}else{if(g.hasOwnProperty(k)){g[k]=b.filter(g[k],function(l){return l.context!==j})}}return this};return h};d.pluralize=function(g,h){return g+(h!==1?"s":"")};d.get_guid=function(){var g=function(){return(((1+Math.random())*65536)|0).toString(16).substring(1)};return(g()+g()+g()+g()+g()+g()+g()+g())};d.generate_xmlns_uuid=function(){var k="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";var h=[],j,g;h[8]=h[13]=h[18]=h[23]="-";h[14]="4";for(g=0;g<36;g++){if(!h[g]){j=Math.floor((Math.random()*16));h[g]=k[(g===19)?(j&3)|8:j&15]}}return h.toString().replace(/,/g,"")};d.isValidElementName=function(h){var g=/^(?!XML)[a-zA-Z][\w-]*$/;return g.test(h)};d.createXPathBoolFromJS=function(g){if(g===true||g==="true"){return"true()"}else{if(g===false||g==="false"){return"false()"}else{return null}}};d.getOneOrFail=function(g,h){if(g.length===0){throw ("No match for "+h+" found!")}else{if(g.length>1){throw ("Multiple matches for "+h+" found!")}}return g[0]};d.reduceToOne=function(h,g,i){return d.getOneOrFail(b(h).filter(g),i)};d.getCaretPosition=function(h){var i=0;if(h.createTextRange){h.focus();var g=document.selection.createRange();g.moveStart("character",-h.value.length);i=g.text.length}else{if(typeof h.selectionStart!=="undefined"){i=h.selectionStart}}return i};d.setCaretPosition=function(i,j,g){if(g===null||g===undefined){g=j}if(i.setSelectionRange){i.focus();i.setSelectionRange(j,g)}else{if(i.createTextRange){var h=i.createTextRange();h.collapse(true);h.moveStart("character",j);h.moveEnd("character",g);h.select()}}};d.insertTextAtCursor=function(l,k,g){var j=l[0],n=d.getCaretPosition(j),i=j.value.substring(0,n),h=j.value.substring(n,j.value.length),m=g?n:n+k.length;l.val(i+k+h).change();n=n+k.length;d.setCaretPosition(j,m,n)};d.xmlDiff=function(i,h,j){function g(m){m=m.replace(/^\t+/mg,function(n){return n.replace(/\t/g,"  ")});if(!m.match(/\n$/)){m=m+"\n"}return m}j=j||{};if(j.normalize_xmlns){var l=e(e.parseXML(h)).find("data").attr("xmlns");i=i.replace(/(data[^>]+xmlns=")(.+?)"/,"$1"+l+'"')}i=g(i);h=g(h);var k=a.createPatch("",h,i,"Server Form","Local Form");k=k.replace(/^Index:/,"XML "+(j.not?"should not be equivalent":"mismatch"));return k};d.markdown=c;d.dropdownAutocomplete=function(h,g){h.atwho({at:"",data:g,maxLen:Infinity,suffix:"",tabSelectsMatch:false,callbacks:{filter:function(j,i,k){return b.filter(i,function(l){return l.name.indexOf(j)!==-1})},matcher:function(i,j,k){return h.val()},beforeInsert:function(i,j){h.data("selected-value",i)},}}).on("inserted.atwho",function(j,k,i){h.val(h.data("selected-value"))})};d.questionAutocomplete=function(i,g,h){h=b.defaults(h||{},{category:"Question Reference",insertTpl:"${name}",property:"",});i.atwho({at:"/data/",data:b.chain(g.form.getMugList()).map(function(j){return{id:j.ufid,name:j.absolutePath,icon:j.options.icon,}}).filter(function(j){return j.name}).value(),displayTpl:'<li><i class="${icon}" /> ${name}</li>',insertTpl:h.insertTpl,limit:10,maxLen:30,tabSelectsMatch:false,callbacks:{matcher:function(j,l){var k,m;m=new RegExp("(\\s+|^)"+RegExp.escape(j)+"([\\w_/]*)$","gi");k=m.exec(l);return k?k[2]:null},beforeInsert:function(j,k){if(window.analytics){window.analytics.usage(h.category,"Autocomplete",h.property)}return j}}});g.on("teardown-mug-properties",function(){i.atwho("destroy")},null,"teardown-mug-properties")};return d});