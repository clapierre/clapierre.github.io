define(["vellum/form","jquery","underscore","vellum/mugs","vellum/parser","vellum/tree","vellum/util","vellum/widgets","tpl!vellum/templates/widget_update_case","tpl!vellum/templates/widget_index_case","tpl!vellum/templates/widget_attachment_case","tpl!vellum/templates/widget_save_to_case","vellum/core"],function(r,g,y,q,e,v,a,s,p,k,t,d){function u(B){return B?B.p.useCreate:false}function x(B){return B?B.p.useClose:false}function f(B){return B?B.p.useUpdate:false}function m(B){return B?B.p.useIndex:false}function A(B){return B?B.p.useAttachment:false}function c(B){return u(B)||x(B)||f(B)||m(B)||A(B)}function j(B){var C=B.absolutePath;if(u(B)){B.form.addSetValue("xforms-ready",C+"/case/@case_id",B.p.case_id)}}var w=function(B,D){var E=s.normal(B,D),F=D.id,C=D.template;E.input=g('<div class="control-row" />').attr("name",F);E.getControl=function(){return E.input};E.refreshControl=function(G){G=G?G:E.getValue();E.input.html(d({internal_template:C,props:G}));E.input.find("input").bind("change keyup",function(){E.handleChange()});E.input.find(".fd-add-property").click(E.addProperty);E.input.find(".fd-remove-property").click(E.removeProperty)};E.setValue=function(G){G=y.isUndefined(G)?{}:G;E.refreshControl(G)};E.updateValue=function(){var G=E.getValue();if(!("" in G)){E.input.find(".btn").removeClass("hide");E.input.find(".fd-remove-property").removeClass("hide")}E.save()};E.removeProperty=function(G){g(this).parent().parent().parent().remove();E.refreshControl();E.save();G.preventDefault()};E.addProperty=function(G){E.refreshControl();G.preventDefault()};return E},o=function(B,C){C.template=p;var D=w(B,C);D.getValue=function(){var E={};y.each(D.input.find(".fd-update-property"),function(F){var G=g(F);E[G.find(".fd-update-property-name").val()]={calculate:G.find(".fd-update-property-source").val(),relevant:G.find(".fd-update-property-relevant").val(),}});return E};return D},z=function(B,C){C.template=k;var D=w(B,C);D.getValue=function(){var E={};y.each(D.input.find(".fd-index-property"),function(F){var G=g(F);E[G.find(".fd-index-property-name").val()]={calculate:G.find(".fd-index-property-source").val(),case_type:G.find(".fd-index-property-case-type").val(),relationship:G.find(".fd-index-property-relationship").val(),}});return E};return D},l=function(B,C){C.template=t;var D=w(B,C);D.getValue=function(){var E={};y.each(D.input.find(".fd-attachment-property"),function(F){var G=g(F);E[G.find(".fd-attachment-property-name").val()]={calculate:G.find(".fd-attachment-property-source").val(),from:G.find(".fd-attachment-property-from").val(),name:G.find(".fd-attachment-name").val(),}});return E};return D};var i="http://commcarehq.org/case/transaction/v2",b=/^[a-z_]+$/i,n={typeName:"Save to Case",isTypeChangeable:false,isDataOnly:true,supportsDataNodeRole:true,icon:"icon-save",init:function(B,C){B.p.date_modified=B.p.date_modified||"/data/meta/timeEnd"},spec:{xmlnsAttr:{presence:"optional"},date_modified:{lstring:"Date modified",visibility:"visible",presence:"required",widget:s.xPath,serialize:q.serializeXPath,deserialize:q.deserializeXPath,},user_id:{lstring:"User ID",visibility:"visible",presence:"optional",widget:s.xPath,serialize:q.serializeXPath,deserialize:q.deserializeXPath,},case_id:{lstring:"Case ID",visibility:"visible",presence:"required",widget:s.xPath,serialize:q.serializeXPath,deserialize:q.deserializeXPath,},useCreate:{lstring:"Create Case",visibility:"visible",presence:"optional",widget:s.checkbox},createProperty:{lstring:"Properties To Create",visibility:"visible",presence:"optional",widget:o,validationFunc:function(C){if(C.p.useCreate){var E=y.without(y.keys(C.p.createProperty),""),I=["case_type","case_name"],D=["owner_id"],G=y.union(I,D),F=y.difference(E,G),B=y.intersection(E,I),H=y.filter(E,function(J){return !b.test(J)});if(B.length!==I.length){return"You must include "+I.join(", ")+" columns to create a case"}else{if(F.length>0){return"You can only use the following properties: "+G.join(", ")}else{if(H.length>0){return H.join(", ")+" are invalid properties"}}}}return"pass"}},useClose:{lstring:"Close Case",visibility:"visible",presence:"optional",widget:s.checkbox},closeCondition:{lstring:"Close Condition",visibility:"visible",presence:"optional",widget:s.xPath,serialize:q.serializeXPath,deserialize:q.deserializeXPath,},useUpdate:{lstring:"Update Case",visibility:"visible",presence:"optional",widget:s.checkbox},updateProperty:{lstring:"Properties To Update",visibility:"visible",presence:"optional",widget:o,validationFunc:function(B){if(B.p.useUpdate){var C=y.without(y.keys(B.p.updateProperty),""),D=y.filter(C,function(E){return !b.test(E)});if(D.length>0){return D.join(", ")+" are invalid properties"}}return"pass"}},useIndex:{lstring:"Use Index",visibility:"visible",presence:"optional",widget:s.checkbox},indexProperty:{lstring:"Index Properties",visibility:"visible",presence:"optional",widget:z,validationFunc:function(B){if(B.p.useIndex){var C=y.without(y.keys(B.p.indexProperty),""),D=y.filter(C,function(E){return !b.test(E)});if(D.length>0){return D.join(", ")+" are invalid properties"}}return"pass"}},useAttachment:{lstring:"Use Attachments",visibility:"visible",presence:"optional",widget:s.checkbox},attachmentProperty:{lstring:"Attachment Properties",visibility:"visible",presence:"optional",widget:l,validationFunc:function(B){if(!B.p.useAttachment){return"pass"}var D=y.without(y.keys(B.p.attachmentProperty),""),F=y.filter(D,function(G){return !b.test(G)}),E=y.filter(D,function(G){return !y.contains(["local","remote","inline"],B.p.attachmentProperty[G].from)}),C=y.filter(D,function(H){var J=B.p.attachmentProperty[H],I=J.from,G=J.name;return I==="inline"&&!G});if(F.length>0){return F.join(", ")+" are invalid properties"}if(E.length>0){return"The from attribute must be one of: local, remote, or inline"}if(C.length>0){return"Inlined attachments must have an attachment name"}return"pass"}}},getExtraDataAttributes:function(B){j(B);return{"vellum:role":"SaveToCase"}},dataChildFilter:function(D,B){function F(G,H,J){H=H?H:[];var I=new v.Node(H,{getNodeID:function(){return G},p:{rawDataAttributes:null},options:{getExtraDataAttributes:function(K){return J}}});return I}function C(H,G){return y.chain(H).map(function(J,I){if(I){return F(I,[],y.pick(J,G))}}).compact().value()}var E=[];if(u(B)){E.push(F("create",C(B.p.createProperty)))}if(f(B)){E.push(F("update",C(B.p.updateProperty)))}if(x(B)){E.push(F("close"))}if(m(B)){E.push(F("index",C(B.p.indexProperty,["case_type","relationship"])))}if(A(B)){E.push(F("attachment",C(B.p.attachmentProperty,["from","name"])))}return[new v.Node(E,{getNodeID:function(){return"c:case"},p:{rawDataAttributes:null},options:{getExtraDataAttributes:function(G){return{"xmlns:c":i,case_id:"",date_modified:"",user_id:"",}}}})]},getBindList:function(B){var C=[];function D(F,E){return y.chain(E).omit("").map(function(H,G){return{nodeset:B.absolutePath+"/case/"+F+"/"+G,calculate:H.calculate,relevant:H.relevant}}).value()}if(u(B)){C=C.concat(D("create",B.p.createProperty))}if(f(B)){C=C.concat(D("update",B.p.updateProperty))}if(x(B)){C.push({nodeset:B.absolutePath+"/case/close",relevant:B.p.closeCondition})}if(m(B)){C=C.concat(D("index",B.p.indexProperty))}if(A(B)){C=C.concat(y.chain(B.p.attachmentProperty).omit("").map(function(F,E){return{nodeset:B.absolutePath+"/case/attachment/"+E+"/@src",calculate:F.calculate}}).value())}if(c(B)){C.push({nodeset:B.absolutePath+"/case/@date_modified",calculate:B.p.date_modified,type:"xsd:dateTime"});C.push({nodeset:B.absolutePath+"/case/@user_id",calculate:B.p.user_id});if(!u(B)){C.push({nodeset:B.absolutePath+"/case/@case_id",calculate:B.p.case_id})}}return C},parseDataNode:function(D,C){var G=C.children(),F=G.find("create"),H=G.find("close"),I=G.find("update"),E=G.find("index"),B=G.find("attachment");if(F&&F.length!==0){D.p.useCreate=true}if(I&&I.length!==0){D.p.useUpdate=true}if(H&&H.length!==0){D.p.useClose=true}if(E&&E.length!==0){D.p.useIndex=true;D.p.indexProperty={};y.each(E.children(),function(K){var J=g(K);D.p.indexProperty[J.prop("tagName")]={case_type:J.attr("case_type"),relationship:J.attr("relationship")}})}if(B&&B.length!==0){D.p.useAttachment=true;if(!D.p.attachmentProperty){D.p.attachmentProperty={}}y.each(B.children(),function(K){var J=g(K);D.p.attachmentProperty[J.prop("tagName")]={from:J.attr("from"),name:J.attr("name")}})}return g([])}},h={SaveToCase:[{slug:"main",displayName:"Basic",properties:["nodeID","date_modified","user_id","case_id",],},{slug:"create",displayName:"Create",properties:["useCreate","createProperty",],isCollapsed:function(B){return !u(B)},},{slug:"update",displayName:"Update",properties:["useUpdate","updateProperty",],isCollapsed:function(B){return !f(B)},},{slug:"close",displayName:"Close",properties:["useClose","closeCondition",],isCollapsed:function(B){return !x(B)},},{slug:"index",displayName:"Index",properties:["useIndex","indexProperty",],isCollapsed:function(B){return !m(B)},},{slug:"attachment",displayName:"Attachments",properties:["useAttachment","attachmentProperty",],isCollapsed:function(B){return !A(B)},},]};g.vellum.plugin("saveToCase",{},{getAdvancedQuestions:function(){return this.__callOld().concat(["SaveToCase"])},handleMugParseFinish:function(C){this.__callOld();if(!u(C)){return}var B=y.object(y.map(C.form.getSetValues(),function(E){return[E.ref,E]})),D=new RegExp(C.p.nodeID+"/case/@case_id$");y.each(B,function(E){if(D.test(E.ref)){C.p.case_id=E.value}})},getMugTypes:function(){var B=this.__callOld();B.normal.SaveToCase=a.extend(q.defaultOptions,n);return B},getSections:function(B){if(h.hasOwnProperty(B.__className)){return y.map(h[B.__className],function(D){var C=y.clone(D);if(y.isFunction(C.isCollapsed)){C.isCollapsed=C.isCollapsed(B)}return C})}return this.__callOld()},parseBindElement:function(D,E,O){var F=D.getMugByPath(O);if(!F){var J=/\/case\/(?:(create|update|index)\/(\w+)|(close|@date_modified|@user_id|@case_id))$/,K=O.match(J),N;if(K&&K.length>0){N=O.replace(J,"");F=D.getMugByPath(N);if(F&&F.__className==="SaveToCase"){if(K[2]){var B=K[2],L={create:"createProperty",update:"updateProperty",index:"indexProperty",attachment:"attachmentProperty",}[K[1]];if(!F.p[L]){F.p[L]={}}if(!F.p[L][B]){F.p[L][B]={}}F.p[L][B].calculate=E.attr("calculate");if(E.attr("relevant")){F.p[L][B].relevant=E.attr("relevant")}return}else{var G={close:{mugProp:"closeCondition",elAttr:"relevant"},"@date_modified":{mugProp:"date_modified",elAttr:"calculate"},"@user_id":{mugProp:"user_id",elAttr:"calculate"},"@case_id":{mugProp:"case_id",elAttr:"calculate"},}[K[3]];F.p[G.mugProp]=E.attr(G.elAttr);return}D.parseWarnings.push("An error occurred when parsing bind node ["+O+"]. Please fix this.");return}}var C=/\/case\/attachment\/(\w+)\/@src$/,I=O.match(C);if(I){N=O.replace(C,"");F=D.getMugByPath(N);if(F&&F.__className==="SaveToCase"){var H=F.p.attachmentProperty,M=I[1];if(!H[M]){H[M]={}}F.p.attachmentProperty[M].calculate=E.attr("calculate");return}}}this.__callOld()}})});