define(["require","underscore","xpath","vellum/tree","vellum/logic","vellum/widgets","vellum/util"],function(g,r,l,o,n,k,a){var m,h;g(["vellum/writer","vellum/exporter"],function(t,u){m=t;h=u});var j=function(t){var u={};u.message=t.message;u.key=t.key;u.level=t.level||"form-warning";u.options=t;u.isMatch=function(v){if(this.key&&v.key){return this.key===v.key}return false};return u};function b(t){t.id=t.id||i(t.uri);r.each(t.levels,function(w){var v=1,u={};r.each(w.subsets,function(x){x.id=v++;x.selector=p(x.selector);u[x.id]=x});w.subsets=u});return t}function p(t){return q(c(t))}function c(t){return t.replace(/\s*([=\[\]])\s*/g,function(u,v){return v})}function q(u){var t="";f(u,function(v){t+=v},function(v){if(v==='"'){v="'"}t+=v});return t}function f(z,u,B){var A=false,C=false,t=false;for(var x=0,v=z.length;x<v;x++){var y=z[x],w=C||t;if(!A&&((C&&y==="'")||(t&&y==='"'))){w=false}(w?u:B)(y);if(!A){if(y==="'"&&!t){C=!C}else{if(y==='"'&&!C){t=!t}}}if(y==="\\"){A=!A}else{A=false}}}function i(t){return t.toLowerCase().replace(/ /g,"_").replace(/[^\w-]+/g,"")}var d=function(v,w,u,y){var x={},t={};x.attributes=v;x.children=w||[];x.addReference=function(z,A){if(!t){return}if(!z){t=null}else{if(!t[z.ufid]){t[z.ufid]={}}t[z.ufid][A||"."]=null}};x.dropReference=function(z,A){if(t&&t[z.ufid]){if(A){delete t[z.ufid][A];if(r.isEmpty(t[z.ufid])){delete t[z.ufid]}}else{delete t[z.ufid]}return r.isEmpty(t)}return false};if(!r.isUndefined(u)){x.addReference(u,y)}return x};var s=/(^)instance\((['"])([^'"]+)\2\)/i;function e(v,u,t){var w=this;this.setValues=[];this._setValueId=1;this._logicManager=new n.LogicManager(this,{allowedDataNodeReferences:v.allowedDataNodeReferences});this.vellum=u;this.mugTypes=t;this.formName="New Form";this.mugMap={};this.tree=new o("data","control");this.tree.on("change",function(x){w.fireChange(x.mug)});this.instanceMetadata=[d({})];this.knownInstances={};this.enableInstanceRefCounting=v.enableInstanceRefCounting;this.errors=[];this.question_counter=1;a.eventuality(this)}e.prototype={dataTree:function(){var t=this.getBasePath().slice(1,-1),v=new o(t,"data"),u={},w=this;this.tree.walk(function(x,y,A){if(x){if(x.options.isControlOnly){return}else{if(x.p.dataParent){var z=x.p.dataParent;if(u[z]){u[z].push(x)}else{u[z]=[x]}}else{v.insertMug(x,"into",x.parentMug)}}}A()});r.each(u,function(B,A){var y=w.mugMap[A];for(var z=0,x=B.length;z<x;z++){v.insertMug(B[z],"into",y)}});return v},getBasePath:function(t){return"/"+this.tree.getRootNode().getID()+(t?"":"/")},fireChange:function(t){this.fire({type:"change",mug:t})},addInstanceIfNotExists:function(u,t,x){function w(C,B){var z=(C||"data")+"-",A=1;while(!C||B.hasOwnProperty(C)){C=z+A;A++}return C}var y;if(u.src){y=r.find(this.instanceMetadata,function(z){return z.attributes.src===u.src});if(!y){var v=r.chain(this.instanceMetadata).map(function(z){return[z.attributes.id,z]}).object().value();y=u.id&&v.hasOwnProperty(u.id)?v[u.id]:null;if(y&&y.internal){y.internal=false;y.attributes.src=u.src}else{u=r.clone(u);u.id=w(u.id,v);y=null}this.knownInstances[u.id]=u.src}}else{if(u.id){y=r.find(this.instanceMetadata,function(z){return z.attributes.id===u.id});if(y){if(y.internal&&this.knownInstances.hasOwnProperty(u.id)){y.internal=false;y.attributes.src=this.knownInstances[u.id]}}else{if(this.knownInstances.hasOwnProperty(u.id)){u.src=this.knownInstances[u.id]}}}else{throw new Error("unsupported: non-primary instance without id or src")}}if(!y){y=d({src:u.src,id:u.id},null,t||null,x);if(!u.src){y.internal=true}this.instanceMetadata.push(y);return u.id}else{if(this.enableInstanceRefCounting){y.addReference(t,x)}}return y.attributes.id},parseInstance:function(y,u,x){var v=y.match(s),t=null;if(v){var w=v[3],z=this.referenceInstance(w,u,x);if(z){t=r.clone(z.attributes)}}return t},parseInstanceRefs:function(w,u,v){var y=new n.LogicExpression(w),t=this.knownInstances,x={};y.analyze();r.each(y.instanceRefs,function(A,z){if(t.hasOwnProperty(z)&&t[z]){x[z]=t[z]}});return x},referenceInstance:function(x,t,u){function w(y){return y.attributes.id===x}var v=r.find(this.instanceMetadata,w);if(this.enableInstanceRefCounting){if(v){v.addReference(t,u)}else{x=this.addInstanceIfNotExists({id:x},t,u);v=r.find(this.instanceMetadata,w)}}return v||null},updateInstanceQuery:function(v,t,w){var u=s;if(w){u=new RegExp("(^|W)instance\\((['\"])"+RegExp.escape(w)+"\2\\)","ig")}return v.replace(u,"$1instance('"+t+"')")},updateKnownInstances:function(u){var t=this.knownInstances;if(u){var v=r.chain(this.instanceMetadata).map(function(w){return[w.attributes.id,w]}).object().value();r.each(u,function(x,y){if(x&&!t.hasOwnProperty(y)){t[y]=x;var w=v[y];if(w&&w.internal){w.internal=false;w.attributes.src=x}}})}else{r.each(this.instanceMetadata,function(w){if(w.attributes.id&&w.attributes.src){t[w.attributes.id]=w.attributes.src}})}},dropInstanceReference:function(w,t,u){if(!this.enableInstanceRefCounting||!t){return false}var v=r.find(this.instanceMetadata,function(x){return x.attributes.src===w});if(v){if(v.dropReference(t,u)){this.instanceMetadata=r.without(this.instanceMetadata,v);return true}}return false},dropAllInstanceReferences:function(t,u){this.instanceMetadata=r.filter(this.instanceMetadata,function(v){return !v.dropReference(t,u)})},addSetValue:function(u,t,v){var w=r.find(this.setValues,function(x){return x.event===u&&x.ref===t});if(w){w.value=v}else{w={_id:this._setValueId++,event:u,ref:t,value:v};this.setValues.push(w)}return w},getSetValues:function(){return this.setValues},dropSetValues:function(t){this.setValues=r.reject(this.setValues,t)},setFormID:function(t){this.tree.setRootID(t)},setAttr:function(t,u){this[t]=u;this.fire({type:"change"})},createXML:function(){return m.createXForm(this)},getMugList:function(){return this.tree.treeMap(function(t){if(t.isRootNode){return}return t.getValue()})},updateError:function(u){u=j(u);if(!u.key){this.errors.push(u)}else{var v=null;for(var t=0;t<this.errors.length;t++){if(u.isMatch(this.errors[t])){v=this.errors.splice(t,1,u)}}if(!v){this.errors.push(u)}}},getSerializationWarnings:function(){var t=[];this.walkMugs(function(v){var u=v.getSerializationWarnings();if(u.length){t.push({mug:v,errors:u})}});return t},fixSerializationWarnings:function(t){r.each(t||[],function(u){u.mug.fixSerializationWarnings(u.errors)})},isFormValid:function(t){return this.tree.isTreeValid(t)},findFirstMatchingChild:function(t,u){var v=(t?this.tree.getNodeFromMug(t):this.tree.rootNode);return r.find(v.getChildrenMugs(),u)},insertMug:function(v,u,t){this.tree.insertMug(u,t,v)},moveMug:function(A,z,v){function y(E){return E!==A&&E.p.nodeID===x}var x,w,u,C,t;if(z==="rename"){x=v;if(!this.tree.getNodeFromMug(A)){A.p.set("nodeID",x);return}w=A.p.nodeID;u=this.tree.getAbsolutePath(A);C=t=A.parentMug}else{w=A.p.nodeID;u=this.tree.getAbsolutePath(A);C=A.parentMug;this.insertMug(v,A,z);var D=A.spec.dataParent;if(D&&D.validationFunc(A)!=="pass"){A.p.set("dataParent")}x=A.p.conflictedNodeId||w;t=A.parentMug}if(!A.options.isControlOnly){if(this.findFirstMatchingChild(t,y)){A.p.conflictedNodeId=x;x=this.generate_question_id(x,A)}else{if(A.p.has("conflictedNodeId")){A.p.conflictedNodeId=null}}if(A.p.nodeID!==x){A.p.set("nodeID",x)}}var B=this.tree.getAbsolutePath(A);this.vellum.handleMugRename(this,A,x,w,B,u,C);if(z!=="rename"){this.fireChange(A)}},walkMugs:function(t){function u(v,w,x){if(v!==null){t(v)}x()}this.tree.walk(u)},getDescendants:function(t){var v=this.getChildren(t),u;for(u=v.length-1;u>=0;u--){v=v.concat(this.getDescendants(v[u]))}return v},handleMugRename:function(D,x,w,E,t,G){function C(I){if(I===E){return t}return I.replace(u,t+"/")}this._logicManager.updatePath(D.ufid,t,E);var H=this.tree;if(!E){return}var v=this.getDescendants(D).concat([D]),B=r(v).map(function(I){return H.getAbsolutePath(I)}),u=new RegExp("^"+RegExp.escape(E)+"/"),F={},y;for(var A=0;A<v.length;A++){if(B[A]){y=C(B[A]);F[v[A].ufid]=[y,B[A]];this._updateMugPath(v[A],y,B[A])}}this._logicManager.updatePaths(F);this.fixBrokenReferences(D);if(w&&D.__className!=="Item"){var z=this.findFirstMatchingChild(G,function(I){return I.p.conflictedNodeId===w});if(z){this.moveMug(z,"rename",w)}}},changeMugType:function(t,u){this.mugTypes.changeType(t,u)},getChildren:function(t){var v=this.tree.getNodeFromMug(t),u=v?v.getChildren():[];return u.map(function(w){return w.getValue()})},duplicateMug:function(t){var y=this._duplicateMug(t,t.parentMug),w=y[0],v=y[1];if(window.analytics){window.analytics.usage("Form Builder","Copy",w.options.typeName)}for(var u=0;u<v.length;u++){var x=v[u];this._logicManager.updatePath(x.mugId,x.from,x.to,this.getAbsolutePath(w))}return w},_duplicateMug:function(u,t,A){A=A||0;var z=this.mugTypes.make(u.__className,this,u);if(A===0){var y=u.p.nodeID;if(z.p.conflictedNodeId){z.p.conflictedNodeId=null}else{z.p.nodeID=this.generate_question_id(y,u)}this.insertQuestion(z,u,"after",true)}else{this.insertQuestion(z,t,"into",true)}this.updateLogicReferences(z);this.vellum.duplicateMugProperties(z);var x=this.getChildren(u),w=[];for(var v=0;v<x.length;v++){w=w.concat(this._duplicateMug(x[v],z,A+1)[1])}w.push({mugId:u.ufid,from:this.getAbsolutePath(u),to:this.getAbsolutePath(z)});return[z,w]},updateLogicReferences:function(t,v,u){this._logicManager.updateReferences(t,v,u)},shouldMugPropertyChange:function(t,w,v,u){if(this.isLoadingXForm){return function(){}}return function(){var x={type:"mug-property-change",mug:t,property:w,val:v,previous:u};t.validate(w);this.fire(x);t.fire({type:"property-changed",property:w,val:v,previous:u});this.fireChange(t)}.bind(this)},createQuestion:function(y,t,w,x){var u=this.mugTypes.make(w,this);if(!u.options.isControlOnly){u.p.nodeID=this.generate_question_id()}if(u.__className==="Item"){var v=y.__className==="Item"?y.parentMug:y;u.p.nodeID=this.generate_item_label(v)}this.insertQuestion(u,y,t,x);if(u.options.isODKOnly){u.addMessage(null,{key:"form-odk-only-warning",level:u.WARNING,message:u.options.typeName+" works on Android devices and some feature phones; please test your specific model to ensure that this question type is supported"})}return u},insertQuestion:function(u,w,t,v){this.mugMap[u.ufid]=u;w=w||this.tree.getRootNode().getValue();this.insertMug(w,u,t);this._updateMugPath(u);this.fire({type:"question-create",mug:u,refMug:w,position:t,isInternal:v});if(!v){u.options.afterInsert(this,u)}},_updateMugPath:function(t,w,u){var v=this.mugMap;delete v[w];if(r.isUndefined(u)){u=this.getAbsolutePath(t)}if(u){v[u]=t}},_fixMugState:function(t){this.mugMap[t.ufid]=t;var u=this.tree.getAbsolutePath(t);if(u){this.mugMap[u]=t}},fixBrokenReferences:function(t){function u(w){v.updateLogicReferences(w)}var v=this;this._logicManager.forEachBrokenReference(u)},getAbsolutePath:function(t,u){if(t&&!t.options.isControlOnly){return this.tree.getAbsolutePath(t,u)}return null},getMugByUFID:function(t){return this.mugMap[t]},getMugByPath:function(t){if(!t){return null}return this.mugMap[t]},removeMugsFromForm:function(x){function v(y){if(y&&!t.hasOwnProperty(y.ufid)){t[y.ufid]=null;w.updateLogicReferences(y)}}var w=this,t={},u={};r.each(x,function(y){w._removeMugFromForm(y,u,false)});this._logicManager.forEachReferencingProperty(u,v)},_removeMugFromForm:function(t,w,y){if(w.hasOwnProperty(t.ufid)){return}w[t.ufid]=null;var x=this.tree.getNodeFromMug(t);if(x){var v=x.getChildrenMugs();for(var u=0;u<v.length;u++){this._removeMugFromForm(v[u],w,true)}delete this.mugMap[this.tree.getAbsolutePath(t)];this.tree.removeMug(t)}if(this.enableInstanceRefCounting){this.instanceMetadata=r.filter(this.instanceMetadata,function(z){return !z.dropReference(t)})}delete this.mugMap[t.ufid];this.fire({type:"question-remove",mug:t,isInternal:y})},isUniqueQuestionId:function(t,u){var w;if(!u){w=this.getMugList()}else{var v=this.tree.getNodeFromMug(u);w=this.tree.getParentNode(v).getChildrenMugs()}return !r.any(w,function(x){return x.p.nodeID===t})},generate_question_id:function(t,v){if(t){var w=/^copy-(\d+)-of-(.+)$/.exec(t);if(w){t=w[2]}var u=t;for(var x=1;;x++){if(this.isUniqueQuestionId(u,v)){return u}u="copy-"+x+"-of-"+t}}else{return this._make_label("question",v)}},generate_item_label:function(t,w,x){var y=(t?this.tree.getNodeFromMug(t):this.tree.rootNode),u=y.getChildrenMugs(),v;if(!w){w="item"}if(arguments.length<3){x=u.length+1}do{v=w+x++}while(r.any(u,function(z){return z.p.nodeID===v}));return v},_make_label:function(t,u){var v;do{v=t+this.question_counter;this.question_counter+=1}while(!this.isUniqueQuestionId(v,u));return v},getExportTSV:function(){this.vellum.beforeSerialize();var t=h.generateExportTSV(this);this.vellum.afterSerialize();return t}};return{Form:e,processInstance:b,normalizeXPathExpr:p,InstanceMetadata:d}});