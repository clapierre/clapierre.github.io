define(["jquery","underscore","vellum/datasources","vellum/widgets","vellum/window",],function(d,j,c,i,g){var h={},f;d.vellum.plugin("databrowser",{},{init:function(){var m=this,l=this.$f.find(".fd-tree"),p=this.$f.find(".fd-accessory-pane"),n,o;h.initDataBrowser=j.once(e);n=p.find(".fd-head-external-sources");o=n.outerHeight(true)||0;p.data("min-size",o).height(l.height()*0.45).resize(function(){if(p.height()>o+100){f=p.height()}});h.initDataBrowser(m);g.preventDoubleScrolling(p.find(".fd-scrollable"));c.getDataSources(function(){});var k=j.partial(b,m);p.parent().find(".fd-external-sources-divider").clickExceptAfterDrag(k);n.click(k)}});function e(k){var n=k.$f.find(".fd-external-sources-container"),m=n.find(".fd-external-resource-search input"),l=n.find(".fd-external-sources-tree");l.jstree({core:{data:function(o,q){if(o.data&&o.data.getNodes){q.call(this,o.data.getNodes())}else{var p=this;c.getDataSources(function(r){q.call(p,a(r,k))})}},worker:false,multiple:false,check_callback:function(p,s,r,o,q){return false}},search:{show_only_matches:true},conditionalevents:{should_activate:function(){return false}},plugins:["themes","conditionalevents","dnd","search"]});m.keyup(j.debounce(function(){l.jstree(true).search(m.val())},250))}function a(r,q){function p(x,y){return function(A,C){var B=x?(x+"/"+C):C,z=w(A,C,B,y);return{text:z.name,icon:z.nodes===true||z.nodes.length?"fcc fcc-fd-external-case":"fcc fcc-fd-external-case-data",state:{opened:z.nodes!==true&&z.nodes.length<=t},children:z.nodes,data:{handleDrop:j.partial(v,B,y),getNodes:z.getNodes,}}}}function w(A,E,D,C){var x={name:A.name||E},B=A;if(!A.structure&&A.reference){var z=A.reference;B=m[z.source||C.id];if(B){C=j.extend(j.omit(B,"structure"),{_parent:C});D="instance('"+B.id+"')"+B.path+"["+z.key+"="+D+"]";if(B.subsets&&z.subset){B=j.findWhere(B.subsets,{id:z.subset,key:"@case_type"})||B}var y=B.name||B.id;if(y){x.name=x.name+" ("+y+")"}if(l.hasOwnProperty(B.id)){x.nodes=true;x.getNodes=j.partial(s,B,D,C);return x}l[B.id]=true}}x.nodes=s(B,D,C);return x}function s(y,A,z){var x=j.chain(y&&y.structure).map(p(A,z)).sortBy("text").value();if(y&&y.related){x=j.chain(y.related).map(function(D,C){var B={reference:{subset:D,key:"@case_id"}};return p(A+"/index",z)(B,C)}).sortBy("text").value().concat(x)}return x}function v(A,z,y){var x=i.util.getWidget(y,q);while(z){var B=x.addInstanceRef({id:z.id,src:z.uri});if(B!==z.id){A=x.mug.form.updateInstanceQuery(A,B,z.id)}z=z._parent}q.handleDropFinish(y,A)}var t=50,m=j.chain(r).map(function(x){return[x.id,x]}).object().value(),n=[],l={};if(m.commcaresession){var k=m.commcaresession,o=j.omit(k,"structure"),u="instance('"+k.id+"')"+k.path;n=p(null,o)(k,u).children}return n}function b(m){var o=m.$f.find(".fd-accessory-pane"),n=o.find(".fd-head-external-sources").outerHeight(true);if(o.height()>n){o.css("height",n+"px");d(window).resize()}else{var l=m.$f.find(".fd-tree"),k=f||l.height()*0.45;o.css("height",k+"px");d(window).resize();h.initDataBrowser(m)}}return h});