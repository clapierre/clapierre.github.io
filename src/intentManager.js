define(["vellum/mugs","vellum/widgets","vellum/util","underscore","jquery","tpl!vellum/templates/intent_templates","vellum/core"],function(i,j,a,s,c,n){var h="http://opendatakit.org/xforms",k=["androidIntentAppId","docTemplate","androidIntentExtra","androidIntentResponse","unknownAttributes","intentXmlns",],g;function m(w,v){return{androidIntentAppId:v||"",intentXmlns:h,androidIntentExtra:{},androidIntentResponse:{},unknownAttributes:{},nodeID:w}}function f(w,x){var A=j.text(w,x),v=A.input,z=x.vellum.opts().intents,C=c(n({templates:z&&z.templates||[]})),y=s.object(s.map(z&&z.templates,function(D){return[D.id,D]})),B=c('<div class="control-row row" />').append(c('<div class="span8" />').append(v)).append(c('<div class="span4" />').append(C));C.find(".dropdown-menu a").click(function(E){E.preventDefault();var F=c(this).data("id");v.val(F).change();if(F&&y.hasOwnProperty(F)){var D=v.parents(".fd-props-content").first();s.each({extra:"[name=property-androidIntentExtra]",response:"[name=property-androidIntentResponse]",},function(G,I){var J=y[F].hasOwnProperty(I)?y[F][I]:{},K=D.find(G),H=j.util.getWidget(K,x.vellum);H.setValue(J);H.handleChange()})}});A.getControl=function(){return B};return A}var l=function(x,w){var v={};s.each(x.find(w),function(z){var y=c(z),A=y.attr("key"),B;B=y.attr("ref");if(v.hasOwnProperty(A)){if(s.isArray(v[A])){v[A].push(B)}else{v[A]=[v[A],B]}}else{v[A]=B}});return v};var o=function(v,x,w){if(w){s.each(w,function(z,y){if(y){s.each(s.isArray(z)?z:[z],function(A){v.writeStartElement(x);v.writeAttributeString("key",y);v.writeAttributeString("ref",A);v.writeEndElement()})}})}};function d(v,w){v.writeStartElement("odkx:intent");v.writeAttributeString("xmlns:odkx",w.intentXmlns);v.writeAttributeString("id",w.nodeID);v.writeAttributeString("class",w.androidIntentAppId);s.each(w.unknownAttributes,function(y,x){v.writeAttributeString(x,y)});o(v,"extra",w.androidIntentExtra);if(w.docTemplate){o(v,"extra",{"cc:print_template_reference":"'"+w.docTemplate+"'"})}o(v,"response",w.androidIntentResponse);v.writeEndElement("odkx:intent")}function b(v){var w={};s.each(v,function(A){var x,z,y;x=c(A);z=x.attr("id");y=m(z,x.attr("class"));y.xmlns=x.attr("xmlns:odkx")||y.intentXmlns;y.androidIntentExtra=l(x,"extra");y.androidIntentResponse=l(x,"response");s.chain(A.attributes).filter(function(B){return !s.contains(["id","class","xmlns:odk"],B.nodeName)}).each(function(B){y.unknownAttributes[B.nodeName]=B.nodeValue});w[z]=y});return w}function p(x,w){if(w.__className==="AndroidIntent"||w.__className==="PrintIntent"){var y=w.p.nodeID,v=x.hasOwnProperty(y)?x[y]:m(y);s.each(k,function(z){if(!w.p[z]){w.p[z]=v[z]}});delete x[v.nodeID]}if(w.p.androidIntentAppId==="org.commcare.dalvik.action.PRINT"){w.form.changeMugType(w,"PrintIntent")}if(w.__className==="PrintIntent"){if(w.p.androidIntentExtra["cc:print_template_reference"]){w.p.docTemplate=w.p.androidIntentExtra["cc:print_template_reference"].replace(/^'|'$/g,"");delete w.p.androidIntentExtra["cc:print_template_reference"]}else{w.p.docTemplate="jr://file/commcare/text/"+w.p.nodeID+".html"}}}function q(x,w,v){s.each(x,function(y){d(w,y)});v.treeMap(function(z){var y=z.getValue();if(y&&y.options.dataType==="intent"){d(w,y.p)}})}function e(y,w,v,x){x[w]=s.clone(v.p[w]);if(x[w][""]===""){delete x[w][""]}}function r(x){var y=/{{\s*([^}\s]+)\s*}}/gm,w=y.exec(x),v={};while(w){s.each(w.splice(1),function(z){v[z]=z});w=y.exec(x)}return v}var u=a.extend(i.defaultOptions,{typeName:"Android App Callout",dataType:"intent",tagName:"input",icon:"icon-vellum-android-intent",isODKOnly:true,isTypeChangeable:false,init:function(v,w){v.p.intentXmlns=v.p.intentXmlns||h},spec:{androidIntentAppId:{lstring:"Intent ID",visibility:"visible",widget:f,placeholder:"Insert Android Application ID",deserialize:function(x,w,v){if(x.intent){v.p.androidIntentAppId=x.intent.path||"";s.each([["intentXmlns","xmlns"],["androidIntentExtra","extra"],["androidIntentResponse","response"],["unknownAttributes","unknownAttributes"],],function(A){var y=A[0],z=A[1];if(!s.isEmpty(x.intent[z])){v.p[y]=x.intent[z]}})}else{v.p[w]=x[w]}}},androidIntentExtra:{lstring:"Extra",visibility:"visible",widget:j.baseKeyValue,serialize:e,},androidIntentResponse:{lstring:"Response",visibility:"visible",widget:j.baseKeyValue,serialize:e,},unknownAttributes:{visibility:"hidden",presence:"optional",serialize:e,},intentXmlns:{visibility:"hidden",presence:"optional",lstring:"Special Intent XMLNS attribute",}},getAppearanceAttribute:function(v){return"intent:"+v.p.nodeID}});var t=a.extend(u,{typeName:"Print",icon:"icon-print",init:function(v,w){u.init(v,w);v.p.androidIntentAppId="org.commcare.dalvik.action.PRINT"},spec:{docTemplate:{lstring:"Document Template",visibility:"visible",widget:j.media,},androidIntentAppId:{visibility:"hidden"},androidIntentResponse:{visibility:"hidden"},}});c.vellum.plugin("intents",{},{init:function(){g=this.refreshCurrentMug.bind(this)},loadXML:function(v){this.data.intents.unmappedIntentTags=b(c(v).find("h\\:head, head").children("odkx\\:intent, intent"));this.__callOld()},contributeToHeadXML:function(v,w){this.__callOld();q(this.data.intents.unmappedIntentTags,v,w.tree)},handleNewMug:function(v){var w=this.__callOld();p(this.data.intents.unmappedIntentTags,v);return w},handleMugParseFinish:function(v){this.__callOld();p(this.data.intents.unmappedIntentTags,v)},getMugTypes:function(){var v=this.__callOld();v.normal.AndroidIntent=u;v.normal.PrintIntent=t;return v},getAdvancedQuestions:function(){var v=this.__callOld();v.push("AndroidIntent");if(this.opts().features.printing){v.push("PrintIntent")}return v},getMainProperties:function(){return this.__callOld().concat(k)}});return{test:{parseFields:r,}}});