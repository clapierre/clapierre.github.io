define(["jquery","underscore","vellum/widgets","vellum/util","tpl!vellum/templates/data_source_editor"],function(e,s,k,a,o){var c,r,d,q;function m(t){c=t;r=c.opts().core.dataSourcesEndpoint;p()}function p(){d=null;q=null}function j(u){if(d){u(d);return}if(q){q.push(u);return}function t(v){d=v.length?v:[{id:"",uri:"",path:"",name:"Not Found",structure:{}}];s.each(q,function(w){w(d)});q=null}q=[u];if(r){if(s.isString(r)){e.ajax({type:"GET",url:r,dataType:"json",success:t,error:function(w,x,v){t([]);window.console.log(a.formatExc(v||x))},data:{}})}else{r(t)}}else{t([])}}function i(u,v){var A=e(o()),z=A.find("[name=instance-id]"),y=A.find("[name=instance-src]"),x=A.find("[name=query]");u.empty().append(A);if(v.source){z.val(v.source.id||"");y.val(v.source.src||"");x.val(v.source.query||"")}function w(){return{id:z.val(),src:y.val(),query:x.val()}}if(v.change){z.on("change keyup",function(){v.change(w())});y.on("change keyup",function(){v.change(w())});x.on("change keyup",function(){v.change(w())})}var t=function(B){u.find(".fd-data-source-editor").hide();v.done(B)};A.find(".fd-data-source-save-button").click(function(){t(w())});A.find(".fd-data-source-cancel-button").click(function(){t()});if(v.onLoad){v.onLoad(A)}}function h(y,C,u){var x=k.text(y,C),D=k.util.getUIElement,w=k.util.getUIElementWithEditButton,A=x.getValue,z=x.setValue,B=null;x.getUIElement=function(){var E=w(D(x.input,u),function(){c.displaySecondaryEditor({source:v(),headerText:u,loadEditor:i,onLoad:function(F){k.util.setWidget(F,x)},done:function(F){if(!s.isUndefined(F)){t(F);x.handleChange()}}})});return e("<div></div>").append(E)};function v(){B.query=A();return B}function t(E){B=E;z(E.query||"")}x.getValue=v;x.setValue=t;return x}function n(y,G,v){var B="Lookup table was not found in the project",t=JSON.stringify({src:"",id:"",query:""});function E(H){return !H||s.all(s.map(H,s.isEmpty))}function w(){return JSON.parse(D())}function u(I){var H=t;if(!E(I)){H=JSON.stringify(I);if(!x.equivalentOption(H)){x.addOption(H,B)}}A(H);F=true}var x=k.dropdown(y,G),D=x.getValue,A=x.setValue,z=G.getSource?G.getSource:w,C=G.setSource?G.setSource:u,F=false;x.addOption(t,"Loading...");j(function(J){var I;if(G.dataSourcesFilter){J=G.dataSourcesFilter(J)}if(F){I=w()}x.clearOptions();var H=b(J);x.addOptions(g(H));if(F&&!E(I)){u(I)}else{if(H&&H.length){u(s.omit(H[0],"name"))}}if(G.onOptionsLoaded){G.onOptionsLoaded(J)}});if(G.hasAdvancedEditor){x.getUIElement=function(){var H=k.util.getUIElementWithEditButton(k.util.getUIElement(x.input,v),function(){c.displaySecondaryEditor({source:z(y),headerText:v,loadEditor:i,done:function(I){if(!s.isUndefined(I)){C(I,y);x.handleChange()}}})});H.find(".fd-edit-button").text("...");H.find(".controls").css("margin-right","48px");return e("<div></div>").append(H)}}x.getValue=w;x.setValue=u;return x}function b(t){function u(v,w){return s.map(v,function(A,y){var x=[],z={id:w.id,src:w.src,query:w.query+"/"+y,name:w.name+" - "+(A.name||y),};if(!(s.isEmpty(A.structure)||A.no_option)){x=[z]}return x.concat(u(A.structure,z))})}return s.flatten(s.map(t,function(w){var v={id:w.id,src:w.uri,query:"instance('"+w.id+"')"+w.path,name:w.name||w.id};return[v].concat(u(w.structure,v))}))}function g(t){return s.map(t,function(u){return{value:JSON.stringify(s.omit(u,"name")),text:u.name}})}function f(u){function t(v){return s.map(v,function(x,w){return[w].concat(s.map(t(x.structure),function(y){return w+"/"+y}))})}if(u){return s.flatten(t(u.structure))}return[]}function l(v,t){var u=s.find(v,function(w){return w.uri===t});return u?f(u):[]}return{init:m,reset:p,getDataSources:j,advancedDataSourceWidget:h,fixtureWidget:n,autocompleteChoices:l,getPossibleFixtures:b}});