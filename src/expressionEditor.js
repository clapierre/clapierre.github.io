define(["jquery","underscore","vellum/debugutil","vellum/util","xpath","xpathmodels","tpl!vellum/templates/xpath_validation_errors","tpl!vellum/templates/xpath_expression","tpl!vellum/templates/xpath","less!vellum/less-style/xpath-editor"],function(e,p,a,f,i,d,h,c,l){var j={};var n=[];var m=d.XPathExpressionTypeEnum;var k={toString:function(s,r,q){return"("+r+") "+d.expressionTypeEnumToXPathLiteral(s)+" ("+q+")"},typeLeftRight:function(q){return q}};var b={toString:function(s,r,q){return s+"("+r+", "+q+")"},typeLeftRight:function(q){if(q.args.length!==2){return false}return{type:q.id,left:q.args[0],right:q.args[1]}}};function o(s,r,q){r=d.expressionTypeEnumToXPathLiteral(r);j[r]=s;n.push([q,r])}o(k,m.EQ,"is equal to");o(k,m.NEQ,"is not equal to");o(k,m.LT,"is less than");o(k,m.LTE,"is less than or equal to");o(k,m.GT,"is greater than");o(k,m.GTE,"is greater than or equal to");o(b,"selected","has selected value");function g(H,s){var w=H;s=p.defaults(s,{leftPlaceholder:"Hint: drag a question here.",rightPlaceholder:"Hint: drag a question here.",});var v=function(){return H.find(".fd-xpath-editor-text")};var z=function(){return H.find(".fd-xpath-validation-summary")};var E=function(){return H.find(".fd-xpath-editor-expressions")};var D=function(){return e(w.find(".top-level-join-select")[0])};var u=function(I,J){if(J){f.dropdownAutocomplete(I,J)}else{f.questionAutocomplete(I,s.mug,{property:s.path})}};var F=function(){var M=E();var J=[];var L=D().val();M.children().each(function(){var P=e(e(this).find(".left-question")[0]).val();var O=e(e(this).find(".right-question")[0]).val();if(P===""&&O===""){return}var Q=e(e(this).find(".op-select")[0]).val();var N=j[Q].toString(Q,P,O);J.push(N)});var I=J.join(" "+L+" ");var K=B(I);if(K[0]&&K[1]){return K[1].toXPath()}return I};var C=function(){if(H.find(".xpath-simple").hasClass("hide")){return v().val()}else{return F()}};var B=function(K){if(K){try{var I=i.parse(K);return[true,I]}catch(J){return[false,J]}}return[true,null]};var x=function(I,M){if(I&&s.DEBUG_MODE){a.log("trying to add",I.toString())}var O=function(S){return(S instanceof d.XPathBoolExpr)};var L=function(S){return(S instanceof d.XPathCmpExpr||S instanceof d.XPathEqExpr||j.hasOwnProperty(S.id))};var J=function(W){var T=e(c({operationOpts:n,leftPlaceholder:s.leftPlaceholder,rightPlaceholder:s.rightPlaceholder}));var U=function(){return e(T.find(".left-question")[0])};var S=function(){return e(T.find(".right-question")[0])};var X=function(aa){s.change();var Y=U().val(),Z=S().val();T.find(".validation-results").addClass("hide");if(Y&&B(Y)[0]&&Z&&B(Z)[0]){T.find(".validation-results.alert-success").removeClass("hide")}else{T.find(".validation-results.alert-error").removeClass("hide")}};var V=function(Y,Z,aa){Y.val(Z.toXPath())};T.find(".xpath-edit-node").on("keyup change",X);T.find(".xpath-delete-expression").click(function(){T.remove()});if(W){if(s.DEBUG_MODE){a.log("populating",W.toString())}if(j.hasOwnProperty(W.id)){W=j[W.id].typeLeftRight(W);if(!W){return false}}V(U(),W.left);T.find(".op-select").val(d.expressionTypeEnumToXPathLiteral(W.type));V(S(),W.right,W.left)}u(U(),s.leftAutocompleteChoices);u(S(),s.rightAutocompleteChoices);return T};var N=function(){E().empty();if(s.DEBUG_MODE){a.log("fail",I)}return false};var Q=E();var R,P,K;if(!I){R=J();return R.appendTo(Q)}else{if(L(I)){R=J(I);if(!R){return N()}return R.appendTo(Q)}else{if(O(I)){if(M&&I.type!==M){return N()}P=x(I.left,I.type);K=x(I.right,I.type);if(P&&K){P.appendTo(Q);K.appendTo(Q);D().val(I.type)}else{return N()}return K}else{return N()}}}};var q=function(K){if(s.DEBUG_MODE){a.log("setting ui for",K)}var J=B(K);if(J[0]){var I=J[1];if(x(I)){}else{r(I.toXPath(),true)}}else{r(K,true)}};var G=function(I){z().text("").addClass("hide");var J=E();J.empty();if(I.xpathType==="bool"){y(I.value);if(!I.value){H.find(".fd-add-exp").click()}}else{r(I.value)}H.find(".fd-xpath-editor-text").val(I.value)};var r=function(J,I){v().val(J);u(v());E().empty();H.find(".xpath-advanced").removeClass("hide");H.find(".xpath-simple").addClass("hide");H.find(".fd-xpath-actions").removeClass("form-actions-condensed");if(I){H.find(".xpath-advanced-notice").removeClass("hide")}else{H.find(".xpath-advanced-notice").addClass("hide")}};var y=function(I){H.find(".xpath-simple").removeClass("hide");H.find(".fd-xpath-actions").addClass("form-actions-condensed");H.find(".xpath-advanced").addClass("hide");E().empty();if(I){q(I)}};var t=function(){var J=e(l({topLevelJoinOpts:[["True when ALL of the expressions are true.",m.AND],["True when ANY of the expressions are true.",m.OR]]}));w.empty().append(J);J.find(".fd-xpath-show-advanced-button").click(function(){if(window.analytics){window.analytics.usage("Form Builder","Edit Expression","Show Advanced Mode")}r(F())});J.find(".fd-xpath-show-simple-button").click(function(){y(v().val())});J.find(".fd-add-exp").click(function(){x()});J.find(".fd-xpath-editor-text").on("change keyup",function(){s.change()});var I=function(K){H.find(".fd-xpath-editor").hide();s.done(K)};J.find(".fd-xpath-save-button").click(function(){var K=C();v().val(K);var L=B(K),M=K.match("instance\\(");if(L[0]||M){if(M){window.alert("This expression is too complex for us to verify; specifically, it makes use of the 'instance' construct. Please be aware that if you use this construct you're on your own in verifying that your expression is correct.")}I(K)}else{z().html(e(h({errors:L[1]}))).removeClass("hide")}});J.find(".fd-xpath-cancel-button").click(function(){I(false)});return J};var A=t();G(s);if(s.onLoad){s.onLoad(A)}}return{showXPathEditor:g}});