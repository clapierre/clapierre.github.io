define(["jquery","underscore","tpl!vellum/templates/copy_paste_help","vellum/mugs","vellum/tsv","vellum/core"],function(g,y,q,r,w){var l=["Form Builder clip","version 1"],f,v={top:-10000,left:-10000},s=g("<textarea></textarea>").css({position:"absolute",width:0,height:0}).css(v).appendTo("body"),k=/Mac/.test(navigator.platform),b=/Chrome/.test(navigator.userAgent),x=/Safari/.test(navigator.userAgent)&&!b;function o(B,A){if(B.length===0){B=g("body")}s.css({top:B.offset().top});s.val(A);s.focus();s.select()}function p(C,A){C.focus();var B=s.val();if(A&&B){s.val("")}return B}function h(A){var C=g(":focus");if(C.is(".jstree-anchor")){var B=A.cut();if(B){o(C,B);setTimeout(function(){p(C)},10)}}}function j(A){var C=g(":focus");if(C.is(".jstree-anchor")){var B=A.copy();if(B){o(C,B);setTimeout(function(){p(C)},10)}}}function c(A){var B=g(":focus");if(B.length===0||B.parents(".fd-tree").length||B.is(s)){o(B);setTimeout(function(){var C=p(B,true);if(C){var D=A.paste(C);if(D.length){f._resetMessages([{level:"parse-warning",message:D,}])}}},0)}}var i=/^(null|true|false|\[[^]*\]|\{[^]*\}|"[^]*"|-?\d+(\.\d+)?([Ee][+-]?\d+)?)$/;function u(A){if(y.isString(A)&&!i.test(A)){return A}return JSON.stringify(A)}function z(A){if(i.test(A)){return JSON.parse(A)}return A}function n(D){var F=1,C=2,A=3,E="1",B=/^(.*)Itext(?::([^-]+)-(.*))?$/.exec(D);if(B){E="0";if(B[F]==="label"){B[F]="!"}if(B[A]==="default"){B[A]="!"}else{if(!B[A]){B[A]="~"}}D=B[F]+" "+B[A]+" "+B[C]}return E+D}function e(A){var B=f.data.core.mugTypes.allTypes[A];return(B&&B.typeName)||A}function a(B,A){var D,C;while(true){if(!B.parent||A.id.startsWith(B.id+"/")){C=B.id&&!A.id.startsWith(B.id+"/");D=f.getInsertTargetAndPosition(B.mug,A.type,C);break}B=B.parent}if(!D){D={};if(!B.mug){D.error="Cannot insert "+e(A.type)+" into tree root"}else{D.error="Cannot insert $1 into or after $2".replace("$1",e(A.type)).replace("$2",e(B.mug.__className))}}else{while(B.mug!==D.mug){if(!B.parent){D.error="Cannot insert $1 into $2".replace("$1",e(A.type)).replace("$2",e(B.mug.parentMug.__className));return D}B=B.parent}if(D.position==="after"){D.parent=B.parent}else{if(D.position==="last"||D.position==="into"){D.parent=B}else{D.error="Cannot insert $1 $2 $3".replace("$1",e(A.type)).replace("$2",D.position).replace("$3",e(D.mug.__className))}}}return D}function d(){var A=t(true),B=f.getCurrentlySelectedMug(true);if(window.analytics){window.analytics.usage("Copy Paste","Cut",B.length);window.analytics.workflow("Cut questions in form builder")}B=y.filter(B,function(C){return C.options.isCopyable});if(B&&B.length){f.data.core.form.removeMugsFromForm(B)}return A}function t(H){var G=f.getCurrentlySelectedMug(true,true),A={};if(window.analytics&&!H){window.analytics.usage("Copy Paste","Copy",G.length);window.analytics.workflow("Copy questions in form builder")}if(!G||!G.length){return""}function B(I){if(A.hasOwnProperty(I.ufid)){return}A[I.ufid]=true;if(!I.options.isCopyable){return}var K=I.serialize(),J=C.getChildren(I);y.each(K,function(M,L){if(!E.hasOwnProperty(L)){F.push(L);E[L]=true}});if(J.length){K=[K].concat(y.map(J,B))}return K}var E={id:true,type:true},F=[],C=G[0].form,D=y.filter(y.flatten(y.map(G,B)),y.identity);if(D.length===0){return""}F=["id","type"].concat(y.sortBy(F,n));return w.tabDelimit([l,F].concat(y.map(D,function(I){return y.map(F,function(J){var K=I[J];return u(y.isUndefined(K)?null:K)})})))}function m(F){if(window.analytics){window.analytics.workflow("Paste questions in form builder")}var H=w.makeRowParser(F);if(!y.isEqual(H().slice(0,2),l)){return["Unsupported paste format"]}var J=f.data.core.mugTypes.allTypes,A=f.data.core.form,D=f.getCurrentlySelectedMug(true,true),I=D.length?D[D.length-1]:null,G=H(),O=H(),M=new r.MugMessages(),B={id:null,mug:I,parent:null},E=[],K=0,N,L;M.add=function(P){M.update(null,{key:P,level:r.ERROR,message:P})};f.beforeBulkInsert(A);for(;O;O=H()){try{N=y.object(G,y.map(O,function(P){return z(P)}))}catch(C){M.add("Unsupported paste format: "+O.join(", "));continue}if(!J.hasOwnProperty(N.type)){M.add("Unknown question type: "+O.join(", "));continue}L=a(B,N);if(L.hasOwnProperty("error")){M.add(L.error);continue}I=A.createQuestion(L.mug,L.position,N.type,true);E.push(I.deserialize(N,M));B={id:N.id,mug:I,parent:L.parent,};K++}y.each(y.flatten(E),function(P){P.execute()});f.afterBulkInsert(A);if(I&&L){f.setCurrentMug(I)}if(window.analytics){window.analytics.usage("Copy Paste","Paste",K)}return M.get()}g.vellum.plugin("copyPaste",{cut:d,copy:t,paste:m},{init:function(){var B=this.opts().copyPaste;f=this;function A(C){return(k&&C.metaKey)||(!k&&C.ctrlKey)}g(document).on("cut copy paste keydown",function(C){if(C.type==="cut"||A(C)&&String.fromCharCode(C.keyCode)==="X"){if(false){h(B)}}else{if(C.type==="copy"||A(C)&&String.fromCharCode(C.keyCode)==="C"){j(B)}else{if(C.type==="paste"||A(C)&&String.fromCharCode(C.keyCode)==="V"){c(B)}}}})},displayMultipleSelectionView:function(){this.__callOld();function D(){E.hide();B.removeClass("hide");A.val(t(true))}var C=g(q({metachar:(k?"\u2318":"Ctrl+")})),E=C.find(".copy-paste-help"),B=C.find(".copy-paste-box"),A=B.find("textarea");if(x){D();setTimeout(function(){A.focus().select()},1)}else{E.click(function(){D();A.focus().select()})}A.focus(function(){A.select().mouseup(function(){A.off("mouseup");return false})}).keyup(function(F){if(F.which===9){A.select()}});C.find(".insert-questions").click(function(){m(A.val())});this.$f.find(".fd-props-content").html(C)}});return{cut:d,copy:t,paste:m,stringify:u,valuify:z}});