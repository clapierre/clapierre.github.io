define(["jquery","underscore","XMLWriter","vellum/util"],function(g,m,b,h){var l=function(s){var q=new b("UTF-8","1.0");s.vellum.beforeSerialize();q.writeStartDocument();q.writeStartElement("h:html");f(q);q.writeStartElement("h:head");q.writeStartElement("h:title");q.writeString(s.formName);q.writeEndElement();q.writeStartElement("model");q.writeStartElement("instance");a(q,s.instanceMetadata[0]);var t=s.dataTree();c(s,t,q);q.writeEndElement();for(var r=1;r<s.instanceMetadata.length;r++){k(q,s.instanceMetadata[r])}d(t,q);p(t,s,q);q.writeEndElement();s.vellum.contributeToHeadXML(q,s);q.writeEndElement();q.writeStartElement("h:body");i(s,q);q.writeEndElement();q.writeEndElement();q.writeEndDocument();s.vellum.afterSerialize();return q.flush()};var e=function(t,q){var s,r;r=t.formJRM;if(!r){r="http://dev.commcarehq.org/jr/xforms"}s=t.formUuid;if(!s){s="http://openrosa.org/formdesigner/"+h.generate_xmlns_uuid()}q.writeAttributeString("xmlns:jrm",r);q.writeAttributeString("xmlns",s);q.writeAttributeString("uiVersion",t.formUIVersion||"1");q.writeAttributeString("version",t.formVersion||"1");q.writeAttributeString("name",t.formName||"New Form")};function f(q){q.writeAttributeString("xmlns:h","http://www.w3.org/1999/xhtml");q.writeAttributeString("xmlns:orx","http://openrosa.org/jr/xforms");q.writeAttributeString("xmlns","http://www.w3.org/2002/xforms");q.writeAttributeString("xmlns:xsd","http://www.w3.org/2001/XMLSchema");q.writeAttributeString("xmlns:jr","http://openrosa.org/javarosa");q.writeAttributeString("xmlns:vellum","http://commcarehq.org/xforms/vellum")}var a=function(s,q){for(var r in q.attributes){if(q.attributes.hasOwnProperty(r)){s.writeAttributeString(r,q.attributes[r])}}};var k=function(r,q){if(!q.internal){r.writeStartElement("instance");a(r,q);if(q.children.length){r.writeXML(g("<div>").append(q.children).clone().html())}r.writeEndElement()}};var c=function(r,s,q){s.walk(function(w,y,A){if(w&&w.options.getTagName){y=w.options.getTagName(w,y);if(y===null){return}}q.writeStartElement(y);if(!w){e(r,q)}else{var z=w.p.rawDataAttributes,t=null;if(w.options.getExtraDataAttributes){t=w.options.getExtraDataAttributes(w)}for(var v in z){if(z.hasOwnProperty(v)){q.writeAttributeString(v,z[v])}}var x=w.p.dataValue,u=w.p.xmlnsAttr;if(x){q.writeString(x)}if(w.options.writeDataNodeXML){w.options.writeDataNodeXML(q,w)}if(u){q.writeAttributeString("xmlns",u)}if(t){for(v in t){if(t.hasOwnProperty(v)){q.writeAttributeString(v,t[v])}}}}A(w&&w.options.dataChildFilter);q.writeEndElement()})};var d=function(r,q){r.walk(function(s,t,u){if(s&&s.options.getBindList){m.each(s.options.getBindList(s),function(v){q.writeStartElement("bind");m.each(v,function(x,w){if(x){q.writeAttributeString(w,x)}});q.writeEndElement()})}u()})};var p=function(t,s,q){function r(u){q.writeStartElement("setvalue");q.writeAttributeString("event",u.event);q.writeAttributeString("ref",u.ref);q.writeAttributeString("value",u.value);q.writeEndElement()}m.each(s.getSetValues(),r);t.walk(function(u,v,w){if(u&&u.options.getSetValues){m.each(u.options.getSetValues(u),r)}w()})};var i=function(r,q){r.tree.walk(function(u,x,z){if(!u){z();return}var w=u.options;if(w.isDataOnly){return}if(w.writesOnlyCustomXML){w.writeCustomXML(q,u);return}q.writeStartElement(u.options.tagName.toLowerCase());if(w.writeControlLabel){j(q,u)}if(w.writeControlHint){o(q,u)}if(w.writeControlHelp){n(q,u)}var t=u.p.rawControlAttributes;for(var s in t){if(t.hasOwnProperty(s)){q.writeAttributeString(s,t[s])}}if(w.writeCustomXML){w.writeCustomXML(q,u)}if(w.writeControlRefAttr){var v=r.getAbsolutePath(u);q.writeAttributeString(w.writeControlRefAttr,v)}var y=u.getAppearanceAttribute();if(y){q.writeAttributeString("appearance",y)}z(w.controlChildFilter);q.writeEndElement()})};function j(q,r){var t=r.p.labelItext;var s;if(t){s=t.get("default","en")}if(s==""){s=" "}q.writeStartElement("label");q.writeString(s);q.writeEndElement()}function o(q,r){var u=r.p.hintLabel,s=r.p.hintItext;if(u||(s&&!s.isEmpty())){q.writeStartElement("hint");if(u){q.writeString(u)}if(s&&!s.isEmpty()){var t="jr:itext('"+s.id+"')";q.writeAttributeString("ref",t)}q.writeEndElement()}}function n(q,r){var t=r.p.helpItext;if(t&&!t.isEmpty()){q.writeStartElement("help");var s="jr:itext('"+t.id+"')";q.writeAttributeString("ref",s);q.writeEndElement()}}return{createXForm:l}});