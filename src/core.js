define(["require","save-button","underscore","xpathmodels","jquery","tpl!vellum/templates/main","tpl!vellum/templates/question_type_group","tpl!vellum/templates/edit_source","tpl!vellum/templates/confirm_overwrite","tpl!vellum/templates/control_group_stdInput","tpl!vellum/templates/form_errors_template","tpl!vellum/templates/question_fieldset","tpl!vellum/templates/question_type_changer","tpl!vellum/templates/question_toolbar","tpl!vellum/templates/alert_global","tpl!vellum/templates/modal_content","tpl!vellum/templates/modal_button","vellum/mugs","vellum/widgets","vellum/parser","vellum/datasources","vellum/util","vellum/debugutil","vellum/base","vellum/jstree-plugins","less!vellum/less-style/main","jquery.jstree","jquery.bootstrap","caretjs","atjs"],function(b,F,J,d,x,H,B,l,s,E,A,i,p,q,j,z,n,o,y,w,u,h,r){setTimeout(function(){b(["codemirror","diff-match-patch","CryptoJS","vellum/expressionEditor",],function(){})},0);var D=/Mac/.test(navigator.platform);var a=false;d.DEBUG_MODE=a;var I={error:{cssClass:"alert-error",title:"Error",icon:"icon-exclamation-sign"},"parse-warning":{cssClass:"",title:"Warning",icon:"icon-warning-sign"},"form-warning":{cssClass:"",title:"Form Warning",icon:"icon-info-sign"}};var e=function(K){return"fd-question-group-"+K};var f=function(K){return{slug:K[0],title:K[1],icon:K.length>2?K[2]:null}};var G=function(N,L){var M=f(N.group),K=e(M.slug);var O=x(B({groupClass:K,showDropdown:N.questions.length>1,textOnly:N.textOnly,relatedQuestions:J.map(N.related||[],f),defaultQuestion:M,questions:J.map(N.questions,f)}));O.find(".fd-question-type").click(function(P){if(!x(this).hasClass("disabled")){L.addQuestion(x(this).data("qtype"))}P.preventDefault()});O.find(".btn.fd-question-type > span").tooltip({title:function(){var Q=x(this).data("qlabel"),P=x(this).parent();if(P.hasClass("disabled")){Q=Q+" (add "+M.title+" first)"}else{Q="Add "+Q}return Q},placement:"bottom"});return O};var v={};v.init=function(){this.data.core.mugTypes=new o.MugTypesManager(this.getMugSpec(),this.getMugTypes(),this.opts());var O=this,N=this.opts().core.bindBeforeUnload;this.data.core.saveButton=F.init({save:function(P){var Q=false;O.ensureCurrentMugIsSaved(function(){O.validateAndSaveXForm(Q)})},unsavedMessage:""});var L=function(){var P=x("i",O.data.core.$fullscreenButton);if(O.data.windowManager.fullscreen){P.addClass("icon-resize-small").removeClass("icon-resize-full")}else{P.removeClass("icon-resize-small").addClass("icon-resize-full")}};setTimeout(L,0);this.data.core.$fullscreenButton=x('<button class="btn"><i/></button>').click(function(P){P.preventDefault();if(window.analytics){window.analytics.usage("Form Builder","Full Screen Mode",O.opts().core.formId)}if(O.data.windowManager.fullscreen){O.data.windowManager.fullscreen=false}else{O.data.windowManager.fullscreen=true}L();O.data.windowManager.adjustToWindow()});this.data.core.currentErrors=[];this.data.core.lastSavedXForm=this.opts().core.form;var K="Ctrl+",M="Alt+";if(D){K="\u2318";M="\u2325"}this.$f.addClass("formdesigner");this.$f.empty().append(H({ctrl:K,alt:M}));x(document).on("keydown",function(Q){var S=(D&&Q.metaKey)||(!D&&Q.ctrlKey),R=(D&&Q.ctrlKey)||(!D&&Q.metaKey),P=(S?"Ctrl+":"")+(Q.altKey?"Alt+":"")+(Q.shiftKey?"Shift+":"")+(R?"Meta+":"")+Q.keyCode;(k[P]||J.identity).call(O,Q)});this._init_toolbar();this._createJSTree();u.init(this)};v.postInit=function(){var L=this;function K(){L.opts().core.onReady.apply(L)}w.init(this);this.loadXFormOrError(this.opts().core.form,function(){setTimeout(K,0)})};var k={"Ctrl+Alt+187":function(){this.data.core.$tree.jstree("open_all")},"Ctrl+Alt+189":function(){this.data.core.$tree.jstree("close_all")},};v.getMugTypes=function(){return o.baseMugTypes};v._init_toolbar=function(){var N=this,K=this.$f.find(".fd-container-question-type-group");this.data.core.QUESTIONS_IN_TOOLBAR=[];this.data.core.QUESTION_TYPE_TO_GROUP={};J.each(this._getQuestionGroups(),function(O){var Q=O.group[0];var P=function(R){var T=N.data.core.mugTypes[R],S=[R,T.typeName,T.icon];N.data.core.QUESTIONS_IN_TOOLBAR.push(R);N.data.core.QUESTION_TYPE_TO_GROUP[R]=Q;return S};O.questions=J.map(O.questions,P);if(O.related&&O.related.length){O.related=J.map(O.related,P)}O.group[2]=O.group[2]||N.data.core.mugTypes[O.group[0]].icon;K.append(new G(O,N))});var M=this.$f.find(".fd-save-button");this.data.core.saveButton.ui.appendTo(M);var L=this.$f.find(".fd-fullscreen-button");this.data.core.$fullscreenButton.appendTo(L)};v._getQuestionGroups=function(){return[{group:["Text","Text"],questions:["Text","Trigger"]},{group:["Select"],related:["Item"],questions:this.getSelectQuestions()},{group:["Int","Number"],questions:["Int"]},{group:["Date","Date"],questions:["Date"]},{group:["FieldList","Groups"],questions:["FieldList","Repeat"]}]};v.getSelectQuestions=function(){return["Select"]};v.getAdvancedQuestions=function(){return["Geopoint"]};v._init_extra_tools=function(){var M=this,K=this.getToolsMenuItems();var L=this.$f.find(".fd-tools-menu");L.empty();J(K).each(function(N){var O=x("<a tabindex='-1' href='#'>"+N.name+"</a>").click(function(P){P.preventDefault();M.ensureCurrentMugIsSaved(function(){N.action(function(){M.refreshVisibleData()})})});x("<li></li>").append(O).appendTo(L)});this.$f.find(".fd-expand-all").click(function(){M.data.core.$tree.jstree("open_all")});this.$f.find(".fd-collapse-all").click(function(){M.data.core.$tree.jstree("close_all")});this.$f.find(".fd-button-copy").click(function(){if(window.analytics){window.analytics.usage("Copy Paste","Copy Button");window.analytics.workflow("Clicked Copy Button in form builder")}M.ensureCurrentMugIsSaved(function(){M.displayMultipleSelectionView();var N=M.jstree("get_selected");if(N.length){x("#"+N[0]+" a").focus()}})})};v.getToolsMenuItems=function(){var K=this;return[{name:"Export Form Contents",action:function(L){K.showExportModal(L)}},{name:"Edit Source XML",action:function(L){K.showSourceXMLModal(L)}},{name:"Form Properties",action:function(L){K.showFormPropertiesModal(L)}}]};v.refreshVisibleData=function(){var K=this;this.data.core.form.getMugList().map(function(L){K.refreshMugName(L)});this.refreshCurrentMug()};v.refreshCurrentMug=function(){var K=this.getCurrentlySelectedMug();if(K){this.displayMugProperties(K)}};v.getMugDisplayName=function(K){return K.getDisplayName(this.data.core.currentItextDisplayLanguage||this.data.javaRosa.Itext.getDefaultLanguage())};v.showSourceXMLModal=function(K){var P=this;function L(Q){Q.validate();return !Q.getErrors().length}if(!P.data.core.form.isFormValid(L)){var M=P.generateNewModal("Error",[{title:"Continue",action:function(){P.closeModal();P.showSourceInModal(K)}},{title:"Abort",cssClasses:"btn-primary",action:function(){P.closeModal()}}],false,"icon-warning-sign");var O="There are validation errors in the form.  Do you want to continue anyway?";O+="<br><br>WARNING: The form will not be valid and likely not perform correctly on your device!";M.find(".modal-body").html(O);M.modal("show")}else{var N=navigator.vendor&&navigator.vendor.indexOf("Apple")>-1;if(N){window.alert("NOTE: Safari users the xml will be shown in your broswer instead of downloading it directly.  You will need to use 'Command + S' to save the file locally.")}g("myCustomForm.xml",this.createXML())}};function g(K,N){var L=document.createElement("a");L.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(N));L.setAttribute("download",K);if(document.createEvent){var M=document.createEvent("MouseEvents");M.initEvent("click",true,true);L.dispatchEvent(M)}else{L.click()}}v.showSourceInModal=function(L){var P=this,S,T,N,O,K,R,M,Q;S=this.generateNewModal("Edit Form's Source XML",[{title:"Update Source",cssClasses:"btn-primary",action:function(){O.save();P.loadXFormOrError(N.val(),function(){S.modal("hide");L()},true)}}]);T=x(l({description:"This is the raw XML. You can edit or paste into this box to make changes to your form. Press 'Update Source' to save changes, or 'Close' to cancel."}));K=S.find(".modal-header").outerHeight(false);R=S.find(".modal-footer").outerHeight(false);M=x(window).height()-40;Q=M-(R-K)-126;S.css("height",M+"px").css("width",x(window).width()-40+"px");S.addClass("fd-source-modal").removeClass("form-horizontal").find(".modal-body").html(T).css("height",Q+"px");N=T.find("textarea");if(!this.data.core.formLoadingFailed){N.val(this.createXML())}else{N.val(this.data.core.failedLoadXML)}O=b("codemirror").fromTextArea(N.get(0));O.setOption("viewportMargin",Infinity);O.setOption("lineNumbers",true);O.setSize("100%","100%");S.modal("show");S.one("shown",function(){O.refresh();O.focus()})};v.showExportModal=function(K){var L,N;L=this.generateNewModal("Export Form Contents",[]);N=x(l({description:"Copy and paste this content into a spreadsheet program like Excel to easily share your form with others."}));L.find(".modal-body").html(N);var M=N.find("textarea");M.val(this.data.core.form.getExportTSV());L.modal("show");L.one("shown",function(){M.focus()})};v.showOverwriteWarning=function(O,Q,L){var M,K,P=this;M=P.generateNewModal("Lost work warning",[{title:"Overwrite their work",cssClasses:"btn-primary",defaultButton:true,action:function(){x("#form-differences").hide();O(Q,"full");P.closeModal()}},{title:"Show XML Differences",cssClasses:"btn-info",action:function(){x("#form-differences").show();var T=M.find(".modal-header").outerHeight(false),U=M.find(".modal-footer").outerHeight(false),S=x(window).height()-40,R=S-(U-T)-126;M.css("height",S+"px").css("width",x(window).width()-40+"px");M.addClass("fd-source-modal").removeClass("form-horizontal").find(".modal-body").html(K).css("height",R+"px");M.find(".btn-info").attr("disabled","disabled")}}],"Cancel","icon-warning-sign");var N=h.xmlDiff(Q,L);K=x(s({description:"Looks like someone else has edited this form since you loaded the page. Are you sure you want to overwrite their work?",xmldiff:x("<div>").text(N).html()}));M.find(".modal-body").html(K);x("#form-differences").hide();M.modal("show")};v.showFormPropertiesModal=function(){var N=this,L=this.generateNewModal("Edit Form Properties",[]),M=L.find(".modal-body"),K=[{label:"Form Name",slug:"formName"},{label:"Form ID",slug:"formID",cleanValue:function(O){return O.replace(/ /g,"_")}}];M.append(x("<p />").text("Note: changing the Form ID here will not automatically change the Form ID in existing references in your logic conditions.  If you change the Form ID, you must manually change any existing logic references."));J.each(K,function(P){var O=x(E({label:P.label}));M.append(O);O.find("input").val(N.data.core.form[P.slug]).on("keyup",function(){var R=x(this),Q=R.val();if(typeof P.cleanValue==="function"){Q=P.cleanValue(Q);R.val(Q)}N.data.core.form.setAttr(P.slug,Q)})});L.modal("show");L.one("shown",function(){M.find("input:first").focus().select()})};v.closeModal=function(){this.$f.find(".fd-modal-generic-container .modal").modal("hide")};v.generateNewModal=function(P,O,M,K){if(typeof M==="undefined"){M="Close"}O.reverse();O=J.map(O,function(R){R.cssClasses=R.cssClasses||"";return R});var Q=this,N=Q.$f.find(".fd-modal-generic-container");Q.closeModal();var L=x(z({title:P,closeButtonTitle:M,headerIcon:K,}));L.one("shown",function(){L.find(".btn-default:last").focus()});J.each(O,function(R){R.defaultButton=R.defaultButton||false;R.action=R.action||function(){Q.closeModal()};L.find(".modal-footer").prepend(x(n(R)).click(R.action))});N.html(L);return L};var t=function(){var K=x("<div><div><div></div></div></div>");K.addClass("fd-form-saving");x("body").append(K)};var c=function(){x(".fd-form-saving").remove()};v.handleDropFinish=function(N,M,K){var O=this,L=N.closest(".xpath-expression-row").find(".op-select");if(N){N.val(N.val()+M).change();if(window.analytics){window.analytics.usage("Question Reference","Drag and Drop",O.data.core.currentlyEditedProperty)}}if(K&&L&&K.options.defaultOperator){L.val(K.options.defaultOperator)}};var m;v._createJSTree=function(){m={"#":{valid_children:this.data.core.mugTypes.Group.validChildTypes},"default":{icon:"icon-question-sign",max_children:0,valid_children:[]}};J(this.data.core.mugTypes.allTypes).each(function(N,M){m[M]={icon:N.icon,max_children:N.maxChildren,valid_children:N.validChildTypes}});var K,L=this;this.data.core.$tree=K=this.$f.find(".fd-question-tree");K.jstree({core:{data:[],worker:false,multiple:true,strings:{"New node":this.opts().core.noTextString},check_callback:function(N,Q,P,M,O){if(N==="move_node"){return L.checkMove(Q.id,Q.type,P.id,P.type,M)}return true}},dnd:{copy:false,inside_pos:"last"},types:m,conditionalevents:{should_activate:function(){return L.ensureCurrentMugIsSaved()},redraw_node:function(O){var M=Array.prototype.slice.call(arguments),N=this.parent.redraw_node.apply(this.inst,M);O=this.inst.get_node(O);if(N&&O.data&&O.data.errors){x(N).find("a > i").first().after(O.data.errors)}return N}},plugins:["themes","types","dnd","conditionalevents"]}).bind("select_node.jstree deselect_node.jstree",function(P,O){var N=L.jstree("get_selected");if(!N.length){L.hideQuestionProperties()}else{if(N.length<2){var M=L.data.core.form.getMugByUFID(N[0]);L.displayMugProperties(M);L.activateQuestionTypeGroup(M)}else{L.displayMultipleSelectionView()}}}).bind("open_node.jstree",function(O,N){if(window.event&&window.event.altKey){L.jstree("open_all",N.node)}var M=L.data.core.form.getMugByUFID(N.node.id);L.activateQuestionTypeGroup(M);L.data.core.form.getDescendants(M).map(function(P){L.refreshMugName(P)})}).bind("close_node.jstree",function(P,O){if(window.event&&window.event.altKey){L.jstree("close_all",O.node)}var M=L.jstree("get_selected"),N=M.length&&L.jstree("get_node",M[0]);if(N&&J.contains(N.parents,O.node.id)){L.jstree("deselect_all",true).jstree("select_node",O.node)}L.activateQuestionTypeGroup(L.data.core.form.getMugByUFID(O.node.id))}).bind("move_node.jstree",function(Q,P){var O=L.data.core.form,N=O.getMugByUFID(P.node.id),R=P.parent!=="#"?O.getMugByUFID(P.parent):null,M=L.getRelativePosition(R,P.position);O.moveMug(N,M.position,M.mug);P.node.icon=N.getIcon();L.refreshCurrentMug()}).bind("deselect_all.jstree deselect_node.jstree",function(N,M){L.resetQuestionTypeGroups()}).bind("model.jstree",function(N,M){J(M.nodes).each(function(P){var O=L.jstree("get_node",P);if(O.data.mug){O.icon=O.data.mug.getIcon()}})})};x(document).on("dnd_move.vakata.jstree",function(O,M){var L=x(M.data.obj.context),N=x(M.event.target),K=x.jstree.reference(N);if(!K&&N.vellum("get")===L.vellum("get")){if(N.hasClass("jstree-drop")){M.helper.find(".jstree-icon").removeClass("jstree-er").addClass("jstree-ok")}else{M.helper.find(".jstree-icon").removeClass("jstree-ok").addClass("jstree-er")}}}).on("dnd_stop.vakata.jstree",function(P,N){var K=x(N.data.obj.context).vellum("get"),O=x(N.event.target),M=x.jstree.reference(O);if(!M&&O.hasClass("jstree-drop")&&K===O.vellum("get")){if(N.data.origin){var L=N.data.origin.get_node(N.data.nodes[0]);if(L.data&&L.data.handleDrop){L.data.handleDrop(O)}}}});v.getRelativePosition=function(L,K){if(!J.isNumber(K)){return{mug:L,position:K}}if(K===0){return{mug:L,position:"first"}}var M=this.jstree("get_node",L?L.ufid:"#");if(K>M.children.length){return{mug:L,position:"last"}}var N=this.jstree("get_node",M.children[K-1]);return{mug:N.data.mug,position:"after"}};v.checkMove=function(K,R,Q,M,O){var L=this.data.core.form,P=L.getMugByUFID(Q),S=L.getMugByUFID(K);if(!S){return false}if(O==="inside"){O="into"}var N=!this.isMugPathMoveable(S.absolutePath);if(N){if(O==="into"||O==="last"||O==="first"){return S.parentMug===P}else{return S.parentMug===P.parentMug}}return true};v.onFormChange=function(K){this.data.core.saveButton.fire("change")};v.jstree=function(){var K=this.data.core.$tree;return K.jstree.apply(K,arguments)};v.getCurrentlySelectedMug=function(K,N){var M=this.jstree("get_selected"),P=this.data.core.form;if(K){if(N&&M.length>1){var L=J.object(J.map(M,function(R){return[R,true]})),O=M.length,Q=[];P.tree.walk(function(R,S,T){if(R&&L.hasOwnProperty(R.ufid)){Q.push(R)}if(Q.length!==O){T()}});return Q}return J.map(M,P.getMugByUFID.bind(P))}return M.length?P.getMugByUFID(M[0]):null};v.getCurrentMugInput=function(K){return this.$f.find("[name=property-"+K+"]")};v.mugToXPathReference=function(K){if(K.__className==="Item"){return'"'+K.p.nodeID+'"'}else{return(K.ufid===this.getCurrentlySelectedMug().ufid)?".":this.data.core.form.getAbsolutePath(K)}};v.activateQuestionTypeGroup=function(K){var L=K.__className;this.resetQuestionTypeGroups();var M=this.data.core.QUESTION_TYPE_TO_GROUP[L];if(M&&L!=="MSelectDynamic"&&L!=="SelectDynamic"&&!this.jstree("is_closed",K.ufid)){this.$f.find("."+e(M)).find(".fd-question-type-related").removeClass("disabled")}};v.resetQuestionTypeGroups=function(){this.$f.find(".fd-container-question-type-group .fd-question-type-related").addClass("disabled")};v.ensureCurrentMugIsSaved=function(K){if(this.data.core.hasXPathEditorChanged){this.alert("Unsaved Changes in Editor","You have UNSAVED changes in the Expression Editor. Please save changes before continuing.");return false}else{(K||function(){})();return true}};v.loadXFormOrError=function(L,K,N){K=K||function(){};var M=this;t();window.setTimeout(function(){M.data.core.formLoadingFailed=false;try{M.data.core.parseWarnings=[];M.loadXML(L,{});delete M.data.core.parseWarnings;if(L){M.showQuestionProperties();if(N){M.data.core.saveButton.fire("change")}}else{M.$f.find(".fd-default-panel").removeClass("hide")}c()}catch(P){var Q=P.toString();if(Q.indexOf("Invalid XML")===0){Q="Parsing Error. Please check that your form is valid XML."}M.hideQuestionProperties();var O=M.generateNewModal("Error",[],"OK","icon-warning-sign");O.find(".modal-body").text(Q);O.modal("show");M.data.core.formLoadingFailed=true;M.data.core.failedLoadXML=L;c();throw P}K()},this.opts().core.loadDelay)};v.loadXML=function(M,K){var L,N=this;N.data.core.$tree.children().children().each(function(O,P){N.jstree("delete_node",P)});K=J.extend({mugTypes:this.data.core.mugTypes,allowedDataNodeReferences:this.opts().core.allowedDataNodeReferences,enableInstanceRefCounting:true},K);this.data.core.form=L=w.parseXForm(M,K,this,N.data.core.parseWarnings);L.formName=this.opts().core.formName||L.formName;if(M){N._resetMessages(N.data.core.form.errors);N._populateTree()}u.getDataSources(function(O){L.updateKnownInstances(J.chain(O).map(function(P){return[P.id,P.uri]}).object().value())});L.on("question-type-change",function(O){N.jstree("set_type",O.mug.ufid,O.qType);if(O.mug===N.getCurrentlySelectedMug()){N.refreshCurrentMug();N.activateQuestionTypeGroup(O.mug)}}).on("parent-question-type-change",function(O){N.jstree("set_icon",O.childMug.ufid,O.childMug.getIcon())}).on("question-remove",function(Q){if(Q.mug){Q.mug.unbind(N.data.core)}var P=N.getCurrentlySelectedMug();if(Q.mug&&Q.mug.parentMug&&Q.mug.parentMug===P){N.displayMugProperties(P)}if(!Q.isInternal){var O=N.jstree("get_prev_dom",Q.mug.ufid);N.jstree("delete_node",Q.mug.ufid);if(O){N.jstree("select_node",O)}else{N.selectSomethingOrHideProperties()}}}).on("question-create",function(P){N.handleNewMug(P.mug,P.refMug,P.position);var O=N.getCurrentlySelectedMug();if(P.mug&&P.mug.parentMug&&P.mug.parentMug===O){N.displayMugProperties(O)}if(!P.isInternal){N.setCurrentMug(P.mug)}}).on("change",function(O){N.onFormChange(O.mug)}).on("question-label-text-change",function(O){N.refreshMugName(O.mug);N.toggleConstraintItext(O.mug)}).on("mug-property-change",function(O){N.refreshMugName(O.mug);N.toggleConstraintItext(O.mug)})};v.refreshMugName=function(K){var L=this.getMugDisplayName(K);if(L!==this.jstree("get_text",K.ufid)){this.jstree("rename_node",K.ufid,L)}};v.toggleConstraintItext=function(K){var M=this.getCurrentlySelectedMug();if(M&&M.ufid!==K.ufid){return}var L=(K.p.constraintMsgItext&&(!K.p.constraintMsgItext.isEmpty()||K.p.constraintAttr)),N=x(".itext-block-constraintMsg");if(L){N.removeClass("hide")}else{N.addClass("hide")}};v._populateTree=function(){var L=this,K=this.data.core.form;K.walkMugs(function(M){L.handleMugParseFinish(M);var N=L.createQuestion(M,M.parentMug,"into");if(N){var O=M.validate();if(!O&&M.getErrors().length){L.setTreeValidationIcon(M)}}});this.selectSomethingOrHideProperties(true)};v.selectSomethingOrHideProperties=function(K){if(K){this.jstree("deselect_all")}if(!this.jstree("get_selected").length){var L=this.data.core.$tree.find("li");if(L.length>0){this.jstree("select_node",L[0]);return true}else{this.jstree("deselect_all");this.hideQuestionProperties();this.$f.find(".fd-default-panel").removeClass("hide");return false}}return true};v.addQuestion=function(L){var M=this,K;this.ensureCurrentMugIsSaved(function(){var O=M.getInsertTargetAndPosition(M.getCurrentlySelectedMug(),L);if(!O){throw new Error("cannot add "+L+" at the current position")}if(window.analytics){window.analytics.workflow("Added question in form builder")}K=M.data.core.form.createQuestion(O.mug,O.position,L);var N=M.$f.find(".fd-question-properties input:text:visible:first");if(N.length){N.focus().select()}});return K};v.getInsertTargetAndPosition=function(P,O,N){var M,L,K=N?"after":"last";while(P){if(K==="after"){M=P.parentMug;if(!M){if(!this.isInsertAllowed(O,K,P)){return null}break}}else{M=P}if(this.jstree("is_closed",M.ufid)){P=M;K="after";continue}L=m[M.__className].valid_children;if(L.indexOf(O)!==-1){break}else{if(K!=="after"){K="after"}else{P=P.parentMug}}}if(!P&&!this.isInsertAllowed(O,K,P)){return null}return{mug:P,position:K}};v.isInsertAllowed=function(L,K,N){var M="#";if(N){if(K==="after"||K==="before"){if(N.parent){throw new Error("validation of insert "+K+" "+N.__className+" not implemented")}}else{throw new Error("validation of insert "+K+" "+N.__className+" not implemented")}}else{if(K!=="into"&&K!=="first"&&K!=="last"){throw new Error("validation of insert "+K+" root node not implemented")}}return m[M].valid_children.indexOf(L)!==-1};v.handleNewMug=function(L,M,K){this.createQuestion(L,M,K)};v.createQuestion=function(L,N,K){var M=this;L.on("messages-changed",function(O){M.setTreeValidationIcon(O.mug)},null,null,this.data.core);return this.jstree("create_node",N?"#"+N.ufid:"#",{text:this.getMugDisplayName(L),type:L.__className,data:{mug:L,handleDrop:function(P){var O=M.mugToXPathReference(L);M.handleDropFinish(P,O,L)}},li_attr:{id:L.ufid,rel:L.__className},state:{opened:true}},(K==="into"?"last":K))};v.handleMugParseFinish=function(K){};v.getMugByPath=function(K){return this.data.core.form.getMugByPath(K)};v.setCurrentMug=function(K){this.jstree("deselect_all",true).jstree("select_node",K.ufid)};v.displayMugProperties=function(N){var P=this.$f.find(".fd-question-properties"),Q=function(T){return C(T,N)};this.$f.find(".fd-default-panel").addClass("hide");P.animate({},200);this.showContentRight();P.hide();this._setPropertiesMug(N);var L=this.$f.find(".fd-props-content").empty(),S=this.getSections(N),K=x("<div class='messages' />");this.$f.find(".fd-props-toolbar").html(this.getMugToolbar(N));for(var M=0;M<S.length;M++){var R=S[M];R.mug=N;R.properties=J(R.properties).map(Q).filter(J.identity);if(R.properties.length){this.getSectionDisplay(N,R).appendTo(L)}}if(L.children().length){K.insertAfter(L.children().first())}else{K.appendTo(L)}function O(){K.empty().append(y.util.getMessages(N,null))}N.on("messages-changed",O,null,"teardown-mug-properties");O();P.show();this.data.windowManager.adjustToWindow();this.$f.find(".fd-help a").fdHelp();this.toggleConstraintItext(N)};v._setPropertiesMug=function(K){if(this._propertiesMug){this._propertiesMug.teardownProperties();try{this._propertiesMug.validate()}catch(L){}}this._propertiesMug=K};v.displayMultipleSelectionView=function(){var K=this.getCurrentlySelectedMug(true);this.showContentRight();this.hideQuestionProperties();this._setPropertiesMug(null);this.$f.find(".fd-props-toolbar").html(this.getMugToolbar(K,true));this.$f.find(".fd-props-content").empty();this.showQuestionProperties()};v.showContentRight=function(){this.$f.find(".fd-content-right").show()};v.hideContentRight=function(){this.$f.find(".fd-content-right").hide()};v.showQuestionProperties=function(){this.$f.find(".fd-question-properties").show()};v.hideQuestionProperties=function(){this.$f.find(".fd-question-properties").hide()};v.displaySecondaryEditor=function(L){var O=this,M=this.$f.find(".fd-xpath-editor");M.find(".fd-head h2").text(L.headerText);L.DEBUG_MODE=a;this.hideQuestionProperties();var K=L.done;L.done=function(P){K(P);if(O.data.core.hasXPathEditorChanged){O.data.core.hasXPathEditorChanged=false;M.hide();O.refreshCurrentMug()}else{M.hide();O.showQuestionProperties()}};var N=L.change;L.change=function(P){O.data.core.hasXPathEditorChanged=true;if(N){N(P)}};M.show();L.loadEditor(O.$f.find(".fd-xpath-editor-content"),L)};v.displayXPathEditor=function(K){K.headerText="Expression Editor";K.loadEditor=function(L,M){b(["vellum/expressionEditor"],function(N){N.showXPathEditor(L,M)})};this.displaySecondaryEditor(K)};v.alert=function(N,M,L){L=L||[];if(this.data.core.isAlertVisible){return}var O=this;this.data.core.isAlertVisible=true;if(!L.length){L.push({title:"OK",defaultButton:true})}var K=this.generateNewModal(N,L,false,"icon-warning-sign");this.data.core.$modal=K;K.removeClass("fade");if(M instanceof x){K.find(".modal-body").append(M)}else{K.find(".modal-body").append(x("<p />").text(M))}K.modal("show").on("hide",function(){O.data.core.isAlertVisible=false})};v.setTreeValidationIcon=function(K){var L=K.ufid&&this.jstree("get_node",K.ufid);if(L){var N=K.getErrors();if(N.length){var M=N.join("\n").replace(/"/g,"'");L.data.errors='<div class="fd-tree-valid-alert-icon icon-exclamation-triangle" title="'+M+'"></div>'}else{L.data.errors=null}this.jstree("redraw_node",L)}};v._resetMessages=function(N){var L,M=this.$f.find(".fd-messages");M.empty();function K(O){if(typeof O==="string"||!(O instanceof Array)){O=[""+O]}return O}if(N.length>0){L=N[N.length-1];M.html(j({messageType:I[L.level],messages:K(L.message)})).find(".alert").removeClass("hide").addClass("in")}};v.getSectionDisplay=function(K,L){var O=this,N=x(i({fieldsetClass:"fd-question-edit-"+L.slug||"anon",fieldsetTitle:L.displayName,isCollapsed:!!L.isCollapsed,help:L.help||{}})),M=N.find(".fd-fieldset-content");L.properties.map(function(R){var Q=R.widget(K,x.extend(R.options,{vellum:O,displayXPathEditor:function(S){O.data.core.currentlyEditedProperty=R.options.path;O.displayXPathEditor(S)}}));Q.setValue(Q.currentValue);Q.on("change",function(){O.onFormChange(K)});var P=Q.getUIElement();y.util.setWidget(P,Q);M.append(P);Q.refreshMessages()});return N};v.getMugToolbar=function(M,L){var P=this,N=this.data.core.form,O=L?M:[M],K=x(q({isDeleteable:O&&O.length&&J.every(O,function(Q){return P.isMugRemoveable(Q,N.getAbsolutePath(Q))}),isCopyable:!L&&M.options.isCopyable}));K.find(".fd-button-remove").click(function(){var Q=P.getCurrentlySelectedMug(true);if(Q.length>1||(Q.length&&N.getChildren(Q[0]).length)){P.alert("Delete Questions?","This cannot be undone.",[{title:"Cancel",},{title:"Delete",cssClasses:"btn-primary",defaultButton:true,action:function(){N.removeMugsFromForm(Q);P.selectSomethingOrHideProperties(true);P.data.core.$modal.modal("hide")}}])}else{N.removeMugsFromForm(Q)}});if(!L){K.find(".btn-toolbar.pull-left").prepend(this.getQuestionTypeChanger(M))}return K};v.getQuestionTypeChanger=function(L){var P=this;var M=function(R){var X=R.__className,T=P.data.core.mugTypes[X],V=P.data.core.QUESTIONS_IN_TOOLBAR,S=[];for(var U=0;U<V.length;U++){var Q=V[U],W=P.data.core.mugTypes[Q];if(X!==Q&&!T.typeChangeError(R,Q)&&W.isTypeChangeable&&!W.typeChangeError(R,X)){S.push({slug:V[U],name:W.typeName,icon:W.icon})}}return S};var N=this.data.core.form,K=this.isMugTypeChangeable(L,N.getAbsolutePath(L));var O=x(p({currentQuestionIcon:L.getIcon(),currentTypeName:L.options.typeName,questions:K?M(L):[]}));O.find(".change-question").click(function(R){try{P.changeMugType(L,x(this).data("qtype"))}catch(Q){window.alert("Sorry, "+Q)}R.preventDefault()});O.addClass("fd-question-changer");return O};v.changeMugType=function(K,L){this.data.core.form.changeMugType(K,L)};v.createXML=function(){return this.data.core.form.createXML()};v.canSerializeXForm=function(P,K){var Q=this,O=this.data.core.form,M=this.data.core.currentItextDisplayLanguage,L=O.getSerializationWarnings();if(L.length){var N=x(A({errors:L,displayLanguage:M}));P=P?" and "+P:"";this.alert("There are errors in the form",N,[{title:"Fix Manually",action:function(){Q.data.core.$modal.modal("hide")}},{title:"Fix Automatically"+P,cssClasses:"btn-primary",defaultButton:true,action:function(){O.fixSerializationWarnings(L);Q.data.core.$modal.modal("hide");K();Q.refreshVisibleData()}}]);return false}return true};v.validateAndSaveXForm=function(O){function K(){Q.validateAndSaveXForm(O)}var Q=this;if(!this.canSerializeXForm("Save",K)){return}var P=this.createXML();try{x.parseXML(P)}catch(N){var M="It looks like your form is not valid XML. This can often happen if you use a reserved character in one of your questions. Characters to look out for are <, >, and &. You can still save, but you CANNOT LOAD THIS FORM again until you fix the XML by hand. What would you like to do?";var L=Q.generateNewModal("Form Validation Error",[{title:"Fix the problem (recommended)",cssClasses:"btn-primary",action:function(){Q.closeModal()},},{title:"Save anyway",action:function(){Q.closeModal();Q.send(P,O?"full":null)},},],false,"icon-warning-sign");L.find(".modal-body").html(M);L.modal("show");return}this.showSourceXMLModal()};v.send=function(R,P){var S=b("CryptoJS"),O=this,K=this.opts().core,M,N;P=P||K.saveType;var L=P==="patch"?K.patchUrl:K.saveUrl;t();if(P==="patch"){var Q=b("diff-match-patch"),T=new Q();M=T.patch_toText(T.patch_make(this.data.core.lastSavedXForm,R));if(M.length>R.length&&K.saveUrl){P="full";L=K.saveUrl}}if(P==="patch"){N={patch:M,sha1:S.SHA1(this.data.core.lastSavedXForm).toString()}}else{N={xform:R}}this.data.core.saveButton.ajax({type:"POST",url:L,data:N,dataType:"json",error:function(){c()},success:function(U){if(P==="patch"){if(U.status==="conflict"){if(J.isUndefined(U.xform)){O.send(R,"full")}else{c();O.showOverwriteWarning(O.send.bind(O),R,U.xform)}return}else{if(S.SHA1(R).toString()!==U.sha1){r.error("sha1's didn't match");O.send(R,"full")}}}c();O.opts().core.onFormSave(U);O.data.core.lastSavedXForm=R}})};v.getSections=function(K){return[{slug:"main",displayName:"Basic",properties:this.getMainProperties(),help:{title:"Basic",text:"<p>The <strong>Question ID</strong> is an internal identifier for a question. It does not appear on the phone. It is the name of the question in data exports.</p><p>The <strong>Label</strong> is text that appears in the application. This text will not appear in data exports.</p> ",link:"https://confluence.dimagi.com/display/commcarepublic/Form+Builder"}},{slug:"data_source",displayName:"Data Source",properties:this.getDataSourceProperties(),help:{title:"Data Source",text:"You can configure an external data source like a case list or lookup table to use as the choices for a multiple choice question."}},{slug:"logic",displayName:"Logic",properties:this.getLogicProperties(),help:{title:"Logic",text:"Use logic to control when questions are asked and what answers are valid. You can add logic to display a question based on a previous answer, to make the question required or ensure the answer is in a valid range.",link:"https://confluence.dimagi.com/display/commcarepublic/Common+Logic+and+Calculations"}}]};v.getMainProperties=function(){return["nodeID","label","readOnlyControl","itemsetData"]};v.getDataSourceProperties=function(){return[]};v.getMediaProperties=function(){return["mediaItext"]};v.getLogicProperties=function(){return["requiredAttr","defaultValue",]};v.getAdvancedProperties=function(){return["dataSource","dataValue","defaultValue","xmlnsAttr","label","hintLabel","constraintMsgAttr","dataParent","appearance",]};function C(K,L){var M=L.p.getDefinition(K);if(!M||!L.isVisible(K)){return null}return{widget:M.widget||y.text,options:x.extend(true,{path:K},M)}}v.getMugSpec=function(){return o.baseSpecs};v.isMugRemoveable=function(K,L){return K.options.isRemoveable};v.isPropertyLocked=function(K,L){return false};v.isMugPathMoveable=function(K){return true};v.isMugTypeChangeable=function(L,K){return L.options.isTypeChangeable};v.handleMugRename=function(O,K,L,P,N,Q,M){O.handleMugRename(K,L,P,N,Q,M)};v.duplicateMugProperties=function(K){};v.beforeSerialize=function(){};v.afterSerialize=function(){};v.beforeBulkInsert=function(K){};v.afterBulkInsert=function(K){this.refreshVisibleData()};v.parseDataElement=function(M,L,K,N){return w.parseDataElement(M,L,K,N)};v.parseBindElement=function(L,K,M){return w.parseBindElement(L,K,M)};v.parseSetValue=function(L,K,M){return w.parseSetValue(L,K,M)};v.getControlNodeAdaptorFactory=function(K){return this.data.core.controlNodeAdaptorMap[K]};v.populateControlMug=function(K,L){return w.populateControlMug(K,L)};v.updateControlNodeAdaptorMap=function(K){};v.contributeToModelXML=function(K){};v.contributeToHeadXML=function(K,L){};v.initWidget=function(K){};v.destroy=function(){};x.vellum.plugin("core",{form:null,loadDelay:500,patchUrl:false,saveUrl:false,saveType:"full",staticPrefix:"",allowedDataNodeReferences:[],noTextString:"[no text]",onReady:function(){},onFormSave:function(K){},bindBeforeUnload:function(K){x(window).bind("beforeunload",K)}},v)});function HandleBrowseClick(){var a=document.getElementById("file");a.click()};