define(["vellum/form","jquery","underscore","vellum/mugs","vellum/parser","vellum/tree","vellum/util","vellum/widgets","vellum/core"],function(p,e,A,m,c,x,a,q){var o="http://commcarehq.org/ledger/v1",i="ledger",d="jr://instance/ledgerdb",n=0,B=[{attr:"entryId",path:"entry/@id"},{attr:"src",path:"@src"},{attr:"dest",path:"@dest"},{attr:"date",path:"@date"}],f={Balance:[{attr:"entryId",path:"entry/@id"},{attr:"entityId",path:"@entity-id"},{attr:"date",path:"@date"}],Transfer:B,Dispense:B,Receive:B,},l={slug:"main",displayName:"Basic",properties:["nodeID","src","dest","sectionId","entryId","quantity"],help:{title:"Basic",text:"<p>The <strong>Question ID</strong> is an internal identifier for a question. It does not appear on the phone. It is the name of the question in data exports.</p>",link:"https://help.commcarehq.org/display/commcarepublic/Transactions",},},w={slug:"logic",displayName:"Logic",help:{title:"Logic",text:"Use logic to control when questions are asked and what answers are valid. You can add logic to display a question based on a previous answer, to make the question required or ensure the answer is in a valid range.",link:"https://confluence.dimagi.com/display/commcarepublic/Common+Logic+and+Calculations"},properties:["relevantAttr",]},g={Balance:[A.extend({},l,{properties:["nodeID","entityId","sectionId","entryId","quantity"],}),w],Transfer:[l,w],Dispense:[l,w],Receive:[l,w],},v=a.extend(m.defaultOptions,{isDataOnly:true,isTypeChangeable:false,supportsDataNodeRole:true,parseDataNode:function(D,C){D.p.nodeID=D.p.rawDataAttributes.type||"tx-"+n++;delete D.p.rawDataAttributes.type;D.p.sectionId=D.p.rawDataAttributes["section-id"];delete D.p.rawDataAttributes["section-id"];return e([])},getPathName:function(C,D){return C.options.getTagName()+"[@type='"+D+"']"},dataChildFilter:function(D,C){return[new x.Node(D,{getNodeID:function(){return"entry"},p:{rawDataAttributes:null},options:{getExtraDataAttributes:function(E){return{id:"",quantity:""}}}})]},getBindList:function(C){return[{nodeset:C.absolutePath,relevant:C.p.relevantAttr,},{nodeset:C.absolutePath+"/entry/@quantity",calculate:C.p.quantity,}]},spec:{date:{visibility:"hidden",presence:"optional",serialize:function(){},deserialize:function(){},},sectionId:{lstring:"Balance ID",visibility:"visible",presence:"optional",widget:q.text,help:"The name of the balance you are tracking. This is an internal identifier which does not appear on the phone.",},entryId:{lstring:"Product",visibility:"visible",presence:"optional",widget:q.xPath,xpathType:"generic",serialize:m.serializeXPath,deserialize:m.deserializeXPath,help:'A reference to a product ID, e.g., "/data/products/current_product"',},quantity:{lstring:"Quantity",visibility:"visible",presence:"optional",widget:q.xPath,xpathType:"generic",serialize:m.serializeXPath,deserialize:m.deserializeXPath,help:"A reference to an integer question in this form.",},relevantAttr:{visibility:"visible",presence:"optional",widget:q.xPath,xpathType:"bool",serialize:m.serializeXPath,deserialize:m.deserializeXPath,lstring:"Display Condition"},},getSetValues:function(C){var F=C.absolutePath,E=C.isInRepeat()?"jr-insert":"xforms-ready",D=[];A.each(f[C.__className],function(I){var H=C.p[I.attr],G=F+"/"+I.path;if(H){D.push({event:E,ref:G,value:H})}});return D},}),j=a.extend(v,{typeName:"Balance",getTagName:function(){return"balance"},getExtraDataAttributes:function(C){var D=C.p.rawDataAttributes||{};return{xmlns:o,type:C.p.nodeID,"entity-id":D["entity-id"]||"","section-id":C.p.sectionId,date:D.date||""}},icon:"fcc fcc-fd-hash",init:function(C,D){C.p.entityId="";C.p.sectionId="";C.p.entryId="";C.p.quantity="";C.p.date="/data/meta/timeEnd";y(C,D)},spec:{xmlnsAttr:{presence:"optional",serialize:function(){},deserialize:function(){}},nodeID:{serialize:h},entityId:{lstring:"Case",visibility:"visible",presence:"optional",widget:q.xPath,xpathType:"generic",serialize:m.serializeXPath,deserialize:m.deserializeXPath,help:"XPath expression for the case ID associated with this balance.",},requiredAttr:{presence:"notallowed"},constraintAttr:{presence:"notallowed"},calculateAttr:{presence:"notallowed"}}}),r=function(C){var D={key:"commtrack-transfer-src-dest-error",level:C.ERROR};if(!C.p.dest||!C.p.src){D.message="Transfer must have both Source Case and Destination Case defined."}C.addMessages({src:[D],dest:[D]});return"pass"},s=a.extend(v,{typeName:"Transfer",getTagName:function(){return"transfer"},isTypeChangeable:true,typeChangeError:function(D,C){if(C!=="Balance"&&D.__className!=="Balance"&&u(D)&&u({__className:C})){return""}return"Cannot change $1 to $2".replace("$1",D.__className).replace("$2",C)},getExtraDataAttributes:function(C){var E=C.p.rawDataAttributes||{},D={xmlns:o,type:C.p.nodeID,date:E.date||"","section-id":C.p.sectionId,};if(C.p.src&&e.trim(C.p.src)){D.src=E.src||""}else{delete E.src}if(C.p.dest&&e.trim(C.p.dest)){D.dest=E.dest||""}else{delete E.dest}return D},icon:"icon-exchange",init:function(C,D){C.p.src="";C.p.dest="";C.p.sectionId="";C.p.entryId="";C.p.quantity="";C.p.date="/data/meta/timeEnd";y(C,D)},spec:{nodeID:{serialize:h},xmlnsAttr:{presence:"optional",serialize:function(){},deserialize:function(){}},src:{lstring:"Source Case",visibility:"visible",presence:"required",widget:q.xPath,xpathType:"generic",serialize:m.serializeXPath,deserialize:m.deserializeXPath,help:"XPath expression for the case ID issuing the transaction.",validationFunc:r,},dest:{lstring:"Destination Case",visibility:"visible",presence:"required",widget:q.xPath,xpathType:"generic",serialize:m.serializeXPath,deserialize:m.deserializeXPath,help:"XPath expression for the case ID receiving the transaction.",validationFunc:r,},requiredAttr:{presence:"notallowed"},constraintAttr:{presence:"notallowed"},calculateAttr:{presence:"notallowed"}}}),b=a.extend(s,{typeName:"Dispense",icon:"icon-signout",spec:{src:{validationFunc:function(C){if(C.p.src){return"pass"}return"Dispense must have a Source Case."},},dest:{presence:"notallowed"},}}),z=a.extend(s,{typeName:"Receive",icon:"icon-signin",spec:{src:{presence:"notallowed"},dest:{validationFunc:function(C){if(C.p.dest){return"pass"}return"Receive must have a Destination Case."},},}}),k=A.chain(f).map(function(C,D){return A.map(C,function(E){return RegExp.escape(E.path)})}).flatten().uniq().value(),t=new RegExp("/("+k.join("|")+")$");e.vellum.plugin("commtrack",{},{getAdvancedQuestions:function(){return this.__callOld().concat(["Balance","Transfer","Dispense","Receive"])},getMugTypes:function(){var C=this.__callOld();C.normal.Balance=j;C.normal.Transfer=s;C.normal.Dispense=b;C.normal.Receive=z;return C},parseDataElement:function(G,F,D,H){var C=F.nodeName;if(!H&&(C==="transfer"||C==="balance")&&e(F).attr("xmlns")===o){if(C==="transfer"){var E=e(F);if(A.isUndefined(E.attr("src"))){H="Receive"}else{if(A.isUndefined(E.attr("dest"))){H="Dispense"}else{H="Transfer"}}}else{H="Balance"}return this.__callOld(G,F,D,H)}return this.__callOld()},parseBindElement:function(E,D,F){var C=E.getMugByPath(F);if(!C){var G=F.replace(/\/entry\/@quantity$/,"");if(F!==G){C=E.getMugByPath(G);if(u(C)){C.p.quantity=D.attr("calculate");return}}}else{if(u(C)){C.p.relevantAttr=D.attr("relevant");return}}this.__callOld()},parseSetValue:function(E,D,F){var C=E.getMugByPath(F);if(!C){var H=F.replace(t,"");if(F!==H){C=E.getMugByPath(H);if(u(C)){var G=A.find(f[C.__className],function(I){return I.path===F.match(t)[1]}).attr;C.p[G]=D.attr("value");return}}}this.__callOld()},getSections:function(C){if(g.hasOwnProperty(C.__className)){return A.map(g[C.__className],function(D){return A.clone(D)})}return this.__callOld()},});function u(C){return C&&f.hasOwnProperty(C.__className)}function y(C,D){var E={id:i,src:d};D.addInstanceIfNotExists(E,C,"")}function h(G,D,C,F){var E=C.parentMug,H=E?C.form.getAbsolutePath(E,true)+"/":"/";F.id=H+C.p.nodeID}});