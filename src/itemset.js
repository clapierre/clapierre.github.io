define(["underscore","jquery","tpl!vellum/templates/external_data_source","tpl!vellum/templates/custom_data_source","vellum/widgets","vellum/datasources","vellum/form","vellum/mugs","vellum/parser","vellum/util","vellum/debugutil"],function(w,e,t,f,p,u,b,n,c,a,o){var d=n.baseMugTypes.normal,q,g,l,m=/\[[^\[]*\]$/;q=a.extend(n.defaultOptions,{isControlOnly:true,typeName:"Lookup Table Data",tagName:"itemset",icon:"icon-th",isTypeChangeable:false,isRemoveable:false,isCopyable:false,getIcon:function(x){return"icon-th"},init:function(x,z,y){x.p.itemsetData={}},writeControlLabel:false,writeControlRefAttr:null,writeCustomXML:function(x,z){var B=z.p.itemsetData,y=B.nodeset,A=z.p.filter;if(A){y+="["+A+"]"}x.writeAttributeString("nodeset",y||"");x.writeStartElement("label");x.writeAttributeString("ref",B.labelRef||"");x.writeEndElement();x.writeStartElement("value");x.writeAttributeString("ref",B.valueRef||"");x.writeEndElement()},spec:{label:{presence:"notallowed"},labelItext:{presence:"notallowed"},labelItextID:{presence:"notallowed"},hintLabel:{presence:"notallowed"},hintItext:{presence:"notallowed"},hintItextID:{presence:"notallowed"},helpItext:{presence:"notallowed"},helpItextID:{presence:"notallowed"},mediaItext:{presence:"notallowed"},otherItext:{presence:"notallowed"},appearance:{presence:"notallowed"},itemsetData:{lstring:"Lookup Table",visibility:"visible_if_present",presence:"optional",widget:i,serialize:function(A,y,x,z){A.nodeset=n.serializeXPath(A.nodeset,y,x,z);return A},deserialize:function(A,y,x){var z=n.deserializeXPath(A,y,x);if(z&&z.instance&&z.instance.id&&z.instance.src){var B={};B[z.instance.id]=z.instance.src;x.form.updateKnownInstances(B)}return z},validationFunc:function(C){var z=C.p.itemsetData;if(!z.nodeset){return"A data source must be selected."}else{C.form.updateLogicReferences(C,"itemsetData",z.nodeset)}if(!z.valueRef){return"Choice Value must be specified."}if(!z.labelRef){return"Choice Label must be specified."}var x=h(),B=u.getPossibleFixtures(x),E=w.some(B,function(G){return G.src===z.instance.src}),F=u.autocompleteChoices(x,z.instance.src),D=/\[[^\[]+]/g,A=z.valueRef.replace(D,""),y=z.labelRef.replace(D,"");if(E&&!w.contains(F,A)){return z.valueRef+" was not found in the lookup table"}else{if(E&&!w.contains(F,y)){return z.labelRef+" was not found in the lookup table"}}return"pass"}},filter:{lstring:"Filter",presence:"optional",widget:p.xPath,xpathType:"bool",serialize:n.serializeXPath,deserialize:n.deserializeXPath,visibility:"visible",leftPlaceholder:"",autocompleteChoices:function(x){var y=h(),z=x.p.itemsetData.instance.src;return u.autocompleteChoices(y,z)},help:"This is an XPath expression that will filter the set of choices from the lookup table",}}});function j(y,x){return y.createQuestion(x,"into","Itemset",true)}var k={presence:"optional",visibility:"hidden",serialize:function(A,y,x,z){A=w.chain(x.form.getChildren(x)).map(function(B){return B.spec[y].serialize(B.p[y],y,B,z)}).filter(w.identity).value();return !w.isEmpty(A)?A:undefined},deserialize:function(z,y,x){w.each(z[y],function(D,B){var A=x.form.getChildren(x),E=A[B]||j(x.form,x),C=w.clone(z);C[y]=D;E.p[y]=E.spec[y].deserialize(C,y,E)})}};function v(x,A,z){if(z&&z.instance&&z.instance.src){x.form.dropInstanceReference(z.instance.src,x,"itemsetData.instance")}if(A&&A.instance&&A.instance.src){var y=x.form.addInstanceIfNotExists(A.instance,x,"itemsetData.instance");if(y!==A.instance.id){A.instance.id=y;A.nodeset=x.form.updateInstanceQuery(A.nodeset,y)}}}function r(x){var y=x.search(m);if(y!==-1){return{value:x.slice(0,y),filter:x.slice(y+1,-1)}}return{value:x,filter:""}}function h(){var x=[];u.getDataSources(function(y){if(l.dataSourcesFilter){y=l.dataSourcesFilter(y)}x=y});return x}function i(F,M){function L(N){return !N||w.all(w.map(N,w.isEmpty))}function K(O){var N=J(),P=u.autocompleteChoices(O,N?N.src:"");H.addAutocomplete(P,D);A.addAutocomplete(P,D);return P}function y(N){x=N;B=true;if(C){var O=K(N);if(O&&O.length&&L(G.value)){if(w.contains(O,"name")){H.val("name")}else{H.val(O[0])}if(w.contains(O,"@id")){A.val("@id")}else{A.val(O.length>1?O[1]:O[0])}if(G.hasOwnProperty("value")){D()}}}}M=w.extend({},M,{onOptionsLoaded:y,dataSourcesFilter:l.dataSourcesFilter,});if(g){M.hasAdvancedEditor=true;M.getSource=function(N){var O=J();if(N.p.filter){O.query+="["+N.p.filter+"]"}return O};M.setSource=function(P,O){var Q=P,N=r(P.query);Q.query=N.value;O.p.filter=N.filter;I(Q)}}var G={},x=[],B=false,C=false,E=u.fixtureWidget(F,M,"Lookup Table"),z=E.getUIElement,J=E.getValue,I=E.setValue,D=E.handleChange,H=s("label_ref","Label Field",false),A=s("value_ref","Value Field",false);E.handleChange=function(){K(x);D()};H.onChange(D);A.onChange(D);E.getUIElement=function(){return e("<div>").append(z()).append(A.element).append(H.element)};E.getValue=function(){var N=J();return{instance:(e.trim(N.src)?{id:N.id,src:N.src}:{id:null,src:null}),nodeset:N.query,labelRef:H.val(),valueRef:A.val()}};E.setValue=function(O){var N=G.hasOwnProperty("value");G.value=O;if(B&&!N&&L(O)){D();return}O=w.isEmpty(O)?{instance:{}}:O;I({id:(O.instance?O.instance.id:""),src:(O.instance?O.instance.src:""),query:O.nodeset||""});H.val(O.labelRef);A.val(O.valueRef)};C=true;if(B){y(x)}return E}function s(A,z,x){var y=e("<input type='text' class='input-block-level'>");y.attr("name",A);return{addAutocomplete:function(B,C){a.dropdownAutocomplete(y,B);y.on("blur change",function(){if(w.isFunction(C)){C()}})},element:p.util.getUIElement(y,z,x),val:function(B){if(w.isUndefined(B)){return y.val()}else{y.val(B||"")}},onChange:function(B){y.bind("change keyup",B)}}}});