var HQMediaUploaderTypes={bulk:HQMediaBulkUploadController,file:HQMediaFileUploadController};function BaseHQMediaUploadController(d,a,c){var b=this;b.container="#"+d;b.marker=a+"_";b.swfURL=c.swfURL;b.fileFilters=c.fileFilters;b.isMultiFileUpload=c.isMultiFileUpload;b.isFlashSupported=c.isFlashSupported;b.selectFilesButtonContainer=b.container+" .hqm-select-files-container";b.selectFilesButton=b.container+" .hqm-select";b.uploadButtonSelector=b.container+" .hqm-upload";b.confirmUploadSelector=b.container+" .hqm-upload-confirm";b.processingFilesListSelector=b.container+" .hqm-upload-processing";b.uploadedFilesListSelector=b.container+" .hqm-uploaded-files";b.queueSelector=b.container+" .hqm-queue";b.uploadFormSelector=b.container+" .hqm-upload-form";b.notSupportedNotice=b.container+" .hqm-not-supported";b.allowCloseDuringUpload=c.allowCloseDuringUpload||false;b.queueTemplate=c.queueTemplate;b.errorsTemplate=c.errorsTemplate;b.uploadParams=c.uploadParams||{};b.sessionid=c.sessionid||null;b.licensingParams=c.licensingParams||[];b.uploadURL=c.uploadURL;b.processingURL=c.processingURL;b.pollInterval=2000;b.maxPollInterval=20000;b.currentPollAttempts=0;b.maxPollAttempts=20;b.allowClose=true;$(b.container).on("hide.bs.modal",function(e){if(!b.allowClose){e.preventDefault()}});b.getActiveUploadSelectors=function(f){var e="#"+b.marker+f.get("id");return{selector:e,progressBarContainer:e+" .progress",progressBar:e+" .progress .bar",cancel:e+" .hqm-cancel",remove:e+" .hqm-remove",beginNotice:e+" .hqm-begin",processingQueuedNotice:e+" .hqm-processing-queued",processingNotice:e+" .hqm-processing",completeNotice:e+" .hqm-upload-completed",errorNotice:e+" .hqm-error",status:e+" .hqm-status",details:e+" .hqm-details"}};b.processQueueTemplate=function(e){var f=1048576;return _.template(b.queueTemplate,{unique_id:b.marker+e.get("id"),file_size:(e.get("size")/f).toFixed(3),file_name:e.get("name")})};b.processErrorsTemplate=function(e){return _.template(b.errorsTemplate,{errors:e})};b.cancelFileUpload=function(e){return function(g){e.cancelUpload();var f=b.getActiveUploadSelectors(e);$(f.progressBar).attr("style","width: 0%;");$(f.cancel).addClass("hide");$(f.remove).removeClass("hide");g.preventDefault();b.allowClose=true}};b.removeFileFromQueue=function(e){return function(f){b.removeFileFromUploader(e);b.removeFileFromUI(e);f.preventDefault()}};b.startUploadUI=function(){};b.removeFileFromUI=function(e){var f=b.getActiveUploadSelectors(e);$(f.selector).remove();b.toggleUploadButton()};b.toggleUploadButton=function(){var e=$(b.uploadButtonSelector);(b.filesInQueueUI.length>0)?e.addClass("btn-success").removeClass("disabled"):e.addClass("disabled").removeClass("btn-success")};b.activateQueueUI=function(){for(var f=0;f<b.filesInQueueUI.length;f++){var e=b.filesInQueueUI[f];var g=b.getActiveUploadSelectors(e);$(g.beginNotice).addClass("hide");$(g.remove).addClass("hide");$(g.cancel).removeClass("hide")}};b.resetUploadForm=function(){var e=$(b.uploadFormSelector);e.find(".hqm-share-media").removeAttr("checked");e.find(".hqm-sharing").addClass("hide");e.find('[name="license"]').val("cc");e.find('[name="author"]').val("");e.find('[name="attribution-notes"]').val("")};b.getLicensingParams=function(){var e=$(b.uploadFormSelector),j={};for(var f=0;f<b.licensingParams.length;f++){var h=b.licensingParams[f];var g=e.find('[name="'+h+'"]').val();if(g.length>0){j[h]=g}}return j};b.init=function(){YUI().use("uploader",function(g){var f=g.one(b.selectFilesButton).get("region");var e=swfobject.getFlashPlayerVersion();if(e&&e.major>5){g.Uploader=g.UploaderFlash}if(g.Uploader.TYPE=="none"){$(b.notSupportedNotice).removeClass("hide");$(b.selectFilesButtonContainer).parent().addClass("hide");return}else{$(b.notSupportedNotice).remove()}b.uploader=new g.Uploader({width:f.width||"100px",height:f.height||"35px",selectFilesButton:g.one(b.selectFilesButton),multipleFiles:b.isMultiFileUpload});if(g.Uploader.TYPE=="flash"){b.uploader.set("fileFilters",b.fileFilters);b.uploader.set("swfURL",b.swfURL)}b.uploader.on("fileselect",b.fileSelect);b.uploader.on("uploadprogress",b.uploadProgress);b.uploader.on("uploadcomplete",b.uploadComplete);b.uploader.on("uploaderror",b.uploadError);b.uploader.render(b.selectFilesButtonContainer)});$(function(){b.resetUploader();$(b.confirmUploadSelector).click(b.startUpload);$(b.uploadFormSelector).find(".hqm-share-media").change(function(){var e=$(b.uploadFormSelector).find(".hqm-sharing");($(this).prop("checked"))?e.removeClass("hide"):e.addClass("hide")})})};b.resetUploader=function(){b.filesInQueueUI=[];b.processingIdToFile={};b.allowClose=true;b.toggleUploadButton();b.resetUploadForm();if(!b.isMultiFileUpload){$(b.queueSelector).empty()}};b.clearUploaderData=function(){b.uploader.set("fileList",[])};b.removeFileFromUploader=function(f){var e=b.uploader.get("fileList");b.uploader.set("fileList",_.without(e,f));b.filesInQueueUI=_.without(b.filesInQueueUI,f)};b.fileSelect=function(h){if(!b.isMultiFileUpload){b.resetUploader();b.uploader.set("fileList",h.fileList)}for(var i=0;i<h.fileList.length;i++){var g=h.fileList[i];if(b.filesInQueueUI.indexOf(g)<0){b.filesInQueueUI.push(g);$(b.queueSelector).append(b.processQueueTemplate(g));var e=b.getActiveUploadSelectors(g);$(e.cancel).click(b.cancelFileUpload(g));if($(e.remove)){$(e.remove).click(b.removeFileFromQueue(g))}}}b.toggleUploadButton()};b.startUpload=function(g){if(!b.allowCloseDuringUpload){b.allowClose=false}if(!b.isMultiFileUpload){var f="."+b.filesInQueueUI[0].get("name").split(".").pop().toLowerCase();b.uploadParams.path=b.uploadParams.path.replace(/(\.[^/.]+)?$/,f)}$(b.uploadButtonSelector).addClass("disabled").removeClass("btn-success");b.startUploadUI();var i=_.clone(b.uploadParams);for(var e in b.uploadParams){if(b.uploadParams.hasOwnProperty(e)&&$(b.uploadFormSelector).find('[name="'+e+'"]').prop("checked")){i[e]=true}}var h=document.cookie;if(!/sessionid=/.exec(h)&&b.sessionid){if(h){h+="; "}h+="sessionid="+b.sessionid}i._cookie=h;b.uploader.uploadAll(b.uploadURL,i);b.activateQueueUI();g.preventDefault()};b.uploadProgress=function(f){var e=b.getActiveUploadSelectors(f.file);$(e.progressBar).attr("style","width: "+f.percentLoaded+"%;")};b.uploadComplete=function(e){throw new Error("Missing implementation for uploadComplete")};b.uploadError=function(f){b.allowClose=true;var e=b.getActiveUploadSelectors(f.file);$(e.progressBarContainer).addClass("progress-danger");b.showErrors(f.file,["Upload Failed: Issue communicating with server.  This usually means your Internet connection is not strong enough. Try again later."])};b.showErrors=function(f,g){var e=b.getActiveUploadSelectors(f);(g.length>0)?$(e.errorNotice).removeClass("hide"):$(e.errorNotice).addClass("hide");$(e.status).append(b.processErrorsTemplate(g))}}function HQMediaBulkUploadController(d,a,c){BaseHQMediaUploadController.call(this,d,a,c);var b=this;b.confirmUploadModalSelector="#hqm-upload-modal";b.detailsTemplate=c.detailsTemplate;b.statusTemplate=c.statusTemplate;b.processDetailsTemplate=function(e,h,g,f){return _.template(b.detailsTemplate,{images:e,audio:h,video:g,unknowns:f})};b.processStatusTemplate=function(e,g,f){var h=e.length+g.length+f.length;return _.template(b.statusTemplate,{num:h})};b.startUploadUI=function(){if($(b.confirmUploadModalSelector)){$(b.confirmUploadModalSelector).modal("hide")}};b.uploadComplete=function(g){var e=b.getActiveUploadSelectors(g.file);$(e.progressBarContainer).removeClass("active");$(e.cancel).addClass("hide");b.removeFileFromUploader(g.file);var f=$(e.selector);f.remove();f.insertAfter($(b.processingFilesListSelector).find(".hqm-list-notice"));b.beginProcessing(g);b.toggleUploadButton()};b.beginProcessing=function(h){var f=$.parseJSON(h.data);var g=f.processing_id;b.processingIdToFile[f.processing_id]=h.file;var e=b.getActiveUploadSelectors(h.file);$(e.progressBar).addClass("hide").attr("style","width: 0%;");$(e.progressBarContainer).addClass("progress-warning active");$(e.processingQueuedNotice).removeClass("hide");b.pollProcessingQueue(g)()};b.pollProcessingQueue=function(e){return function f(){setTimeout(function(){if(e in b.processingIdToFile){$.ajax({url:b.processingURL,dataType:"json",data:{processing_id:e},type:"POST",success:b.processingProgress,error:b.processingError(e),complete:f,timeout:b.pollInterval})}},b.pollInterval)}};b.processingProgress=function(g){b.currentPollAttempts=0;var e=b.getActiveUploadSelectors(b.processingIdToFile[g.processing_id]);if(g.in_celery){$(e.processingQueuedNotice).addClass("hide");$(e.processingNotice).removeClass("hide");$(e.progressBar).removeClass("hide").attr("style","width: "+g.progress+"%;");if(g.total_files){var f=$(e.processingNotice).find(".label");f.find(".denominator").text(g.total_files);f.find(".numerator").text(g.processed_files||0);f.removeClass("hide")}}if(g.complete){b.processingComplete(g)}};b.processingComplete=function(g){var f=b.processingIdToFile[g.processing_id];delete b.processingIdToFile[g.processing_id];var e=b.getActiveUploadSelectors(f);b.stopProcessingFile(f);$(e.progressBarContainer).addClass("progress-success");b.showMatches(f,g);b.showErrors(f,g.errors)};b.processingError=function(e){return function(i,f){if(b.pollInterval<b.maxPollInterval){b.pollInterval=Math.min(b.pollInterval+2000,b.maxPollInterval)}else{b.currentPollAttempts+=1}if(b.currentPollAttempts>b.maxPollAttempts){var h=b.processingIdToFile[e];delete b.processingIdToFile[e];var g=b.getActiveUploadSelectors(h);b.stopProcessingFile(h);$(g.progressBarContainer).addClass("progress-danger");b.showErrors(h,["There was an issue communicating with the server at this time. The upload has failed."])}}};b.stopProcessingFile=function(f){var e=b.getActiveUploadSelectors(f);if(b.isMultiFileUpload){var g=$(e.selector);g.remove();g.insertAfter($(b.uploadedFilesListSelector).find(".hqm-list-notice"))}$(e.processingNotice).addClass("hide");$(e.completeNotice).removeClass("hide");$(e.progressBar).attr("style","width: 100%;");$(e.progressBarContainer).removeClass("active progress-warning")};b.showMatches=function(g,k){var f=b.getActiveUploadSelectors(g);if(k.type==="zip"&&k.matched_files){var e=k.matched_files.CommCareImage,j=k.matched_files.CommCareAudio,i=k.matched_files.CommCareVideo,h=k.unmatched_files;$(f.status).append(b.processStatusTemplate(e,j,i));$(f.details).html(b.processDetailsTemplate(e,j,i,h));$(f.details).find(".match-info").popover({html:true,title:"Click to open in new tab.",trigger:"hover",placement:"bottom"})}}}HQMediaBulkUploadController.prototype=Object.create(BaseHQMediaUploadController.prototype);HQMediaBulkUploadController.prototype.constructor=HQMediaBulkUploadController;function HQMediaFileUploadController(d,a,c){BaseHQMediaUploadController.call(this,d,a,c);var b=this;b.currentReference=null;b.existingFileTemplate=c.existingFileTemplate;b.processExistingFileTemplate=function(e){return _.template(b.existingFileTemplate,{url:e})};b.existingFileSelector=b.container+" .hqm-existing";b.fileUploadCompleteSelector=b.existingFileSelector+" .hqm-upload-completed";b.updateUploadFormUI=function(){var e=$(b.existingFileSelector);$(b.fileUploadCompleteSelector).addClass("hide");if(b.currentReference.isMediaMatched()){e.removeClass("hide");e.find(".controls").html(b.processExistingFileTemplate(b.currentReference.getUrl()))}else{e.addClass("hide");e.find(".controls").empty()}$(".existing-media").tooltip({placement:"bottom"})};b.uploadComplete=function(g){b.allowClose=true;var f=b.getActiveUploadSelectors(g.file);$(f.cancel).addClass("hide");$(f.progressBarContainer).removeClass("active").addClass("progress-success");var e=$.parseJSON(g.data.replace(/\r|\n|\r\n/,"\\n"));$('[data-hqmediapath="'+b.currentReference.path+'"]').trigger("mediaUploadComplete",e);if(!e.errors.length){b.updateUploadFormUI();$(b.fileUploadCompleteSelector).removeClass("hide");b.removeFileFromUI(g.file);b.resetUploader()}else{b.showErrors(g.file,e.errors)}b.clearUploaderData()}}HQMediaFileUploadController.prototype=Object.create(BaseHQMediaUploadController.prototype);HQMediaFileUploadController.prototype.constructor=HQMediaFileUploadController;