!function(d,c){"function"==typeof define&&define.amd?define(["jquery"],function(b){return c(b)}):"object"==typeof exports?module.exports=c(require("jquery")):c(jQuery)}(this,function(z){var y,x,w,v,u,t,s,r,q,p=[].slice,o=function(f,e){function h(){this.constructor=f}for(var g in e){n.call(e,g)&&(f[g]=e[g])}return h.prototype=e.prototype,f.prototype=new h,f.__super__=e.prototype,f},n={}.hasOwnProperty;x=function(){function b(c){this.currentFlag=null,this.controllers={},this.aliasMaps={},this.$inputor=$(c),this.setupRootElement(),this.listen()}return b.prototype.createContainer=function(d){var c;return null!=(c=this.$el)&&c.remove(),$(d.body).append(this.$el=$("<div class='atwho-container'></div>"))},b.prototype.setupRootElement=function(f,e){var h;if(null==e&&(e=!1),f){this.window=f.contentWindow,this.document=f.contentDocument||this.window.document,this.iframe=f}else{this.document=this.$inputor[0].ownerDocument,this.window=this.document.defaultView||this.document.parentWindow;try{this.iframe=this.window.frameElement}catch(g){if(h=g,this.iframe=null,$.fn.atwho.debug){throw new Error("iframe auto-discovery is failed.\nPlease use `setIframe` to set the target iframe manually.\n"+h)}}}return this.createContainer((this.iframeAsRoot=e)?this.document:document)},b.prototype.controller=function(g){var f,j,i,h;if(this.aliasMaps[g]){j=this.controllers[this.aliasMaps[g]]}else{h=this.controllers;for(i in h){if(f=h[i],i===g){j=f;break}}}return j?j:this.controllers[this.currentFlag]},b.prototype.setContextFor=function(c){return this.currentFlag=c,this},b.prototype.reg=function(f,e){var h,g;return g=(h=this.controllers)[f]||(h[f]=this.$inputor.is("[contentEditable]")?new u(this,f):new r(this,f)),e.alias&&(this.aliasMaps[e.alias]=f),g.init(e),this},b.prototype.listen=function(){return this.$inputor.on("compositionstart",function(c){return function(a){var d;return null!=(d=c.controller())&&d.view.hide(),c.isComposing=!0}}(this)).on("compositionend",function(c){return function(a){return c.isComposing=!1}}(this)).on("keyup.atwhoInner",function(c){return function(a){return c.onKeyup(a)}}(this)).on("keydown.atwhoInner",function(c){return function(a){return c.onKeydown(a)}}(this)).on("scroll.atwhoInner",function(c){return function(a){var d;return null!=(d=c.controller())?d.view.hide(a):void 0}}(this)).on("blur.atwhoInner",function(c){return function(a){var d;return(d=c.controller())?d.view.hide(a,d.getOpt("displayTimeout")):void 0}}(this)).on("click.atwhoInner",function(c){return function(a){return c.dispatch(a)}}(this))},b.prototype.shutdown=function(){var e,d,f;f=this.controllers;for(e in f){d=f[e],d.destroy(),delete this.controllers[e]}return this.$inputor.off(".atwhoInner"),this.$el.remove()},b.prototype.dispatch=function(g){var f,j,i,h;i=this.controllers,h=[];for(f in i){j=i[f],h.push(j.lookUp(g))}return h},b.prototype.onKeyup=function(d){var c;switch(d.keyCode){case t.ESC:d.preventDefault(),null!=(c=this.controller())&&c.view.hide();break;case t.DOWN:case t.UP:case t.CTRL:$.noop();break;case t.P:case t.N:d.ctrlKey||this.dispatch(d);break;default:this.dispatch(d)}},b.prototype.onKeydown=function(e){var d,f;if(f=null!=(d=this.controller())?d.view:void 0,f&&f.visible()){switch(e.keyCode){case t.ESC:e.preventDefault(),f.hide(e);break;case t.UP:e.preventDefault(),f.prev();break;case t.DOWN:e.preventDefault(),f.next();break;case t.P:if(!e.ctrlKey){return}e.preventDefault(),f.prev();break;case t.N:if(!e.ctrlKey){return}e.preventDefault(),f.next();break;case t.TAB:case t.ENTER:case t.SPACE:if(!f.visible()){return}if(!this.controller().getOpt("spaceSelectsMatch")&&e.keyCode===t.SPACE){return}if(!this.controller().getOpt("tabSelectsMatch")&&e.keyCode===t.TAB){return}f.highlighted()?(e.preventDefault(),f.choose(e)):f.hide(e);break;default:$.noop()}}},b}(),w=function(){function b(d,c){this.app=d,this.at=c,this.$inputor=this.app.$inputor,this.id=this.$inputor[0].id||this.uid(),this.setting=null,this.query=null,this.pos=0,this.range=null,0===(this.$el=$("#atwho-ground-"+this.id,this.app.$el)).length&&this.app.$el.append(this.$el=$("<div id='atwho-ground-"+this.id+"'></div>")),this.model=new s(this),this.view=new q(this)}return b.prototype.uid=function(){return(Math.random().toString(16)+"000000000").substr(2,8)+(new Date).getTime()},b.prototype.init=function(c){return this.setting=$.extend({},this.setting||$.fn.atwho["default"],c),this.view.init(),this.model.reload(this.setting.data)},b.prototype.destroy=function(){return this.trigger("beforeDestroy"),this.model.destroy(),this.view.destroy(),this.$el.remove()},b.prototype.callDefault=function(){var f,e,h;h=arguments[0],f=2<=arguments.length?p.call(arguments,1):[];try{return v[h].apply(this,f)}catch(g){return e=g,$.error(e+" Or maybe At.js doesn't have function "+h)}},b.prototype.trigger=function(f,e){var h,g;return null==e&&(e=[]),e.push(this),h=this.getOpt("alias"),g=h?f+"-"+h+".atwho":f+".atwho",this.$inputor.trigger(g,e)},b.prototype.callbacks=function(c){return this.getOpt("callbacks")[c]||v[c]},b.prototype.getOpt=function(f,e){var h;try{return this.setting[f]}catch(g){return h=g,null}},b.prototype.insertContentFor=function(e){var d,f;return f=this.getOpt("insertTpl"),d=$.extend({},e.data("item-data"),{"atwho-at":this.at}),this.callbacks("tplEval").call(this,f,d,"onInsert")},b.prototype.renderView=function(d){var c;return c=this.getOpt("searchKey"),d=this.callbacks("sorter").call(this,this.query.text,d.slice(0,1001),c),this.view.render(d.slice(0,this.getOpt("limit")))},b.arrayToDefaultHash=function(g){var f,j,i,h;if(!$.isArray(g)){return g}for(h=[],f=0,i=g.length;i>f;f++){j=g[f],h.push($.isPlainObject(j)?j:{name:j})}return h},b.prototype.lookUp=function(e){var d,f;if(d=this.catchQuery(e)){return this.app.setContextFor(this.at),(f=this.getOpt("delay"))?this._delayLookUp(d,f):this._lookUp(d),d}},b.prototype._delayLookUp=function(f,e){var h,g;return h=Date.now?Date.now():(new Date).getTime(),this.previousCallTime||(this.previousCallTime=h),g=e-(h-this.previousCallTime),g>0&&e>g?(this.previousCallTime=h,this._stopDelayedCall(),this.delayedCallTimeout=setTimeout(function(a){return function(){return a.previousCallTime=0,a.delayedCallTimeout=null,a._lookUp(f)}}(this),e)):(this._stopDelayedCall(),this.previousCallTime!==h&&(this.previousCallTime=0),this._lookUp(f))},b.prototype._stopDelayedCall=function(){return this.delayedCallTimeout?(clearTimeout(this.delayedCallTimeout),this.delayedCallTimeout=null):void 0},b.prototype._lookUp=function(d){var c;return c=function(e){return e&&e.length>0?this.renderView(this.constructor.arrayToDefaultHash(e)):this.view.hide()},this.model.query(d.text,$.proxy(c,this))},b}(),r=function(d){function c(){return c.__super__.constructor.apply(this,arguments)}return o(c,d),c.prototype.catchQuery=function(){var h,g,l,k,j,i;return g=this.$inputor.val(),h=this.$inputor.caret("pos",{iframe:this.app.iframe}),i=g.slice(0,h),k=this.callbacks("matcher").call(this,this.at,i,this.getOpt("startWithSpace")),"string"==typeof k&&k.length<=this.getOpt("maxLen",20)?(j=h-k.length,l=j+k.length,this.pos=j,k={text:k,headPos:j,endPos:l},this.trigger("matched",[this.at,k.text])):(k=null,this.view.hide()),this.query=k},c.prototype.rect=function(){var f,e,g;if(f=this.$inputor.caret("offset",this.pos-1,{iframe:this.app.iframe})){return this.app.iframe&&!this.app.iframeAsRoot&&(e=$(this.app.iframe).offset(),f.left+=e.left,f.top+=e.top),g=this.app.document.selection?0:2,{left:f.left,top:f.top,bottom:f.top+f.height+g}}},c.prototype.insert=function(i,h){var A,m,l,k,j;return A=this.$inputor,m=A.val(),l=m.slice(0,Math.max(this.query.headPos-this.at.length,0)),k=""===(k=this.getOpt("suffix"))?k:k||" ",i+=k,j=""+l+i+m.slice(this.query.endPos||0),A.val(j),A.caret("pos",l.length+i.length,{iframe:this.app.iframe}),A.is(":focus")||A.focus(),A.change()},c}(w),u=function(d){function c(){return c.__super__.constructor.apply(this,arguments)}return o(c,d),c.prototype._getRange=function(){var b;return b=this.app.window.getSelection(),b.rangeCount>0?b.getRangeAt(0):void 0},c.prototype._setRange=function(f,e,g){return null==g&&(g=this._getRange()),g?(e=$(e)[0],"after"===f?(g.setEndAfter(e),g.setStartAfter(e)):(g.setEndBefore(e),g.setStartBefore(e)),g.collapse(!1),this._clearRange(g)):void 0},c.prototype._clearRange=function(f){var e;return null==f&&(f=this._getRange()),e=this.app.window.getSelection(),null==this.ctrl_a_pressed?(e.removeAllRanges(),e.addRange(f)):void 0},c.prototype._movingEvent=function(f){var e;return"click"===f.type||(e=f.which)===t.RIGHT||e===t.LEFT||e===t.UP||e===t.DOWN},c.prototype._unwrap=function(f){var e;return f=$(f).unwrap().get(0),(e=f.nextSibling)&&e.nodeValue&&(f.nodeValue+=e.nodeValue,$(e).remove()),f},c.prototype.catchQuery=function(I){var H,G,F,E,D,C,B,A,m,g;if(!this.app.isComposing&&(g=this._getRange())){if(I.which===t.CTRL?this.ctrl_pressed=!0:I.which===t.A?null==this.ctrl_pressed&&(this.ctrl_a_pressed=!0):(delete this.ctrl_a_pressed,delete this.ctrl_pressed),I.which===t.ENTER){return(G=$(g.startContainer).closest(".atwho-query")).contents().unwrap(),G.is(":empty")&&G.remove(),(G=$(".atwho-query",this.app.document)).text(G.text()).contents().last().unwrap(),void this._clearRange()}if(/firefox/i.test(navigator.userAgent)){if($(g.startContainer).is(this.$inputor)){return void this._clearRange()}I.which===t.BACKSPACE&&g.startContainer.nodeType===document.ELEMENT_NODE&&(A=g.startOffset-1)>=0?(F=g.cloneRange(),F.setStart(g.startContainer,A),$(F.cloneContents()).contents().last().is(".atwho-inserted")&&(D=$(g.startContainer).contents().get(A),this._setRange("after",$(D).contents().last()))):I.which===t.LEFT&&g.startContainer.nodeType===document.TEXT_NODE&&(H=$(g.startContainer.previousSibling),H.is(".atwho-inserted")&&0===g.startOffset&&this._setRange("after",H.contents().last()))}return $(g.startContainer).closest(".atwho-inserted").addClass("atwho-query").siblings().removeClass("atwho-query"),(G=$(".atwho-query",this.app.document)).length>0&&G.is(":empty")&&0===G.text().length&&G.remove(),this._movingEvent(I)||G.removeClass("atwho-inserted"),F=g.cloneRange(),F.setStart(g.startContainer,0),B=this.callbacks("matcher").call(this,this.at,F.toString(),this.getOpt("startWithSpace")),0===G.length&&"string"==typeof B&&(E=g.startOffset-this.at.length-B.length)>=0&&(g.setStart(g.startContainer,E),G=$("<span/>",this.app.document).attr(this.getOpt("editableAtwhoQueryAttrs")).addClass("atwho-query"),g.surroundContents(G.get(0)),C=G.contents().last().get(0),/firefox/i.test(navigator.userAgent)?(g.setStart(C,C.length),g.setEnd(C,C.length),this._clearRange(g)):this._setRange("after",C,g)),"string"==typeof B&&B.length<=this.getOpt("maxLen",20)?(m={text:B,el:G},this.trigger("matched",[this.at,m.text]),this.query=m):(this.view.hide(),this.query={el:G},G.text().indexOf(this.at)>=0&&(this._movingEvent(I)&&G.hasClass("atwho-inserted")?G.removeClass("atwho-query"):!1!==this.callbacks("afterMatchFailed").call(this,this.at,G)&&this._setRange("after",this._unwrap(G.text(G.text()).contents().first()))),null)}},c.prototype.rect=function(){var f,e,g;return g=this.query.el.offset(),this.app.iframe&&!this.app.iframeAsRoot&&(e=(f=$(this.app.iframe)).offset(),g.left+=e.left-this.$inputor.scrollLeft(),g.top+=e.top-this.$inputor.scrollTop()),g.bottom=g.top+this.query.el.height(),g},c.prototype.insert=function(g,f){var j,i,h;return i=""===(i=this.getOpt("suffix"))?i:i||" ",this.query.el.removeClass("atwho-query").addClass("atwho-inserted").html(g),(j=this._getRange())&&(j.setEndAfter(this.query.el[0]),j.collapse(!1),j.insertNode(h=this.app.document.createTextNode(i)),this._setRange("after",h,j)),this.$inputor.is(":focus")||this.$inputor.focus(),this.$inputor.change()},c}(w),s=function(){function b(c){this.context=c,this.at=this.context.at,this.storage=this.context.$inputor}return b.prototype.destroy=function(){return this.storage.data(this.at,null)},b.prototype.saved=function(){return this.fetch()>0},b.prototype.query=function(g,f){var j,i,h;return i=this.fetch(),h=this.context.getOpt("searchKey"),i=this.context.callbacks("filter").call(this.context,g,i,h)||[],j=this.context.callbacks("remoteFilter"),i.length>0||!j&&0===i.length?f(i):j.call(this.context,g,f)},b.prototype.fetch=function(){return this.storage.data(this.at)||[]},b.prototype.save=function(c){return this.storage.data(this.at,this.context.callbacks("beforeSave").call(this.context,c||[]))},b.prototype.load=function(c){return !this.saved()&&c?this._load(c):void 0},b.prototype.reload=function(c){return this._load(c)},b.prototype._load=function(c){return"string"==typeof c?$.ajax(c,{dataType:"json"}).done(function(d){return function(a){return d.save(a)}}(this)):this.save(c)},b}(),q=function(){function b(c){this.context=c,this.$el=$("<div class='atwho-view'><ul class='atwho-view-ul'></ul></div>"),this.timeoutID=null,this.context.$el.append(this.$el),this.bindEvent()}return b.prototype.init=function(){var c;return c=this.context.getOpt("alias")||this.context.at.charCodeAt(0),this.$el.attr({id:"at-view-"+c})},b.prototype.destroy=function(){return this.$el.remove()},b.prototype.bindEvent=function(){var c;return c=this.$el.find("ul"),c.on("mouseenter.atwho-view","li",function(a){return c.find(".cur").removeClass("cur"),$(a.currentTarget).addClass("cur")}).on("click.atwho-view","li",function(a){return function(d){return c.find(".cur").removeClass("cur"),$(d.currentTarget).addClass("cur"),a.choose(d),d.preventDefault()}}(this))},b.prototype.visible=function(){return this.$el.is(":visible")},b.prototype.highlighted=function(){return this.$el.find(".cur").length>0},b.prototype.choose=function(e){var d,f;return(d=this.$el.find(".cur")).length&&(f=this.context.insertContentFor(d),this.context.insert(this.context.callbacks("beforeInsert").call(this.context,f,d),d),this.context.trigger("inserted",[d,e]),this.hide(e)),this.context.getOpt("hideWithoutSuffix")?this.stopShowing=!0:void 0},b.prototype.reposition=function(g){var f,j,i,h;return f=this.context.app.iframeAsRoot?this.context.app.window:window,g.bottom+this.$el.height()-$(f).scrollTop()>$(f).height()&&(g.bottom=g.top-this.$el.height()),g.left>(i=$(f).width()-this.$el.width()-5)&&(g.left=i),j={left:g.left,top:g.bottom},null!=(h=this.context.callbacks("beforeReposition"))&&h.call(this.context,j),this.$el.offset(j),this.context.trigger("reposition",[j])},b.prototype.next=function(){var d,c;return d=this.$el.find(".cur").removeClass("cur"),c=d.next(),c.length||(c=this.$el.find("li:first")),c.addClass("cur"),this.scrollTop(Math.max(0,d.innerHeight()*(c.index()+2)-this.$el.height()))},b.prototype.prev=function(){var d,c;return d=this.$el.find(".cur").removeClass("cur"),c=d.prev(),c.length||(c=this.$el.find("li:last")),c.addClass("cur"),this.scrollTop(Math.max(0,d.innerHeight()*(c.index()+2)-this.$el.height()))},b.prototype.scrollTop=function(d){var c;return c=this.context.getOpt("scrollDuration"),c?this.$el.animate({scrollTop:d},c):this.$el.scrollTop(d)},b.prototype.show=function(){var c;return this.stopShowing?void (this.stopShowing=!1):(this.visible()||(this.$el.show(),this.$el.scrollTop(0),this.context.trigger("shown")),(c=this.context.rect())?this.reposition(c):void 0)},b.prototype.hide=function(e,d){var f;if(this.visible()){return isNaN(d)?(this.$el.hide(),this.context.trigger("hidden",[e])):(f=function(c){return function(){return c.hide()}}(this),clearTimeout(this.timeoutID),this.timeoutID=setTimeout(f,d))}},b.prototype.render=function(j){var i,C,B,A,m,l,k;if(!($.isArray(j)&&j.length>0)){return void this.hide()}for(this.$el.find("ul").empty(),C=this.$el.find("ul"),k=this.context.getOpt("displayTpl"),B=0,m=j.length;m>B;B++){A=j[B],A=$.extend({},A,{"atwho-at":this.context.at}),l=this.context.callbacks("tplEval").call(this.context,k,A,"onDisplay"),i=$(this.context.callbacks("highlighter").call(this.context,l,this.context.query.text)),i.data("item-data",A),C.append(i)}return this.show(),this.context.getOpt("highlightFirst")?C.find("li:first").addClass("cur"):void 0},b}(),t={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13,CTRL:17,A:65,P:80,N:78,LEFT:37,UP:38,RIGHT:39,DOWN:40,BACKSPACE:8,SPACE:32},v={beforeSave:function(b){return w.arrayToDefaultHash(b)},matcher:function(E,D,C,B){var A,m,l,k,j;return E=E.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),C&&(E="(?:^|\\s)"+E),A=decodeURI("%C3%80"),m=decodeURI("%C3%BF"),j=B?" ":"",k=new RegExp(E+"([A-Za-z"+A+"-"+m+"0-9_"+j+".+-]*)$|"+E+"([^\\x00-\\xff]*)$","gi"),l=k.exec(D),l?l[2]||l[1]:null},filter:function(i,h,A){var m,l,k,j;for(m=[],l=0,j=h.length;j>l;l++){k=h[l],~new String(k[A]).toLowerCase().indexOf(i.toLowerCase())&&m.push(k)}return m},remoteFilter:null,sorter:function(i,h,A){var m,l,k,j;if(!i){return h}for(m=[],l=0,j=h.length;j>l;l++){k=h[l],k.atwho_order=new String(k[A]).toLowerCase().indexOf(i.toLowerCase()),k.atwho_order>-1&&m.push(k)}return m.sort(function(d,c){return d.atwho_order-c.atwho_order})},tplEval:function(g,f){var j,i;i=g;try{return"string"!=typeof g&&(i=g(f)),i.replace(/\$\{([^\}]*)\}/g,function(b,k,e){return f[k]})}catch(h){return j=h,""}},highlighter:function(e,d){var f;return d?(f=new RegExp(">\\s*(\\w*?)("+d.replace("+","\\+")+")(\\w*)\\s*<","ig"),e.replace(f,function(h,g,j,i){return"> "+g+"<strong>"+j+"</strong>"+i+" <"})):e},beforeInsert:function(d,c){return d},beforeReposition:function(b){return b},afterMatchFailed:function(d,c){}},y={load:function(e,d){var f;return(f=this.controller(e))?f.model.load(d):void 0},isSelecting:function(){var b;return null!=(b=this.controller())?b.view.visible():void 0},hide:function(){var b;return null!=(b=this.controller())?b.view.hide():void 0},reposition:function(){var b;return(b=this.controller())?b.view.reposition(b.rect()):void 0},setIframe:function(d,c){return this.setupRootElement(d,c),null},run:function(){return this.dispatch()},destroy:function(){return this.shutdown(),this.$inputor.data("atwho",null)}},$.fn.atwho=function(b){var f,c;return f=arguments,c=null,this.filter('textarea, input, [contenteditable=""], [contenteditable=true]').each(function(){var d,a;return(a=(d=$(this)).data("atwho"))||d.data("atwho",a=new x(this)),"object"!=typeof b&&b?y[b]&&a?c=y[b].apply(a,Array.prototype.slice.call(f,1)):$.error("Method "+b+" does not exist on jQuery.atwho"):a.reg(b.at,b)}),c||this},$.fn.atwho["default"]={at:void 0,alias:void 0,data:null,displayTpl:"<li>${name}</li>",insertTpl:"${atwho-at}${name}",callbacks:v,searchKey:"name",suffix:void 0,hideWithoutSuffix:!1,startWithSpace:!0,highlightFirst:!0,limit:5,maxLen:20,displayTimeout:300,delay:null,spaceSelectsMatch:!1,tabSelectsMatch:!0,editableAtwhoQueryAttrs:{},scrollDuration:150},$.fn.atwho.debug=!1});